<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AccounTally Pro</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap');
:root{--bg:#f0f2f5;--sidebar:#0f172a;--primary:#2563eb;--pd:#1d4ed8;--ok:#059669;--bad:#dc2626;--warn:#d97706;--sur:#fff;--bdr:#e2e8f0;--txt:#1e293b;--tm:#64748b;--tl:#94a3b8;--mono:'IBM Plex Mono',monospace;--font:'IBM Plex Sans',sans-serif;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--font);background:var(--bg);color:var(--txt);height:100vh;display:flex;overflow:hidden;font-size:13px;}
#app{flex:1;min-width:0;width:100%;}
.hidden{display:none!important;}

/* ‚îÄ‚îÄ LOGIN & COMPANY SELECT ‚îÄ‚îÄ */
#co-select-wrap,#login-wrap{position:fixed;inset:0;background:linear-gradient(135deg,#0f172a 0%,#1e3a6e 60%,#0f172a 100%);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:0;}
.login-box{background:rgba(255,255,255,.07);border:1.5px solid rgba(255,255,255,.13);border-radius:20px;padding:40px 36px;width:380px;max-width:95vw;}
.login-logo{text-align:center;margin-bottom:28px;}
.login-logo-icon{font-size:42px;}
.login-logo-name{font-size:24px;font-weight:700;color:#fff;letter-spacing:-0.5px;margin-top:6px;}
.login-logo-sub{color:#93c5fd;font-size:12px;margin-top:3px;}
.login-field{margin-bottom:16px;}
.login-label{font-size:11px;font-weight:600;color:#94a3b8;margin-bottom:6px;display:block;}
.login-input{width:100%;padding:11px 14px;background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.15);border-radius:10px;color:#fff;font-size:13px;font-family:var(--font);outline:none;transition:border .15s;}
.login-input:focus{border-color:#3b82f6;background:rgba(59,130,246,.1);}
.login-input:disabled{opacity:.5;cursor:not-allowed;}
.login-input::placeholder{color:#475569;}
.login-btn{width:100%;padding:12px;background:linear-gradient(135deg,#2563eb,#3b82f6);border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .15s;margin-top:4px;}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(37,99,235,.4);}
.login-btn-sec{width:100%;padding:11px;background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.2);border-radius:10px;color:#cbd5e1;font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .15s;margin-top:8px;}
.login-btn-sec:hover{background:rgba(255,255,255,.14);color:#fff;}
.login-error{background:rgba(220,38,38,.15);border:1px solid rgba(220,38,38,.3);border-radius:8px;padding:10px 14px;color:#fca5a5;font-size:12px;margin-bottom:14px;display:none;}
.login-footer{color:#334155;font-size:11px;text-align:center;margin-top:20px;}
.login-switch{color:#60a5fa;cursor:pointer;text-decoration:underline;}
.db-badge{background:rgba(5,150,105,.15);border:1px solid rgba(5,150,105,.25);border-radius:30px;padding:6px 16px;color:#34d399;font-size:11px;font-weight:600;margin-bottom:24px;}
/* Company Select Screen */
.co-select-box{width:580px;max-width:96vw;max-height:90vh;overflow-y:auto;}
.co-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.co-card{background:rgba(255,255,255,.07);border:1.5px solid rgba(255,255,255,.12);border-radius:14px;padding:16px 18px;cursor:pointer;transition:all .18s;display:flex;flex-direction:column;gap:4px;position:relative;overflow:hidden;}
.co-card:hover{background:rgba(59,130,246,.18);border-color:#3b82f6;transform:translateY(-2px);}
.co-card-icon{font-size:24px;margin-bottom:4px;}
.co-card-name{font-size:13px;font-weight:700;color:#e2e8f0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.co-card-gstin{font-size:10px;color:#64748b;font-family:var(--mono);}
.co-card-fy{font-size:10px;color:#3b82f6;font-weight:600;}
.co-card-badge{position:absolute;top:8px;right:8px;background:rgba(59,130,246,.2);color:#93c5fd;font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;text-transform:uppercase;}
.co-new-card{background:rgba(5,150,105,.08);border:1.5px dashed rgba(5,150,105,.45);border-radius:14px;padding:16px 18px;cursor:pointer;transition:all .18s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;min-height:88px;}
.co-new-card:hover{background:rgba(5,150,105,.18);border-color:#10b981;}
.co-new-icon{font-size:26px;}
.co-new-label{font-size:13px;font-weight:700;color:#34d399;}
.co-new-sub{font-size:10px;color:#34d399;opacity:.7;}
.co-loading{color:#64748b;font-size:13px;text-align:center;padding:24px 0;}
/* Company switcher in topbar */
.co-switcher{background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:8px;padding:4px 11px;font-size:11px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:all .15s;}
.co-switcher:hover{background:#2563eb;border-color:#2563eb;color:#fff;}
/* Step indicator for new company wizard */
.step-dots{display:flex;gap:6px;margin-bottom:22px;justify-content:center;}
.step-dot{width:32px;height:4px;border-radius:2px;background:rgba(255,255,255,.15);transition:background .25s;}
.step-dot.done{background:#2563eb;}.step-dot.active{background:#60a5fa;}
.setup-step{display:none;}.setup-step.active{display:block;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar{width:220px;background:var(--sidebar);color:#fff;display:flex;flex-direction:column;flex-shrink:0;transition:width .2s;overflow:hidden;}
#sidebar.col{width:52px;}
.slg{padding:14px;border-bottom:1px solid #1e293b;display:flex;align-items:center;gap:10px;min-height:58px;}
.logo-n{font-size:13px;font-weight:700;color:#e2e8f0;white-space:nowrap;}
.logo-s{font-size:10px;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:145px;}
.stog{background:none;border:none;color:#64748b;cursor:pointer;padding:6px;font-size:18px;flex-shrink:0;line-height:1;}
.stog:hover{color:#fff;}
.snav{flex:1;padding:8px 0;overflow-y:auto;}
.ni{display:flex;align-items:center;gap:10px;padding:9px 14px;cursor:pointer;color:#94a3b8;font-size:12.5px;font-weight:500;transition:all .15s;white-space:nowrap;border-left:3px solid transparent;}
.ni:hover{background:#1e293b;color:#e2e8f0;}
.ni.act{background:#1e3a6e;color:#fff;border-left-color:#2563eb;}
.nico{font-size:15px;flex-shrink:0;width:20px;text-align:center;}
.nsec{padding:12px 14px 4px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:#334155;white-space:nowrap;}
#sidebar.col .nsec,#sidebar.col .nlb,#sidebar.col .ltxt{display:none;}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
#main{flex:1;min-width:0;width:100%;display:flex;flex-direction:column;overflow:hidden;}
#topbar{background:var(--sur);border-bottom:1px solid var(--bdr);padding:0 20px;height:52px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,.05);}
.pg-title{font-size:15px;font-weight:700;color:var(--txt);}
.tbr{display:flex;align-items:center;gap:8px;}
.fy-badge{background:#eff6ff;color:#2563eb;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;border:1px solid #bfdbfe;}
.save-status{font-size:10px;font-weight:600;padding:3px 10px;border-radius:20px;}
.save-ok{background:#ecfdf5;color:#059669;border:1px solid #a7f3d0;}
.save-ing{background:#fefce8;color:#b45309;border:1px solid #fde68a;}
.usr-badge{background:#f1f5f9;color:#475569;font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;cursor:pointer;}
.usr-badge:hover{background:#e2e8f0;}
#content{flex:1;min-height:0;overflow-y:auto;padding:18px 22px;width:100%;}
.page-full{display:flex;flex-direction:column;min-height:calc(100vh - 88px);}
.page-full .pf-grid{flex:1;}

/* ‚îÄ‚îÄ CARDS & COMPONENTS ‚îÄ‚îÄ */
.card{background:var(--sur);border:1px solid var(--bdr);border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.ch{background:#0f172a;color:#fff;padding:12px 18px;font-weight:700;font-size:13px;}
.sg{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px;}
.sc{border-radius:12px;padding:16px;color:#fff;position:relative;overflow:hidden;}
.sc::after{content:'';position:absolute;right:-8px;top:-8px;width:72px;height:72px;background:rgba(255,255,255,.07);border-radius:50%;}
.sl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:.8;}
.sv{font-size:20px;font-weight:700;margin-top:5px;font-family:var(--mono);}
.ss{font-size:10px;opacity:.65;margin-top:2px;}
.sc-b{background:linear-gradient(135deg,#2563eb,#3b82f6);}
.sc-g{background:linear-gradient(135deg,#059669,#10b981);}
.sc-r{background:linear-gradient(135deg,#dc2626,#ef4444);}
.sc-p{background:linear-gradient(135deg,#7c3aed,#8b5cf6);}
.sc-o{background:linear-gradient(135deg,#d97706,#f59e0b);}

.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-weight:600;font-family:var(--font);transition:all .15s;white-space:nowrap;}
.btn-p{background:var(--primary);color:#fff;}.btn-p:hover{background:var(--pd);}
.btn-s{background:var(--ok);color:#fff;}.btn-s:hover{background:#047857;}
.btn-d{background:var(--bad);color:#fff;}.btn-d:hover{background:#b91c1c;}
.btn-g{background:var(--bdr);color:var(--txt);}.btn-g:hover{background:#cbd5e1;}
.btn-w{background:#fff7ed;color:#c2410c;border:1px solid #fed7aa;}.btn-w:hover{background:#ffedd5;}
.btn-sm{padding:4px 9px;font-size:11px;}
.btn:disabled{opacity:.4;cursor:not-allowed;}

.tb{display:flex;align-items:center;gap:9px;margin-bottom:12px;flex-wrap:wrap;}
.tg{display:flex;gap:3px;background:var(--bdr);padding:3px;border-radius:8px;}
.t{padding:5px 11px;border-radius:6px;border:none;cursor:pointer;font-size:11px;font-weight:600;background:none;color:var(--tm);font-family:var(--font);transition:all .15s;}
.t.act{background:#fff;color:var(--primary);box-shadow:0 1px 3px rgba(0,0,0,.1);}
.t:hover:not(.act){color:var(--txt);}

.si{padding:7px 12px;border:1px solid var(--bdr);border-radius:8px;font-size:12px;font-family:var(--font);outline:none;transition:border .15s;min-width:180px;}
.si:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.08);}

.tbl{width:100%;border-collapse:collapse;}
.tbl th{background:#0f172a;color:#e2e8f0;padding:9px 13px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;}
.tbl td{padding:9px 13px;border-bottom:1px solid var(--bdr);font-size:12.5px;vertical-align:middle;}
.tbl tr:last-child td{border-bottom:none;}
.tbl tr:hover td{background:#f8fafc;}
.tbl tr.alt td{background:#fafafa;}.tbl tr.alt:hover td{background:#f0f4ff;}
.tf td{background:#0f172a!important;color:#fff!important;font-weight:700!important;}

.mono{font-family:var(--mono);}.tr{text-align:right;}.tc{text-align:center;}
.tb-{color:#2563eb;}.tg-{color:#059669;}.tr-{color:#dc2626;}.tm-{color:var(--tm);}

.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;white-space:nowrap;}
.bb{background:#eff6ff;color:#1d4ed8;}.bg-{background:#ecfdf5;color:#059669;}
.br{background:#fef2f2;color:#dc2626;}.by{background:#fefce8;color:#b45309;}
.bp{background:#faf5ff;color:#7c3aed;}.bgr{background:#f1f5f9;color:#475569;}
.bo{background:#fff7ed;color:#c2410c;}

.fg{display:grid;grid-template-columns:repeat(auto-fit,minmax(175px,1fr));gap:11px;}
.fgr{display:flex;flex-direction:column;gap:4px;}
.fl{font-size:11px;font-weight:600;color:var(--tm);}
.fc{padding:8px 10px;border:1px solid var(--bdr);border-radius:8px;font-size:12.5px;font-family:var(--font);outline:none;transition:border .15s;background:#fff;width:100%;}
.fc:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.08);}
.fc:disabled{background:#f8fafc;color:var(--tm);}

.fp{background:#f8fafc;border:1px solid var(--bdr);border-radius:12px;padding:18px;margin-bottom:14px;}

.al{padding:10px 13px;border-radius:8px;font-size:12px;margin-bottom:10px;}
.al-s{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;}
.al-d{background:#fef2f2;color:#991b1b;border:1px solid #fca5a5;}
.al-w{background:#fefce8;color:#92400e;border:1px solid #fde68a;}
.al-i{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe;}

.et{width:100%;border-collapse:collapse;border:1px solid var(--bdr);border-radius:8px;overflow:hidden;}
.et th{background:#334155;color:#e2e8f0;padding:8px 10px;font-size:11px;font-weight:700;text-align:left;}
.et td{padding:6px 8px;border-bottom:1px solid var(--bdr);}
.et tfoot td{background:#f8fafc;font-weight:700;padding:8px 10px;}
.et tfoot.bal td{background:#ecfdf5;color:#065f46;}
.et tfoot.unbal td{background:#fef2f2;color:#991b1b;}

.mo{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1000;padding:16px;}
.mo.hidden{display:none;}
.mb{background:#fff;border-radius:16px;max-width:780px;width:100%;max-height:92vh;overflow-y:auto;box-shadow:0 25px 60px rgba(0,0,0,.3);}
.mh{background:#0f172a;color:#fff;padding:15px 20px;display:flex;align-items:center;justify-content:space-between;border-radius:16px 16px 0 0;}
.mbdy{padding:20px;}
.mc{background:none;border:none;color:#94a3b8;cursor:pointer;font-size:20px;line-height:1;}
.mc:hover{color:#fff;}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}

.rp{background:var(--sur);border:1px solid var(--bdr);border-radius:12px;padding:18px;}
.rst{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--tl);margin-bottom:7px;margin-top:14px;}
.rr{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px dashed var(--bdr);}
.rrl{color:var(--txt);padding-left:12px;}
.rrv{font-weight:600;font-family:var(--mono);}
.rtot{display:flex;justify-content:space-between;padding:9px 12px;border-radius:8px;font-weight:700;margin-top:7px;}
.rt-b{background:#eff6ff;color:#1e40af;}.rt-g{background:#ecfdf5;color:#065f46;}.rt-r{background:#fef2f2;color:#991b1b;}
.rg{background:#0f172a;color:#fff;border-radius:10px;padding:12px 16px;display:flex;justify-content:space-between;font-weight:700;margin-top:10px;font-size:13px;}

.qg{display:grid;grid-template-columns:repeat(6,1fr);gap:9px;}
.ql{display:flex;flex-direction:column;align-items:center;gap:7px;padding:14px 7px;border-radius:12px;border:2px solid;cursor:pointer;background:none;font-family:var(--font);transition:all .15s;}
.ql:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1);}
.qi{font-size:20px;}.qlb{font-size:10px;font-weight:700;text-align:center;}
.q1{border-color:#bfdbfe;color:#1d4ed8;background:#eff6ff;}
.q2{border-color:#a7f3d0;color:#065f46;background:#ecfdf5;}
.q3{border-color:#ddd6fe;color:#5b21b6;background:#f5f3ff;}
.q4{border-color:#fed7aa;color:#9a3412;background:#fff7ed;}
.q5{border-color:#fca5a5;color:#991b1b;background:#fef2f2;}
.q6{border-color:#99f6e4;color:#0f766e;background:#f0fdfa;}
.q7{border-color:#e9d5ff;color:#6b21a8;background:#faf5ff;}
.q8{border-color:#bae6fd;color:#0369a1;background:#f0f9ff;}

::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px;}
/* Hide number input spinners globally */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
input[type=number]{-moz-appearance:textfield;}

/* ‚îÄ‚îÄ TOAST ANIMATION ‚îÄ‚îÄ */
@keyframes fadeInUp{
  from{opacity:0;transform:translateY(16px);}
  to{opacity:1;transform:translateY(0);}
}

/* ‚îÄ‚îÄ DUE DATE COLORS ‚îÄ‚îÄ */
.due-over{color:#dc2626;font-weight:700;}
.due-warn{color:#d97706;font-weight:700;}
.due-ok{color:#059669;}
.due-badge-over{background:#fef2f2;color:#991b1b;border:1px solid #fca5a5;}
.due-badge-warn{background:#fefce8;color:#92400e;border:1px solid #fde68a;}
.due-badge-ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;}

/* ‚îÄ‚îÄ SVG CHART ‚îÄ‚îÄ */
.chart-legend{display:flex;gap:14px;margin-bottom:10px;font-size:11px;font-weight:600;}
.leg-dot{width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:4px;}
.chart-wrap{background:#fff;border-radius:12px;border:1px solid var(--bdr);padding:14px;overflow:hidden;}

/* ‚îÄ‚îÄ PRINT / PDF ‚îÄ‚îÄ */
@media print{
  #login-wrap,#sidebar,#topbar,.tb,.no-print{display:none!important;}
  #content{padding:0;}
  body{height:auto;overflow:visible;}
}

/* ‚îÄ‚îÄ OTP RESET PASSWORD SCREEN ‚îÄ‚îÄ */
#otp-wrap{position:fixed;inset:0;background:linear-gradient(135deg,#0f172a 0%,#1e3a6e 60%,#0f172a 100%);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;}
.otp-box{background:rgba(255,255,255,.07);border:1.5px solid rgba(255,255,255,.13);border-radius:20px;padding:40px 36px;width:400px;max-width:95vw;}
.otp-digits{display:flex;gap:10px;justify-content:center;margin:20px 0;}
.otp-digit{width:48px;height:56px;border-radius:10px;border:1.5px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff;font-size:22px;font-weight:700;text-align:center;font-family:var(--mono);outline:none;transition:border .15s;}
.otp-digit:focus{border-color:#3b82f6;background:rgba(59,130,246,.15);}
.otp-step{display:none;}.otp-step.active{display:block;}
.otp-timer{font-size:11px;color:#64748b;text-align:center;margin-top:8px;}
.otp-timer span{color:#3b82f6;font-weight:700;}

</style>
</head>
<body>

<!-- ‚ïê‚ïê COMPANY SELECT ‚ïê‚ïê -->
<div id="co-select-wrap">
  <div class="db-badge">‚òÅÔ∏è Supabase Cloud Storage ‚Äî Multi-Company Edition</div>
  <div class="login-box co-select-box">
    <div class="login-logo" style="margin-bottom:20px;">
      <div class="login-logo-icon">üìä</div>
      <div class="login-logo-name">AccounTally Pro</div>
      <div class="login-logo-sub">Select a company to continue</div>
    </div>
    <div id="co-list-wrap">
      <div class="co-loading" id="co-loading" style="display:block;">‚è≥ Loading companies‚Ä¶</div>
      <div class="co-grid" id="co-grid" style="display:grid;">
        <div class="co-new-card" onclick="openNewCoWizard()">
          <div class="co-new-icon">‚ûï</div>
          <div class="co-new-label">Create New Company</div>
          <div class="co-new-sub">Set up a separate entity</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div id="login-wrap" class="hidden">
  <div class="db-badge">‚òÅÔ∏è Supabase Cloud Storage ‚Äî Data saved permanently online</div>
  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-icon">üìä</div>
      <div id="login-co-name" class="login-logo-name">AccounTally Pro</div>
      <div class="login-logo-sub">Sign in to access your company</div>
    </div>
    <div class="login-error" id="login-err"></div>
    <div class="login-error" id="login-lockout" style="background:rgba(234,179,8,.15);border-color:rgba(234,179,8,.4);color:#fde68a;"></div>
    <div id="login-form-wrap">
      <div class="login-field">
        <label class="login-label">Username</label>
        <input class="login-input" id="li-user" placeholder="Enter username" autocomplete="username">
      </div>
      <div class="login-field">
        <label class="login-label">Password</label>
        <input class="login-input" id="li-pass" type="password" placeholder="Enter password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="login-btn" onclick="doLogin()">Sign In ‚Üí</button>
      <button class="login-btn-sec" onclick="backToCompanySelect()">‚Üê Back to Company List</button>
      <div style="text-align:center;margin-top:14px;">
        <span onclick="openOtpScreen()" style="color:#60a5fa;font-size:12px;cursor:pointer;text-decoration:underline;">üîë Forgot Password? Reset via OTP</span>
      </div>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê OTP PASSWORD RESET SCREEN ‚ïê‚ïê -->
<div id="otp-wrap" class="hidden">
  <div class="login-logo" style="margin-bottom:20px;">
    <div class="login-logo-icon">üîê</div>
    <div class="login-logo-name">Reset Password</div>
    <div class="login-logo-sub">AccounTally Pro</div>
  </div>
  <div class="otp-box">
    <div id="otp-error" class="login-error"></div>

    <!-- Step 1: Enter mobile number directly -->
    <div class="otp-step active" id="otp-s1">
      <div style="color:#94a3b8;font-size:12px;margin-bottom:20px;line-height:1.7;">
        Enter your registered mobile number. A 6-digit OTP will be sent via SMS.
      </div>
      <div class="login-field">
        <label class="login-label">Mobile Number</label>
        <input class="login-input" id="otp-mobile-input" type="tel" placeholder="+91 9876543210" maxlength="13" autocomplete="tel" onkeydown="if(event.key==='Enter')otpSendStep1()">
      </div>
      <button class="login-btn" onclick="otpSendStep1()">Send OTP ‚Üí</button>
      <button class="login-btn-sec" onclick="closeOtpScreen()">‚Üê Back to Login</button>
    </div>

    <!-- Step 2: Enter OTP -->
    <div class="otp-step" id="otp-s2">
      <div style="color:#94a3b8;font-size:12px;margin-bottom:6px;text-align:center;">
        Enter the 6-digit OTP sent to <strong id="otp-sent-to" style="color:#93c5fd;"></strong>
      </div>
      <div class="otp-digits">
        <input class="otp-digit" id="od1" maxlength="1" type="tel" oninput="otpDigitInput(this,'od2')" onkeydown="otpDigitKey(event,this,'','od1')">
        <input class="otp-digit" id="od2" maxlength="1" type="tel" oninput="otpDigitInput(this,'od3')" onkeydown="otpDigitKey(event,this,'od1','od2')">
        <input class="otp-digit" id="od3" maxlength="1" type="tel" oninput="otpDigitInput(this,'od4')" onkeydown="otpDigitKey(event,this,'od2','od3')">
        <input class="otp-digit" id="od4" maxlength="1" type="tel" oninput="otpDigitInput(this,'od5')" onkeydown="otpDigitKey(event,this,'od3','od4')">
        <input class="otp-digit" id="od5" maxlength="1" type="tel" oninput="otpDigitInput(this,'od6')" onkeydown="otpDigitKey(event,this,'od4','od5')">
        <input class="otp-digit" id="od6" maxlength="1" type="tel" oninput="otpDigitInput(this,'')"    onkeydown="otpDigitKey(event,this,'od5','od6')">
      </div>
      <div class="otp-timer">Expires in <span id="otp-timer-val">10:00</span> &nbsp;|&nbsp;
        <span style="color:#3b82f6;cursor:pointer;" onclick="otpResend()">Resend OTP</span>
      </div>
      <button class="login-btn" style="margin-top:16px;" onclick="otpVerify()">Verify OTP ‚Üí</button>
      <button class="login-btn-sec" onclick="otpGoStep(1)">‚Üê Change Number</button>
    </div>

    <!-- Step 3: Set new password -->
    <div class="otp-step" id="otp-s3">
      <div style="color:#94a3b8;font-size:12px;margin-bottom:20px;">
        ‚úÖ Identity verified! Set your new password below.
      </div>
      <div class="login-field">
        <label class="login-label">New Password</label>
        <input class="login-input" id="otp-newpass" type="password" placeholder="Minimum 6 characters" onkeydown="if(event.key==='Enter')document.getElementById('otp-newpass2').focus()">
      </div>
      <div class="login-field">
        <label class="login-label">Confirm New Password</label>
        <input class="login-input" id="otp-newpass2" type="password" placeholder="Re-enter new password" onkeydown="if(event.key==='Enter')otpSetNewPassword()">
      </div>
      <button class="login-btn" onclick="otpSetNewPassword()">üîê Save New Password ‚Üí</button>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê NEW COMPANY WIZARD (Modal overlay) ‚ïê‚ïê -->
<div id="new-co-overlay" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:16px;">
  <div style="background:#0f172a;border:1.5px solid rgba(255,255,255,.15);border-radius:20px;padding:36px 32px;width:420px;max-width:95vw;max-height:92vh;overflow-y:auto;">
    <div style="text-align:center;margin-bottom:18px;">
      <div style="font-size:32px;">üè¢</div>
      <div style="font-size:18px;font-weight:700;color:#fff;margin-top:6px;">Create New Company</div>
      <div style="font-size:11px;color:#64748b;margin-top:3px;">Fill in company details ‚Äî you can update these later in Settings</div>
    </div>
    <div class="step-dots">
      <div class="step-dot active" id="sdot-1"></div>
      <div class="step-dot" id="sdot-2"></div>
      <div class="step-dot" id="sdot-3"></div>
    </div>
    <!-- Step 1: Company Info -->
    <div class="setup-step active" id="nc-step-1">
      <div style="font-size:11px;font-weight:700;color:#3b82f6;text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;">Step 1 of 3 ‚Äî Company Identity</div>
      <div class="login-field">
        <label class="login-label">Company Name *</label>
        <input class="login-input" id="nc-name" placeholder="e.g. Reliance Industries Ltd.">
      </div>
      <div class="login-field">
        <label class="login-label">GSTIN (optional)</label>
        <input class="login-input" id="nc-gstin" placeholder="27AAPFU0939F1ZV" maxlength="15" style="text-transform:uppercase;">
      </div>
      <div class="login-field">
        <label class="login-label">Company State</label>
        <select class="login-input" id="nc-state" style="background:rgba(255,255,255,.08);color:#fff;">
          <option value="Maharashtra" style="background:#1e293b;">Maharashtra</option>
          <option value="Delhi" style="background:#1e293b;">Delhi</option>
          <option value="Karnataka" style="background:#1e293b;">Karnataka</option>
          <option value="Tamil Nadu" style="background:#1e293b;">Tamil Nadu</option>
          <option value="Gujarat" style="background:#1e293b;">Gujarat</option>
          <option value="Telangana" style="background:#1e293b;">Telangana</option>
          <option value="Uttar Pradesh" style="background:#1e293b;">Uttar Pradesh</option>
          <option value="West Bengal" style="background:#1e293b;">West Bengal</option>
          <option value="Rajasthan" style="background:#1e293b;">Rajasthan</option>
          <option value="Andhra Pradesh" style="background:#1e293b;">Andhra Pradesh</option>
          <option value="Kerala" style="background:#1e293b;">Kerala</option>
          <option value="Punjab" style="background:#1e293b;">Punjab</option>
          <option value="Haryana" style="background:#1e293b;">Haryana</option>
          <option value="Madhya Pradesh" style="background:#1e293b;">Madhya Pradesh</option>
        </select>
      </div>
      <div class="login-field">
        <label class="login-label">Financial Year *</label>
        <select class="login-input" id="nc-fy" style="background:rgba(255,255,255,.08);color:#fff;"></select>
      </div>
      <div class="login-field">
        <label class="login-label">TAN (optional)</label>
        <input class="login-input" id="nc-tan" placeholder="e.g. MUMT12345G" maxlength="10" style="text-transform:uppercase;">
      </div>
      <button class="login-btn" onclick="ncNext(1)">Next: Admin Account ‚Üí</button>
      <button class="login-btn-sec" onclick="closeNewCoWizard()">Cancel</button>
    </div>
    <!-- Step 2: Admin Account -->
    <div class="setup-step" id="nc-step-2">
      <div style="font-size:11px;font-weight:700;color:#3b82f6;text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;">Step 2 of 3 ‚Äî Admin Account</div>
      <div class="login-field">
        <label class="login-label">Admin Username *</label>
        <input class="login-input" id="nc-user" placeholder="e.g. admin or john">
      </div>
      <div class="login-field">
        <label class="login-label">Password *</label>
        <input class="login-input" id="nc-pass" type="password" placeholder="Minimum 4 characters">
      </div>
      <div class="login-field">
        <label class="login-label">Confirm Password *</label>
        <input class="login-input" id="nc-pass2" type="password" placeholder="Re-enter password">
      </div>
      <div class="login-field">
        <label class="login-label">Mobile Number * <span style="font-size:10px;opacity:.7;">(for OTP password reset)</span></label>
        <input class="login-input" id="nc-mobile" type="tel" placeholder="+91 9876543210" maxlength="13">
      </div>
      <button class="login-btn" onclick="ncNext(2)">Next: Final Settings ‚Üí</button>
      <button class="login-btn-sec" onclick="ncBack(2)">‚Üê Back</button>
    </div>
    <!-- Step 3: Settings -->
    <div class="setup-step" id="nc-step-3">
      <div style="font-size:11px;font-weight:700;color:#3b82f6;text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;">Step 3 of 3 ‚Äî Accounting Settings</div>
      <div class="login-field">
        <label class="login-label">Accounting Method</label>
        <select class="login-input" id="nc-method" style="background:rgba(255,255,255,.08);color:#fff;">
          <option value="mercantile" style="background:#1e293b;">Mercantile / Accrual (IND AS)</option>
          <option value="cash" style="background:#1e293b;">Cash Basis</option>
        </select>
      </div>
      <div class="login-field">
        <label class="login-label">Currency</label>
        <select class="login-input" id="nc-currency" style="background:rgba(255,255,255,.08);color:#fff;">
          <option value="INR" style="background:#1e293b;">‚Çπ Indian Rupee (INR)</option>
          <option value="USD" style="background:#1e293b;">$ US Dollar (USD)</option>
        </select>
      </div>
      <div class="login-field">
        <label class="login-label">Load Sample Data?</label>
        <select class="login-input" id="nc-sample" style="background:rgba(255,255,255,.08);color:#fff;">
          <option value="yes" style="background:#1e293b;">Yes ‚Äî Load demo data (recommended for new users)</option>
          <option value="no" style="background:#1e293b;">No ‚Äî Start with blank books</option>
        </select>
      </div>
      <div id="nc-error" style="background:rgba(220,38,38,.15);border:1px solid rgba(220,38,38,.3);border-radius:8px;padding:10px 14px;color:#fca5a5;font-size:12px;margin-bottom:14px;display:none;"></div>
      <button class="login-btn" id="nc-create-btn" onclick="doCreateCompany()">üè¢ Create Company & Sign In ‚Üí</button>
      <button class="login-btn-sec" onclick="ncBack(3)">‚Üê Back</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê -->
<div id="app" class="hidden" style="display:flex;width:100%;height:100vh;overflow:hidden;">
  <nav id="sidebar">
    <div class="slg">
      <button class="stog" onclick="toggleSidebar()">‚ò∞</button>
      <div class="ltxt">
        <div class="logo-n" id="sb-company">My Business</div>
        <div class="logo-s" id="sb-fy">FY 2025-26</div>
      </div>
    </div>
    <div class="snav">
      <div class="nsec">Main</div>
      <div class="ni act" id="nav-dashboard" onclick="navigate('dashboard')"><span class="nico">üè†</span><span class="nlb">Dashboard</span></div>
      <div class="nsec">Masters</div>
      <div class="ni" id="nav-accounts" onclick="navigate('accounts')"><span class="nico">üìã</span><span class="nlb">Chart of Accounts</span></div>
      <div class="ni" id="nav-items" onclick="navigate('items')"><span class="nico">üì¶</span><span class="nlb">Item Master (HSN/SAC)</span></div>
      <div class="ni" id="nav-vendors" onclick="navigate('vendors')"><span class="nico">üè≠</span><span class="nlb">Vendors / Suppliers</span></div>
      <div class="ni" id="nav-debtors" onclick="navigate('debtors')"><span class="nico">ü§ù</span><span class="nlb">Customers / Debtors</span></div>
      <div class="nsec">Transactions</div>
      <div class="ni" id="nav-vouchers" onclick="navigate('vouchers')"><span class="nico">üìù</span><span class="nlb">Voucher Entry</span></div>
      <div class="ni" id="nav-advances" onclick="navigate('advances')"><span class="nico">üí∞</span><span class="nlb">Advance Payments</span></div>
      <div class="nsec">Books</div>
      <div class="ni" id="nav-daybook" onclick="navigate('daybook')"><span class="nico">üìÖ</span><span class="nlb">Day Book</span></div>
      <div class="ni" id="nav-cashbook" onclick="navigate('cashbook')"><span class="nico">üíµ</span><span class="nlb">Cash Book</span></div>
      <div class="ni" id="nav-ledger" onclick="navigate('ledger')"><span class="nico">üìñ</span><span class="nlb">Ledger</span></div>
      <div class="ni" id="nav-bankrecon" onclick="navigate('bankrecon')"><span class="nico">üè¶</span><span class="nlb">Bank Reconciliation</span></div>
      <div class="nsec">Registers</div>
      <div class="ni" id="nav-reg-sales" onclick="navigate('reg-sales')"><span class="nico">üßæ</span><span class="nlb">Sales Register</span></div>
      <div class="ni" id="nav-reg-purchase" onclick="navigate('reg-purchase')"><span class="nico">üõí</span><span class="nlb">Purchase Register</span></div>
      <div class="ni" id="nav-reg-debit" onclick="navigate('reg-debit')"><span class="nico">üì§</span><span class="nlb">Debit Note Register</span></div>
      <div class="ni" id="nav-reg-credit" onclick="navigate('reg-credit')"><span class="nico">üì•</span><span class="nlb">Credit Note Register</span></div>
      <div class="ni" id="nav-reg-journal" onclick="navigate('reg-journal')"><span class="nico">üìì</span><span class="nlb">Journal Register</span></div>
      <div class="nsec">Reports</div>
      <div class="ni" id="nav-trial" onclick="navigate('trial')"><span class="nico">‚öñÔ∏è</span><span class="nlb">Trial Balance</span></div>
      <div class="ni" id="nav-pnl" onclick="navigate('pnl')"><span class="nico">üìä</span><span class="nlb">Profit & Loss</span></div>
      <div class="ni" id="nav-balance" onclick="navigate('balance')"><span class="nico">üèó</span><span class="nlb">Balance Sheet</span></div>
      <div class="ni" id="nav-cashflow" onclick="navigate('cashflow')"><span class="nico">üí∏</span><span class="nlb">Cash Flow (AS-3)</span></div>
      <div class="ni" id="nav-gst" onclick="navigate('gst')"><span class="nico">üßæ</span><span class="nlb">GST Reports</span></div>
      <div class="ni" id="nav-tds" onclick="navigate('tds')"><span class="nico">üìë</span><span class="nlb">TDS Reports</span></div>
      <div class="ni" id="nav-outstanding" onclick="navigate('outstanding')"><span class="nico">üî¥</span><span class="nlb">Outstanding Report</span></div>
      <div class="nsec">Data</div>
      <div class="ni" id="nav-import" onclick="navigate('import')"><span class="nico">üîÑ</span><span class="nlb">Excel Import/Export</span></div>
      <div class="nsec">Admin</div>
      <div class="ni" id="nav-settings" onclick="navigate('settings')"><span class="nico">‚öôÔ∏è</span><span class="nlb">Settings</span></div>
      <div class="nsec">Billing</div>
      <div class="ni" id="nav-invoice" onclick="navigate('invoice')"><span class="nico">üßæ</span><span class="nlb">GST Invoices</span></div>
      <div class="nsec">HR &amp; Payroll</div>
      <div class="ni" id="nav-employees" onclick="navigate('employees')"><span class="nico">üë•</span><span class="nlb">Employee Master</span></div>
      <div class="ni" id="nav-payroll" onclick="navigate('payroll')"><span class="nico">üíº</span><span class="nlb">Payroll Processing</span></div>
      <div class="nsec">Compliance</div>
      <div class="ni" id="nav-gstr1" onclick="navigate('gstr1')"><span class="nico">üìã</span><span class="nlb">GSTR-1 Return</span></div>
      <div class="ni" id="nav-gstr3b" onclick="navigate('gstr3b')"><span class="nico">üìä</span><span class="nlb">GSTR-3B Return</span></div>
      <div class="ni" id="nav-einvoice" onclick="navigate('einvoice')"><span class="nico">üîê</span><span class="nlb">E-Invoice (IRN)</span></div>
      <div class="ni" id="nav-audittrail" onclick="navigate('audittrail')"><span class="nico">üïµÔ∏è</span><span class="nlb">Audit Trail</span></div>
      <div class="nsec">Users</div>
      <div class="ni" id="nav-usermgmt" onclick="navigate('usermgmt')"><span class="nico">üîê</span><span class="nlb">User Management</span></div>
    </div>
  </nav>
  <div id="main">
    <header id="topbar">
      <div style="display:flex;align-items:center;gap:10px;">
        <span id="pg-title" class="pg-title">üè† Dashboard</span>
      </div>
      <div class="tbr">
        <span id="save-ind" class="save-status save-ok">‚úì Saved</span>
        <span class="fy-badge" id="top-fy">FY 2025-26</span>
        <button class="co-switcher" id="co-switch-btn" onclick="showCompanySwitcher()" title="Switch Company" style="display:none;">üè¢ <span id="co-switch-label">Company</span> ‚ñæ</button>
        <span class="usr-badge" id="usr-btn" onclick="showUserMenu()">üë§ Admin ‚ñæ</span>
      </div>
    </header>
    <div id="content"></div>
  </div>
</div>

<!-- MODAL -->
<div class="mo hidden" id="modal">
  <div class="mb">
    <div class="mh"><span id="mtitle">Modal</span><button class="mc" onclick="closeModal()">‚úï</button></div>
    <div class="mbdy" id="mbody"></div>
  </div>
</div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS & DEFAULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const VT = ['Receipt','Payment','Sales','Purchase','Journal','Contra','Debit Note','Credit Note'];
const AT = ['Asset','Liability','Income','Expense','Capital'];
const AG = {
  Asset:    ['Cash & Bank','Sundry Debtors','Stock-in-Hand','Fixed Assets','Loans & Advances','Current Assets','Advance to Suppliers'],
  Liability:['Sundry Creditors','Duties & Taxes','Loans (Liability)','Current Liabilities','Advance from Customers','TDS Payable'],
  Income:   ['Sales Accounts','Direct Income','Indirect Income','Service Income'],
  Expense:  ['Purchase Accounts','Direct Expenses','Indirect Expenses','COGS'],
  Capital:  ['Capital Account','Reserves & Surplus','Retained Earnings'],
};

// GST rates and TDS sections per Indian Tax Law
const GST_RATES = [0,5,12,18,28];
const GST_TYPES = ['CGST+SGST (Intra-state)','IGST (Inter-state)','Exempt','Composition'];
const TDS_SECTIONS = [
  {code:'194C',desc:'Contractor / Sub-contractor',rate:1,thresholdSingle:30000,thresholdYearly:100000},
  {code:'194J',desc:'Professional / Technical Services',rate:10,thresholdSingle:30000,thresholdYearly:30000},
  {code:'194I',desc:'Rent',rate:10,thresholdSingle:240000,thresholdYearly:240000},
  {code:'194A',desc:'Interest (other than securities)',rate:10,thresholdSingle:40000,thresholdYearly:40000},
  {code:'194H',desc:'Commission / Brokerage',rate:5,thresholdSingle:15000,thresholdYearly:15000},
  {code:'194D',desc:'Insurance Commission',rate:5,thresholdSingle:15000,thresholdYearly:15000},
  {code:'194B',desc:'Winnings from Lottery',rate:30,thresholdSingle:10000,thresholdYearly:10000},
  {code:'194Q',desc:'Purchase of Goods',rate:0.1,thresholdSingle:5000000,thresholdYearly:5000000},
  {code:'194R',desc:'Perquisites / Benefits',rate:10,thresholdSingle:20000,thresholdYearly:20000},
];
const INDIAN_STATES = ['Andhra Pradesh','Arunachal Pradesh','Assam','Bihar','Chhattisgarh','Goa','Gujarat','Haryana','Himachal Pradesh','Jharkhand','Karnataka','Kerala','Madhya Pradesh','Maharashtra','Manipur','Meghalaya','Mizoram','Nagaland','Odisha','Punjab','Rajasthan','Sikkim','Tamil Nadu','Telangana','Tripura','Uttar Pradesh','Uttarakhand','West Bengal','Delhi','Jammu & Kashmir','Ladakh','Puducherry','Chandigarh','Dadra & Nagar Haveli','Daman & Diu','Lakshadweep','Andaman & Nicobar'];

const DEFAULT_STATE = {
  company:'My Company Pvt. Ltd.',fy:'2025-26',fyStart:'2025-04-01',fyEnd:'2026-03-31',
  gstin:'',companyState:'Maharashtra',
  accounts:[
    // Assets
    {id:'1001',name:'Cash in Hand',group:'Cash & Bank',type:'Asset',nature:'Dr',balance:0},
    {id:'1002',name:'Bank Account',group:'Cash & Bank',type:'Asset',nature:'Dr',balance:0},
    {id:'1003',name:'Accounts Receivable',group:'Sundry Debtors',type:'Asset',nature:'Dr',balance:0},
    {id:'1004',name:'Inventory / Stock',group:'Stock-in-Hand',type:'Asset',nature:'Dr',balance:0},
    {id:'1005',name:'Fixed Assets',group:'Fixed Assets',type:'Asset',nature:'Dr',balance:0},
    {id:'1006',name:'Input CGST',group:'Current Assets',type:'Asset',nature:'Dr',balance:0},
    {id:'1007',name:'Input SGST',group:'Current Assets',type:'Asset',nature:'Dr',balance:0},
    {id:'1008',name:'Input IGST',group:'Current Assets',type:'Asset',nature:'Dr',balance:0},
    {id:'1009',name:'Advance to Suppliers',group:'Advance to Suppliers',type:'Asset',nature:'Dr',balance:0},
    // Liabilities
    {id:'2001',name:'Accounts Payable',group:'Sundry Creditors',type:'Liability',nature:'Cr',balance:0},
    {id:'2002',name:'Output CGST',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    {id:'2003',name:'Output SGST',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    {id:'2004',name:'Output IGST',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    {id:'2005',name:'TDS Payable',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    {id:'1010',name:'TDS Receivable',group:'Current Assets',type:'Asset',nature:'Dr',balance:0},
    {id:'2006',name:'Advance from Customers',group:'Advance from Customers',type:'Liability',nature:'Cr',balance:0},
    {id:'2007',name:'Bank Loan / OD',group:'Loans (Liability)',type:'Liability',nature:'Cr',balance:0},
    {id:'2008',name:'GST Payable',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    // Income
    {id:'3001',name:'Sales Revenue',group:'Sales Accounts',type:'Income',nature:'Cr',balance:0},
    {id:'3002',name:'Service Income',group:'Service Income',type:'Income',nature:'Cr',balance:0},
    {id:'3003',name:'Other Income',group:'Indirect Income',type:'Income',nature:'Cr',balance:0},
    // Expenses
    {id:'4001',name:'Purchases',group:'Purchase Accounts',type:'Expense',nature:'Dr',balance:0},
    {id:'4002',name:'Salaries & Wages',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4003',name:'Rent Expense',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4004',name:'Electricity & Utilities',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4005',name:'Office Expenses',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4006',name:'Marketing & Advertising',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4007',name:'Bank Charges',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4008',name:'Depreciation',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    // Capital
    {id:'5001',name:"Owner's Capital",group:'Capital Account',type:'Capital',nature:'Cr',balance:0},
    {id:'5002',name:'Retained Earnings',group:'Reserves & Surplus',type:'Capital',nature:'Cr',balance:0},
  ],
  vouchers:[],
  vendors:[],
  debtors:[],
  items:[],
  bankStatements:[],
  advances:[],
  invoices:[],
  employees:[],
  payroll:[],
  appUsers:[],
  auditLog:[],
};

// ‚ïê‚ïê SUPABASE CLIENT ‚ïê‚ïê
const SUPA_URL = 'https://dfsltxehfdmnwxkwecww.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmc2x0eGVoZmRtbnd4a3dlY3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTg0MDgsImV4cCI6MjA4NzQzNDQwOH0.Xe8JTV2Gw1WfCx-0U4im64dZ8aw_wYWhrFqciDrX990';
let supa = null;
function getSupa(){
  if(!supa){
    if(typeof supabase === 'undefined') throw new Error('Supabase library not loaded. Please check your internet connection.');
    supa = supabase.createClient(SUPA_URL, SUPA_KEY);
  }
  return supa;
}

// ‚îÄ‚îÄ v11: Supabase Auth ‚Äî passwords managed by Supabase, NOT stored in DB ‚îÄ‚îÄ
// app_users: username, user_id (uuid‚Üíauth.users), company_id, role
function rowToUser(r){ return {username:r.username, id:r.company_id+'_u1', companyId:r.company_id, passwordHash:'', role:r.role, fullName:r.username, mobile:r.mobile||''}; }

const DB = {
  async open(){ return true; },
  async get(store, key){
    const db=getSupa();
    if(store==='users'){
      const {data,error}=await db.from('app_users').select('*').eq('username',key).maybeSingle();
      if(error) throw error;
      return data ? rowToUser(data) : undefined;
    } else {
      const {data,error}=await db.from('app_data').select('*').eq('id',key).maybeSingle();
      if(error) throw error;
      return data ? data.state : undefined;
    }
  },
  async set(store, key, val){
    const db=getSupa();
    if(store==='users'){
      const row={username:val.username, company_id:val.companyId||val.company_id||state.companyId||'', role:val.role||'viewer'};
      const {error}=await db.from('app_users').upsert(row,{onConflict:'username'});
      if(error) throw error;
    } else {
      const {error}=await db.from('app_data').upsert({id:key,state:val},{onConflict:'id'});
      if(error) throw error;
    }
  },
  async getAll(store){
    const db=getSupa();
    if(store==='users'){
      const {data,error}=await db.from('app_users').select('*');
      if(error) throw error;
      return (data||[]).map(rowToUser);
    } else {
      const {data,error}=await db.from('app_data').select('*');
      if(error) throw error;
      return data||[];
    }
  },
  async del(store, key){
    const db=getSupa();
    const tbl=store==='users'?'app_users':'app_data';
    const col=store==='users'?'username':'id';
    const {error}=await db.from(tbl).delete().eq(col,key);
    if(error) throw error;
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SECURITY LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ 1. LEGACY HASH (sha256legacy ‚Äî used for e-Invoice IRN only) ‚îÄ‚îÄ
async function sha256legacy(str){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ‚îÄ‚îÄ 2. RATE LIMITING (lockout after 5 failed attempts for 15 mins) ‚îÄ‚îÄ
const _loginAttempts = {};
const MAX_ATTEMPTS   = 5;
const LOCKOUT_MS     = 15 * 60 * 1000;

function checkRateLimit(username){
  const key = username.toLowerCase();
  const rec = _loginAttempts[key];
  if(!rec) return { allowed: true };
  if(rec.lockedUntil && Date.now() < rec.lockedUntil){
    const mins = Math.ceil((rec.lockedUntil - Date.now()) / 60000);
    return { allowed: false, message: `Account locked. Try again in ${mins} minute${mins>1?'s':''}.` };
  }
  return { allowed: true };
}
function recordFailedLogin(username){
  const key = username.toLowerCase();
  if(!_loginAttempts[key]) _loginAttempts[key] = { count: 0, lockedUntil: null };
  _loginAttempts[key].count++;
  if(_loginAttempts[key].count >= MAX_ATTEMPTS){
    _loginAttempts[key].lockedUntil = Date.now() + LOCKOUT_MS;
    _loginAttempts[key].count = 0;
  }
}
function clearFailedLogins(username){ delete _loginAttempts[username.toLowerCase()]; }

// ‚îÄ‚îÄ 3. SESSION TIMEOUT (auto-logout after 30 mins idle) ‚îÄ‚îÄ
const SESSION_TIMEOUT_MS = 30 * 60 * 1000;
let _sessionTimer = null;
function resetSessionTimer(){
  clearTimeout(_sessionTimer);
  if(!currentUser) return;
  _sessionTimer = setTimeout(()=>{
    if(currentUser){
      showToast('Session expired due to inactivity. Please login again.','#dc2626');
      setTimeout(doLogout, 2000);
    }
  }, SESSION_TIMEOUT_MS);
}
['click','keydown','mousemove','touchstart'].forEach(ev=>{
  document.addEventListener(ev, ()=>{ if(currentUser) resetSessionTimer(); }, { passive:true });
});

// ‚îÄ‚îÄ AUDIT TRAIL ‚îÄ‚îÄ
// Logs who did what and when. Call logAudit(action, detail) anywhere.
function logAudit(action, detail=''){
  if(!state.auditLog) state.auditLog=[];
  state.auditLog.unshift({
    ts: new Date().toISOString(),
    user: currentUser?.username||'system',
    role: currentUser?.role||'‚Äî',
    action,
    detail: String(detail).slice(0,200),
    page: document.getElementById('pg-title')?.textContent?.replace(/^[\u0080-\uFFFF\s]+/,'').trim()||'‚Äî'
  });
  // Keep last 500 entries to avoid bloating state
  if(state.auditLog.length>500) state.auditLog=state.auditLog.slice(0,500);
}

// ‚îÄ‚îÄ 4. INPUT SANITIZATION ‚îÄ‚îÄ
function sanitizeInput(str){
  if(typeof str !== 'string') return '';
  return str.replace(/[<>"'`]/g,'').trim().slice(0, 100);
}

let currentUser=null;
let _selectedCompanyId=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COMPANY REGISTRY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function getCompanyRegistry(){
  try{
    const {data,error}=await getSupa().from('companies_registry').select('*').order('created_at',{ascending:true});
    if(error) throw error;
    return (data||[]).map(r=>({companyId:r.company_id,name:r.name,gstin:r.gstin||'',fy:r.fy||'2025-26',createdAt:r.created_at}));
  }catch(e){console.error('Registry load',e);return[];}
}
async function saveCompanyRegistry(reg){ /* no-op v11 */ }
async function registerCompany(companyId,name,gstin,fy){
  const {error}=await getSupa().from('companies_registry').upsert(
    {company_id:companyId,name:name||'My Company',gstin:gstin||'',fy:fy||'2025-26'},
    {onConflict:'company_id'}
  );
  if(error) throw new Error('Could not register company: '+error.message);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COMPANY SELECT SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CO_ICONS=['üè¢','üèó','üè¨','üè¶','üè≠','üè™','üè´','üèõ'];

async function showCompanySelectScreen(){
  document.getElementById('co-select-wrap').classList.remove('hidden');
  document.getElementById('login-wrap').classList.add('hidden');
  document.getElementById('app').classList.add('hidden');
  const grid=document.getElementById('co-grid');
  const loading=document.getElementById('co-loading');
  // Show ‚ûï immediately ‚Äî user is never stuck even if network is slow
  if(grid){grid.style.display='grid';grid.innerHTML=buildNewCoCard();}
  if(loading){loading.textContent='‚è≥ Loading companies‚Ä¶';loading.style.display='block';}
  try{
    const {data,error}=await Promise.race([
      getSupa().from('companies_registry').select('*').order('created_at',{ascending:true}),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),6000))
    ]);
    if(loading)loading.style.display='none';
    if(error)throw error;
    if(data&&data.length>0){
      const companies=data.map(r=>({companyId:r.company_id,name:r.name,gstin:r.gstin||'',fy:r.fy||'2025-26'}));
      if(grid)grid.innerHTML=companies.map((co,i)=>buildCoCard(co,i)).join('')+buildNewCoCard();
    }
  }catch(e){
    if(loading){loading.textContent='‚ö†Ô∏è '+e.message;loading.style.display='block';}
    console.warn('Company list error:',e.message);
  }
}

function buildCoCard(co,i){
  return `<div class="co-card" onclick="selectCompanyForLogin('${co.companyId}','${(co.name||'').replace(/'/g,"\\'").replace(/"/g,"&quot;")}')">
    <div class="co-card-icon">${CO_ICONS[i%CO_ICONS.length]}</div>
    <div class="co-card-name">${co.name||co.companyId}</div>
    <div class="co-card-gstin">${co.gstin||'GSTIN not set'}</div>
    <div class="co-card-fy">FY ${co.fy||'‚Äî'}</div>
    <div class="co-card-badge">Active</div>
  </div>`;
}
function buildNewCoCard(){
  return `<div class="co-new-card" onclick="openNewCoWizard()">
    <div class="co-new-icon">‚ûï</div>
    <div class="co-new-label">Create New Company</div>
    <div class="co-new-sub">Set up a separate entity</div>
  </div>`;
}
function selectCompanyForLogin(companyId,companyName){
  _selectedCompanyId=companyId;
  document.getElementById('co-select-wrap').classList.add('hidden');
  document.getElementById('login-wrap').classList.remove('hidden');
  document.getElementById('login-co-name').textContent=companyName||'Company Login';
  document.getElementById('li-user').value='';
  document.getElementById('li-pass').value='';
  const e=document.getElementById('login-err');
  if(e)e.style.display='none';
}
function backToCompanySelect(){
  _selectedCompanyId=null;
  document.getElementById('login-wrap').classList.add('hidden');
  showCompanySelectScreen();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doLogin(){
  const u=sanitizeInput(document.getElementById('li-user').value.trim());
  const p=document.getElementById('li-pass').value;
  if(!u||!p){showLoginErr('Please enter username and password.');return;}
  if(!_selectedCompanyId){showLoginErr('Please select a company first.');backToCompanySelect();return;}
  const rl=checkRateLimit(u);
  if(!rl.allowed){showLoginErr(rl.message);return;}
  const btn=document.querySelector('#login-form-wrap .login-btn');
  if(btn){btn.disabled=true;btn.textContent='Signing in‚Ä¶';}
  try{
    // Step 1: Supabase Auth sign-in
    // Try new format first (username_companyid@accountally.app),
    // then fall back to old format (username@accountally.app) for existing users
    const emailNew = u.toLowerCase()+'_'+_selectedCompanyId.toLowerCase()+'@accountally.app';
    const emailOld = u.toLowerCase()+'@accountally.app';
    let authData=null, authErr=null;

    const res1 = await getSupa().auth.signInWithPassword({email:emailNew, password:p});
    if(!res1.error){
      authData = res1.data;
    } else {
      // Fall back to old format
      const res2 = await getSupa().auth.signInWithPassword({email:emailOld, password:p});
      if(!res2.error){
        authData = res2.data;
      } else {
        authErr = res2.error;
      }
    }

    if(authErr || !authData){
      recordFailedLogin(u);
      showLoginErr('Invalid username or password.');
      return;
    }
    // Step 2: Fetch app_users row (RLS: only own company visible)
    const {data:userRow,error:rowErr}=await getSupa().from('app_users')
      .select('*').eq('username',u.toLowerCase()).maybeSingle();
    if(rowErr||!userRow){
      await getSupa().auth.signOut();
      showLoginErr('User account not found. Contact your admin.');
      return;
    }
    // Step 3: Confirm correct company selected
    if(userRow.company_id!==_selectedCompanyId){
      await getSupa().auth.signOut();
      recordFailedLogin(u);
      showLoginErr('This user belongs to a different company. Please select the correct company.');
      return;
    }
    clearFailedLogins(u);
    await doLoginSuccess(rowToUser(userRow), _selectedCompanyId);
  }catch(e){
    console.error('Login error:',e);
    showLoginErr('Connection error: '+(e.message||'Could not reach server. Check internet.'));
  }finally{
    if(btn){btn.disabled=false;btn.textContent='Sign In ‚Üí';}
  }
}

async function doLoginSuccess(found,companyId){
  let savedState=null;
  try{savedState=await DB.get('data',companyId);}catch(_){}
  if(savedState){state={...DEFAULT_STATE,...savedState,companyId};}
  else{
    // No app_data row yet ‚Äî use defaults (happens on very first login)
    state={...DEFAULT_STATE,companyId};
    // Fetch company name from registry to populate state
    try{
      const {data:reg}=await getSupa().from('companies_registry')
        .select('name,gstin,fy').eq('company_id',companyId).maybeSingle();
      if(reg){ state.company=reg.name||state.company; state.gstin=reg.gstin||''; state.fy=reg.fy||state.fy; }
    }catch(_){}
  }
  if(state.appUsers)state.appUsers=state.appUsers.filter(x=>x&&x.username);
  state.companyId=companyId;
  currentUser=found;
  _selectedCompanyId=companyId;
  resetSessionTimer();
  setTimeout(()=>logAudit('Login',`User ${found.username} logged in`),100);
  sessionStorage.setItem('loggedInUser',found.username);
  sessionStorage.setItem('companyId',companyId);
  document.getElementById('login-wrap').classList.add('hidden');
  document.getElementById('co-select-wrap').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  const rl=found.role==='admin'?'üëë':found.role==='accountant'?'üìä':'üëÅ';
  document.getElementById('usr-btn').textContent=`${rl} ${found.username} ‚ñæ`;
  document.getElementById('sb-company').textContent=state.company||'My Company';
  document.getElementById('sb-fy').textContent='FY '+(state.fy||'2025-26');
  document.getElementById('top-fy').textContent='FY '+(state.fy||'2025-26');
  applyRoleRestrictions(found.role);
  updateCompanySwitcherBtn();
  navigate('dashboard');
}

function applyRoleRestrictions(role){
  const umNav=document.getElementById('nav-usermgmt');
  if(umNav)umNav.style.display=(role==='admin'?'':'none');
  const stNav=document.getElementById('nav-settings');
  if(stNav&&role==='viewer')stNav.style.display='none';
  const vNav=document.getElementById('nav-vouchers');
  if(vNav&&role==='viewer')vNav.style.opacity='0.4';
}
function canEdit(){
  if(!currentUser)return false;
  return currentUser.role==='admin'||currentUser.role==='accountant';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NEW COMPANY WIZARD (3-Step)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _ncData={};
function openNewCoWizard(){
  const ovl=document.getElementById('new-co-overlay');
  ovl.classList.remove('hidden');
  ovl.style.display='flex';
  const fyList=generateFYList();
  const now=new Date();
  const fyDefault=now.getMonth()>=3?`${now.getFullYear()}-${String(now.getFullYear()+1).slice(2)}`:`${now.getFullYear()-1}-${String(now.getFullYear()).slice(2)}`;
  const ncFy=document.getElementById('nc-fy');
  if(ncFy)ncFy.innerHTML=fyList.map(f=>`<option value="${f}" ${f===fyDefault?'selected':''} style="background:#1e293b;">${f}</option>`).join('');
  ncShowStep(1);
}
function closeNewCoWizard(){
  const ovl=document.getElementById('new-co-overlay');
  ovl.classList.add('hidden');
  ovl.style.display='none';
  _ncData={};
}
function ncShowStep(n){
  [1,2,3].forEach(i=>{
    const s=document.getElementById('nc-step-'+i);
    if(s)s.classList.toggle('active',i===n);
    const d=document.getElementById('sdot-'+i);
    if(d)d.className='step-dot'+(i<n?' done':i===n?' active':'');
  });
}
function ncNext(from){
  if(from===1){
    const name=(document.getElementById('nc-name')?.value||'').trim();
    if(!name){showAlert('Company name is required.');return;}
    _ncData.name=name;
    _ncData.gstin=(document.getElementById('nc-gstin')?.value||'').toUpperCase().trim();
    _ncData.state=document.getElementById('nc-state')?.value||'Maharashtra';
    _ncData.fy=document.getElementById('nc-fy')?.value||'2025-26';
    _ncData.tan=(document.getElementById('nc-tan')?.value||'').toUpperCase().trim();
    ncShowStep(2);
  } else if(from===2){
    const u=(document.getElementById('nc-user')?.value||'').trim();
    const p=document.getElementById('nc-pass')?.value||'';
    const p2=document.getElementById('nc-pass2')?.value||'';
    if(!u){showAlert('Admin username required.');return;}
    if(!p||p.length<6){showAlert('Password must be at least 6 characters.');return;}
    if(p!==p2){showAlert('Passwords do not match.');return;}
    _ncData.username=u;_ncData.password=p;
    const mob=(document.getElementById('nc-mobile')?.value||'').trim();
    if(!mob){showAlert('Mobile number is required for OTP password reset.');return;}
    _ncData.mobile=mob;
    ncShowStep(3);
  }
}
function ncBack(from){ncShowStep(from-1);}

async function doCreateCompany(){
  const method=document.getElementById('nc-method')?.value||'mercantile';
  const currency=document.getElementById('nc-currency')?.value||'INR';
  const loadSample=document.getElementById('nc-sample')?.value==='yes';
  const btn=document.getElementById('nc-create-btn');
  const errEl=document.getElementById('nc-error');
  if(btn){btn.disabled=true;btn.textContent='Creating‚Ä¶';}
  if(errEl)errEl.style.display='none';

  const companyId='C'+Date.now().toString(36).toUpperCase().slice(-6);
  const username=_ncData.username.toLowerCase();
  const email=username+'_'+companyId.toLowerCase()+'@accountally.app';
  let authUserId=null;

  try{
    // ‚îÄ‚îÄ Step 1: Supabase Auth signup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Store phone in Supabase Auth user_metadata (used for OTP reset)
    const rawMobile=(_ncData.mobile||'').trim();
    const phoneE164=rawMobile&&!rawMobile.startsWith('+')?'+91'+rawMobile.replace(/^0/,''):rawMobile;
    const {data:authData,error:authErr}=await getSupa().auth.signUp({
      email, password:_ncData.password,
      options:{ data:{ mobile: phoneE164 } }
    });

    if(authErr){
      // If email already registered ‚Äî sign in to get existing user_id
      // (happens when a previous creation attempt partially failed)
      if(authErr.message.includes('already registered') || authErr.message.includes('already been registered')){
        const {data:signinData,error:signinErr}=await getSupa().auth.signInWithPassword({email,password:_ncData.password});
        if(signinErr) throw new Error('Username already exists and password is wrong. Use a different username or the correct password.');
        authUserId=signinData.user.id;
        // Check if this user already has a company
        const {data:existingUser}=await getSupa().from('app_users').select('company_id').eq('user_id',authUserId).maybeSingle();
        if(existingUser) throw new Error('Username "'+username+'" already exists with another company. Please use a different username.');
      } else {
        throw new Error('Auth signup failed: '+authErr.message);
      }
    } else {
      if(!authData.user) throw new Error('Signup failed ‚Äî go to Supabase ‚Üí Auth ‚Üí Settings ‚Üí Email and turn OFF "Enable email confirmations".');
      authUserId=authData.user.id;
      // Set session immediately so RLS passes on next inserts
      if(authData.session) await getSupa().auth.setSession(authData.session);
    }

    // ‚îÄ‚îÄ Step 2: Insert companies_registry FIRST (FK parent) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const {error:regErr}=await getSupa().from('companies_registry').upsert(
      {company_id:companyId, name:_ncData.name, gstin:_ncData.gstin||'', fy:_ncData.fy||'2025-26'},
      {onConflict:'company_id'}
    );
    if(regErr) throw new Error('Could not create company: '+regErr.message);

    // ‚îÄ‚îÄ Step 3: Insert app_users (FK child) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const mobile=(_ncData.mobile||'').trim();
    const {error:userErr}=await getSupa().from('app_users').insert({
      username: username,
      user_id: authUserId,
      company_id: companyId,
      role: 'admin',
      mobile: mobile
    });
    if(userErr){
      // Rollback: remove company we just created
      await getSupa().from('companies_registry').delete().eq('company_id',companyId);
      throw new Error('Could not save user profile: '+userErr.message);
    }

    // ‚îÄ‚îÄ Step 4: Build and save company state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const fyParts=(_ncData.fy||'2025-26').split('-');
    const fyYear=parseInt(fyParts[0]);
    const ns=JSON.parse(JSON.stringify(DEFAULT_STATE));
    ns.company=_ncData.name; ns.gstin=_ncData.gstin||''; ns.companyState=_ncData.state||'Maharashtra';
    ns.fy=_ncData.fy; ns.fyStart=`${fyYear}-04-01`; ns.fyEnd=`${fyYear+1}-03-31`;
    ns.tan=_ncData.tan||''; ns.currency=currency; ns.accountingMethod=method; ns.companyId=companyId;
    ns.appUsers=[{username,role:'admin',fullName:username,createdAt:new Date().toISOString()}];
    if(loadSample)injectSampleData(ns);
    state=ns;
    _selectedCompanyId=companyId;
    sessionStorage.setItem('companyId',companyId);
    sessionStorage.setItem('loggedInUser',username);
    await saveState();

    // ‚îÄ‚îÄ Step 5: Set current user and launch app ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    currentUser={id:companyId+'_u1',username,passwordHash:'',role:'admin',companyId};
    const cname=_ncData.name;
    closeNewCoWizard();
    document.getElementById('co-select-wrap').classList.add('hidden');
    document.getElementById('login-wrap').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('usr-btn').textContent=`üëë ${username} ‚ñæ`;
    document.getElementById('sb-company').textContent=state.company;
    document.getElementById('sb-fy').textContent='FY '+state.fy;
    document.getElementById('top-fy').textContent='FY '+state.fy;
    resetSessionTimer();
    applyRoleRestrictions('admin');
    updateCompanySwitcherBtn();
    _ncData={};
    logAudit('Company Created',`Company: ${cname}`);
    showToast(`üè¢ "${cname}" created & loaded!`,'#059669');
    navigate('dashboard');

  }catch(e){
    console.error('Create company error:',e);
    if(errEl){errEl.textContent='‚ùå '+e.message;errEl.style.display='block';}
  }finally{
    if(btn){btn.disabled=false;btn.textContent='üè¢ Create Company & Sign In ‚Üí';}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COMPANY SWITCHER (in-app ‚Äî admin/accountant only)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCompanySwitcherBtn(){
  const btn=document.getElementById('co-switch-btn');
  const lbl=document.getElementById('co-switch-label');
  if(!btn||!lbl)return;
  btn.style.display=canEdit()?'inline-flex':'none';
  const nm=state.company||'Company';
  lbl.textContent=nm.length>16?nm.substring(0,14)+'‚Ä¶':nm;
}

async function showCompanySwitcher(){
  if(!canEdit()){showToast('Only Admin/Accountant can switch companies.','#dc2626');return;}
  let companies=await getCompanyRegistry();
  if(!companies||companies.length<=1){
    openModal('üîÑ Switch Company',`
      <div style="text-align:center;padding:20px 0 10px;">
        <div style="font-size:36px;margin-bottom:10px;">üè¢</div>
        <div style="font-weight:700;margin-bottom:6px;">Only one company registered</div>
        <div style="font-size:12px;color:var(--tm);margin-bottom:20px;">Create additional companies to enable switching</div>
        <button class="btn btn-p" onclick="closeModal();openNewCoWizard()">‚ûï Create New Company</button>
      </div>`);
    return;
  }
  const rows=companies.map((co,i)=>`
    <div style="display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:10px;border:1.5px solid ${co.companyId===state.companyId?'#2563eb':'var(--bdr)'};background:${co.companyId===state.companyId?'#eff6ff':'#f8fafc'};margin-bottom:8px;">
      <div style="font-size:22px;cursor:pointer;" onclick="switchToCompany('${co.companyId}')">${CO_ICONS[i%CO_ICONS.length]}</div>
      <div style="flex:1;min-width:0;cursor:pointer;" onclick="switchToCompany('${co.companyId}')">
        <div style="font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${co.name}</div>
        <div style="font-size:10px;color:var(--tm);">${co.gstin||'GSTIN not set'} ¬∑ FY ${co.fy}</div>
      </div>
      ${co.companyId===state.companyId
        ? '<span style="font-size:11px;font-weight:700;color:#2563eb;white-space:nowrap;">‚úì Active</span>'
        : `<div style="display:flex;gap:6px;">
            <span style="font-size:11px;color:var(--tl);white-space:nowrap;cursor:pointer;padding:4px 8px;border-radius:6px;background:#f1f5f9;" onclick="switchToCompany('${co.companyId}')">Switch ‚Üí</span>
            ${currentUser?.role==='admin'?`<span style="font-size:11px;color:#dc2626;white-space:nowrap;cursor:pointer;padding:4px 8px;border-radius:6px;background:#fef2f2;" onclick="closeModal();confirmDeleteCompany('${co.companyId}','${(co.name||'').replace(/'/g,"\\'")}')">üóë</span>`:''}
           </div>`
      }
    </div>`).join('');
  openModal('üîÑ Switch Company',`
    <div style="font-size:12px;color:var(--tm);margin-bottom:12px;">Current session saved automatically before switching.</div>
    ${rows}
    <button class="btn btn-p" style="width:100%;margin-top:4px;" onclick="closeModal();openNewCoWizard()">‚ûï Create New Company</button>
  `);
}

async function switchToCompany(companyId){
  if(companyId===state.companyId){closeModal();showToast('Already on this company.','#d97706');return;}
  closeModal();
  await saveState();
  try{
    const newSt=await DB.get('data',companyId);
    if(!newSt){showToast('Could not load company data.','#dc2626');return;}
    state={...DEFAULT_STATE,...newSt};
    _selectedCompanyId=companyId;
    sessionStorage.setItem('companyId',companyId);
    document.getElementById('sb-company').textContent=state.company;
    document.getElementById('sb-fy').textContent='FY '+state.fy;
    document.getElementById('top-fy').textContent='FY '+state.fy;
    updateCompanySwitcherBtn();
    showToast(`üîÑ Switched to ${state.company}`,'#2563eb');
    navigate('dashboard');
  }catch(e){showToast('Switch error: '+e.message,'#dc2626');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DELETE COMPANY (Admin only)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function confirmDeleteCompany(companyId, companyName){
  if(currentUser?.role !== 'admin'){
    showToast('Only admins can delete a company.','#dc2626'); return;
  }
  openModal('üóë Delete Company', `
    <div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:10px;padding:14px 16px;margin-bottom:16px;">
      <div style="font-size:13px;font-weight:700;color:#991b1b;margin-bottom:6px;">‚ö†Ô∏è This is permanent and cannot be undone!</div>
      <div style="font-size:12px;color:#7f1d1d;">This will permanently delete:</div>
      <ul style="font-size:12px;color:#7f1d1d;margin:6px 0 0 16px;line-height:1.8;">
        <li>All accounting data (vouchers, accounts, invoices)</li>
        <li>All users belonging to this company</li>
        <li>The company registration</li>
      </ul>
    </div>
    <div style="font-size:13px;margin-bottom:10px;">Type <strong>${companyName}</strong> to confirm:</div>
    <input class="fc" id="del-co-confirm" placeholder="Type company name exactly..." style="margin-bottom:14px;">
    <div id="del-co-err" style="color:#dc2626;font-size:12px;margin-bottom:10px;display:none;"></div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-d" style="flex:1;" onclick="executeDeleteCompany('${companyId}','${companyName.replace(/'/g,"\'")}')">üóë Delete Permanently</button>
      <button class="btn btn-g" onclick="closeModal()">Cancel</button>
    </div>
  `);
}

async function executeDeleteCompany(companyId, companyName){
  const typed = document.getElementById('del-co-confirm')?.value?.trim();
  const errEl = document.getElementById('del-co-err');
  if(typed !== companyName){
    if(errEl){errEl.textContent='Company name does not match. Please type it exactly.';errEl.style.display='block';}
    return;
  }
  const btn = document.querySelector('#modal .btn-d');
  if(btn){btn.disabled=true;btn.textContent='Deleting‚Ä¶';}
  try{
    const isCurrentCompany = companyId === state.companyId;
    // Step 1: Delete app_data
    await getSupa().from('app_data').delete().eq('id', companyId);
    // Step 2: Delete app_users (cascade would handle this but be explicit)
    await getSupa().from('app_users').delete().eq('company_id', companyId);
    // Step 3: Delete companies_registry
    const {error} = await getSupa().from('companies_registry').delete().eq('company_id', companyId);
    if(error) throw new Error('Could not delete company: ' + error.message);

    closeModal();
    logAudit('Company Deleted', 'Company: ' + companyName);
    showToast('üóë Company "' + companyName + '" deleted.', '#dc2626');

    if(isCurrentCompany){
      // Deleted current company ‚Äî sign out and go back to company select
      await getSupa().auth.signOut();
      currentUser = null; _selectedCompanyId = null;
      sessionStorage.clear();
      document.getElementById('app').classList.add('hidden');
      setTimeout(()=>showCompanySelectScreen(), 800);
    } else {
      // Deleted a different company ‚Äî refresh switcher
      navigate('settings');
    }
  }catch(e){
    if(btn){btn.disabled=false;btn.textContent='üóë Delete Permanently';}
    const errEl2 = document.getElementById('del-co-err');
    if(errEl2){errEl2.textContent='Error: '+e.message;errEl2.style.display='block';}
    console.error('Delete company error:',e);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USER MENU & LOGOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showLoginErr(msg){
  const el=document.getElementById('login-err');
  if(!el)return;
  el.textContent=msg;el.style.display='block';
  if(showLoginErr._timer)clearTimeout(showLoginErr._timer);
  showLoginErr._timer=setTimeout(()=>{el.style.display='none';showLoginErr._timer=null;},7000);
  // Show remaining attempts warning
  const lockEl=document.getElementById('login-lockout');
  if(lockEl){
    const u=document.getElementById('li-user')?.value.trim().toLowerCase();
    if(u&&_loginAttempts[u]&&!_loginAttempts[u].lockedUntil){
      const left=MAX_ATTEMPTS-(_loginAttempts[u]?.count||0);
      if(left>0&&left<=3){
        lockEl.textContent=`‚ö†Ô∏è Warning: ${left} attempt${left>1?'s':''} remaining before account lockout.`;
        lockEl.style.display='block';
        setTimeout(()=>lockEl.style.display='none',7000);
      }
    }
  }
}

function showUserMenu(){
  const roleInfo={admin:'üëë Admin',accountant:'üìä Accountant',viewer:'üëÅ Viewer'};
  const roleIcon=currentUser?.role==='admin'?'üëë':currentUser?.role==='accountant'?'üìä':'üëÅ';
  const isAdmin=currentUser?.role==='admin';
  const canEd=canEdit();
  let btns='';
  if(isAdmin) btns+=`<button class="btn btn-g" style="justify-content:flex-start;" onclick="closeModal();navigate('settings')">‚öôÔ∏è Settings</button>`;
  if(isAdmin) btns+=`<button class="btn btn-g" style="justify-content:flex-start;" onclick="closeModal();navigate('usermgmt')">üîê User Management</button>`;
  if(canEd)   btns+=`<button class="btn btn-g" style="justify-content:flex-start;" onclick="closeModal();openNewCoWizard()">üè¢ Create New Company</button>`;
  if(canEd)   btns+=`<button class="btn btn-g" style="justify-content:flex-start;" onclick="closeModal();showCompanySwitcher()">üîÑ Switch Company</button>`;
  btns+=`<button class="btn btn-d" style="justify-content:flex-start;" onclick="doLogout()">üö™ Logout</button>`;
  openModal('User Menu',`
    <div style="text-align:center;padding:10px 0 16px;">
      <div style="font-size:32px;">${roleIcon}</div>
      <div style="font-weight:700;font-size:16px;margin-top:6px;">${currentUser?.username||''}</div>
      <div style="color:var(--tm);font-size:12px;">${roleInfo[currentUser?.role]||'User'}</div>
      <div style="color:var(--tl);font-size:11px;margin-top:3px;">üìÅ ${state.company}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;">${btns}</div>
  `);
}
async function doLogout(){
  closeModal();
  clearTimeout(_sessionTimer);

  // ‚îÄ‚îÄ Step 1: Clear UI immediately ‚Äî never block on network ‚îÄ‚îÄ
  const username = currentUser?.username||'?';
  currentUser = null;
  _selectedCompanyId = null;
  sessionStorage.removeItem('loggedInUser');
  sessionStorage.removeItem('companyId');
  document.getElementById('app').classList.add('hidden');
  document.getElementById('login-wrap').classList.add('hidden');
  showCompanySelectScreen();

  // ‚îÄ‚îÄ Step 2: Background cleanup (non-blocking) ‚îÄ‚îÄ
  try{ logAudit('Logout', 'User '+username+' logged out'); }catch(_){}
  try{ await Promise.race([saveState(), new Promise(r=>setTimeout(r,3000))]); }catch(_){}
  try{ await getSupa().auth.signOut(); }catch(_){}
}


// ‚ïê‚ïê STATE & STORAGE ‚ïê‚ïê
let state=JSON.parse(JSON.stringify(DEFAULT_STATE));
let saveTimer=null;

async function saveState(){
  try{
    // Use companyId as key so each company has its OWN isolated row
    const key = state.companyId || 'state';
    await DB.set('data', key, state);
    setSaveInd('ok');
  }catch(e){console.error('Save error',e);setSaveInd('err');}
}
function scheduleSave(){
  setSaveInd('saving');
  clearTimeout(saveTimer);
  saveTimer=setTimeout(saveState,600);
}
function setSaveInd(s){
  const el=document.getElementById('save-ind');
  if(!el)return;
  if(s==='ok'){el.className='save-status save-ok';el.textContent='‚úì Saved to Cloud';}
  else if(s==='saving'){el.className='save-status save-ing';el.textContent='‚è≥ Saving...';}
  else{el.className='save-status';el.textContent='‚ö† Save error';}
}

// ‚ïê‚ïê HELPERS ‚ïê‚ïê
const fmt=n=>'‚Çπ'+Number(n||0).toLocaleString('en-IN',{maximumFractionDigits:2});
const fmtN=n=>Number(n||0).toLocaleString('en-IN',{maximumFractionDigits:2});
const today=()=>new Date().toISOString().slice(0,10);
const fmtD=d=>d?new Date(d+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}):'‚Äî';
const daysLeft=d=>{if(!d)return null;return Math.ceil((new Date(d)-new Date())/86400000);};
const aN=id=>(state.accounts.find(a=>a.id===id)||{name:id}).name;
const vN=id=>(state.vendors.find(v=>v.id===id)||{name:'‚Äî'}).name;
const dbN=id=>(state.debtors.find(d=>d.id===id)||{name:'‚Äî'}).name;
function partyName(v){
  if(!v.partyId)return '‚Äî';
  if(['Sales','Debit Note','Receipt'].includes(v.type))return dbN(v.partyId);
  return vN(v.partyId);
}

function generateFYList(){
  const now=new Date();
  const base=now.getMonth()>=3?now.getFullYear():now.getFullYear()-1;
  const list=[];
  for(let y=base-4;y<=base+6;y++) list.push(`${y}-${String(y+1).slice(2)}`);
  return list;
}
function fyRange(fy){
  const y=parseInt(fy);
  return {start:`${y}-04-01`,end:`${y+1}-03-31`};
}

function bcol(type){
  const m={Asset:'bb',Liability:'br',Income:'bg-',Expense:'by',Capital:'bp',
           Receipt:'bg-',Payment:'br',Sales:'bb',Purchase:'bo',Journal:'bp',
           Contra:'bgr','Debit Note':'by','Credit Note':'br'};
  return m[type]||'bgr';
}

function computeLedger(){
  const L={};
  state.accounts.forEach(a=>{L[a.id]={...a,txns:[]};});
  state.vouchers.forEach(v=>{
    v.entries.forEach(e=>{
      if(L[e.accId]) L[e.accId].txns.push({...e,date:v.date,narration:v.narration,vno:v.id,vtype:v.type});
    });
  });
  Object.values(L).forEach(a=>{
    const txD=a.txns.reduce((s,t)=>s+(t.dr||0),0);
    const txC=a.txns.reduce((s,t)=>s+(t.cr||0),0);
    const opD=a.nature==='Dr'?a.balance:0, opC=a.nature==='Cr'?a.balance:0;
    a.totalDr=opD+txD; a.totalCr=opC+txC;
    const net=a.totalDr-a.totalCr;
    a.closingDr=net>0?net:0; a.closingCr=net<0?Math.abs(net):0;
  });
  return L;
}

// ‚ïê‚ïê NAVIGATION ‚ïê‚ïê
const PTITLES={dashboard:'üè† Dashboard',accounts:'üìã Chart of Accounts',items:'üì¶ Item Master (HSN / SAC)',
  vendors:'üè≠ Vendors / Suppliers',debtors:'ü§ù Customers / Debtors',vouchers:'üìù Voucher Entry',
  advances:'üí∞ Advance Payments',daybook:'üìÖ Day Book',cashbook:'üíµ Cash Book',ledger:'üìñ Ledger',
  bankrecon:'üè¶ Bank Reconciliation',trial:'‚öñÔ∏è Trial Balance',pnl:'üìä Profit & Loss',
  balance:'üèó Balance Sheet',cashflow:'üí∏ Cash Flow Statement (AS-3)',gst:'üßæ GST Reports',
  tds:'üìë TDS Reports',import:'üîÑ Excel Import / Export',settings:'‚öôÔ∏è Settings',
  'reg-sales':'üßæ Sales Register','reg-purchase':'üõí Purchase Register',
  'reg-debit':'üì§ Debit Note Register','reg-credit':'üì• Credit Note Register',
  'reg-journal':'üìì Journal Register',
  invoice:'üßæ GST Invoice Generator',employees:'üë• Employee Master',
  payroll:'üíº Payroll Processing',usermgmt:'üîê User Management',
  outstanding:'üî¥ Party-wise Outstanding Report',
  gstr1:'üìã GSTR-1 Return',gstr3b:'üìä GSTR-3B Return',
  einvoice:'üîê E-Invoice (IRN) Generator',audittrail:'üïµÔ∏è Audit Trail'};

function navigate(page){
  if(typeof destroyDashCharts==='function') destroyDashCharts();
  document.querySelectorAll('.ni').forEach(el=>el.classList.remove('act'));
  const n=document.getElementById('nav-'+page);
  if(n)n.classList.add('act');
  document.getElementById('pg-title').textContent=PTITLES[page]||page;
  const pages={dashboard:pgDashboard,accounts:pgAccounts,items:pgItems,vendors:pgVendors,debtors:pgDebtors,
    vouchers:pgVouchers,advances:pgAdvances,daybook:pgDayBook,cashbook:pgCashBook,ledger:pgLedger,
    bankrecon:pgBankRecon,trial:pgTrial,pnl:pgPnL,balance:pgBalance,cashflow:pgCashFlow,
    gst:pgGST,tds:pgTDS,import:pgImport,settings:pgSettings,
    invoice:pgInvoice,employees:pgEmployees,payroll:pgPayroll,usermgmt:pgUserMgmt,outstanding:pgOutstanding,
    'reg-sales':()=>pgRegister('Sales'),'reg-purchase':()=>pgRegister('Purchase'),
    'reg-debit':()=>pgRegister('Debit Note'),'reg-credit':()=>pgRegister('Credit Note'),
    'reg-journal':()=>pgRegister('Journal'),
    gstr1:pgGSTR1,gstr3b:pgGSTR3B,einvoice:pgEInvoice,audittrail:pgAuditTrail};
  (pages[page]||function(){})();
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('col');}
function openModal(title,html){
  document.getElementById('mtitle').textContent=title;
  document.getElementById('mbody').innerHTML=html;
  document.getElementById('modal').classList.remove('hidden');
}
function closeModal(){document.getElementById('modal').classList.add('hidden');}
function eid(id){return document.getElementById(id);}
function refocusSearch(id){const el=document.getElementById(id);if(el){const len=el.value.length;el.focus();el.setSelectionRange(len,len);}}
function showToast(msg,color='#059669'){
  const t=document.createElement('div');
  t.style.cssText=`position:fixed;bottom:24px;right:24px;background:${color};color:#fff;padding:12px 20px;border-radius:12px;font-size:13px;font-weight:700;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.2);animation:fadeInUp .3s ease;`;
  t.innerHTML=msg;document.body.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .4s';setTimeout(()=>t.remove(),400);},3000);
}
function showAlert(msg){ showToast('‚ö†Ô∏è '+msg,'#dc2626'); }
function exportXLS(data,sheet,file){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(data);
  const cols=data[0]?.map((_,ci)=>({wch:Math.max(...data.map(r=>String(r[ci]||'').length))+3}));
  if(cols)ws['!cols']=cols;
  XLSX.utils.book_append_sheet(wb,ws,sheet);
  XLSX.writeFile(wb,file);
}
function exportMultiXLS(sheets,file){
  const wb=XLSX.utils.book_new();
  sheets.forEach(({data,name})=>{
    const ws=XLSX.utils.aoa_to_sheet(data);
    const cols=data[0]?.map((_,ci)=>({wch:Math.max(...data.map(r=>String(r[ci]||'').length))+3}));
    if(cols)ws['!cols']=cols;
    XLSX.utils.book_append_sheet(wb,ws,name);
  });
  XLSX.writeFile(wb,file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dashFilter='monthly';
let _dashCharts={};

function destroyDashCharts(){
  Object.values(_dashCharts).forEach(c=>{try{c.destroy();}catch(e){}});
  _dashCharts={};
}

function pgDashboard(){
  destroyDashCharts();
  // ‚îÄ‚îÄ FY-filtered computations for KPI cards ‚îÄ‚îÄ
  const fyVouchers=state.vouchers.filter(v=>v.date>=state.fyStart&&v.date<=state.fyEnd);
  const accTypeMap={};state.accounts.forEach(a=>{accTypeMap[a.id]={type:a.type,group:a.group,name:a.name};});
  let totInc=0,totExp=0,cash=0,gstLiab=0,gstCredit=0;
  fyVouchers.forEach(v=>{
    v.entries.forEach(e=>{
      const a=accTypeMap[e.accId]||{};
      if(a.type==='Income') totInc+=(e.cr||0);
      if(a.type==='Expense') totExp+=(e.dr||0);
      if(a.group==='Cash & Bank'){cash+=(e.dr||0);cash-=(e.cr||0);}
      if(a.name&&a.name.includes('Output')) gstLiab+=(e.cr||0);
      if(a.name&&a.name.includes('Input')) gstCredit+=(e.dr||0);
    });
  });
  // Full ledger for balance sheet KPIs (assets/liabilities need all-time data)
  const L=computeLedger();
  const totAssets=Object.values(L).filter(a=>a.type==='Asset').reduce((s,a)=>s+a.closingDr,0);
  const totLiab=Object.values(L).filter(a=>a.type==='Liability').reduce((s,a)=>s+a.closingCr,0);
  const netP=totInc-totExp;
  const netGst=gstLiab-gstCredit;
  const totVouchers=fyVouchers.length;

  const recent=[...fyVouchers].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,8).map((v,i)=>{
    const amt=v.entries.reduce((s,e)=>s+(e.dr||0),0);
    return `<tr class="${i%2?'alt':''}">
      <td class="mono tb-" style="font-size:11px;">${v.id}</td><td style="font-size:11px;">${fmtD(v.date)}</td>
      <td><span class="badge ${bcol(v.type)}">${v.type}</span></td>
      <td class="tm-" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;">${v.narration||'‚Äî'}</td>
      <td class="tr mono" style="font-size:11px;">${fmt(amt)}</td>
    </tr>`;
  }).join('');

  const recv=getReceivables(); const pay=getPayables();

  // Expense breakdown by group
  const expGroups={};
  Object.values(L).filter(a=>a.type==='Expense'&&a.closingDr>0).forEach(a=>{
    expGroups[a.group]=(expGroups[a.group]||0)+a.closingDr;
  });
  const expLabels=Object.keys(expGroups);
  const expVals=Object.values(expGroups);

  // Income breakdown
  const incGroups={};
  Object.values(L).filter(a=>a.type==='Income'&&a.closingCr>0).forEach(a=>{
    incGroups[a.group]=(incGroups[a.group]||0)+a.closingCr;
  });
  const incLabels=Object.keys(incGroups);
  const incVals=Object.values(incGroups);


  // Cash flow trend ‚Äî respects dashFilter (monthly/quarterly/yearly)
  const cfData=[];
  const cfLabels=[];
  // Use account-type lookup: cash inflow = dr on Asset(Cash/Bank), outflow = cr on Asset(Cash/Bank)
  // Simpler: sum net of Receipt vs Payment per period
  const cashBankAccIds=new Set(state.accounts.filter(a=>a.group==='Cash & Bank').map(a=>a.id));
  function cfForPeriod(filterFn){
    let inflow=0,outflow=0;
    state.vouchers.filter(filterFn).forEach(v=>{
      v.entries.forEach(e=>{
        if(cashBankAccIds.has(e.accId)){
          inflow+=(e.dr||0);   // Cash/Bank debited = money coming in
          outflow+=(e.cr||0);  // Cash/Bank credited = money going out
        }
      });
    });
    return inflow-outflow;
  }
  if(dashFilter==='monthly'){
    for(let i=5;i>=0;i--){
      const d=new Date(new Date().getFullYear(),new Date().getMonth()-i,1);
      const yr=d.getFullYear(),mo=String(d.getMonth()+1).padStart(2,'0');
      cfLabels.push(d.toLocaleString('en-IN',{month:'short'})+"'"+String(yr).slice(2));
      cfData.push(cfForPeriod(v=>v.date.startsWith(`${yr}-${mo}`)));
    }
  }else if(dashFilter==='quarterly'){
    const now=new Date();
    for(let i=3;i>=0;i--){
      const d=new Date(now.getFullYear(),now.getMonth()-i*3,1);
      const yr=d.getFullYear(),qm=Math.floor(d.getMonth()/3);
      const months=[(qm*3),(qm*3)+1,(qm*3)+2].map(m=>String(m+1).padStart(2,'0'));
      cfLabels.push(`Q${qm+1}'${String(yr).slice(2)}`);
      cfData.push(cfForPeriod(v=>months.some(m=>v.date.startsWith(`${yr}-${m}`))));
    }
  }else{
    const yr=new Date().getFullYear();
    for(let y=yr-2;y<=yr;y++){
      cfLabels.push(String(y));
      cfData.push(cfForPeriod(v=>v.date.startsWith(String(y))));
    }
  }

  const profitPct=totInc>0?((netP/totInc)*100).toFixed(1):0;

  eid('content').innerHTML=`
  <style>
  .dash-kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;}
  .kpi-card{border-radius:14px;padding:16px 18px;color:#fff;position:relative;overflow:hidden;cursor:default;transition:transform .15s,box-shadow .15s;}
  .kpi-card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.15);}
  .kpi-card::before{content:'';position:absolute;right:-15px;top:-15px;width:90px;height:90px;background:rgba(255,255,255,.08);border-radius:50%;}
  .kpi-card::after{content:'';position:absolute;right:10px;bottom:-20px;width:60px;height:60px;background:rgba(255,255,255,.05);border-radius:50%;}
  .kpi-icon{font-size:22px;margin-bottom:8px;display:block;position:relative;z-index:1;}
  .kpi-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;opacity:.8;position:relative;z-index:1;}
  .kpi-val{font-size:19px;font-weight:800;margin-top:5px;font-family:'IBM Plex Mono',monospace;position:relative;z-index:1;letter-spacing:-0.5px;}
  .kpi-sub{font-size:10px;opacity:.65;margin-top:3px;position:relative;z-index:1;}
  .kpi-trend{font-size:10px;margin-top:4px;font-weight:700;position:relative;z-index:1;}
  .kpi-b{background:linear-gradient(135deg,#1d4ed8,#3b82f6);}
  .kpi-g{background:linear-gradient(135deg,#047857,#10b981);}
  .kpi-r{background:linear-gradient(135deg,#b91c1c,#ef4444);}
  .kpi-p{background:linear-gradient(135deg,#6d28d9,#a78bfa);}
  .kpi-o{background:linear-gradient(135deg,#b45309,#f59e0b);}
  .kpi-t{background:linear-gradient(135deg,#0f766e,#2dd4bf);}
  .dash-charts-row{display:grid;grid-template-columns:1.6fr 1fr;gap:14px;margin-bottom:14px;}
  .dash-charts-row2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
  .chart-card{background:#fff;border:1px solid var(--bdr);border-radius:14px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.05);}
  .chart-card-hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--bdr);background:#f8fafc;}
  .chart-card-title{font-size:12px;font-weight:700;color:#0f172a;}
  .chart-card-body{padding:14px;}
  .dash-bottom{display:grid;grid-template-columns:1.3fr 1fr;gap:14px;margin-bottom:14px;}
  .qa-modern{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:20px;}
  .qa-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:13px 8px;border-radius:12px;border:1.5px solid;cursor:pointer;background:none;font-family:var(--font);transition:all .18s;}
  .qa-btn:hover{transform:translateY(-3px);box-shadow:0 6px 18px rgba(0,0,0,.12);}
  .qa-icon{font-size:22px;line-height:1;}
  .qa-lbl{font-size:10px;font-weight:700;text-align:center;line-height:1.3;}
  .dash-section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--tm);margin-bottom:10px;}
  .profit-indicator{display:flex;align-items:center;gap:8px;}
  .profit-bar-wrap{flex:1;background:#e2e8f0;border-radius:20px;height:6px;overflow:hidden;}
  .profit-bar-fill{height:100%;border-radius:20px;transition:width .6s ease;}
  </style>

  <div style="background:linear-gradient(135deg,#0f172a 0%,#1e3a6e 60%,#0b4a6e 100%);border-radius:16px;padding:18px 24px;color:#fff;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;box-shadow:0 4px 20px rgba(15,23,42,.3);">
    <div>
      <div style="font-size:22px;font-weight:800;letter-spacing:-0.5px;">${state.company}</div>
      <div style="color:#93c5fd;font-size:12px;margin-top:5px;display:flex;gap:10px;flex-wrap:wrap;">
        <span>üìÖ FY ${state.fy}</span>
        <span>¬∑</span><span>${fmtD(state.fyStart)} ‚Äî ${fmtD(state.fyEnd)}</span>
        ${state.gstin?'<span>¬∑</span><span>GSTIN: <strong>'+state.gstin+'</strong></span>':''}
        ${state.companyState?'<span>¬∑</span><span>'+state.companyState+'</span>':''}
      </div>
    </div>
    <div style="text-align:right;">
      <div style="font-size:13px;color:#bfdbfe;font-weight:600;">${fmtD(today())}</div>
      <div style="font-size:11px;color:#64748b;margin-top:3px;">${totVouchers} vouchers recorded</div>
      ${!state.gstin?'<div style="font-size:10px;color:#fbbf24;margin-top:3px;">‚ö† Set GSTIN in Settings</div>':''}
    </div>
  </div>

  <div class="dash-kpi">
    <div class="kpi-card kpi-b">
      <span class="kpi-icon">üí∞</span>
      <div class="kpi-lbl">Total Income</div>
      <div class="kpi-val">${fmt(totInc)}</div>
      <div class="kpi-sub">This financial year</div>
    </div>
    <div class="kpi-card kpi-r">
      <span class="kpi-icon">üì§</span>
      <div class="kpi-lbl">Total Expenses</div>
      <div class="kpi-val">${fmt(totExp)}</div>
      <div class="kpi-sub">This financial year</div>
    </div>
    <div class="kpi-card ${netP>=0?'kpi-g':'kpi-r'}">
      <span class="kpi-icon">${netP>=0?'üìà':'üìâ'}</span>
      <div class="kpi-lbl">Net ${netP>=0?'Profit':'Loss'}</div>
      <div class="kpi-val">${fmt(Math.abs(netP))}</div>
      <div class="kpi-trend">${profitPct}% margin</div>
    </div>
    <div class="kpi-card kpi-p">
      <span class="kpi-icon">üè¶</span>
      <div class="kpi-lbl">Cash & Bank</div>
      <div class="kpi-val">${fmt(cash)}</div>
      <div class="kpi-sub">Liquid balance</div>
    </div>
    <div class="kpi-card ${netGst>=0?'kpi-o':'kpi-t'}">
      <span class="kpi-icon">üßæ</span>
      <div class="kpi-lbl">GST ${netGst>=0?'Payable':'Credit'}</div>
      <div class="kpi-val">${fmt(Math.abs(netGst))}</div>
      <div class="kpi-sub">${netGst>=0?'Net liability':'Input credit'}</div>
    </div>
  </div>

  <div class="dash-section-title">üìä Financial Charts</div>
  <div class="dash-charts-row">
    <div class="chart-card">
      <div class="chart-card-hdr">
        <span class="chart-card-title">üìä Revenue vs Expenses</span>
        <div class="tg">
          <button class="t ${dashFilter==='monthly'?'act':''}" onclick="dashFilter='monthly';pgDashboard()">Monthly</button>
          <button class="t ${dashFilter==='quarterly'?'act':''}" onclick="dashFilter='quarterly';pgDashboard()">Quarterly</button>
          <button class="t ${dashFilter==='yearly'?'act':''}" onclick="dashFilter='yearly';pgDashboard()">Yearly</button>
        </div>
      </div>
      <div class="chart-card-body"><canvas id="ch-rev" height="170"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-card-hdr">
        <span class="chart-card-title">üç© Expense Breakdown</span>
      </div>
      <div class="chart-card-body" style="display:flex;align-items:center;justify-content:center;"><canvas id="ch-exp" height="180" width="280"></canvas></div>
    </div>
  </div>

  <div class="dash-charts-row2">
    <div class="chart-card">
      <div class="chart-card-hdr">
        <span class="chart-card-title">üìà Cash Flow Trend (${dashFilter==="monthly"?"6 Months":dashFilter==="quarterly"?"4 Quarters":"3 Years"})</span>
      </div>
      <div class="chart-card-body"><canvas id="ch-cf" height="150"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-card-hdr">
        <span class="chart-card-title">ü•ß Income Breakdown</span>
      </div>
      <div class="chart-card-body" style="display:flex;align-items:center;justify-content:center;"><canvas id="ch-inc" height="150" width="280"></canvas></div>
    </div>
  </div>

  <div class="dash-section-title">‚ö° Quick Actions</div>
  <div class="qa-modern">
    <button class="qa-btn q1" onclick="navigate('vouchers')"><span class="qa-icon">üìù</span><span class="qa-lbl">New Voucher</span></button>
    <button class="qa-btn q3" onclick="navigate('trial')"><span class="qa-icon">‚öñÔ∏è</span><span class="qa-lbl">Trial Balance</span></button>
    <button class="qa-btn q4" onclick="navigate('pnl')"><span class="qa-icon">üìä</span><span class="qa-lbl">P & L</span></button>
    <button class="qa-btn q5" onclick="navigate('balance')"><span class="qa-icon">üèó</span><span class="qa-lbl">Balance Sheet</span></button>
    <button class="qa-btn q6" onclick="navigate('gst')"><span class="qa-icon">üßæ</span><span class="qa-lbl">GST Reports</span></button>
    <button class="qa-btn q2" onclick="navigate('items')"><span class="qa-icon">üì¶</span><span class="qa-lbl">Item Master</span></button>
    <button class="qa-btn q7" onclick="navigate('vendors')"><span class="qa-icon">üè≠</span><span class="qa-lbl">Vendors</span></button>
    <button class="qa-btn q8" onclick="navigate('debtors')"><span class="qa-icon">ü§ù</span><span class="qa-lbl">Debtors</span></button>
    <button class="qa-btn q6" onclick="navigate('cashflow')"><span class="qa-icon">üí∏</span><span class="qa-lbl">Cash Flow</span></button>
    <button class="qa-btn q6" onclick="navigate('bankrecon')"><span class="qa-icon">üè¶</span><span class="qa-lbl">Bank Recon</span></button>
  </div>

  <div class="dash-bottom">
    <div>
      <div class="dash-section-title">üïê Recent Transactions</div>
      <div class="card">
        <table class="tbl">
          <thead><tr><th>Voucher</th><th>Date</th><th>Type</th><th>Narration</th><th class="tr">Amount</th></tr></thead>
          <tbody>${recent||'<tr><td colspan="5" class="tc tm-" style="padding:20px;">No transactions yet</td></tr>'}</tbody>
        </table>
      </div>
    </div>
    <div>
      <div class="dash-section-title">üì• Upcoming Receivables</div>
      ${buildDueTable(recv,'receivable')}
      <div style="margin-top:12px;" class="dash-section-title">üì§ Upcoming Payables</div>
      ${buildDueTable(pay,'payable')}
    </div>
  </div>`;

  // ‚îÄ‚îÄ Render Chart.js charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const chartDefaults={
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{labels:{font:{family:'IBM Plex Sans',size:11},usePointStyle:true}},tooltip:{callbacks:{label:ctx=>' ‚Çπ'+fmtN(ctx.raw)}}},
    scales:{x:{grid:{display:false},ticks:{font:{family:'IBM Plex Sans',size:10}}},y:{grid:{color:'#f1f5f9'},ticks:{font:{family:'IBM Plex Sans',size:10},callback:v=>'‚Çπ'+fmtN(v/1000)+'k'}}}
  };

  // 1. Revenue vs Expenses bar chart
  const {labels:rLabels,income:rIncome,expense:rExpense}=buildTimeSeriesData();
  const ctxRev=document.getElementById('ch-rev');
  if(ctxRev){
    _dashCharts.rev=new Chart(ctxRev,{
      type:'bar',
      data:{
        labels:rLabels,
        datasets:[
          {label:'Revenue / Income',data:rIncome,backgroundColor:'rgba(37,99,235,0.85)',borderRadius:6,borderSkipped:false},
          {label:'Expenses',data:rExpense,backgroundColor:'rgba(239,68,68,0.85)',borderRadius:6,borderSkipped:false}
        ]
      },
      options:{...JSON.parse(JSON.stringify(chartDefaults)),plugins:{...JSON.parse(JSON.stringify(chartDefaults)).plugins,tooltip:{callbacks:{label:ctx=>' ‚Çπ'+fmtN(ctx.raw)}}}}
    });
  }

  // 2. Expense breakdown doughnut
  const ctxExp=document.getElementById('ch-exp');
  if(ctxExp){
    const dColors=['#3b82f6','#ef4444','#f59e0b','#10b981','#8b5cf6','#06b6d4','#f97316','#ec4899','#14b8a6'];
    _dashCharts.exp=new Chart(ctxExp,{
      type:'doughnut',
      data:{
        labels:expLabels.length?expLabels:['No Expenses'],
        datasets:[{data:expVals.length?expVals:[1],backgroundColor:dColors.slice(0,Math.max(expVals.length,1)),borderWidth:2,borderColor:'#fff',hoverOffset:8}]
      },
      options:{responsive:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{font:{family:'IBM Plex Sans',size:10},usePointStyle:true,padding:8}},tooltip:{callbacks:{label:ctx=>' ‚Çπ'+fmtN(ctx.raw)}}}}
    });
  }

  // 3. Cash flow line chart
  const ctxCf=document.getElementById('ch-cf');
  if(ctxCf){
    _dashCharts.cf=new Chart(ctxCf,{
      type:'line',
      data:{
        labels:cfLabels,
        datasets:[{
          label:'Net Cash Flow',
          data:cfData,
          borderColor:'#2563eb',
          backgroundColor:'rgba(37,99,235,0.08)',
          borderWidth:2.5,
          pointBackgroundColor:cfData.map(v=>v>=0?'#10b981':'#ef4444'),
          pointRadius:5,
          fill:true,
          tension:0.35
        }]
      },
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>' ‚Çπ'+fmtN(ctx.raw)}}},scales:{x:{grid:{display:false},ticks:{font:{family:'IBM Plex Sans',size:10}}},y:{grid:{color:'#f1f5f9'},ticks:{font:{family:'IBM Plex Sans',size:10},callback:v=>'‚Çπ'+fmtN(v/1000)+'k'}}}}
    });
  }

  // 4. Income breakdown pie
  const ctxInc=document.getElementById('ch-inc');
  if(ctxInc){
    const pColors=['#10b981','#2563eb','#f59e0b','#8b5cf6','#06b6d4','#f97316'];
    _dashCharts.inc=new Chart(ctxInc,{
      type:'pie',
      data:{
        labels:incLabels.length?incLabels:['No Income'],
        datasets:[{data:incVals.length?incVals:[1],backgroundColor:pColors.slice(0,Math.max(incVals.length,1)),borderWidth:2,borderColor:'#fff',hoverOffset:8}]
      },
      options:{responsive:false,plugins:{legend:{position:'bottom',labels:{font:{family:'IBM Plex Sans',size:10},usePointStyle:true,padding:8}},tooltip:{callbacks:{label:ctx=>' ‚Çπ'+fmtN(ctx.raw)}}}}
    });
  }
}

function buildTimeSeriesData(){
  // Use account-type lookup so ALL voucher types (Journal, Receipt, etc.) are captured
  const accType={};
  state.accounts.forEach(a=>{accType[a.id]=a.type;});

  function getIncExp(filterFn){
    let s=0,e=0;
    state.vouchers.filter(filterFn).forEach(v=>{
      v.entries.forEach(en=>{
        const t=accType[en.accId];
        if(t==='Income'&&(en.cr||0)>0) s+=(en.cr||0);
        if(t==='Expense'&&(en.dr||0)>0) e+=(en.dr||0);
      });
    });
    return{s,e};
  }

  const labels=[],income=[],expense=[];
  if(dashFilter==='monthly'){
    for(let i=5;i>=0;i--){
      const d=new Date(new Date().getFullYear(),new Date().getMonth()-i,1);
      const yr=d.getFullYear(),mo=String(d.getMonth()+1).padStart(2,'0');
      labels.push(d.toLocaleString('en-IN',{month:'short'})+"'"+String(yr).slice(2));
      const{s,e}=getIncExp(v=>v.date.startsWith(`${yr}-${mo}`));
      income.push(s); expense.push(e);
    }
  }else if(dashFilter==='quarterly'){
    const now=new Date();
    for(let i=3;i>=0;i--){
      const d=new Date(now.getFullYear(),now.getMonth()-i*3,1);
      const yr=d.getFullYear(),qm=Math.floor(d.getMonth()/3);
      const months=[(qm*3),(qm*3)+1,(qm*3)+2].map(m=>String(m+1).padStart(2,'0'));
      labels.push(`Q${qm+1}'${String(yr).slice(2)}`);
      const{s,e}=getIncExp(v=>months.some(m=>v.date.startsWith(`${yr}-${m}`)));
      income.push(s); expense.push(e);
    }
  }else{
    // Show last 3 financial years (Apr-Mar)
    const baseFY=parseInt(state.fy||new Date().getFullYear()+'-'+(new Date().getFullYear()+1).toString().slice(2));
    for(let offset=2;offset>=0;offset--){
      const fyStart=`${baseFY-offset}-04-01`;
      const fyEnd=`${baseFY-offset+1}-03-31`;
      labels.push(`FY ${baseFY-offset}-${String(baseFY-offset+1).slice(2)}`);
      const{s,e}=getIncExp(v=>v.date>=fyStart&&v.date<=fyEnd);
      income.push(s); expense.push(e);
    }
  }
  return{labels,income,expense};
}

function buildBarChart(){return '';} // Legacy stub ‚Äî replaced by Chart.js

function getReceivables(){
  // Net off: Sales/Debit Notes minus Receipts/Credit Notes per party
  const received={};
  state.vouchers.filter(v=>['Receipt','Credit Note'].includes(v.type)&&v.partyId).forEach(v=>{
    const amt=v.entries.reduce((s,e)=>s+(e.dr||0),0);
    received[v.partyId]=(received[v.partyId]||0)+amt;
  });
  return state.vouchers
    .filter(v=>['Sales','Debit Note'].includes(v.type)&&v.dueDate)
    .map(v=>{
      const gross=v.entries.reduce((s,e)=>s+(e.dr||0),0);
      const settled=Math.min(received[v.partyId]||0,gross);
      if(v.partyId){received[v.partyId]=Math.max((received[v.partyId]||0)-settled,0);}
      const outstanding=gross-settled;
      return{...v,dl:daysLeft(v.dueDate),amount:outstanding,party:partyName(v)};
    }).filter(v=>v.amount>0.01).sort((a,b)=>a.dl-b.dl);
}
function getPayables(){
  // Net off: Purchase/Credit Notes minus Payments/Debit Notes per party
  const paid={};
  state.vouchers.filter(v=>['Payment','Debit Note'].includes(v.type)&&v.partyId).forEach(v=>{
    const amt=v.entries.reduce((s,e)=>s+(e.dr||0),0);
    paid[v.partyId]=(paid[v.partyId]||0)+amt;
  });
  return state.vouchers
    .filter(v=>['Purchase','Credit Note'].includes(v.type)&&v.dueDate)
    .map(v=>{
      const gross=v.entries.reduce((s,e)=>s+(e.dr||0),0);
      const settled=Math.min(paid[v.partyId]||0,gross);
      if(v.partyId){paid[v.partyId]=Math.max((paid[v.partyId]||0)-settled,0);}
      const outstanding=gross-settled;
      return{...v,dl:daysLeft(v.dueDate),amount:outstanding,party:partyName(v)};
    }).filter(v=>v.amount>0.01).sort((a,b)=>a.dl-b.dl);
}
function buildDueTable(items,type){
  if(!items.length)return`<div class="card" style="padding:16px;text-align:center;color:var(--tm);font-size:12px;">No pending ${type}s with due dates</div>`;
  const rows=items.slice(0,6).map((v,i)=>{
    const dc=v.dl<0?'due-over':v.dl<=7?'due-warn':'due-ok';
    const db=v.dl<0?'due-badge-over':v.dl<=7?'due-badge-warn':'due-badge-ok';
    return`<tr class="${i%2?'alt':''}">
      <td class="mono tb-" style="font-size:11px;">${v.id}</td>
      <td style="font-size:11px;">${v.party}</td>
      <td class="tr" style="font-size:11px;">${fmt(v.amount)}</td>
      <td><span class="badge ${db}">${v.dl<0?Math.abs(v.dl)+' overdue':v.dl===0?'Today':v.dl+' days'}</span></td>
    </tr>`;
  }).join('');
  return`<div class="card"><table class="tbl">
    <thead><tr><th>Voucher</th><th>Party</th><th class="tr">Amount</th><th>Due In</th></tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: ACCOUNTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let accFil='All',accSrch='';

function pgAccounts(){renderAccounts();}

function renderAccounts(){
  const fil=state.accounts.filter(a=>(accFil==='All'||a.type===accFil)&&(a.name.toLowerCase().includes(accSrch.toLowerCase())||a.id.includes(accSrch)));
  const rows=fil.map((a,i)=>`<tr class="${i%2?'alt':''}">
    <td class="mono tb- fw-bold">${a.id}</td><td class="fw-bold">${a.name}</td>
    <td class="tm-" style="font-size:11px;">${a.group}</td>
    <td><span class="badge ${bcol(a.type)}">${a.type}</span></td>
    <td class="tr mono">${fmt(a.balance)}</td>
    <td><span class="badge ${a.nature==='Dr'?'bb':'br'}">${a.nature}</span></td>
    <td><button class="btn btn-g btn-sm" onclick="openAccForm('${a.id}')">‚úè Edit</button>
        <button class="btn btn-d btn-sm" onclick="delAcc('${a.id}')">Del</button></td>
  </tr>`).join('');
  eid('content').innerHTML=`
  <div class="tb no-print">
    <input class="si" id="acc-s" placeholder="üîç Search‚Ä¶" value="${accSrch}" oninput="accSrch=this.value;renderAccounts()">
    <div class="tg">${['All',...AT].map(t=>`<button class="t ${accFil===t?'act':''}" onclick="accFil='${t}';renderAccounts()">${t}</button>`).join('')}</div>
    <button class="btn btn-p" onclick="openAccForm()">+ New Account</button>
    <button class="btn btn-s" onclick="exportAccounts()" style="margin-left:auto;">‚¨á Export Excel</button>
  </div>
  <div class="card"><table class="tbl">
    <thead><tr><th>Acc. ID</th><th>Name</th><th>Group</th><th>Type</th><th class="tr">Opening Bal.</th><th>Nature</th><th class="no-print">Actions</th></tr></thead>
    <tbody>${rows||'<tr><td colspan="7" style="padding:20px;text-align:center;color:var(--tm)">No accounts found</td></tr>'}</tbody>
  </table></div>
  <div style="margin-top:7px;font-size:11px;color:var(--tm);">Showing ${fil.length} of ${state.accounts.length} accounts</div>`;
  refocusSearch('acc-s');
}

function openAccForm(editId){
  const a=editId?state.accounts.find(x=>x.id===editId):null;
  const tOpts=AT.map(t=>`<option ${a?.type===t?'selected':''}>${t}</option>`).join('');
  const gOpts=(a?AG[a.type]||[]:AG['Asset']).map(g=>`<option ${a?.group===g?'selected':''}>${g}</option>`).join('');
  openModal(editId?'Edit Account':'New Account',`
  <div class="fg">
    <div class="fgr"><label class="fl">Account ID *</label><input class="fc" id="f-id" value="${a?.id||''}" ${editId?'disabled':''} placeholder="e.g. 1007"></div>
    <div class="fgr"><label class="fl">Account Name *</label><input class="fc" id="f-name" value="${a?.name||''}" placeholder="Account name"></div>
    <div class="fgr"><label class="fl">Type</label><select class="fc" id="f-type" onchange="updGrp(this.value,'${a?.group||''}')">
      ${tOpts}</select></div>
    <div class="fgr"><label class="fl">Group</label><select class="fc" id="f-grp">
      <option value="">‚ÄîSelect Group‚Äî</option>${gOpts}</select></div>
    <div class="fgr"><label class="fl">Opening Balance</label><input type="number" class="fc" id="f-bal" value="${a?.balance||0}" min="0"></div>
    <div class="fgr"><label class="fl">Nature</label><select class="fc" id="f-nat">
      <option ${a?.nature==='Dr'?'selected':''}>Dr</option><option ${a?.nature==='Cr'?'selected':''}>Cr</option></select></div>
  </div>
  <div style="display:flex;gap:8px;margin-top:14px;">
    <button class="btn btn-p" onclick="saveAcc('${editId||''}')">üíæ Save</button>
    <button class="btn btn-g" onclick="closeModal()">Cancel</button>
  </div>`);
}
function updGrp(type,sel){
  const s=eid('f-grp');
  s.innerHTML='<option value="">‚ÄîSelect Group‚Äî</option>'+(AG[type]||[]).map(g=>`<option ${g===sel?'selected':''}>${g}</option>`).join('');
}
function saveAcc(editId){
  const id=eid('f-id').value.trim(),name=eid('f-name').value.trim(),type=eid('f-type').value,group=eid('f-grp').value,bal=parseFloat(eid('f-bal').value)||0,nat=eid('f-nat').value;
  if(!id||!name)return showAlert('ID and Name required');
  if(!editId&&state.accounts.find(a=>a.id===id))return showAlert('ID already exists');
  const obj={id,name,type,group,balance:bal,nature:nat};
  if(editId) state.accounts=state.accounts.map(a=>a.id===editId?obj:a);
  else state.accounts.push(obj);
  scheduleSave();closeModal();renderAccounts();
}
function delAcc(id){if(!confirm('Delete account?'))return;state.accounts=state.accounts.filter(a=>a.id!==id);scheduleSave();renderAccounts();}
function exportAccounts(){
  exportXLS([[state.company,'','','','',''],['CHART OF ACCOUNTS','','','','',''],
    ['Account ID','Account Name','Group','Type','Opening Balance','Nature'],
    ...state.accounts.map(a=>[a.id,a.name,a.group,a.type,a.balance,a.nature])
  ],'Accounts','Chart_of_Accounts.xlsx');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: VENDORS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgVendors(){renderVendors();}
let vndSrch='';

function renderVendors(){
  const fil=state.vendors.filter(v=>v.name.toLowerCase().includes(vndSrch.toLowerCase())||v.contact?.includes(vndSrch));
  const rows=fil.map((v,i)=>`<tr class="${i%2?'alt':''}">
    <td class="fw-bold">${v.name}</td>
    <td class="tm-" style="font-size:11px;">${v.city||''}${v.pincode?', '+v.pincode:''}</td>
    <td class="mono" style="font-size:11px;">${v.contact||'‚Äî'}</td>
    <td style="font-size:11px;">${v.email||'‚Äî'}</td>
    <td><span class="badge ${v.gstRegistered?'bg-':'bgr'}">${v.gstRegistered?v.gstn||'Registered':'Unregistered'}</span></td>
    <td><button class="btn btn-g btn-sm" onclick="openPartyForm('vendor','${v.id}')">‚úè Edit</button>
        <button class="btn btn-d btn-sm" onclick="delParty('vendor','${v.id}')">Del</button></td>
  </tr>`).join('');
  eid('content').innerHTML=`
  <div class="tb no-print">
    <input class="si" id="vnd-s" placeholder="üîç Search vendors‚Ä¶" value="${vndSrch}" oninput="vndSrch=this.value;renderVendors()">
    <button class="btn btn-p" onclick="openPartyForm('vendor')">+ Add Vendor</button>
    <button class="btn btn-s" onclick="exportParty('vendor')" style="margin-left:auto;">‚¨á Export Excel</button>
  </div>
  <div class="card"><table class="tbl">
    <thead><tr><th>Name</th><th>City / Pincode</th><th>Contact</th><th>Email</th><th>GST Status</th><th class="no-print">Actions</th></tr></thead>
    <tbody>${rows||'<tr><td colspan="6" style="padding:20px;text-align:center;color:var(--tm)">No vendors added yet</td></tr>'}</tbody>
  </table></div>`;
  refocusSearch('vnd-s');
}

function pgDebtors(){renderDebtors();}
let dbtSrch='';

function renderDebtors(){
  const fil=state.debtors.filter(d=>d.name.toLowerCase().includes(dbtSrch.toLowerCase())||d.contact?.includes(dbtSrch));
  const rows=fil.map((d,i)=>`<tr class="${i%2?'alt':''}">
    <td class="fw-bold">${d.name}</td>
    <td class="tm-" style="font-size:11px;">${d.city||''}${d.pincode?', '+d.pincode:''}</td>
    <td class="mono" style="font-size:11px;">${d.contact||'‚Äî'}</td>
    <td style="font-size:11px;">${d.email||'‚Äî'}</td>
    <td><span class="badge ${d.gstRegistered?'bg-':'bgr'}">${d.gstRegistered?d.gstn||'Registered':'Unregistered'}</span></td>
    <td><button class="btn btn-g btn-sm" onclick="openPartyForm('debtor','${d.id}')">‚úè Edit</button>
        <button class="btn btn-d btn-sm" onclick="delParty('debtor','${d.id}')">Del</button></td>
  </tr>`).join('');
  eid('content').innerHTML=`
  <div class="tb no-print">
    <input class="si" id="dbt-s" placeholder="üîç Search customers‚Ä¶" value="${dbtSrch}" oninput="dbtSrch=this.value;renderDebtors()">
    <button class="btn btn-p" onclick="openPartyForm('debtor')">+ Add Customer / Debtor</button>
    <button class="btn btn-s" onclick="exportParty('debtor')" style="margin-left:auto;">‚¨á Export Excel</button>
  </div>
  <div class="card"><table class="tbl">
    <thead><tr><th>Name</th><th>City / Pincode</th><th>Contact</th><th>Email</th><th>GST Status</th><th class="no-print">Actions</th></tr></thead>
    <tbody>${rows||'<tr><td colspan="6" style="padding:20px;text-align:center;color:var(--tm)">No customers added yet</td></tr>'}</tbody>
  </table></div>`;
  refocusSearch('dbt-s');
}

function openPartyForm(ptype,editId){
  const list=ptype==='vendor'?state.vendors:state.debtors;
  const p=editId?list.find(x=>x.id===editId):null;
  const title=ptype==='vendor'?(editId?'Edit Vendor':'New Vendor'):(editId?'Edit Customer':'New Customer');
  openModal(title,`
  <div class="fg" style="margin-bottom:14px;">
    <div class="fgr" style="grid-column:span 2;"><label class="fl">Full Name / Company Name *</label><input class="fc" id="p-name" value="${p?.name||''}" placeholder="${ptype==='vendor'?'Supplier name':'Customer / Company name'}"></div>
    <div class="fgr" style="grid-column:span 2;"><label class="fl">Address</label><input class="fc" id="p-addr" value="${p?.address||''}" placeholder="Street address"></div>
    <div class="fgr"><label class="fl">City</label><input class="fc" id="p-city" value="${p?.city||''}" placeholder="City"></div>
    <div class="fgr"><label class="fl">State</label><input class="fc" id="p-state" value="${p?.state||''}" placeholder="State"></div>
    <div class="fgr"><label class="fl">Pincode</label><input class="fc" id="p-pin" value="${p?.pincode||''}" placeholder="e.g. 400001" maxlength="6"></div>
    <div class="fgr"><label class="fl">Contact No.</label><input class="fc" id="p-cont" value="${p?.contact||''}" placeholder="10-digit mobile" maxlength="12"></div>
    <div class="fgr"><label class="fl">Email ID</label><input type="email" class="fc" id="p-email" value="${p?.email||''}" placeholder="email@company.com"></div>
    <div class="fgr"><label class="fl">Credit Days</label><input type="number" class="fc" id="p-cdays" value="${p?.creditDays||30}" min="0" max="365"></div>
  </div>
  <div style="background:#f0fdf4;border:1px solid #a7f3d0;border-radius:10px;padding:14px;margin-bottom:14px;">
    <div style="font-size:12px;font-weight:700;color:#065f46;margin-bottom:10px;">GST Details</div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <label class="fl" style="margin:0;">GST Registered?</label>
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;">
        <input type="checkbox" id="p-gstreg" ${p?.gstRegistered?'checked':''} onchange="toggleGSTInput()"> Yes, Registered
      </label>
    </div>
    <div id="gstn-wrap" style="${p?.gstRegistered?'':'display:none'}">
      <input class="fc" id="p-gstn" value="${p?.gstn||''}" placeholder="15-digit GSTIN e.g. 27AABCU9603R1ZX" maxlength="15" style="text-transform:uppercase;">
    </div>
    <div id="ungst-wrap" style="${p?.gstRegistered?'display:none':''}">
      <div style="font-size:11px;color:#64748b;">This party is unregistered under GST. RCM may apply.</div>
    </div>
  </div>
  <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:14px;margin-bottom:14px;">
    <div style="font-size:12px;font-weight:700;color:#1e40af;margin-bottom:10px;">Bank Details (for payment)</div>
    <div class="fg">
      <div class="fgr"><label class="fl">Bank Name</label><input class="fc" id="p-bank" value="${p?.bankName||''}" placeholder="e.g. State Bank of India"></div>
      <div class="fgr"><label class="fl">Account No.</label><input class="fc" id="p-bano" value="${p?.bankAccount||''}" placeholder="Account number"></div>
      <div class="fgr"><label class="fl">IFSC Code</label><input class="fc" id="p-ifsc" value="${p?.bankIFSC||''}" placeholder="e.g. SBIN0001234"></div>
      <div class="fgr"><label class="fl">Branch</label><input class="fc" id="p-brnch" value="${p?.bankBranch||''}" placeholder="Branch name"></div>
    </div>
  </div>
  <div style="display:flex;gap:8px;">
    <button class="btn btn-p" onclick="saveParty('${ptype}','${editId||''}')">üíæ Save</button>
    <button class="btn btn-g" onclick="closeModal()">Cancel</button>
  </div>`);
}
function toggleGSTInput(){
  const checked=eid('p-gstreg').checked;
  eid('gstn-wrap').style.display=checked?'':'none';
  eid('ungst-wrap').style.display=checked?'none':'';
}
function saveParty(ptype,editId){
  const name=eid('p-name').value.trim();
  if(!name)return showAlert('Name is required');
  const obj={
    id:editId||(ptype[0]+Date.now()),name,
    address:eid('p-addr').value.trim(),city:eid('p-city').value.trim(),
    state:eid('p-state').value.trim(),pincode:eid('p-pin').value.trim(),
    contact:eid('p-cont').value.trim(),email:eid('p-email').value.trim(),
    creditDays:parseInt(eid('p-cdays').value)||30,
    gstRegistered:eid('p-gstreg').checked,
    gstn:eid('p-gstn')?.value.toUpperCase().trim()||'',
    bankName:eid('p-bank').value.trim(),bankAccount:eid('p-bano').value.trim(),
    bankIFSC:eid('p-ifsc').value.toUpperCase().trim(),bankBranch:eid('p-brnch').value.trim(),
  };
  const list=ptype==='vendor'?'vendors':'debtors';
  if(editId) state[list]=state[list].map(x=>x.id===editId?obj:x);
  else state[list].push(obj);
  scheduleSave();closeModal();
  ptype==='vendor'?renderVendors():renderDebtors();
}
function delParty(ptype,id){
  if(!confirm('Delete?'))return;
  const list=ptype==='vendor'?'vendors':'debtors';
  state[list]=state[list].filter(x=>x.id!==id);
  scheduleSave();
  ptype==='vendor'?renderVendors():renderDebtors();
}
function exportParty(ptype){
  const list=ptype==='vendor'?state.vendors:state.debtors;
  const title=ptype==='vendor'?'VENDOR MASTER':'DEBTOR MASTER';
  exportXLS([
    [state.company,'','','','','','',''],
    [title,'','','','','','',''],
    ['Name','Address','City','State','Pincode','Contact','Email','GST Status','GSTN','Bank Name','Account No','IFSC','Branch','Credit Days'],
    ...list.map(p=>[p.name,p.address,p.city,p.state,p.pincode,p.contact,p.email,p.gstRegistered?'Registered':'Unregistered',p.gstn,p.bankName,p.bankAccount,p.bankIFSC,p.bankBranch,p.creditDays])
  ],title,`${title}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: ITEM MASTER (HSN / SAC)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgItems(){renderItems();}
let itemSrch='';
function renderItems(){
  if(!state.items)state.items=[];
  const fil=state.items.filter(i=>i.name.toLowerCase().includes(itemSrch.toLowerCase())||i.hsn?.includes(itemSrch)||i.sac?.includes(itemSrch));
  const rows=fil.map((it,i)=>`<tr class="${i%2?'alt':''}">
    <td class="mono tb-">${it.id}</td>
    <td class="fw-bold">${it.name}</td>
    <td><span class="badge ${it.type==='Goods'?'bb':'bg-'}">${it.type}</span></td>
    <td class="mono">${it.hsn||it.sac||'‚Äî'}</td>
    <td class="tm-">${it.unit}</td>
    <td class="tr mono">${fmt(it.saleRate)}</td>
    <td class="tr mono">${fmt(it.purchaseRate)}</td>
    <td class="tc"><span class="badge by">${it.gstRate}%</span></td>
    <td>
      <button class="btn btn-g btn-sm" onclick="openItemForm('${it.id}')">‚úè Edit</button>
      <button class="btn btn-d btn-sm" onclick="delItem('${it.id}')">Del</button>
    </td>
  </tr>`).join('');
  eid('content').innerHTML=`
  <div class="tb no-print">
    <input class="si" id="itm-s" placeholder="üîç Search items, HSN/SAC‚Ä¶" value="${itemSrch}" oninput="itemSrch=this.value;renderItems()">
    <button class="btn btn-p" onclick="openItemForm()">+ New Item / Service</button>
    <button class="btn btn-s" onclick="exportItems()" style="margin-left:auto;">‚¨á Excel</button>
  </div>
  <div class="card"><table class="tbl">
    <thead><tr><th>Item ID</th><th>Name</th><th>Type</th><th>HSN/SAC</th><th>Unit</th><th class="tr">Sale Rate</th><th class="tr">Purchase Rate</th><th class="tc">GST%</th><th class="no-print">Actions</th></tr></thead>
    <tbody>${rows||'<tr><td colspan="9" style="padding:20px;text-align:center;color:var(--tm);">No items yet. Add your products/services.</td></tr>'}</tbody>
  </table></div>`;
  refocusSearch('itm-s');
}
function openItemForm(editId){
  const it=editId?(state.items||[]).find(x=>x.id===editId):null;
  const accOpts=(type)=>state.accounts.filter(a=>a.type===type).map(a=>`<option value="${a.id}" ${it?.[type==='Income'?'incomeAccId':'expenseAccId']===a.id?'selected':''}>${a.id} ‚Äî ${a.name}</option>`).join('');
  openModal(editId?'Edit Item':'New Item / Service',`
  <div class="fg" style="margin-bottom:14px;">
    <div class="fgr"><label class="fl">Item Name *</label><input class="fc" id="it-name" value="${it?.name||''}" placeholder="Product or Service name"></div>
    <div class="fgr"><label class="fl">Type</label>
      <select class="fc" id="it-type" onchange="toggleHSNSAC(this.value)">
        <option ${it?.type==='Goods'?'selected':''}>Goods</option>
        <option ${it?.type==='Service'?'selected':''}>Service</option>
      </select>
    </div>
    <div class="fgr" id="hsn-wrap"><label class="fl">HSN Code (Goods)</label><input class="fc" id="it-hsn" value="${it?.hsn||''}" placeholder="6-8 digit HSN"></div>
    <div class="fgr" id="sac-wrap" style="${it?.type==='Service'?'':'display:none'}"><label class="fl">SAC Code (Services)</label><input class="fc" id="it-sac" value="${it?.sac||''}" placeholder="6-digit SAC"></div>
    <div class="fgr"><label class="fl">Unit</label>
      <select class="fc" id="it-unit">
        ${['Nos','Kg','Ltr','Mtr','Box','Set','Hr','Day','Month','Pair','Pcs','Ton'].map(u=>`<option ${it?.unit===u?'selected':''}>${u}</option>`).join('')}
      </select>
    </div>
    <div class="fgr"><label class="fl">GST Rate %</label>
      <select class="fc" id="it-gst">
        ${GST_RATES.map(r=>`<option value="${r}" ${it?.gstRate===r?'selected':''}>${r}%</option>`).join('')}
      </select>
    </div>
    <div class="fgr"><label class="fl">Sale Rate (‚Çπ)</label><input type="number" class="fc" id="it-srate" value="${it?.saleRate||0}" min="0"></div>
    <div class="fgr"><label class="fl">Purchase Rate (‚Çπ)</label><input type="number" class="fc" id="it-prate" value="${it?.purchaseRate||0}" min="0"></div>
    <div class="fgr" style="grid-column:span 2;"><label class="fl">Income Account (for Sales)</label>
      <select class="fc" id="it-iacc"><option value="">‚ÄîSelect‚Äî</option>${accOpts('Income')}</select></div>
    <div class="fgr" style="grid-column:span 2;"><label class="fl">Expense Account (for Purchase)</label>
      <select class="fc" id="it-eacc"><option value="">‚ÄîSelect‚Äî</option>${accOpts('Expense')}</select></div>
    <div class="fgr" style="grid-column:span 4;"><label class="fl">Description</label><input class="fc" id="it-desc" value="${it?.desc||it?.description||''}" placeholder="Item description"></div>
  </div>
  <div style="display:flex;gap:8px;">
    <button class="btn btn-p" onclick="saveItem('${editId||''}')">üíæ Save Item</button>
    <button class="btn btn-g" onclick="closeModal()">Cancel</button>
  </div>`);
  toggleHSNSAC(it?.type||'Goods');
}
function toggleHSNSAC(type){
  const hw=eid('hsn-wrap'),sw=eid('sac-wrap');
  if(hw)hw.style.display=type==='Goods'?'':'none';
  if(sw)sw.style.display=type==='Service'?'':'none';
}
function saveItem(editId){
  if(!state.items)state.items=[];
  const name=eid('it-name').value.trim();
  if(!name)return showAlert('Item name required');
  const obj={
    id:editId||('ITM'+String(Date.now()).slice(-6)),
    name,type:eid('it-type').value,
    hsn:eid('it-hsn')?.value.trim()||'',sac:eid('it-sac')?.value.trim()||'',
    unit:eid('it-unit').value,gstRate:parseFloat(eid('it-gst').value)||0,
    saleRate:parseFloat(eid('it-srate').value)||0,purchaseRate:parseFloat(eid('it-prate').value)||0,
    incomeAccId:eid('it-iacc').value,expenseAccId:eid('it-eacc').value,
    description:eid('it-desc').value.trim()
  };
  if(editId) state.items=state.items.map(x=>x.id===editId?obj:x);
  else state.items.push(obj);
  scheduleSave();closeModal();renderItems();
}
function delItem(id){if(!confirm('Delete item?'))return;state.items=state.items.filter(x=>x.id!==id);scheduleSave();renderItems();}
function exportItems(){
  exportXLS([[state.company,'','','','','','',''],['ITEM MASTER','','','','','','',''],
    ['Item ID','Name','Type','HSN','SAC','Unit','GST%','Sale Rate','Purchase Rate','Description'],
    ...(state.items||[]).map(i=>[i.id,i.name,i.type,i.hsn,i.sac,i.unit,i.gstRate,i.saleRate,i.purchaseRate,i.description])
  ],'Items','Item_Master.xlsx');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: VOUCHERS ‚Äî Zoho-Style with Item Lines, GST Auto-split,
//        TDS Engine, Entry Preview Panel, Advance Adjustment
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let vFil='All', vItemLines=[], vManualEntries=[{accId:'',dr:0,cr:0},{accId:'',dr:0,cr:0}], editVId=null, vMode='smart';

function pgVouchers(){
  vItemLines=[{itemId:'',desc:'',qty:1,rate:0,disc:0,gstRate:18,gstType:'CGST+SGST (Intra-state)'}];
  vManualEntries=[{accId:'',dr:0,cr:0},{accId:'',dr:0,cr:0}];
  editVId=null;renderVouchers();
}

function renderVouchers(){
  if(!state.items)state.items=[];
  const fil=vFil==='All'?state.vouchers:state.vouchers.filter(v=>v.type===vFil);
  const sorted=[...fil].sort((a,b)=>b.date.localeCompare(a.date));
  const rows=sorted.map((v,i)=>{
    const amt=v.entries.reduce((s,e)=>s+(e.dr||0),0);
    const hasItems=v.items&&v.items.length>0;
    return`<tr class="${i%2?'alt':''}">
      <td class="mono tb-">${v.id}</td><td>${fmtD(v.date)}</td>
      <td><span class="badge ${bcol(v.type)}">${v.type}</span></td>
      <td class="tm-" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${v.narration}</td>
      <td class="tm-" style="font-size:11px;">${v.ref||'‚Äî'}</td>
      ${hasItems?`<td><span class="badge bg-">${v.items.length} item${v.items.length>1?'s':''}</span></td>`:'<td class="tm-" style="font-size:10px;">Manual</td>'}
      <td class="tr mono">${fmt(amt)}</td>
      <td style="white-space:nowrap;">
        <button class="btn btn-g btn-sm" onclick="editVoucher('${v.id}')">‚úè</button>
        ${['Sales','Debit Note'].includes(v.type)?`<button class="btn btn-w btn-sm" onclick="printVoucher('${v.id}')">üñ®</button>`:''}
        <button class="btn btn-d btn-sm" onclick="delVoucher('${v.id}')">Del</button>
      </td>
    </tr>`;
  }).join('');

  const usedNums=new Set(state.vouchers.map(v=>parseInt(v.id.replace(/\D/g,''))||0));let nextNum=1;while(usedNums.has(nextNum))nextNum++;const nextId='V'+String(nextNum).padStart(3,'0');
  const curType=eid('v-type')?.value||'Sales';
  const partyList=(['Sales','Debit Note','Receipt'].includes(curType)?state.debtors:state.vendors);
  const partyOpts=partyList.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  const accOpts=state.accounts.map(a=>`<option value="${a.id}">${a.id} ‚Äî ${a.name}</option>`).join('');
  const itemOpts=(state.items||[]).map(i=>`<option value="${i.id}">${i.name} (${i.hsn||i.sac||'‚Äî'})</option>`).join('');

  // ‚îÄ‚îÄ Compute preview entries from item lines ‚îÄ‚îÄ
  const preview = computePreviewEntries(curType, vItemLines);
  const totDr=preview.reduce((s,e)=>s+(e.dr||0),0);
  const totCr=preview.reduce((s,e)=>s+(e.cr||0),0);
  const bal=Math.abs(totDr-totCr)<0.01;

  const previewRows = preview.map(e=>`
    <tr style="font-size:11px;">
      <td class="mono" style="color:#2563eb;padding:5px 8px;">${e.accId}</td>
      <td style="padding:5px 8px;">${aN(e.accId)||e.accId}</td>
      <td style="padding:5px 8px;"><span style="font-size:10px;background:#f1f5f9;border-radius:4px;padding:1px 6px;">${e.tag||''}</span></td>
      <td class="tr" style="padding:5px 8px;color:#059669;font-weight:600;">${e.dr>0?fmt(e.dr):'‚Äî'}</td>
      <td class="tr" style="padding:5px 8px;color:#dc2626;font-weight:600;">${e.cr>0?fmt(e.cr):'‚Äî'}</td>
    </tr>`).join('');

  const itemRows=vItemLines.map((ln,i)=>`
    <tr id="irow-${i}" style="background:${i%2?'#fafafa':'#fff'};">
      <td style="padding:4px 6px;min-width:180px;">
        <select class="fc" style="padding:4px 6px;font-size:12px;" onchange="onItemSelect(${i},this.value)">
          <option value="">‚Äî Select Item ‚Äî</option>${itemOpts.replace(`value="${ln.itemId}"`,`value="${ln.itemId}" selected`)}
        </select>
      </td>
      <td style="padding:4px 6px;min-width:150px;">
        <input class="fc" style="padding:4px 6px;font-size:12px;" value="${ln.desc||''}" placeholder="Description" oninput="vItemLines[${i}].desc=this.value;refreshPreview()">
      </td>
      <td style="padding:4px 6px;min-width:100px;">
        <input type="text" inputmode="decimal" class="fc tr" style="padding:6px 8px;font-size:12px;width:100%;min-width:90px;-moz-appearance:textfield;" value="${ln.qty||1}" placeholder="0.00" oninput="vItemLines[${i}].qty=parseFloat(this.value)||1;refreshPreview()">
      </td>
      <td style="padding:4px 6px;min-width:120px;">
        <input type="text" inputmode="decimal" class="fc tr" style="padding:6px 8px;font-size:12px;width:100%;min-width:110px;" value="${ln.rate||''}" placeholder="0.00" oninput="vItemLines[${i}].rate=parseFloat(this.value)||0;refreshPreview()">
      </td>
      <td style="padding:4px 6px;min-width:90px;">
        <input type="text" inputmode="decimal" class="fc tr" style="padding:6px 8px;font-size:12px;width:100%;min-width:80px;" value="${ln.disc||0}" placeholder="0" oninput="vItemLines[${i}].disc=parseFloat(this.value)||0;refreshPreview()">
      </td>
      <td style="padding:4px 6px;min-width:90px;">
        <select class="fc" style="padding:6px 8px;font-size:12px;min-width:80px;" onchange="vItemLines[${i}].gstRate=parseFloat(this.value);refreshPreview()">
          ${GST_RATES.map(r=>`<option value="${r}" ${ln.gstRate===r?'selected':''}>${r}%</option>`).join('')}
        </select>
      </td>
      <td style="padding:4px 6px;min-width:170px;">
        <select class="fc" style="padding:6px 8px;font-size:12px;min-width:160px;" onchange="vItemLines[${i}].gstType=this.value;refreshPreview()">
          ${GST_TYPES.map(t=>`<option ${ln.gstType===t?'selected':''}>${t}</option>`).join('')}
        </select>
      </td>
      <td class="tr" id="row-taxable-${i}" style="padding:4px 10px;font-size:12px;font-weight:600;white-space:nowrap;color:#1e293b;">
        ${fmt(calcLineTaxable(ln))}
      </td>
      <td class="tr" id="row-total-${i}" style="padding:4px 10px;font-size:12px;font-weight:700;white-space:nowrap;color:#059669;">
        ${fmt(calcLineTotal(ln))}
      </td>
      <td style="padding:4px 6px;text-align:center;">
        ${vItemLines.length>1?`<button class="btn btn-d btn-sm" onclick="remItemRow(${i})">‚úï</button>`:''}
      </td>
    </tr>`).join('');

  const taxSummary=calcTaxSummary(vItemLines,curType);

  eid('content').innerHTML=`
  <div style="display:grid;grid-template-columns:1fr 380px;gap:16px;align-items:start;">
    <!-- LEFT: VOUCHER FORM -->
    <div>
      <div style="font-weight:700;color:var(--tm);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">
        ${editVId?'‚úè Edit Voucher: '+editVId:'üÜï New Voucher ‚Äî Zoho Style'}
      </div>
      <div class="fp">
        <!-- Header -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px;">
          <div class="fgr"><label class="fl">Voucher No.</label><input class="fc" id="v-id" value="${editVId||nextId}"></div>
          <div class="fgr"><label class="fl">Date *</label><input type="date" class="fc" id="v-date" value="${eid('v-date')?.value||today()}"></div>
          <div class="fgr"><label class="fl">Type</label>
            <select class="fc" id="v-type" onchange="onVTypeChange(this.value)">
              ${VT.map(t=>`<option ${t===(eid('v-type')?.value||'Sales')?'selected':''}>${t}</option>`).join('')}
            </select>
          </div>
          <div class="fgr"><label class="fl">Reference No.</label><input class="fc" id="v-ref" value="${eid('v-ref')?.value||''}" placeholder="INV / PO no."></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
          <div class="fgr"><label class="fl">Party</label>
            <select class="fc" id="v-party" onchange="onPartyChange(this.value,'${curType}')">
              <option value="">‚Äî No party ‚Äî</option>${partyOpts}
            </select>
          </div>
          <div class="fgr"><label class="fl">Narration *</label><input class="fc" id="v-nar" value="${eid('v-nar')?.value||''}" placeholder="Transaction description‚Ä¶"></div>
          <div class="fgr"><label class="fl">Due Date</label><input type="date" class="fc" id="v-due" value="${eid('v-due')?.value||''}"></div>
          <div class="fgr"><label class="fl">TDS Section</label>
            <select class="fc" id="v-tds" onchange="refreshPreview()">
              <option value="">‚Äî No TDS ‚Äî</option>
              ${TDS_SECTIONS.map(s=>`<option value="${s.code}" ${eid('v-tds')?.value===s.code?'selected':''}>${s.code} ‚Äî ${s.desc} (${s.rate}%)</option>`).join('')}
            </select>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center;">
          <span style="font-size:11px;font-weight:700;color:var(--tm);">Mode:</span>
          <div class="tg">
            <button class="t ${vMode==='smart'?'act':''}" onclick="vMode='smart';renderVouchers()">üì¶ Smart (Items)</button>
            <button class="t ${vMode==='manual'?'act':''}" onclick="vMode='manual';renderVouchers()">‚úè Manual (Accounts)</button>
          </div>
        </div>
        ${vMode==='smart'?`
        <!-- ITEM LINES TABLE -->
        <div style="overflow-x:auto;margin-bottom:8px;">
          <table style="width:100%;border-collapse:collapse;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;">
            <thead><tr style="background:#334155;color:#e2e8f0;">
              <th style="padding:8px 8px;font-size:10px;text-align:left;min-width:180px;">Item / Product</th>
              <th style="padding:8px 8px;font-size:10px;text-align:left;min-width:150px;">Description</th>
              <th style="padding:8px 8px;font-size:10px;text-align:right;min-width:100px;">Qty</th>
              <th style="padding:8px 8px;font-size:10px;text-align:right;min-width:120px;">Rate (‚Çπ)</th>
              <th style="padding:8px 8px;font-size:10px;text-align:right;min-width:90px;">Disc%</th>
              <th style="padding:8px 8px;font-size:10px;text-align:center;min-width:90px;">GST%</th>
              <th style="padding:8px 8px;font-size:10px;text-align:center;min-width:170px;">GST Type</th>
              <th style="padding:8px 8px;font-size:10px;text-align:right;">Taxable</th>
              <th style="padding:8px 8px;font-size:10px;text-align:right;">Total</th>
              <th style="padding:8px 8px;font-size:10px;"></th>
            </tr></thead>
            <tbody>${itemRows}</tbody>
          </table>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <button class="btn btn-g btn-sm" onclick="addItemRow()">+ Add Line</button>
        </div>
        <!-- Tax Summary -->
        <div style="background:#f0fdf4;border:1px solid #a7f3d0;border-radius:10px;padding:12px 16px;margin-bottom:10px;">
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;font-size:12px;">
            <div><span style="color:var(--tm);">Taxable Amt</span><div id="tax-taxable" style="font-weight:700;font-size:15px;">${fmt(taxSummary.taxable)}</div></div>
            <div><span style="color:var(--tm);">CGST</span><div id="tax-cgst" style="font-weight:700;font-size:15px;color:#059669;">${fmt(taxSummary.cgst)}</div></div>
            <div><span style="color:var(--tm);">SGST</span><div id="tax-sgst" style="font-weight:700;font-size:15px;color:#059669;">${fmt(taxSummary.sgst)}</div></div>
            <div><span style="color:var(--tm);">IGST</span><div id="tax-igst" style="font-weight:700;font-size:15px;color:#7c3aed;">${fmt(taxSummary.igst)}</div></div>
          </div>
          ${taxSummary.tds>0?`<div style="margin-top:8px;padding-top:8px;border-top:1px dashed #a7f3d0;display:flex;justify-content:space-between;font-size:12px;"><span style="color:#dc2626;font-weight:600;">TDS Deducted (${eid('v-tds')?.options[eid('v-tds')?.selectedIndex]?.text?.split('‚Äî')[0]||''})</span><span style="font-weight:700;color:#dc2626;">‚àí${fmt(taxSummary.tds)}</span></div>`:''}
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid #a7f3d0;display:flex;justify-content:space-between;font-size:14px;font-weight:700;"><span>Grand Total</span><span id="tax-grand" style="color:#059669;">${fmt(taxSummary.grand)}</span></div>
        </div>`:`
        <!-- MANUAL ENTRIES -->
        <div id="manual-entries">
          <table class="et" style="margin-bottom:8px;">
            <thead><tr><th style="width:44%">Account</th><th class="tr" style="width:22%">Debit (Dr)</th><th class="tr" style="width:22%">Credit (Cr)</th><th style="width:12%"></th></tr></thead>
            <tbody id="erows">
              ${vManualEntries.map((e,i)=>{
                const accOpts=state.accounts.map(a=>`<option value="${a.id}" ${a.id===e.accId?'selected':''}>${a.id} ‚Äî ${a.name}</option>`).join('');
                const totDrM=vManualEntries.reduce((s,x)=>s+(x.dr||0),0);
                const totCrM=vManualEntries.reduce((s,x)=>s+(x.cr||0),0);
                return`<tr class="m-acc-row">
                  <td><select class="fc m-acc" style="padding:4px 7px;font-size:12px;" onchange="vManualEntries[${i}].accId=this.value;renderVouchers()"><option value="">‚Äî Account ‚Äî</option>${accOpts}</select></td>
                  <td><input type="number" class="fc tr m-dr" style="padding:4px 7px;font-size:12px;" value="${e.dr||''}" min="0" placeholder="0" oninput="vManualEntries[${i}].dr=parseFloat(this.value)||0;refreshManualTotals()"></td>
                  <td><input type="number" class="fc tr m-cr" style="padding:4px 7px;font-size:12px;" value="${e.cr||''}" min="0" placeholder="0" oninput="vManualEntries[${i}].cr=parseFloat(this.value)||0;refreshManualTotals()"></td>
                  <td class="tc">${vManualEntries.length>2?`<button class="btn btn-d btn-sm" onclick="vManualEntries.splice(${i},1);renderVouchers()">‚úï</button>`:''}</td>
                </tr>`;
              }).join('')}
            </tbody>
            <tfoot><tr style="${(()=>{const d=vManualEntries.reduce((s,e)=>s+(e.dr||0),0),c=vManualEntries.reduce((s,e)=>s+(e.cr||0),0);return Math.abs(d-c)<0.01&&d>0?'background:#ecfdf5':'background:#fef2f2';})()}">
              <td style="padding:7px 10px;font-weight:700;font-size:12px;">TOTAL</td>
              <td class="tr" style="padding:7px 10px;font-weight:700;color:#059669;">${fmt(vManualEntries.reduce((s,e)=>s+(e.dr||0),0))}</td>
              <td class="tr" style="padding:7px 10px;font-weight:700;color:#dc2626;">${fmt(vManualEntries.reduce((s,e)=>s+(e.cr||0),0))}</td>
              <td></td>
            </tr></tfoot>
          </table>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn btn-g btn-sm" onclick="vManualEntries.push({accId:'',dr:0,cr:0});renderVouchers()">+ Add Row</button>
            <span class="bal-hint" style="font-size:11px;color:var(--tm);">Debit must equal Credit</span>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;align-items:center;">
          <button class="btn btn-p" onclick="showManualPreviewAndPost()" style="font-size:13px;padding:9px 18px;">üëÅ Preview &amp; Post Voucher</button>
          ${editVId?`<button class="btn btn-g" onclick="cancelEdit()">‚úï Cancel</button>`:''}
          <span style="font-size:10px;color:var(--tm);">Manual ¬∑ AS-1 Compliant</span>
        </div>`}
        ${vMode==='smart'?`
        <div style="display:flex;gap:8px;margin-top:12px;align-items:center;">
          <button class="btn btn-p" onclick="showEntryPreviewAndSave()" style="font-size:13px;padding:9px 18px;">üëÅ Preview &amp; Post Voucher</button>
          ${editVId?`<button class="btn btn-g" onclick="cancelEdit()">‚úï Cancel</button>`:''}
          <span style="font-size:10px;color:var(--tm);">Auto GST ¬∑ TDS ¬∑ AS-1 Compliant</span>
        </div>`:``}
      </div>
    </div>

    <!-- RIGHT: LIVE JOURNAL PREVIEW PANEL -->
    <div>
      <div style="font-weight:700;color:var(--tm);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">üìí Live Journal Entry Preview</div>
      <div id="voucher-preview-wrap" style="background:#fff;border:1.5px solid #2563eb;border-radius:12px;overflow:hidden;box-shadow:0 4px 16px rgba(37,99,235,.12);">
        ${buildPreviewPanel(vMode,vManualEntries,preview,previewRows,bal,totDr,totCr,editVId)}
      </div>
    </div>
  </div>`;
  // Always sync party dropdown to current voucher type after re-render
  onVTypeChange(curType);
  if(editVId){ const v=state.vouchers.find(x=>x.id===editVId); if(v&&eid('v-party')) eid('v-party').value=v.partyId||''; }
}


function refreshManualTotals(){
  // Read live values from DOM into vManualEntries
  document.querySelectorAll('.m-acc-row').forEach((row,i)=>{
    if(vManualEntries[i]){
      vManualEntries[i].dr = parseFloat(row.querySelector('.m-dr')?.value)||0;
      vManualEntries[i].cr = parseFloat(row.querySelector('.m-cr')?.value)||0;
    }
  });
  const totDr = vManualEntries.reduce((s,e)=>s+(e.dr||0),0);
  const totCr = vManualEntries.reduce((s,e)=>s+(e.cr||0),0);
  const bal = Math.abs(totDr-totCr)<0.01 && totDr>0;
  // Update totals row
  const tfoot = document.querySelector('#manual-entries tfoot tr');
  if(tfoot){
    tfoot.style.background = bal ? '#ecfdf5' : '#fef2f2';
    const cells = tfoot.querySelectorAll('td');
    if(cells[1]) cells[1].innerHTML = fmt(totDr);
    if(cells[2]) cells[2].innerHTML = fmt(totCr);
  }
  const hint = document.querySelector('#manual-entries .bal-hint');
  if(hint) hint.textContent = bal ? '‚úì Balanced' : 'Debit must equal Credit';
  // Also rebuild the right-side live preview panel
  const previewWrap = document.querySelector('#voucher-preview-wrap');
  if(previewWrap) previewWrap.innerHTML = buildPreviewPanel('manual', vManualEntries, [], '', false, totDr, totCr, editVId);
}


function buildPreviewPanel(mode, manualEntries, preview, previewRows, bal, totDr, totCr, editVId){
  const th = '<thead><tr style="background:#f8fafc;border-bottom:1px solid #e2e8f0;"><th style="padding:6px 8px;text-align:left;font-size:10px;color:#64748b;">Acc ID</th><th style="padding:6px 8px;text-align:left;font-size:10px;color:#64748b;">Account Name</th><th style="padding:6px 8px;text-align:left;font-size:10px;color:#64748b;">Tag</th><th style="padding:6px 8px;text-align:right;font-size:10px;color:#059669;">Dr ‚Çπ</th><th style="padding:6px 8px;text-align:right;font-size:10px;color:#dc2626;">Cr ‚Çπ</th></tr></thead>';

  if(mode === 'manual'){
    const mEntries = manualEntries.filter(e => e.accId && (e.dr > 0 || e.cr > 0));
    const mDr = mEntries.reduce((s,e) => s+(e.dr||0), 0);
    const mCr = mEntries.reduce((s,e) => s+(e.cr||0), 0);
    const mBal = Math.abs(mDr-mCr) < 0.01 && mEntries.length >= 2;
    const mRows = mEntries.map(e =>
      '<tr style="border-bottom:1px solid #f1f5f9;">' +
      '<td style="padding:6px 8px;font-family:monospace;color:#2563eb;font-size:11px;">'+e.accId+'</td>' +
      '<td style="padding:6px 8px;font-size:11px;">'+aN(e.accId)+'</td>' +
      '<td style="padding:6px 8px;font-size:10px;color:#64748b;">Manual</td>' +
      '<td style="padding:6px 8px;text-align:right;color:#059669;font-weight:700;">'+(e.dr>0?fmt(e.dr):'‚Äî')+'</td>' +
      '<td style="padding:6px 8px;text-align:right;color:#dc2626;font-weight:700;">'+(e.cr>0?fmt(e.cr):'‚Äî')+'</td>' +
      '</tr>'
    ).join('');
    const balBadge = mEntries.length > 0
      ? '<span style="background:'+(mBal?'#059669':'#dc2626')+';border-radius:20px;padding:2px 10px;font-size:10px;">'+(mBal?'‚úì Balanced':'‚úó Not Balanced')+'</span>'
      : '';
    const totalsRow = mEntries.length > 0
      ? '<div style="background:#f8fafc;border-top:2px solid #e2e8f0;padding:8px 12px;display:grid;grid-template-columns:1fr 1fr;gap:4px;"><div style="font-size:11px;color:#64748b;">Total Dr: <strong style="color:#059669;">'+fmt(mDr)+'</strong></div><div style="font-size:11px;color:#64748b;text-align:right;">Total Cr: <strong style="color:#dc2626;">'+fmt(mCr)+'</strong></div></div>'
      : '';
    const actionRow = mBal
      ? '<div style="padding:8px 14px;background:#ecfdf5;border-top:1px solid #a7f3d0;font-size:11px;font-weight:700;color:#065f46;">‚úÖ Entry is Balanced ‚Äî use the button below to post</div>'
      : '<div style="padding:8px 14px;background:#fef2f2;border-top:1px solid #fca5a5;font-size:11px;color:#991b1b;font-weight:600;">‚ö† Balance Dr = Cr to enable posting</div>';
    const emptyRow = '<tr><td colspan="5" style="padding:16px;text-align:center;color:#94a3b8;font-size:11px;">Fill account rows above to preview</td></tr>';
    return '<div style="background:#0f172a;color:#fff;padding:10px 14px;font-size:12px;font-weight:700;display:flex;justify-content:space-between;"><span>As per Double Entry (AS-1)</span>'+balBadge+'</div>' +
      '<table style="width:100%;border-collapse:collapse;font-size:11.5px;">' + th + '<tbody>'+(mRows||emptyRow)+'</tbody></table>' +
      totalsRow + actionRow;
  } else {
    const balBadge = preview.length > 0
      ? '<span style="background:'+(bal?'#059669':'#dc2626')+';border-radius:20px;padding:2px 10px;font-size:10px;">'+(bal?'‚úì Balanced':'‚úó Not Balanced')+'</span>'
      : '';
    // Journal/Contra hint
    if(preview.length===1 && preview[0]._journalHint){
      return '<div style="background:#0f172a;color:#fff;padding:10px 14px;font-size:12px;font-weight:700;">As per Double Entry (AS-1)</div>' +
        '<div style="padding:20px 16px;text-align:center;">' +
        '<div style="font-size:24px;margin-bottom:8px;">üìì</div>' +
        '<div style="font-size:13px;font-weight:700;color:#1e293b;margin-bottom:6px;">Journal / Contra Entry</div>' +
        '<div style="font-size:12px;color:#64748b;margin-bottom:14px;">These voucher types require manual account selection. Switch to Manual mode to enter Dr/Cr freely.</div>' +
        '<button class="btn btn-p" onclick="vMode=\'manual\';renderVouchers()" style="font-size:12px;">‚Üí Switch to Manual (Accounts) Mode</button>' +
        '</div>';
    }
    const emptyRow = '<tr><td colspan="5" style="padding:16px;text-align:center;color:#94a3b8;font-size:11px;">Select items above to see journal entries</td></tr>';
    const totalsRow = preview.length > 0
      ? '<div style="background:#f8fafc;border-top:2px solid #e2e8f0;padding:8px 12px;display:grid;grid-template-columns:1fr 1fr;gap:4px;"><div style="font-size:11px;color:#64748b;">Total Dr: <strong style="color:#059669;">'+fmt(totDr)+'</strong></div><div style="font-size:11px;color:#64748b;text-align:right;">Total Cr: <strong style="color:#dc2626;">'+fmt(totCr)+'</strong></div></div>'
      : '';
    return '<div style="background:#0f172a;color:#fff;padding:10px 14px;font-size:12px;font-weight:700;display:flex;justify-content:space-between;"><span>As per Double Entry (AS-1)</span>'+balBadge+'</div>' +
      '<table style="width:100%;border-collapse:collapse;font-size:11.5px;">' + th + '<tbody id="preview-tbody">'+(previewRows||emptyRow)+'</tbody></table>' +
      totalsRow;
  }
}

// ‚îÄ‚îÄ Item line helpers ‚îÄ‚îÄ
function calcLineTaxable(ln){ return Math.round((ln.qty||1)*(ln.rate||0)*(1-(ln.disc||0)/100)*100)/100; }
function calcLineTotal(ln){
  const t=calcLineTaxable(ln), g=ln.gstRate||0;
  if(ln.gstType&&ln.gstType.includes('Exempt'))return t;
  return Math.round(t*(1+g/100)*100)/100;
}
function calcTaxSummary(lines,vtype){
  let taxable=0,cgst=0,sgst=0,igst=0;
  lines.forEach(ln=>{
    const t=calcLineTaxable(ln), g=ln.gstRate||0;
    taxable+=t;
    if(ln.gstType&&ln.gstType.includes('IGST')) igst+=Math.round(t*g)/100;
    else if(!ln.gstType||ln.gstType.includes('Exempt')){}
    else{ cgst+=Math.round(t*(g/2))/100; sgst+=Math.round(t*(g/2))/100; }
  });
  // TDS
  let tds=0;
  const tdsEl=eid('v-tds');
  if(tdsEl&&tdsEl.value){
    const sec=TDS_SECTIONS.find(s=>s.code===tdsEl.value);
    if(sec) tds=Math.round(taxable*sec.rate)/100;
  }
  const grand=taxable+cgst+sgst+igst-tds;
  return{taxable:Math.round(taxable*100)/100,cgst:Math.round(cgst*100)/100,sgst:Math.round(sgst*100)/100,igst:Math.round(igst*100)/100,tds:Math.round(tds*100)/100,grand:Math.round(grand*100)/100};
}

function computePreviewEntries(vtype, lines){
  if(!lines||lines.every(ln=>!ln.rate||ln.rate===0))return[];
  const entries=[];
  const tax=calcTaxSummary(lines,vtype);
  const isSales=['Sales','Debit Note'].includes(vtype);
  const isPurchase=['Purchase','Credit Note'].includes(vtype);
  const isReceipt=vtype==='Receipt';
  const isPayment=vtype==='Payment';

  // Find default accounts
  const debtorAcc=state.accounts.find(a=>a.group==='Sundry Debtors');
  const creditorAcc=state.accounts.find(a=>a.group==='Sundry Creditors');
  const cashBankAcc=state.accounts.find(a=>a.group==='Cash & Bank'&&a.name.includes('Bank'))||state.accounts.find(a=>a.group==='Cash & Bank');

  // Get party account if selected
  const partyEl=eid('v-party');
  const partyId=partyEl?.value||'';
  let partyAccId='';
  if(partyId){
    const debtor=state.debtors.find(d=>d.id===partyId);
    const vendor=state.vendors.find(v=>v.id===partyId);
    if(debtor) partyAccId=debtorAcc?.id||'1003';
    if(vendor) partyAccId=creditorAcc?.id||'2001';
  }

  if(isSales){
    // Debit: Accounts Receivable (or party) for grand total
    entries.push({accId:partyAccId||debtorAcc?.id||'1003',dr:tax.grand,cr:0,tag:'Debtor Dr'});
    // Credit: each item's income account for taxable amount
    const incGroups={};
    lines.forEach(ln=>{
      const it=(state.items||[]).find(i=>i.id===ln.itemId);
      const accId=it?.incomeAccId||state.accounts.find(a=>a.type==='Income')?.id||'3001';
      const t=calcLineTaxable(ln);
      incGroups[accId]=(incGroups[accId]||0)+t;
    });
    Object.entries(incGroups).forEach(([accId,amt])=>entries.push({accId,dr:0,cr:Math.round(amt*100)/100,tag:'Sales Cr'}));
    if(tax.cgst>0) entries.push({accId:'2002',dr:0,cr:tax.cgst,tag:'Output CGST'});
    if(tax.sgst>0) entries.push({accId:'2003',dr:0,cr:tax.sgst,tag:'Output SGST'});
    if(tax.igst>0) entries.push({accId:'2004',dr:0,cr:tax.igst,tag:'Output IGST'});
    if(tax.tds>0){
      entries.push({accId:'2005',dr:0,cr:tax.tds,tag:'TDS Payable Cr'});
      entries[0].dr=Math.round((entries[0].dr-tax.tds)*100)/100;
    }
  } else if(isPurchase){
    // Debit: each item's expense account for taxable
    const expGroups={};
    lines.forEach(ln=>{
      const it=(state.items||[]).find(i=>i.id===ln.itemId);
      const accId=it?.expenseAccId||state.accounts.find(a=>a.type==='Expense')?.id||'4001';
      const t=calcLineTaxable(ln);
      expGroups[accId]=(expGroups[accId]||0)+t;
    });
    Object.entries(expGroups).forEach(([accId,amt])=>entries.push({accId,dr:Math.round(amt*100)/100,cr:0,tag:'Purchase Dr'}));
    if(tax.cgst>0) entries.push({accId:'1006',dr:tax.cgst,cr:0,tag:'Input CGST'});
    if(tax.sgst>0) entries.push({accId:'1007',dr:tax.sgst,cr:0,tag:'Input SGST'});
    if(tax.igst>0) entries.push({accId:'1008',dr:tax.igst,cr:0,tag:'Input IGST'});
    // Credit: Accounts Payable for grand total - TDS
    const net=tax.grand;
    entries.push({accId:partyAccId||creditorAcc?.id||'2001',dr:0,cr:net,tag:'Creditor Cr'});
    if(tax.tds>0) entries.push({accId:'2005',dr:0,cr:tax.tds,tag:'TDS Payable'});
  } else if(isReceipt||isPayment){
    const line=lines[0];
    const t=calcLineTaxable(line);
    if(isReceipt){
      entries.push({accId:cashBankAcc?.id||'1001',dr:tax.grand,cr:0,tag:'Cash/Bank Dr'});
      entries.push({accId:partyAccId||debtorAcc?.id||'1003',dr:0,cr:tax.grand,tag:'Debtor Cr'});
    } else {
      entries.push({accId:partyAccId||creditorAcc?.id||'2001',dr:tax.grand,cr:0,tag:'Creditor Dr'});
      entries.push({accId:cashBankAcc?.id||'1002',dr:0,cr:tax.grand,tag:'Cash/Bank Cr'});
    }
    if(tax.tds>0&&isPayment){
      const tdsSec=TDS_SECTIONS.find(s=>s.code===eid('v-tds')?.value);
      entries.push({accId:'2005',dr:0,cr:tax.tds,tag:`TDS ${tdsSec?.code||''}`});
      entries[1].cr=Math.round((entries[1].cr-tax.tds)*100)/100;
    }
  }
  // Journal / Contra ‚Äî not auto-computable, return special marker
  if(['Journal','Contra'].includes(vtype)) return [{_journalHint:true}];
  return entries.filter(e=>e.dr>0||e.cr>0);
}

function refreshPreview(){
  const curType=eid('v-type')?.value||'Sales';

  // ‚îÄ‚îÄ Update each row's Taxable & Total cells in real time ‚îÄ‚îÄ
  vItemLines.forEach((ln,i)=>{
    const taxCell=eid('row-taxable-'+i);
    const totCell=eid('row-total-'+i);
    if(taxCell) taxCell.textContent=fmt(calcLineTaxable(ln));
    if(totCell) totCell.textContent=fmt(calcLineTotal(ln));
  });

  // ‚îÄ‚îÄ Update tax summary box values ‚îÄ‚îÄ
  const tax=calcTaxSummary(vItemLines,curType);
  const upd=(id,val)=>{const el=eid(id);if(el)el.textContent=fmt(val);};
  upd('tax-taxable', tax.taxable);
  upd('tax-cgst',    tax.cgst);
  upd('tax-sgst',    tax.sgst);
  upd('tax-igst',    tax.igst);
  upd('tax-grand',   tax.grand);

  // ‚îÄ‚îÄ Update right-side journal preview ‚îÄ‚îÄ
  const preview=computePreviewEntries(curType,vItemLines);
  const totDr=preview.reduce((s,e)=>s+(e.dr||0),0);
  const totCr=preview.reduce((s,e)=>s+(e.cr||0),0);
  const bal=Math.abs(totDr-totCr)<0.01;
  const tbody=eid('preview-tbody');
  if(tbody){
    tbody.innerHTML=preview.map(e=>`
      <tr style="font-size:11px;">
        <td class="mono" style="color:#2563eb;padding:5px 8px;">${e.accId}</td>
        <td style="padding:5px 8px;">${aN(e.accId)||e.accId}</td>
        <td style="padding:5px 8px;"><span style="font-size:10px;background:#f1f5f9;border-radius:4px;padding:1px 6px;">${e.tag||''}</span></td>
        <td class="tr" style="padding:5px 8px;color:#059669;font-weight:600;">${e.dr>0?fmt(e.dr):'‚Äî'}</td>
        <td class="tr" style="padding:5px 8px;color:#dc2626;font-weight:600;">${e.cr>0?fmt(e.cr):'‚Äî'}</td>
      </tr>`).join('')||'<tr><td colspan="5" style="padding:12px;text-align:center;color:#94a3b8;">Enter line items to preview</td></tr>';
  }
  // Update balance badge
  const balBadge=eid('preview-bal');
  if(balBadge){
    const td2=preview.reduce((s,e)=>s+(e.dr||0),0),tc2=preview.reduce((s,e)=>s+(e.cr||0),0);
    const b2=Math.abs(td2-tc2)<0.01&&preview.length>0;
    balBadge.textContent=b2?'‚úì Balanced':'‚úó Not Balanced';
    balBadge.style.background=b2?'#059669':'#dc2626';
  }
}

function addItemRow(){vItemLines.push({itemId:'',desc:'',qty:1,rate:0,disc:0,gstRate:18,gstType:'CGST+SGST (Intra-state)'});renderVouchers();}
function remItemRow(i){vItemLines.splice(i,1);renderVouchers();}
function onItemSelect(i,itemId){
  vItemLines[i].itemId=itemId;
  const it=(state.items||[]).find(x=>x.id===itemId);
  if(it){
    vItemLines[i].desc=it.description||it.name;
    vItemLines[i].rate=(['Sales','Debit Note'].includes(eid('v-type')?.value||'Sales'))?it.saleRate:it.purchaseRate;
    vItemLines[i].gstRate=it.gstRate;
  }
  renderVouchers();
}
function onPartyChange(partyId,vtype){ refreshPreview(); }
function onVTypeChange(type){
  const partyEl=eid('v-party');
  if(partyEl){
    const list=['Sales','Debit Note','Receipt'].includes(type)?state.debtors:state.vendors;
    partyEl.innerHTML=`<option value="">‚Äî No party ‚Äî</option>`+list.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  }
  refreshPreview();
}

function showEntryPreviewAndSave(){
  const id=eid('v-id')?.value.trim()||'', dt=eid('v-date')?.value, tp=eid('v-type')?.value;
  const nar=eid('v-nar')?.value.trim()||'', ref=eid('v-ref')?.value.trim()||'';
  const partyId=eid('v-party')?.value||'', due=eid('v-due')?.value||'';
  const tdsSection=eid('v-tds')?.value||'';
  if(!nar)return showAlert('Narration is required');
  if(!dt) return showAlert('Date is required');

  const preview=computePreviewEntries(tp,vItemLines).filter(e=>!e._journalHint);
  if(['Journal','Contra'].includes(tp))return showAlert('Journal/Contra vouchers require Manual (Accounts) mode.\nPlease switch to Manual mode to enter your Dr/Cr entries.');
  if(!preview.length)return showAlert('Please add at least one item line with amount');
  const totDr=preview.reduce((s,e)=>s+(e.dr||0),0);
  const totCr=preview.reduce((s,e)=>s+(e.cr||0),0);
  const bal=Math.abs(totDr-totCr)<0.01;
  const tax=calcTaxSummary(vItemLines,tp);
  const items=vItemLines.filter(ln=>ln.rate>0).map(ln=>{
    const t=calcLineTaxable(ln), g=ln.gstRate||0;
    const igst=ln.gstType?.includes('IGST')?Math.round(t*g)/100:0;
    const cgst=igst===0?Math.round(t*(g/2))/100:0;
    const sgst=igst===0?Math.round(t*(g/2))/100:0;
    return{name:ln.desc||(state.items||[]).find(i=>i.id===ln.itemId)?.name||'Item',
      hsn:(state.items||[]).find(i=>i.id===ln.itemId)?.hsn||'',
      qty:ln.qty,rate:ln.rate,gstRate:g,taxableAmt:t,cgst,sgst,igst,total:calcLineTotal(ln)};
  });

  const entryRows=preview.map(e=>`
    <tr style="font-size:12px;">
      <td style="padding:8px 10px;border-bottom:1px solid #f1f5f9;">
        <span style="color:#2563eb;font-family:monospace;font-weight:600;">${e.accId}</span>
        <span style="margin-left:8px;">${aN(e.accId)||e.accId}</span>
        <span style="margin-left:6px;font-size:10px;background:#f1f5f9;border-radius:4px;padding:1px 6px;color:#64748b;">${e.tag||''}</span>
      </td>
      <td style="padding:8px 10px;border-bottom:1px solid #f1f5f9;text-align:right;color:#059669;font-weight:700;font-family:monospace;">${e.dr>0?fmt(e.dr):'‚Äî'}</td>
      <td style="padding:8px 10px;border-bottom:1px solid #f1f5f9;text-align:right;color:#dc2626;font-weight:700;font-family:monospace;">${e.cr>0?fmt(e.cr):'‚Äî'}</td>
    </tr>`).join('');

  openModal(`üìí Journal Entry Preview ‚Äî ${tp} | ${id}`, `
    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;">
      <strong>üìã Voucher:</strong> ${id} &nbsp;|&nbsp; <strong>Date:</strong> ${fmtD(dt)} &nbsp;|&nbsp; <strong>Type:</strong> ${tp} &nbsp;|&nbsp; <strong>Narration:</strong> ${nar}
      ${tdsSection?`&nbsp;|&nbsp; <strong>TDS:</strong> ${tdsSection}`:''}
    </div>
    <div style="margin-bottom:12px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#64748b;margin-bottom:8px;">As per Double-Entry (AS-1 / IND-AS 1)</div>
      <table style="width:100%;border-collapse:collapse;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;">
        <thead><tr style="background:#0f172a;color:#fff;">
          <th style="padding:8px 10px;text-align:left;font-size:11px;">Account</th>
          <th style="padding:8px 10px;text-align:right;font-size:11px;">Debit (Dr)</th>
          <th style="padding:8px 10px;text-align:right;font-size:11px;">Credit (Cr)</th>
        </tr></thead>
        <tbody>${entryRows}</tbody>
        <tfoot><tr style="background:#0f172a;color:#fff;font-weight:700;">
          <td style="padding:8px 10px;font-size:12px;">TOTAL</td>
          <td style="padding:8px 10px;text-align:right;">${fmt(totDr)}</td>
          <td style="padding:8px 10px;text-align:right;">${fmt(totCr)}</td>
        </tr></tfoot>
      </table>
    </div>
    <div style="background:${bal?'#ecfdf5':'#fef2f2'};border:1px solid ${bal?'#a7f3d0':'#fca5a5'};border-radius:8px;padding:9px 14px;margin-bottom:14px;font-size:12px;font-weight:700;color:${bal?'#065f46':'#991b1b'};">
      ${bal?'‚úÖ Entry is Balanced ‚Äî Ready to Post':'‚ùå Entry Not Balanced ‚Äî Cannot Post. Difference: '+fmt(Math.abs(totDr-totCr))}
    </div>
    ${tax.cgst>0||tax.sgst>0||tax.igst>0?`
    <div style="background:#fefce8;border:1px solid #fde68a;border-radius:8px;padding:9px 14px;margin-bottom:14px;font-size:12px;">
      <strong>GST Summary:</strong> Taxable: ${fmt(tax.taxable)} | CGST: ${fmt(tax.cgst)} | SGST: ${fmt(tax.sgst)} | IGST: ${fmt(tax.igst)}
      ${tax.tds>0?` | TDS: ${fmt(tax.tds)}`:''}
      | <strong>Net: ${fmt(tax.grand)}</strong>
    </div>`:''}
    <div style="display:flex;gap:10px;">
      ${bal?`<button class="btn btn-s" onclick="closeModal();_commitZohoVoucher('${id}','${dt}','${tp}','${encodeURIComponent(nar)}','${ref}','${partyId}','${due}','${tdsSection}')" style="flex:1;">‚úÖ Confirm &amp; Post Voucher</button>`:''}
      <button class="btn btn-g" onclick="closeModal()" style="flex:1;">‚úè Go Back &amp; Edit</button>
    </div>`);
}

function _commitZohoVoucher(id,dt,tp,narEnc,ref,partyId,due,tdsSection){
  const nar=decodeURIComponent(narEnc);
  const entries=computePreviewEntries(tp,vItemLines);
  const tax=calcTaxSummary(vItemLines,tp);
  const items=vItemLines.filter(ln=>ln.rate>0).map(ln=>{
    const t=calcLineTaxable(ln),g=ln.gstRate||0;
    const igst=ln.gstType?.includes('IGST')?Math.round(t*g)/100:0;
    const cgst=igst===0?Math.round(t*(g/2))/100:0, sgst=igst===0?Math.round(t*(g/2))/100:0;
    return{name:ln.desc||(state.items||[]).find(i=>i.id===ln.itemId)?.name||'Item',
      hsn:(state.items||[]).find(i=>i.id===ln.itemId)?.hsn||'',
      qty:ln.qty,rate:ln.rate,gstRate:g,taxableAmt:t,cgst,sgst,igst,total:calcLineTotal(ln)};
  });
  const vobj={id,date:dt,type:tp,narration:nar,ref,partyId,dueDate:due,entries,
    gstType:vItemLines[0]?.gstType||'',tdsSection,items,
    totals:{taxable:tax.taxable,cgst:tax.cgst,sgst:tax.sgst,igst:tax.igst,tds:tax.tds,grand:tax.grand}};
  if(editVId){
    state.vouchers=state.vouchers.map(v=>v.id===editVId?vobj:v);editVId=null;
  }else{
    if(state.vouchers.find(v=>v.id===id))return showAlert('Voucher ID already exists');
    state.vouchers.push(vobj);
  }
  logAudit(editVId?'Voucher Edited':'Voucher Created', `${tp} ${id}: ${nar}`);
  scheduleSave();
  showToast(`‚úÖ ${tp} Voucher <strong>${id}</strong> posted successfully!`);
  vItemLines=[{itemId:'',desc:'',qty:1,rate:0,disc:0,gstRate:18,gstType:'CGST+SGST (Intra-state)'}];
  renderVouchers();
}


function cancelEdit(){editVId=null;vItemLines=[{itemId:'',desc:'',qty:1,rate:0,disc:0,gstRate:18,gstType:'CGST+SGST (Intra-state)'}];vManualEntries=[{accId:'',dr:0,cr:0},{accId:'',dr:0,cr:0}];renderVouchers();}

function showManualPreviewAndPost(){
  const id=eid('v-id')?.value.trim(), dt=eid('v-date')?.value, tp=eid('v-type')?.value;
  const nar=eid('v-nar')?.value.trim()||'', ref=eid('v-ref')?.value.trim()||'';
  const partyId=eid('v-party')?.value||'', due=eid('v-due')?.value||'';
  if(!nar) return showAlert('Narration is required');
  if(!dt)  return showAlert('Date is required');
  // Read entries live from DOM
  const entries=[];
  document.querySelectorAll('.m-acc-row').forEach(row=>{
    const accId=row.querySelector('.m-acc')?.value||'';
    const dr=parseFloat(row.querySelector('.m-dr')?.value)||0;
    const cr=parseFloat(row.querySelector('.m-cr')?.value)||0;
    if(accId&&(dr>0||cr>0)) entries.push({accId,dr,cr});
  });
  if(entries.length<2) return showAlert('Add at least 2 account entries');
  const totDr=entries.reduce((s,e)=>s+(e.dr||0),0);
  const totCr=entries.reduce((s,e)=>s+(e.cr||0),0);
  if(Math.abs(totDr-totCr)>0.01) return showAlert('Entry not balanced!\nDebit: '+fmt(totDr)+' | Credit: '+fmt(totCr));

  // ‚îÄ‚îÄ Golden Rules Validation ‚îÄ‚îÄ
  const warnings=[];
  const cashBankIds=state.accounts.filter(a=>a.group==='Cash & Bank').map(a=>a.id);
  const liabilityIds=state.accounts.filter(a=>a.type==='Liability').map(a=>a.id);
  const assetIds=state.accounts.filter(a=>a.type==='Asset').map(a=>a.id);
  const incomeIds=state.accounts.filter(a=>a.type==='Income').map(a=>a.id);
  const expenseIds=state.accounts.filter(a=>a.type==='Expense').map(a=>a.id);

  const drAccIds=entries.filter(e=>e.dr>0).map(e=>e.accId);
  const crAccIds=entries.filter(e=>e.cr>0).map(e=>e.accId);

  if(tp==='Payment'){
    // Payment: Bank/Cash must be CREDITED (going out), not debited
    const bankDebited=drAccIds.some(id=>cashBankIds.includes(id));
    const bankCredited=crAccIds.some(id=>cashBankIds.includes(id));
    if(bankDebited && !bankCredited)
      warnings.push('‚ö†Ô∏è <strong>Payment voucher:</strong> Bank/Cash account should be <strong>Credited</strong> (money going OUT), not Debited. You appear to have it reversed.');
    // Liability should be debited (reducing what you owe)
    const liabDebited=drAccIds.some(id=>liabilityIds.includes(id));
    const liabCredited=crAccIds.some(id=>liabilityIds.includes(id));
    if(liabCredited && !liabDebited)
      warnings.push('‚ö†Ô∏è <strong>Payment voucher:</strong> Accounts Payable / Liability should be <strong>Debited</strong> (liability reducing), not Credited.');
  }
  if(tp==='Receipt'){
    // Receipt: Bank/Cash must be DEBITED (coming in)
    const bankDebited=drAccIds.some(id=>cashBankIds.includes(id));
    if(!bankDebited)
      warnings.push('‚ö†Ô∏è <strong>Receipt voucher:</strong> Bank/Cash account should be <strong>Debited</strong> (money coming IN).');
    // Income/Debtor should be credited
    const incOrDebtorCredited=crAccIds.some(id=>[...incomeIds,...assetIds].includes(id));
    if(!incOrDebtorCredited)
      warnings.push('‚ö†Ô∏è <strong>Receipt voucher:</strong> Income or Debtor account should be <strong>Credited</strong>.');
  }
  if(tp==='Sales'||tp==='Debit Note'){
    // Sales: Income must be CREDITED
    const incCredited=crAccIds.some(id=>incomeIds.includes(id));
    if(!incCredited)
      warnings.push('‚ö†Ô∏è <strong>Sales voucher:</strong> Income/Sales account should be <strong>Credited</strong> (Rule 3: Credit all incomes).');
  }
  if(tp==='Purchase'||tp==='Credit Note'){
    // Purchase: Expense must be DEBITED
    const expDebited=drAccIds.some(id=>expenseIds.includes(id));
    if(!expDebited)
      warnings.push('‚ö†Ô∏è <strong>Purchase voucher:</strong> Expense/Purchase account should be <strong>Debited</strong> (Rule 3: Debit all expenses).');
  }

  const entryRows=entries.map(e=>`
    <tr style="font-size:12px;">
      <td style="padding:8px 10px;border-bottom:1px solid #f1f5f9;">
        <span style="color:#2563eb;font-family:monospace;font-weight:600;">${e.accId}</span>
        <span style="margin-left:8px;">${aN(e.accId)||e.accId}</span>
      </td>
      <td style="padding:8px 10px;border-bottom:1px solid #f1f5f9;text-align:right;color:#059669;font-weight:700;font-family:monospace;">${e.dr>0?fmt(e.dr):'‚Äî'}</td>
      <td style="padding:8px 10px;border-bottom:1px solid #f1f5f9;text-align:right;color:#dc2626;font-weight:700;font-family:monospace;">${e.cr>0?fmt(e.cr):'‚Äî'}</td>
    </tr>`).join('');

  openModal('üìí Manual Journal Entry Preview ‚Äî '+tp+' | '+id, `
    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;">
      <strong>üìã Voucher:</strong> ${id} &nbsp;|&nbsp; <strong>Date:</strong> ${fmtD(dt)} &nbsp;|&nbsp; <strong>Type:</strong> ${tp} &nbsp;|&nbsp; <strong>Narration:</strong> ${nar}
      ${partyId?`&nbsp;|&nbsp; <strong>Party:</strong> ${partyId}`:''}
    </div>
    <div style="margin-bottom:12px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#64748b;margin-bottom:8px;">Double Entry (AS-1 Compliant)</div>
      <table style="width:100%;border-collapse:collapse;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;">
        <thead><tr style="background:#0f172a;color:#fff;">
          <th style="padding:8px 10px;text-align:left;font-size:11px;">Account</th>
          <th style="padding:8px 10px;text-align:right;font-size:11px;">Debit (Dr)</th>
          <th style="padding:8px 10px;text-align:right;font-size:11px;">Credit (Cr)</th>
        </tr></thead>
        <tbody>${entryRows}</tbody>
        <tfoot><tr style="background:#0f172a;color:#fff;font-weight:700;">
          <td style="padding:8px 10px;font-size:12px;">TOTAL</td>
          <td style="padding:8px 10px;text-align:right;">${fmt(totDr)}</td>
          <td style="padding:8px 10px;text-align:right;">${fmt(totCr)}</td>
        </tr></tfoot>
      </table>
    </div>
    ${warnings.length>0?`
    <div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;padding:12px 14px;margin-bottom:14px;">
      <div style="font-size:12px;font-weight:700;color:#991b1b;margin-bottom:8px;">‚ùå Accounting Error ‚Äî Golden Rules Violated</div>
      ${warnings.map(w=>'<div style="font-size:12px;color:#7f1d1d;margin-bottom:5px;padding-left:8px;border-left:3px solid #dc2626;">'+w+'</div>').join('')}
      <div style="font-size:11px;color:#991b1b;margin-top:8px;font-style:italic;">Please go back and correct the Dr/Cr sides before posting.</div>
    </div>`:''}
    <div style="background:${warnings.length>0?'#fefce8':'#ecfdf5'};border:1px solid ${warnings.length>0?'#fde68a':'#a7f3d0'};border-radius:8px;padding:9px 14px;margin-bottom:14px;font-size:12px;font-weight:700;color:${warnings.length>0?'#92400e':'#065f46'};">
      ${warnings.length>0?'‚ö†Ô∏è Mathematically Balanced but Accounting Rules Violated':'‚úÖ Entry is Balanced ‚Äî Ready to Post'}
    </div>
    <div style="display:flex;gap:8px;">
      ${warnings.length===0?`<button class="btn btn-s" onclick="closeModal();_postManualVoucher('${id}','${dt}','${tp}','${encodeURIComponent(nar)}','${ref}','${partyId}','${due}')">‚úÖ Confirm &amp; Post Voucher</button>`:''}
      <button class="btn ${warnings.length>0?'btn-p':'btn-g'}" onclick="closeModal()">‚úè Go Back &amp; Edit</button>
    </div>
  `);
  // Store entries for post
  window._pendingManualEntries = entries;
}

function _postManualVoucher(id,dt,tp,narEnc,ref,partyId,due){
  const nar=decodeURIComponent(narEnc);
  const entries=window._pendingManualEntries||[];
  if(!entries.length){showAlert('No entries found. Please try again.');return;}
  const totDr=entries.reduce((s,e)=>s+(e.dr||0),0);
  const vobj={id,date:dt,type:tp,narration:nar,ref,partyId,dueDate:due,entries,gstType:'',tdsSection:'',items:[],totals:{taxable:0,cgst:0,sgst:0,igst:0,tds:0,grand:totDr}};
  if(editVId){state.vouchers=state.vouchers.map(v=>v.id===editVId?vobj:v);editVId=null;}
  else{if(state.vouchers.find(v=>v.id===id))return showAlert('Voucher ID already exists');state.vouchers.push(vobj);}
  window._pendingManualEntries=[];
  scheduleSave();
  showToast('‚úÖ '+tp+' Voucher <strong>'+id+'</strong> posted successfully!');
  vManualEntries=[{accId:'',dr:0,cr:0},{accId:'',dr:0,cr:0}];
  editVId=null;
  renderVouchers();
}

function saveManualVoucher(){
  const id=eid('v-id')?.value.trim(),dt=eid('v-date')?.value,tp=eid('v-type')?.value;
  const nar=eid('v-nar')?.value.trim()||'',ref=eid('v-ref')?.value.trim()||'';
  const partyId=eid('v-party')?.value||'',due=eid('v-due')?.value||'',tdsSection=eid('v-tds')?.value||'';
  if(!id)return showAlert('Voucher ID is required');
  if(!dt)return showAlert('Date is required');
  if(!nar)return showAlert('Narration is required');
  // Read manual entry rows
  const entries=[];
  document.querySelectorAll('.m-acc-row').forEach((row,i)=>{
    const accId=row.querySelector('.m-acc')?.value||'';
    const dr=parseFloat(row.querySelector('.m-dr')?.value)||0;
    const cr=parseFloat(row.querySelector('.m-cr')?.value)||0;
    if(accId&&(dr>0||cr>0))entries.push({accId,dr,cr});
  });
  if(entries.length<2)return showAlert('Add at least 2 account entries');
  const totDr=entries.reduce((s,e)=>s+(e.dr||0),0);
  const totCr=entries.reduce((s,e)=>s+(e.cr||0),0);
  if(Math.abs(totDr-totCr)>0.01)return showAlert(`Entry not balanced!\nDebit: ‚Çπ${totDr.toFixed(2)} | Credit: ‚Çπ${totCr.toFixed(2)}\nDifference: ‚Çπ${Math.abs(totDr-totCr).toFixed(2)}`);
  const vobj={id,date:dt,type:tp,narration:nar,ref,partyId,dueDate:due,entries,gstType:'',tdsSection,items:[],totals:{taxable:0,cgst:0,sgst:0,igst:0,tds:0,grand:totDr}};
  if(editVId){state.vouchers=state.vouchers.map(v=>v.id===editVId?vobj:v);editVId=null;}
  else{if(state.vouchers.find(v=>v.id===id))return showAlert('Voucher ID already exists');state.vouchers.push(vobj);}
  scheduleSave();
  showToast(`‚úÖ ${tp} Voucher <strong>${id}</strong> posted!`);
  vItemLines=[{itemId:'',desc:'',qty:1,rate:0,disc:0,gstRate:18,gstType:'CGST+SGST (Intra-state)'}];
  editVId=null;renderVouchers();
}
function delVoucher(id){if(!confirm('Delete voucher?'))return;state.vouchers=state.vouchers.filter(v=>v.id!==id);scheduleSave();renderVouchers();}
function exportVouchers(){
  exportXLS([[state.company,'','','',''],['VOUCHER REGISTER','','','',''],
    ['Voucher No.','Date','Type','Narration','Ref','Amount'],
    ...state.vouchers.map(v=>[v.id,v.date,v.type,v.narration,v.ref||'',v.entries.reduce((s,e)=>s+(e.dr||0),0)])
  ],'Vouchers','Voucher_Register.xlsx');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: REGISTERS (Sales / Purchase / Debit Note / Credit Note / Journal)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgRegister(type){
  const isDetailed=['Sales','Purchase'].includes(type);
  const vouchers=[...state.vouchers].filter(v=>v.type===type).sort((a,b)=>a.date.localeCompare(b.date));

  // ‚îÄ‚îÄ Summary totals ‚îÄ‚îÄ
  const totals=vouchers.reduce((acc,v)=>{
    const t=v.totals||{};
    acc.taxable+=(t.taxable||0);
    acc.cgst+=(t.cgst||0);
    acc.sgst+=(t.sgst||0);
    acc.igst+=(t.igst||0);
    acc.tds+=(t.tds||0);
    acc.grand+=(t.grand||v.entries.reduce((s,e)=>s+(e.dr||0),0));
    return acc;
  },{taxable:0,cgst:0,sgst:0,igst:0,tds:0,grand:0});

  // ‚îÄ‚îÄ Build table rows ‚îÄ‚îÄ
  const rows=vouchers.map((v,i)=>{
    const t=v.totals||{};
    const party=v.partyId?(['Sales','Debit Note'].includes(v.type)?
      state.debtors.find(d=>d.id===v.partyId):
      state.vendors.find(x=>x.id===v.partyId)):null;
    const amt=t.grand||v.entries.reduce((s,e)=>s+(e.dr||0),0);

    if(isDetailed){
      const itemsHtml=(v.items&&v.items.length>0)?
        v.items.map(it=>`<div style="font-size:10px;color:#475569;padding:1px 0;">${it.name||'‚Äî'} √ó ${it.qty} @ ‚Çπ${it.rate} = ‚Çπ${fmt(it.total||0)}</div>`).join('')
        :'<span style="font-size:10px;color:#94a3b8;">No item details</span>';
      return`<tr class="${i%2?'alt':''}">
        <td class="mono tb-" style="white-space:nowrap;">${v.id}</td>
        <td style="white-space:nowrap;">${fmtD(v.date)}</td>
        <td>${party?`<strong>${party.name}</strong>${party.gstn?`<div style="font-size:10px;color:#64748b;">GSTIN: ${party.gstn}</div>`:''}` :'<span class="tm-">‚Äî</span>'}</td>
        <td class="tm-" style="font-size:11px;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${v.narration}</td>
        <td style="font-size:11px;">${v.ref||'‚Äî'}</td>
        <td style="max-width:160px;">${itemsHtml}</td>
        <td class="tr mono">${fmt(t.taxable||0)}</td>
        <td class="tr mono tg-">${fmt(t.cgst||0)}</td>
        <td class="tr mono tg-">${fmt(t.sgst||0)}</td>
        <td class="tr mono" style="color:#7c3aed;">${fmt(t.igst||0)}</td>
        <td class="tr mono tr-">${t.tds>0?fmt(t.tds):'‚Äî'}</td>
        <td class="tr mono" style="font-weight:700;color:#059669;">${fmt(amt)}</td>
        <td class="no-print"><button class="btn btn-g btn-sm" onclick="editVoucher('${v.id}')">‚úè</button> <button class="btn btn-d btn-sm" onclick="delVoucherReg('${v.id}','${type}')">‚úï</button></td>
      </tr>`;
    } else {
      // Journal / Debit Note / Credit Note ‚Äî simpler view
      const drAcc=v.entries.filter(e=>e.dr>0).map(e=>`${aN(e.accId)||e.accId}`).join(', ');
      const crAcc=v.entries.filter(e=>e.cr>0).map(e=>`${aN(e.accId)||e.accId}`).join(', ');
      return`<tr class="${i%2?'alt':''}">
        <td class="mono tb-" style="white-space:nowrap;">${v.id}</td>
        <td style="white-space:nowrap;">${fmtD(v.date)}</td>
        <td>${party?`<strong>${party.name}</strong>`:'<span class="tm-">‚Äî</span>'}</td>
        <td class="tm-" style="font-size:11px;">${v.narration}</td>
        <td style="font-size:11px;">${v.ref||'‚Äî'}</td>
        <td style="font-size:11px;color:#059669;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${drAcc}">${drAcc||'‚Äî'}</td>
        <td style="font-size:11px;color:#dc2626;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${crAcc}">${crAcc||'‚Äî'}</td>
        <td class="tr mono" style="font-weight:700;">${fmt(amt)}</td>
        <td class="no-print"><button class="btn btn-g btn-sm" onclick="editVoucher('${v.id}')">‚úè</button> <button class="btn btn-d btn-sm" onclick="delVoucherReg('${v.id}','${type}')">‚úï</button></td>
      </tr>`;
    }
  }).join('');

  const iconMap={'Sales':'üßæ','Purchase':'üõí','Debit Note':'üì§','Credit Note':'üì•','Journal':'üìì'};
  const colorMap={'Sales':'sc-g','Purchase':'sc-b','Debit Note':'sc-o','Credit Note':'sc-p','Journal':'sc-r'};
  const regKey=type.toLowerCase().replace(' ','-');

  eid('content').innerHTML=`
  <div class="page-full">
  <div class="tb no-print" style="margin-bottom:14px;">
    <div style="font-weight:700;font-size:14px;">${iconMap[type]||'üìã'} ${type} Register ‚Äî FY ${state.fy}</div>
    <button class="btn btn-s" onclick="exportRegister('${type}')" style="margin-left:auto;">‚¨á Export Excel</button>
    <button class="btn btn-p" onclick="navigate('vouchers')" style="margin-left:6px;">+ New ${type}</button>
  </div>

  <!-- Summary cards -->
  ${isDetailed?`
  <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:14px;">
    <div class="sc ${colorMap[type]}"><div class="sl">Entries</div><div class="sv" style="font-size:16px;">${vouchers.length}</div></div>
    <div class="sc sc-b"><div class="sl">Taxable</div><div class="sv" style="font-size:14px;">${fmt(totals.taxable)}</div></div>
    <div class="sc sc-g"><div class="sl">CGST</div><div class="sv" style="font-size:14px;">${fmt(totals.cgst)}</div></div>
    <div class="sc sc-g"><div class="sl">SGST</div><div class="sv" style="font-size:14px;">${fmt(totals.sgst)}</div></div>
    <div class="sc sc-p"><div class="sl">IGST</div><div class="sv" style="font-size:14px;">${fmt(totals.igst)}</div></div>
    <div class="sc ${colorMap[type]}"><div class="sl">Grand Total</div><div class="sv" style="font-size:14px;">${fmt(totals.grand)}</div></div>
  </div>`:`
  <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px;">
    <div class="sc ${colorMap[type]||'sc-b'}"><div class="sl">Total Entries</div><div class="sv">${vouchers.length}</div></div>
    <div class="sc sc-g"><div class="sl">Total Amount</div><div class="sv">${fmt(totals.grand)}</div></div>
  </div>`}

  <!-- Register Table -->
  <div class="card pf-grid" style="overflow-x:auto;">
    <table class="tbl">
      <thead><tr>
        <th>Voucher No.</th><th>Date</th><th>Party</th><th>Narration</th><th>Ref</th>
        ${isDetailed?`
        <th>Items</th>
        <th class="tr">Taxable</th>
        <th class="tr">CGST</th>
        <th class="tr">SGST</th>
        <th class="tr">IGST</th>
        <th class="tr">TDS</th>
        <th class="tr">Grand Total</th>`:`
        <th>Debit A/c</th>
        <th>Credit A/c</th>
        <th class="tr">Amount</th>`}
        <th class="no-print">Actions</th>
      </tr></thead>
      <tbody>${rows||`<tr><td colspan="${isDetailed?13:9}" style="padding:28px;text-align:center;color:var(--tm);font-size:13px;">No ${type} entries found. <button class="btn btn-p btn-sm" onclick="navigate('vouchers')" style="margin-left:8px;">+ Create ${type}</button></td></tr>`}</tbody>
      ${vouchers.length>0&&isDetailed?`
      <tfoot><tr class="tf">
        <td colspan="6" class="tr">TOTALS</td>
        <td class="tr">${fmt(totals.taxable)}</td>
        <td class="tr">${fmt(totals.cgst)}</td>
        <td class="tr">${fmt(totals.sgst)}</td>
        <td class="tr">${fmt(totals.igst)}</td>
        <td class="tr">${totals.tds>0?fmt(totals.tds):'‚Äî'}</td>
        <td class="tr">${fmt(totals.grand)}</td>
        <td></td>
      </tr></tfoot>`:''}
    </table>
  </div>
  </div>`;
}

function delVoucherReg(id,type){
  if(!confirm('Delete this voucher?'))return;
  state.vouchers=state.vouchers.filter(v=>v.id!==id);
  scheduleSave();
  showToast('üóë Voucher deleted','#dc2626');
  pgRegister(type);
}

function editVoucher(id){
  const v=state.vouchers.find(x=>x.id===id);if(!v)return;
  editVId=id;
  vMode=v.items&&v.items.length>0?'smart':'manual';
  if(vMode==='smart'){
    vItemLines=v.items&&v.items.length>0?v.items.map(it=>({
      itemId:it.itemId||'',desc:it.name||'',qty:it.qty||1,
      rate:it.rate||0,disc:it.disc||0,gstRate:it.gstRate||0,
      gstType:it.gstType||'CGST+SGST (Intra-state)'
    })):[{itemId:'',desc:'',qty:1,rate:0,disc:0,gstRate:18,gstType:'CGST+SGST (Intra-state)'}];
  } else {
    vManualEntries=v.entries.length>=2?v.entries.map(e=>({accId:e.accId,dr:e.dr||0,cr:e.cr||0})):[{accId:'',dr:0,cr:0},{accId:'',dr:0,cr:0}];
  }
  navigate('vouchers');
  setTimeout(()=>{
    if(eid('v-id'))eid('v-id').value=v.id;
    if(eid('v-date'))eid('v-date').value=v.date;
    if(eid('v-type')){eid('v-type').value=v.type;onVTypeChange(v.type);}
    if(eid('v-nar'))eid('v-nar').value=v.narration;
    if(eid('v-ref'))eid('v-ref').value=v.ref||'';
    if(eid('v-due'))eid('v-due').value=v.dueDate||'';
    if(eid('v-party'))eid('v-party').value=v.partyId||'';
    if(eid('v-tds'))eid('v-tds').value=v.tdsSection||'';
    refreshPreview();
  },50);
}

function exportRegister(type){
  const vouchers=[...state.vouchers].filter(v=>v.type===type).sort((a,b)=>a.date.localeCompare(b.date));
  const isDetailed=['Sales','Purchase'].includes(type);
  const co=state.company, fy=state.fy;
  const fname=type.replace(' ','_');

  if(isDetailed){
    // ‚îÄ‚îÄ Detailed multi-sheet export for Sales / Purchase ‚îÄ‚îÄ
    const summaryData=[
      [co,'','','','','','','','','',''],
      [`${type.toUpperCase()} REGISTER ‚Äî DETAILED`,'','','','','','','','','',''],
      [`Financial Year: ${fy}`,'','','','','','','','','',''],
      [],
      ['Voucher No.','Date','Party Name','Party GSTIN','Narration','Ref / PO No.',
       'Taxable Amount','CGST','SGST','IGST','TDS Deducted','Grand Total'],
    ];
    vouchers.forEach(v=>{
      const t=v.totals||{};
      const party=v.partyId?(['Sales','Debit Note'].includes(v.type)?
        state.debtors.find(d=>d.id===v.partyId):
        state.vendors.find(x=>x.id===v.partyId)):null;
      const amt=t.grand||v.entries.reduce((s,e)=>s+(e.dr||0),0);
      summaryData.push([
        v.id, v.date, party?.name||'‚Äî', party?.gstn||'‚Äî',
        v.narration, v.ref||'‚Äî',
        t.taxable||0, t.cgst||0, t.sgst||0, t.igst||0,
        t.tds||0, amt
      ]);
    });
    // Totals row
    const tot=vouchers.reduce((acc,v)=>{const t=v.totals||{};acc.taxable+=(t.taxable||0);acc.cgst+=(t.cgst||0);acc.sgst+=(t.sgst||0);acc.igst+=(t.igst||0);acc.tds+=(t.tds||0);acc.grand+=(t.grand||v.entries.reduce((s,e)=>s+(e.dr||0),0));return acc;},{taxable:0,cgst:0,sgst:0,igst:0,tds:0,grand:0});
    summaryData.push([]);
    summaryData.push(['TOTAL','','','','','',tot.taxable,tot.cgst,tot.sgst,tot.igst,tot.tds,tot.grand]);

    // Item-level detail sheet
    const itemData=[
      [co,'','','','','','','','','','',''],
      [`${type.toUpperCase()} REGISTER ‚Äî ITEM-WISE DETAIL`,'','','','','','','','','','',''],
      [`Financial Year: ${fy}`,'','','','','','','','','','',''],
      [],
      ['Voucher No.','Date','Party Name','Item Name','HSN/SAC','Qty','Rate','Disc%',
       'Taxable Amt','CGST%','CGST Amt','SGST%','SGST Amt','IGST%','IGST Amt','Total'],
    ];
    vouchers.forEach(v=>{
      const party=v.partyId?(['Sales','Debit Note'].includes(v.type)?
        state.debtors.find(d=>d.id===v.partyId):
        state.vendors.find(x=>x.id===v.partyId)):null;
      if(v.items&&v.items.length>0){
        v.items.forEach(it=>{
          const g=it.gstRate||0;
          const isIGST=(it.gstType||'').includes('IGST');
          itemData.push([
            v.id, v.date, party?.name||'‚Äî',
            it.name||'‚Äî', it.hsn||it.sac||'‚Äî',
            it.qty||1, it.rate||0, it.disc||0, it.taxableAmt||it.taxable||0,
            isIGST?0:g/2, isIGST?0:(it.cgst||0),
            isIGST?0:g/2, isIGST?0:(it.sgst||0),
            isIGST?g:0, isIGST?(it.igst||0):0,
            it.total||0
          ]);
        });
      } else {
        const amt=v.entries.reduce((s,e)=>s+(e.dr||0),0);
        itemData.push([v.id,v.date,party?.name||'‚Äî','‚Äî','‚Äî','‚Äî','‚Äî','‚Äî',amt,'‚Äî','‚Äî','‚Äî','‚Äî','‚Äî','‚Äî',amt]);
      }
    });

    exportMultiXLS([
      {name:`${type} Summary`,data:summaryData},
      {name:`${type} Item Detail`,data:itemData}
    ],`${fname}_Register_FY${fy}.xlsx`);

  } else {
    // Simple export for Journal / Debit Note / Credit Note
    const data=[
      [co,'','','','',''],
      [`${type.toUpperCase()} REGISTER`,'','','','',''],
      [`Financial Year: ${fy}`,'','','','',''],
      [],
      ['Voucher No.','Date','Narration','Ref','Debit Accounts','Credit Accounts','Amount'],
      ...vouchers.map(v=>{
        const amt=v.entries.reduce((s,e)=>s+(e.dr||0),0);
        const drAcc=v.entries.filter(e=>e.dr>0).map(e=>aN(e.accId)||e.accId).join(' | ');
        const crAcc=v.entries.filter(e=>e.cr>0).map(e=>aN(e.accId)||e.accId).join(' | ');
        return[v.id,v.date,v.narration,v.ref||'‚Äî',drAcc,crAcc,amt];
      })
    ];
    const totAmt=vouchers.reduce((s,v)=>s+v.entries.reduce((x,e)=>x+(e.dr||0),0),0);
    data.push([]);
    data.push(['TOTAL','','','','','',totAmt]);
    exportXLS(data,`${type} Register`,`${fname}_Register_FY${fy}.xlsx`);
  }
}

// ‚îÄ‚îÄ PDF PRINT for SALES / CREDIT NOTE ‚îÄ‚îÄ
function printVoucher(id){
  const v=state.vouchers.find(x=>x.id===id);if(!v)return;
  const party=v.partyId?(['Sales','Debit Note'].includes(v.type)?state.debtors.find(d=>d.id===v.partyId):state.vendors.find(vd=>vd.id===v.partyId)):null;
  const totAmt=v.totals?.grand||v.entries.reduce((s,e)=>s+(e.dr||0),0);
  const itemRows=(v.items||[]).length>0?v.items.map(it=>`<tr><td>${it.name}</td><td>${it.hsn||'‚Äî'}</td><td style="text-align:right">${it.qty}</td><td style="text-align:right">${fmt(it.rate)}</td><td style="text-align:right">${fmt(it.taxableAmt)}</td><td style="text-align:right">${fmt(it.cgst)}</td><td style="text-align:right">${fmt(it.sgst)}</td><td style="text-align:right">${fmt(it.igst)}</td><td style="text-align:right;font-weight:700;">${fmt(it.total)}</td></tr>`).join(''):'';
  const win=window.open('','_blank','width=900,height=750');
  win.document.write(`<!DOCTYPE html><html><head><title>${v.type} ‚Äî ${v.id}</title>
  <style>body{font-family:'Segoe UI',sans-serif;margin:0;padding:28px;color:#1e293b;font-size:13px;}
  .inv-header{display:flex;justify-content:space-between;border-bottom:3px solid #2563eb;padding-bottom:16px;margin-bottom:16px;}
  .co-name{font-size:22px;font-weight:700;}.co-info{font-size:11px;color:#64748b;margin-top:3px;}
  .inv-title{font-size:26px;font-weight:700;color:#2563eb;text-align:right;}.inv-no{font-size:13px;color:#64748b;text-align:right;}
  table{width:100%;border-collapse:collapse;margin-bottom:16px;}th{background:#0f172a;color:#fff;padding:8px 10px;font-size:11px;}
  td{padding:8px 10px;border-bottom:1px solid #e2e8f0;}.grandtot{background:#0f172a;color:#fff;padding:12px 16px;border-radius:8px;display:flex;justify-content:space-between;font-size:15px;font-weight:700;margin-bottom:16px;}
  .gst-box{background:#f0fdf4;border:1px solid #a7f3d0;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;}
  .footer{border-top:1px solid #e2e8f0;padding-top:12px;font-size:10px;color:#94a3b8;display:flex;justify-content:space-between;}
  @media print{button{display:none!important;}}</style></head><body>
  <div class="inv-header">
    <div><div class="co-name">${state.company}</div><div class="co-info">GSTIN: ${state.gstin||'‚Äî'} | FY: ${state.fy}</div></div>
    <div><div class="inv-title">${v.type.toUpperCase()}</div><div class="inv-no"># ${v.id} | ${fmtD(v.date)}</div></div>
  </div>
  ${party?`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:#94a3b8;margin-bottom:5px;">Bill To</div>
      <div style="font-size:14px;font-weight:700;">${party.name}</div>
      <div style="font-size:11px;color:#64748b;">${[party.address,party.city,party.state,party.pincode].filter(Boolean).join(', ')}</div>
      ${party.gstRegistered?`<div style="font-size:11px;font-weight:600;margin-top:4px;">GSTIN: ${party.gstn}</div>`:''}
    </div>
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:#94a3b8;margin-bottom:5px;">Details</div>
      ${v.ref?`<div style="font-size:12px;">Ref: <strong>${v.ref}</strong></div>`:''}
      ${v.dueDate?`<div style="font-size:12px;color:#dc2626;">Due: <strong>${fmtD(v.dueDate)}</strong></div>`:''}
      ${v.tdsSection?`<div style="font-size:12px;">TDS: <strong>${v.tdsSection}</strong></div>`:''}
    </div>
  </div>`:''}
  ${(v.items||[]).length>0?`
  <table><thead><tr><th>Item</th><th>HSN/SAC</th><th style="text-align:right">Qty</th><th style="text-align:right">Rate</th><th style="text-align:right">Taxable</th><th style="text-align:right">CGST</th><th style="text-align:right">SGST</th><th style="text-align:right">IGST</th><th style="text-align:right">Total</th></tr></thead>
  <tbody>${itemRows}</tbody></table>
  <div class="gst-box"><strong>GST Summary:</strong> Taxable: ${fmt(v.totals?.taxable||0)} | CGST: ${fmt(v.totals?.cgst||0)} | SGST: ${fmt(v.totals?.sgst||0)} | IGST: ${fmt(v.totals?.igst||0)}${v.totals?.tds?` | TDS Deducted: ${fmt(v.totals.tds)}`:''}</div>`:''}
  <div class="grandtot"><span>GRAND TOTAL</span><span>${fmt(totAmt)}</span></div>
  <div class="footer"><span>Generated by AccounTally Pro (Zoho-Style)</span><span>${new Date().toLocaleString('en-IN')}</span></div>
  <div style="text-align:center;margin-top:18px;"><button onclick="window.print()" style="padding:9px 22px;background:#2563eb;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">üñ® Print / PDF</button></div>
  </body></html>`);
  win.document.close();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: DAY BOOK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgDayBook(){renderDayBook(state.fyStart,state.fyEnd);}
function renderDayBook(df,dt){
  const fil=state.vouchers.filter(v=>v.date>=df&&v.date<=dt).sort((a,b)=>a.date.localeCompare(b.date));
  let rows='';
  fil.forEach((v,vi)=>{v.entries.forEach((e,ei)=>{
    rows+=`<tr class="${vi%2?'alt':''}">
      ${ei===0?`<td rowspan="${v.entries.length}">${fmtD(v.date)}</td><td rowspan="${v.entries.length}" class="mono tb-">${v.id}</td><td rowspan="${v.entries.length}"><span class="badge ${bcol(v.type)}">${v.type}</span></td>`:''}
      <td>${aN(e.accId)}</td>
      ${ei===0?`<td rowspan="${v.entries.length}" class="tm-" style="font-size:11px;">${v.narration}</td>`:''}
      <td class="tr tg-">${e.dr?fmt(e.dr):''}</td><td class="tr tr-">${e.cr?fmt(e.cr):''}</td>
    </tr>`;
  });});
  eid('content').innerHTML=`
  <div class="tb no-print">
    <span class="fl" style="white-space:nowrap;">From:</span><input type="date" class="fc" id="db-f" value="${df}" style="width:150px;">
    <span class="fl" style="white-space:nowrap;">To:</span><input type="date" class="fc" id="db-t" value="${dt}" style="width:150px;">
    <button class="btn btn-p" onclick="renderDayBook(eid('db-f').value,eid('db-t').value)">Filter</button>
    <button class="btn btn-s" onclick="exportDayBook(eid('db-f').value,eid('db-t').value)" style="margin-left:auto;">‚¨á Excel</button>
  </div>
  <div class="card"><table class="tbl">
    <thead><tr><th>Date</th><th>Voucher</th><th>Type</th><th>Account</th><th>Narration</th><th class="tr">Debit</th><th class="tr">Credit</th></tr></thead>
    <tbody>${rows||'<tr><td colspan="7" style="padding:20px;text-align:center;color:var(--tm)">No transactions in this period</td></tr>'}</tbody>
  </table></div>`;
}
function exportDayBook(df,dt){
  const fil=state.vouchers.filter(v=>v.date>=df&&v.date<=dt).sort((a,b)=>a.date.localeCompare(b.date));
  const data=[[state.company,'','','','','',''],['DAY BOOK','','','','','',''],['Period:',`${df} to ${dt}`,'','','','',''],[]
    ,['Date','Voucher','Type','Account','Narration','Debit','Credit']];
  fil.forEach(v=>v.entries.forEach(e=>data.push([v.date,v.id,v.type,aN(e.accId),v.narration,e.dr||0,e.cr||0])));
  exportXLS(data,'Day Book',`Day_Book_${df}_to_${dt}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: CASH BOOK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgCashBook(){const ca=state.accounts.filter(a=>a.group==='Cash & Bank');renderCashBook(ca[0]?.id||'');}
function renderCashBook(selId){
  const L=computeLedger();const ca=state.accounts.filter(a=>a.group==='Cash & Bank');
  const acc=L[selId];let rb=acc?(acc.nature==='Dr'?acc.balance:-acc.balance):0;
  let rows='';
  if(acc){
    rows+=`<tr style="background:#eff6ff;"><td>‚Äî</td><td class="tb-">Opening Balance</td><td></td><td class="tr tg-">${acc.nature==='Dr'?fmt(acc.balance):''}</td><td class="tr tr-">${acc.nature==='Cr'?fmt(acc.balance):''}</td><td class="tr"><strong>${fmt(Math.abs(rb))} ${rb>=0?'Dr':'Cr'}</strong></td></tr>`;
    acc.txns.sort((a,b)=>a.date.localeCompare(b.date)).forEach((t,i)=>{rb+=(t.dr||0)-(t.cr||0);
      rows+=`<tr class="${i%2?'alt':''}"><td>${fmtD(t.date)}</td><td>${t.narration}</td><td class="mono tb-">${t.vno}</td><td class="tr tg-">${t.dr?fmt(t.dr):''}</td><td class="tr tr-">${t.cr?fmt(t.cr):''}</td><td class="tr"><strong>${fmt(Math.abs(rb))} ${rb>=0?'Dr':'Cr'}</strong></td></tr>`;
    });
  }
  eid('content').innerHTML=`
  <div class="tb no-print">
    <select class="fc" onchange="renderCashBook(this.value)" style="min-width:220px;">${ca.map(a=>`<option value="${a.id}" ${a.id===selId?'selected':''}>${a.name}</option>`).join('')}</select>
    ${acc?`<span class="fy-badge">Closing: ${fmt(acc.closingDr||acc.closingCr)}</span>`:''}
    <button class="btn btn-s" onclick="exportCashBook('${selId}')" style="margin-left:auto;">‚¨á Excel</button>
  </div>
  ${acc?`<div class="card"><div class="ch">Cash Book ‚Äî ${acc.name}</div>
  <table class="tbl"><thead><tr><th>Date</th><th>Particulars</th><th>Voucher</th><th class="tr">Receipts (Dr)</th><th class="tr">Payments (Cr)</th><th class="tr">Balance</th></tr></thead>
  <tbody>${rows}</tbody><tfoot><tr class="tf"><td colspan="3">CLOSING BALANCE</td><td class="tr">${acc.closingDr?fmt(acc.closingDr):''}</td><td class="tr">${acc.closingCr?fmt(acc.closingCr):''}</td><td class="tr">${fmt(acc.closingDr||acc.closingCr)}</td></tr></tfoot>
  </table></div>`:'<div class="al al-w">No Cash & Bank accounts found.</div>'}`;
}
function exportCashBook(selId){
  const L=computeLedger();const acc=L[selId];if(!acc)return;
  let rb=acc.nature==='Dr'?acc.balance:-acc.balance;
  const data=[[state.company,'','','','',''],['CASH BOOK','','','','',''],['Account:',acc.name,'','','',''],[]
    ,['Date','Particulars','Voucher No.','Receipts (Dr)','Payments (Cr)','Balance']
    ,['','Opening Balance','',acc.nature==='Dr'?acc.balance:'',acc.nature==='Cr'?acc.balance:'',Math.abs(rb)]
    ,...acc.txns.sort((a,b)=>a.date.localeCompare(b.date)).map(t=>{rb+=(t.dr||0)-(t.cr||0);return[t.date,t.narration,t.vno,t.dr||'',t.cr||'',Math.abs(rb)];})
    ,['','Closing Balance','',acc.closingDr||'',acc.closingCr||'',acc.closingDr||acc.closingCr]];
  exportXLS(data,'Cash Book',`Cash_Book_${acc.name.replace(/\s+/g,'_')}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: LEDGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgLedger(){renderLedger(state.accounts[0]?.id||'');}
function renderLedger(selId){
  const L=computeLedger();const acc=L[selId];let rb=acc?(acc.nature==='Dr'?acc.balance:-acc.balance):0;
  let rows='';
  if(acc){
    rows+=`<tr style="background:#eff6ff;"><td>‚Äî</td><td class="tb-">Opening Balance</td><td></td><td></td><td class="tr tg-">${acc.nature==='Dr'?fmtN(acc.balance):''}</td><td class="tr tr-">${acc.nature==='Cr'?fmtN(acc.balance):''}</td><td class="tr"><strong>${fmtN(Math.abs(rb))} ${rb>=0?'Dr':'Cr'}</strong></td></tr>`;
    acc.txns.sort((a,b)=>a.date.localeCompare(b.date)).forEach((t,i)=>{rb+=(t.dr||0)-(t.cr||0);
      rows+=`<tr class="${i%2?'alt':''}"><td>${fmtD(t.date)}</td><td>${t.narration}</td><td class="mono tb-">${t.vno}</td><td><span class="badge ${bcol(t.vtype)}">${t.vtype}</span></td><td class="tr tg-">${t.dr?fmtN(t.dr):''}</td><td class="tr tr-">${t.cr?fmtN(t.cr):''}</td><td class="tr"><strong>${fmtN(Math.abs(rb))} ${rb>=0?'Dr':'Cr'}</strong></td></tr>`;
    });
  }
  const aOpts=state.accounts.map(a=>`<option value="${a.id}" ${a.id===selId?'selected':''}>${a.id} ‚Äî ${a.name}</option>`).join('');
  eid('content').innerHTML=`
  <div class="tb no-print">
    <select class="fc" onchange="renderLedger(this.value)" style="min-width:280px;">${aOpts}</select>
    <button class="btn btn-s" onclick="exportLedger('${selId}')" style="margin-left:auto;">‚¨á Excel</button>
  </div>
  ${acc?`<div class="card"><div class="ch">${acc.name} <span style="font-size:11px;opacity:.7;font-weight:400;">${acc.group} | ${acc.type}</span></div>
  <table class="tbl"><thead><tr><th>Date</th><th>Particulars</th><th>Voucher</th><th>Type</th><th class="tr">Debit</th><th class="tr">Credit</th><th class="tr">Balance</th></tr></thead>
  <tbody>${rows}</tbody><tfoot><tr class="tf"><td colspan="4">CLOSING BALANCE</td><td class="tr">${acc.closingDr?fmtN(acc.closingDr):''}</td><td class="tr">${acc.closingCr?fmtN(acc.closingCr):''}</td><td class="tr">${fmtN(acc.closingDr||acc.closingCr)} ${acc.closingDr>0?'Dr':'Cr'}</td></tr></tfoot>
  </table></div>`:''}`;
}
function exportLedger(selId){
  const L=computeLedger();const acc=L[selId];if(!acc)return;
  let rb=acc.nature==='Dr'?acc.balance:-acc.balance;
  const data=[[state.company,'','','','','',''],['LEDGER','','','','','',''],['Account:',acc.name,'Group:',acc.group,'Type:',acc.type,''],[]
    ,['Date','Particulars','Voucher','Type','Debit','Credit','Balance']
    ,['','Opening Balance','','',acc.nature==='Dr'?acc.balance:'',acc.nature==='Cr'?acc.balance:'',Math.abs(rb)]
    ,...acc.txns.sort((a,b)=>a.date.localeCompare(b.date)).map(t=>{rb+=(t.dr||0)-(t.cr||0);return[t.date,t.narration,t.vno,t.vtype,t.dr||'',t.cr||'',Math.abs(rb)];})
    ,['','CLOSING BALANCE','','',acc.closingDr||'',acc.closingCr||'',acc.closingDr||acc.closingCr]];
  exportXLS(data,'Ledger',`Ledger_${acc.name.replace(/\s+/g,'_')}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: TRIAL BALANCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgTrial(){
  const L=computeLedger();const rows=state.accounts.map(a=>({...a,...L[a.id]}));
  const totDr=rows.reduce((s,r)=>s+(r.closingDr||0),0),totCr=rows.reduce((s,r)=>s+(r.closingCr||0),0);
  const bal=Math.abs(totDr-totCr)<1;
  let tableRows='';
  ['Asset','Liability','Income','Expense','Capital'].forEach(type=>{
    const tr=rows.filter(r=>r.type===type);if(!tr.length)return;
    tableRows+=`<tr style="background:#f1f5f9;"><td colspan="4" style="font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#475569;padding:8px 13px;">${type}s</td></tr>`;
    tr.forEach((r,i)=>tableRows+=`<tr class="${i%2?'alt':''}">
      <td class="mono tb-">${r.id}</td><td>${r.name} <span class="tm-" style="font-size:10px;">(${r.group})</span></td>
      <td class="tr tg-">${r.closingDr?fmtN(r.closingDr):'‚Äî'}</td><td class="tr tr-">${r.closingCr?fmtN(r.closingCr):'‚Äî'}</td>
    </tr>`);
  });
  eid('content').innerHTML=`
  <div class="page-full">
  <div class="tb no-print">
    <div class="${bal?'al al-s':'al al-d'}" style="margin:0;padding:8px 13px;">${bal?'‚úì Trial Balance is Balanced':'‚ö† Not Balanced ‚Äî Diff: '+fmt(Math.abs(totDr-totCr))}</div>
    <button class="btn btn-s" onclick="exportTrial()" style="margin-left:auto;">‚¨á Excel</button>
  </div>
  <div class="card pf-grid"><table class="tbl">
    <thead><tr><th style="width:13%">Acc. ID</th><th>Account Name</th><th class="tr" style="width:22%">Debit (Dr)</th><th class="tr" style="width:22%">Credit (Cr)</th></tr></thead>
    <tbody>${tableRows}</tbody>
    <tfoot><tr class="tf"><td colspan="2" class="tr">GRAND TOTAL</td><td class="tr">${fmtN(totDr)}</td><td class="tr">${fmtN(totCr)}</td></tr></tfoot>
  </table></div>
  </div>`;
}
function exportTrial(){
  const L=computeLedger();const rows=state.accounts.map(a=>({...a,...L[a.id]}));
  const totDr=rows.reduce((s,r)=>s+(r.closingDr||0),0),totCr=rows.reduce((s,r)=>s+(r.closingCr||0),0);
  exportXLS([[state.company,'','',''],['TRIAL BALANCE','','',''],['Financial Year:',state.fy,'',''],[]
    ,['Account ID','Account Name','Debit (Dr)','Credit (Cr)']
    ,...rows.map(r=>[r.id,r.name,r.closingDr||0,r.closingCr||0])
    ,['','TOTAL',totDr,totCr]],'Trial Balance','Trial_Balance.xlsx');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: PARTY-WISE OUTSTANDING REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let outTab = 'debtors';

function pgOutstanding(){ outTab = outTab||'debtors'; renderOutstanding(); }

function renderOutstanding(){
  // ‚îÄ‚îÄ Build debtor outstanding ‚îÄ‚îÄ
  const debtorMap = {};
  state.debtors.forEach(d => { debtorMap[d.id] = {id:d.id, name:d.name, contact:d.contact||'', invoiced:0, received:0, vouchers:[]}; });

  // ‚îÄ‚îÄ Build creditor outstanding ‚îÄ‚îÄ
  const creditorMap = {};
  state.vendors.forEach(v => { creditorMap[v.id] = {id:v.id, name:v.name, contact:v.contact||'', invoiced:0, paid:0, vouchers:[]}; });

  state.vouchers.forEach(v => {
    if(!v.partyId) return;
    const amt = v.entries.reduce((s,e) => s + (e.dr||0), 0);
    // Debtors: Sales & Debit Note = they owe us | Receipt & Credit Note = they paid/adjusted
    if(['Sales','Debit Note'].includes(v.type) && debtorMap[v.partyId]){
      debtorMap[v.partyId].invoiced += amt;
      debtorMap[v.partyId].vouchers.push({...v, amt});
    }
    if(['Receipt','Credit Note'].includes(v.type) && debtorMap[v.partyId]){
      debtorMap[v.partyId].received += amt;
    }
    // Creditors: Purchase = we owe them | Payment/Debit Note/Credit Note = we paid/adjusted/returned
    // Credit Note from vendor = they credited us = reduces what we owe = counts as PAID
    if(['Purchase'].includes(v.type) && creditorMap[v.partyId]){
      creditorMap[v.partyId].invoiced += amt;
      creditorMap[v.partyId].vouchers.push({...v, amt});
    }
    if(['Payment','Debit Note','Credit Note'].includes(v.type) && creditorMap[v.partyId]){
      creditorMap[v.partyId].paid += amt;
    }
  });

  const debtors = Object.values(debtorMap).map(d => ({...d, outstanding: d.invoiced - d.received})).sort((a,b) => b.outstanding - a.outstanding);
  const creditors = Object.values(creditorMap).map(c => ({...c, outstanding: c.invoiced - c.paid})).sort((a,b) => b.outstanding - a.outstanding);

  const totDebOut = debtors.reduce((s,d) => s + Math.max(d.outstanding,0), 0);
  const totCredOut = creditors.reduce((s,c) => s + Math.max(c.outstanding,0), 0);
  const totDebInv = debtors.reduce((s,d) => s + d.invoiced, 0);
  const totCredInv = creditors.reduce((s,c) => s + c.invoiced, 0);

  const dRows = debtors.map((d,i) => {
    const os = d.outstanding;
    const pct = d.invoiced > 0 ? ((d.received / d.invoiced)*100).toFixed(0) : 0;
    const osClass = os > 0 ? 'tr-' : os < 0 ? 'tg-' : 'tm-';
    return `<tr class="${i%2?'alt':''}">
      <td class="fw-bold">${d.name}</td>
      <td class="tm-" style="font-size:11px;">${d.contact||'‚Äî'}</td>
      <td class="tr mono tg-">${fmt(d.invoiced)}</td>
      <td class="tr mono tb-">${fmt(d.received)}</td>
      <td class="tr mono fw-bold ${osClass}">${fmt(Math.abs(os))} ${os<0?'<span class="badge bg-" style="font-size:9px;">Advance</span>':os===0?'<span class="badge bgr" style="font-size:9px;">Cleared</span>':''}</td>
      <td class="tc">
        <div style="background:#e2e8f0;border-radius:20px;height:8px;width:80px;overflow:hidden;display:inline-block;">
          <div style="background:#059669;height:100%;width:${Math.min(pct,100)}%;border-radius:20px;"></div>
        </div>
        <span style="font-size:10px;color:var(--tm);margin-left:4px;">${pct}%</span>
      </td>
      <td><button class="btn btn-g btn-sm" onclick="viewPartyLedger('debtor','${d.id}','${d.name.replace(/'/g,"\\'")}')">üìñ Ledger</button></td>
    </tr>`;
  }).join('');

  const cRows = creditors.map((c,i) => {
    const os = c.outstanding;
    const pct = c.invoiced > 0 ? ((c.paid / c.invoiced)*100).toFixed(0) : 0;
    const osClass = os > 0 ? 'tr-' : os < 0 ? 'tg-' : 'tm-';
    return `<tr class="${i%2?'alt':''}">
      <td class="fw-bold">${c.name}</td>
      <td class="tm-" style="font-size:11px;">${c.contact||'‚Äî'}</td>
      <td class="tr mono tr-">${fmt(c.invoiced)}</td>
      <td class="tr mono tb-">${fmt(c.paid)}</td>
      <td class="tr mono fw-bold ${osClass}">${fmt(Math.abs(os))} ${os<0?'<span class="badge bg-" style="font-size:9px;">Advance</span>':os===0?'<span class="badge bgr" style="font-size:9px;">Cleared</span>':''}</td>
      <td class="tc">
        <div style="background:#e2e8f0;border-radius:20px;height:8px;width:80px;overflow:hidden;display:inline-block;">
          <div style="background:#2563eb;height:100%;width:${Math.min(pct,100)}%;border-radius:20px;"></div>
        </div>
        <span style="font-size:10px;color:var(--tm);margin-left:4px;">${pct}%</span>
      </td>
      <td><button class="btn btn-g btn-sm" onclick="viewPartyLedger('creditor','${c.id}','${c.name.replace(/'/g,"\\'")}')">üìñ Ledger</button></td>
    </tr>`;
  }).join('');

  eid('content').innerHTML = `
  <div class="sg" style="grid-template-columns:repeat(4,1fr);margin-bottom:14px;">
    <div class="sc sc-r"><div class="sl">Total Receivable</div><div class="sv">${fmt(totDebOut)}</div><div class="ss">${debtors.filter(d=>d.outstanding>0).length} customers pending</div></div>
    <div class="sc sc-b"><div class="sl">Total Payable</div><div class="sv">${fmt(totCredOut)}</div><div class="ss">${creditors.filter(c=>c.outstanding>0).length} vendors pending</div></div>
    <div class="sc sc-g"><div class="sl">Total Invoiced (Sales)</div><div class="sv">${fmt(totDebInv)}</div><div class="ss">Across all customers</div></div>
    <div class="sc sc-o"><div class="sl">Total Invoiced (Purchase)</div><div class="sv">${fmt(totCredInv)}</div><div class="ss">Across all vendors</div></div>
  </div>
  <div class="tb no-print" style="margin-bottom:12px;">
    <div class="tg">
      <button class="t ${outTab==='debtors'?'act':''}" onclick="outTab='debtors';renderOutstanding()">ü§ù Debtors / Receivable</button>
      <button class="t ${outTab==='creditors'?'act':''}" onclick="outTab='creditors';renderOutstanding()">üè≠ Creditors / Payable</button>
    </div>
    <button class="btn btn-s" onclick="exportOutstanding()" style="margin-left:auto;">‚¨á Export Excel</button>
  </div>
  ${outTab==='debtors' ? `
  <div class="card">
    <div class="ch">ü§ù Customer-wise Outstanding (Receivable)</div>
    <table class="tbl">
      <thead><tr><th>Customer Name</th><th>Contact</th><th class="tr">Invoiced</th><th class="tr">Received</th><th class="tr">Outstanding</th><th class="tc">Collected %</th><th>Action</th></tr></thead>
      <tbody>${dRows || '<tr><td colspan="7" style="padding:20px;text-align:center;color:var(--tm)">No debtors or vouchers found</td></tr>'}</tbody>
      <tfoot><tr class="tf"><td colspan="2">TOTAL</td><td class="tr">${fmt(totDebInv)}</td><td class="tr">${fmt(debtors.reduce((s,d)=>s+d.received,0))}</td><td class="tr">${fmt(totDebOut)}</td><td colspan="2"></td></tr></tfoot>
    </table>
  </div>` : `
  <div class="card">
    <div class="ch">üè≠ Vendor-wise Outstanding (Payable)</div>
    <table class="tbl">
      <thead><tr><th>Vendor Name</th><th>Contact</th><th class="tr">Invoiced</th><th class="tr">Paid</th><th class="tr">Outstanding</th><th class="tc">Paid %</th><th>Action</th></tr></thead>
      <tbody>${cRows || '<tr><td colspan="7" style="padding:20px;text-align:center;color:var(--tm)">No vendors or vouchers found</td></tr>'}</tbody>
      <tfoot><tr class="tf"><td colspan="2">TOTAL</td><td class="tr">${fmt(totCredInv)}</td><td class="tr">${fmt(creditors.reduce((s,c)=>s+c.paid,0))}</td><td class="tr">${fmt(totCredOut)}</td><td colspan="2"></td></tr></tfoot>
    </table>
  </div>`}`;
}

function viewPartyLedger(type, partyId, partyName){
  const vouchers = state.vouchers.filter(v => v.partyId === partyId);
  if(!vouchers.length){ showAlert('No vouchers found for '+partyName); return; }
  const isDebtor = type === 'debtor';
  let running = 0;
  const rows = [...vouchers].sort((a,b) => a.date.localeCompare(b.date)).map((v,i) => {
    const amt = v.entries.reduce((s,e) => s+(e.dr||0), 0);
    // For creditors: Purchase = Dr (amount we owe increases); Payment/Credit Note/Debit Note = Cr (reduces what we owe)
    const isDebit = isDebtor ? ['Sales','Debit Note'].includes(v.type) : ['Purchase'].includes(v.type);
    if(isDebit) running += amt; else running -= amt;
    return `<tr class="${i%2?'alt':''}">
      <td>${fmtD(v.date)}</td>
      <td class="mono tb-">${v.id}</td>
      <td><span class="badge ${bcol(v.type)}">${v.type}</span></td>
      <td class="tm-">${v.narration}</td>
      <td class="tr tg-">${isDebit?fmt(amt):''}</td>
      <td class="tr tr-">${!isDebit?fmt(amt):''}</td>
      <td class="tr fw-bold ${running>0?'tr-':running<0?'tg-':'tm-'}">${fmt(Math.abs(running))} ${running>0?(isDebtor?'Receivable':'Payable'):running<0?'Advance':'NIL'}</td>
    </tr>`;
  }).join('');
  openModal('üìñ '+partyName+' ‚Äî Party Ledger', `
    <table class="tbl" style="width:100%;">
      <thead><tr><th>Date</th><th>Voucher</th><th>Type</th><th>Narration</th><th class="tr">${isDebtor?'Invoice/Dr':'Purchase/Cr'}</th><th class="tr">${isDebtor?'Receipt/Cr':'Payment/Dr'}</th><th class="tr">Balance</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr class="tf"><td colspan="4">CLOSING BALANCE</td><td colspan="2"></td><td class="tr">${fmt(Math.abs(running))} ${running>0?(isDebtor?'Receivable':'Payable'):running<0?'Advance':'NIL'}</td></tr></tfoot>
    </table>
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button class="btn btn-g" onclick="closeModal()">Close</button>
    </div>
  `);
}

function exportOutstanding(){
  const debtorMap = {};
  state.debtors.forEach(d => { debtorMap[d.id] = {name:d.name, invoiced:0, received:0}; });
  const creditorMap = {};
  state.vendors.forEach(v => { creditorMap[v.id] = {name:v.name, invoiced:0, paid:0}; });
  state.vouchers.forEach(v => {
    if(!v.partyId) return;
    const amt = v.entries.reduce((s,e) => s+(e.dr||0), 0);
    if(['Sales','Debit Note'].includes(v.type) && debtorMap[v.partyId]) debtorMap[v.partyId].invoiced += amt;
    if(['Receipt','Credit Note'].includes(v.type) && debtorMap[v.partyId]) debtorMap[v.partyId].received += amt;
    if(['Purchase'].includes(v.type) && creditorMap[v.partyId]) creditorMap[v.partyId].invoiced += amt;
    if(['Credit Note'].includes(v.type) && creditorMap[v.partyId]) creditorMap[v.partyId].paid += amt;
    if(['Payment','Debit Note'].includes(v.type) && creditorMap[v.partyId]) creditorMap[v.partyId].paid += amt;
  });
  const dRows = Object.values(debtorMap).map(d => [d.name, d.invoiced, d.received, d.invoiced - d.received]);
  const cRows = Object.values(creditorMap).map(c => [c.name, c.invoiced, c.paid, c.invoiced - c.paid]);
  exportMultiXLS([
    {name:'Debtors Outstanding', data:[[state.company,'','',''],['DEBTORS OUTSTANDING - FY '+state.fy,'','',''],['Customer','Invoiced','Received','Outstanding'],...dRows]},
    {name:'Creditors Outstanding', data:[[state.company,'','',''],['CREDITORS OUTSTANDING - FY '+state.fy,'','',''],['Vendor','Invoiced','Paid','Outstanding'],...cRows]}
  ], `Outstanding_Report_FY${state.fy}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: P&L
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgPnL(){
  const L=computeLedger();
  const aL=(t,g)=>state.accounts.filter(a=>a.type===t&&(g?a.group===g:true)).map(a=>({...a,...L[a.id]}));
  const sI=aL('Income','Sales Accounts'),dI=aL('Income','Direct Income'),svcI=aL('Income','Service Income'),inI=aL('Income','Indirect Income');
  const pE=aL('Expense','Purchase Accounts'),dE=aL('Expense','Direct Expenses'),cogsE=aL('Expense','COGS'),inE=aL('Expense','Indirect Expenses');
  // Net approach: income accounts may have Dr balance (returns/refunds), expense may have Cr balance (rebates)
  const sC=arr=>arr.reduce((s,a)=>s+(a.closingCr||0)-(a.closingDr||0),0);
  const sD=arr=>arr.reduce((s,a)=>s+(a.closingDr||0)-(a.closingCr||0),0);
  const gI=sC(sI)+sC(dI)+sC(svcI),gE=sD(pE)+sD(dE)+sD(cogsE),gP=gI-gE,iI=sC(inI),iE=sD(inE),nP=gP+iI-iE;
  const rows=(arr,t='cr')=>arr.length?arr.map(a=>`<div class="rr"><span class="rrl">${a.name}</span><span class="rrv">${fmt(t==='cr'?a.closingCr:a.closingDr)}</span></div>`).join(''):`<div class="rr"><span class="rrl tm-" style="font-style:italic;">No entries</span></div>`;
  eid('content').innerHTML=`
  <div class="page-full">
  <div class="tb no-print" style="margin-bottom:14px;">
    <div style="font-weight:700;font-size:14px;">Profit & Loss ‚Äî FY ${state.fy}</div>
    <button class="btn btn-s" onclick="exportPnL()" style="margin-left:auto;">‚¨á Excel</button>
  </div>
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px;">
    <div class="sc ${gP>=0?'sc-g':'sc-r'}" style="border-radius:12px;"><div class="sl">Gross ${gP>=0?'Profit':'Loss'}</div><div class="sv">${fmt(Math.abs(gP))}</div></div>
    <div class="sc ${nP>=0?'sc-b':'sc-r'}" style="border-radius:12px;"><div class="sl">Net ${nP>=0?'Profit':'Loss'}</div><div class="sv">${fmt(Math.abs(nP))}</div></div>
    <div class="sc sc-p" style="border-radius:12px;"><div class="sl">Net Margin</div><div class="sv">${gI>0?((nP/gI)*100).toFixed(1):0}%</div></div>
  </div>
  <div class="g2 pf-grid" style="align-items:stretch;">
    <div class="rp"><div style="font-size:15px;font-weight:700;padding-bottom:11px;border-bottom:2px solid var(--bdr);margin-bottom:10px;">üìà Income</div>
      <div class="rst" style="margin-top:0;">Sales / Service / Direct Income</div>${rows([...sI,...dI,...svcI])}
      <div class="rtot rt-g"><span>Gross Income</span><span>${fmt(gI)}</span></div>
      <div class="rst">Indirect Income</div>${rows(inI)}
      <div class="rg"><span>TOTAL INCOME</span><span>${fmt(gI+iI)}</span></div>
    </div>
    <div class="rp"><div style="font-size:15px;font-weight:700;padding-bottom:11px;border-bottom:2px solid var(--bdr);margin-bottom:10px;">üìâ Expenses</div>
      <div class="rst" style="margin-top:0;">Purchase / Direct / COGS</div>${rows([...pE,...dE,...cogsE],'dr')}
      <div class="rtot rt-r"><span>Gross Expenses</span><span>${fmt(gE)}</span></div>
      <div class="rst">Indirect Expenses</div>${rows(inE,'dr')}
      <div class="rtot rt-r" style="margin-top:8px;"><span>Total Expenses</span><span>${fmt(gE+iE)}</span></div>
      <div class="rg" style="background:${nP>=0?'#1e3a6e':'#7f1d1d'};margin-top:10px;"><span>NET ${nP>=0?'PROFIT':'LOSS'}</span><span>${fmt(Math.abs(nP))}</span></div>
    </div>
  </div>
  </div>`;
}
function exportPnL(){
  const L=computeLedger();
  const aL=(t,g)=>state.accounts.filter(a=>a.type===t&&(g?a.group===g:true)).map(a=>({...a,...L[a.id]}));
  const sI=aL('Income','Sales Accounts'),dI=aL('Income','Direct Income'),svcI=aL('Income','Service Income'),inI=aL('Income','Indirect Income');
  const pE=aL('Expense','Purchase Accounts'),dE=aL('Expense','Direct Expenses'),cogsE=aL('Expense','COGS'),inE=aL('Expense','Indirect Expenses');
  const sC=arr=>arr.reduce((s,a)=>s+(a.closingCr||0)-(a.closingDr||0),0);
  const sD=arr=>arr.reduce((s,a)=>s+(a.closingDr||0)-(a.closingCr||0),0);
  const gI=sC(sI)+sC(dI)+sC(svcI),gE=sD(pE)+sD(dE)+sD(cogsE),iI=sC(inI),iE=sD(inE),nP=gI-gE+iI-iE;
  exportXLS([[state.company,''],['PROFIT & LOSS',''],['FY:',state.fy],[],
    ['INCOME','Amount'],['Sales / Direct',''],[...[...sI,...dI].map(a=>['  '+a.name,a.closingCr||0])],
    ['Gross Income',gI],[],['Indirect Income',''],[...inI.map(a=>['  '+a.name,a.closingCr||0])],[],
    ['EXPENSES',''],['Purchase / Direct',''],[...[...pE,...dE].map(a=>['  '+a.name,a.closingDr||0])],
    ['Gross Expenses',gE],[],['Indirect Expenses',''],[...inE.map(a=>['  '+a.name,a.closingDr||0])],[],
    ['NET PROFIT / (LOSS)',nP]],'P&L',`Profit_Loss_FY${state.fy}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: BALANCE SHEET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgBalance(){
  const L=computeLedger();
  const aL=t=>state.accounts.filter(a=>a.type===t).map(a=>({...a,...L[a.id]}));
  const cap=aL('Capital'),liab=aL('Liability'),assets=aL('Asset');
  const incR=aL('Income'),expR=aL('Expense');

  // ‚îÄ‚îÄ BUG FIX: use NET values so balance sheet always balances ‚îÄ‚îÄ
  // Old code used only closingDr/closingCr ‚Äî ignoring accounts with reversed balances
  // (e.g. TDS Payable with Dr balance = TDS Receivable; Fixed Assets with Cr balance = depreciation)
  // Net approach: Asset(Dr‚àíCr) = Cap(Cr‚àíDr) + Liab(Cr‚àíDr) + Inc(Cr‚àíDr) + Exp(Cr‚àíDr) always holds
  const netVal=a=>(a.closingDr||0)-(a.closingCr||0); // positive = Dr balance, negative = Cr balance
  const totCap=cap.reduce((s,a)=>s+(a.closingCr||0)-(a.closingDr||0),0);
  const totLiab=liab.reduce((s,a)=>s+(a.closingCr||0)-(a.closingDr||0),0);
  const totAssets=assets.reduce((s,a)=>s+(a.closingDr||0)-(a.closingCr||0),0);
  // Net Profit: income Cr balance minus expense Dr balance (net each to handle contra entries)
  const nP=incR.reduce((s,a)=>s+(a.closingCr||0)-(a.closingDr||0),0)
           -expR.reduce((s,a)=>s+(a.closingDr||0)-(a.closingCr||0),0);
  const totSrc=totCap+nP+totLiab;
  const bal=Math.abs(totSrc-totAssets)<1;

  // Display helper: show net value for each account line
  // If an asset has Cr balance (like depreciated fixed asset), show it as 0 (net offset in total)
  // If a liability has Dr balance (like TDS Receivable), show it under a special section
  const drBalLiab=liab.filter(a=>(a.closingDr||0)>(a.closingCr||0)); // Liab with Dr balance = hidden asset
  const crBalAssets=assets.filter(a=>(a.closingCr||0)>(a.closingDr||0)); // Assets with Cr balance = contra
  const rows=(arr,key,netFn)=>arr.map(a=>{
    const v=netFn?netFn(a):(a[key]||0);
    return`<div class="rr"><span class="rrl">${a.name}</span><span class="rrv">${fmt(Math.abs(v))}${v<0?' <span style="font-size:10px;color:#dc2626;">(Cr)</span>':''}</span></div>`;
  }).join('');
  eid('content').innerHTML=`
  <div class="page-full">
  <div class="tb no-print">
    <div style="font-weight:700;font-size:14px;">Balance Sheet ‚Äî FY ${state.fy}</div>
    <div class="${bal?'al al-s':'al al-d'}" style="margin:0;padding:6px 12px;font-size:11px;">${bal?'‚úì Balanced':'‚ö† Diff: '+fmt(Math.abs(totSrc-totAssets))}</div>
    ${!bal?`<button class="btn btn-d" onclick="diagUnbalancedVouchers()" style="font-size:11px;padding:5px 10px;">üîç Find Unbalanced Vouchers</button>`:''}
    <button class="btn btn-s" onclick="exportBalance()" style="margin-left:auto;">‚¨á Excel</button>
  </div>
  <div class="g2 pf-grid" style="align-items:stretch;">
    <div class="rp"><div style="font-size:15px;font-weight:700;padding-bottom:11px;border-bottom:2px solid var(--bdr);margin-bottom:10px;">üí≥ Sources of Funds</div>
      <div class="rst" style="margin-top:0;">Capital & Reserves</div>${rows(cap)}
      <div class="rr" style="padding-left:12px;"><span>Add: Net ${nP>=0?'Profit':'Loss'}</span><span class="rrv ${nP>=0?'tg-':'tr-'}">${fmt(Math.abs(nP))}</span></div>
      <div class="rtot rt-b"><span>Total Capital</span><span>${fmt(totCap+nP)}</span></div>
      <div class="rst">Liabilities</div>${liab.map(a=>{
        const net=(a.closingCr||0)-(a.closingDr||0);
        if(net<=0) return ''; // Dr-balance liabilities shown in Assets section
        return`<div class="rr"><span class="rrl">${a.name}</span><span class="rrv">${fmt(net)}</span></div>`;
      }).join('')}
      <div class="rtot rt-b"><span>Total Liabilities</span><span>${fmt(totLiab)}</span></div>
      <div class="rg"><span>TOTAL SOURCES</span><span>${fmt(totSrc)}</span></div>
    </div>
    <div class="rp"><div style="font-size:15px;font-weight:700;padding-bottom:11px;border-bottom:2px solid var(--bdr);margin-bottom:10px;">üèó Application of Funds</div>
      ${['Fixed Assets','Cash & Bank','Sundry Debtors','Stock-in-Hand','Loans & Advances','Current Assets'].map(grp=>{
        const it=assets.filter(a=>a.group===grp);
        return it.length?`<div class="rst">${grp}</div>${it.map(a=>{
          const net=(a.closingDr||0)-(a.closingCr||0);
          return`<div class="rr"><span class="rrl">${a.name}${net<0?' <span style="font-size:9px;color:#dc2626;">[Contra]</span>':''}</span><span class="rrv ${net<0?'tr-':''}">${fmt(Math.abs(net))}</span></div>`;
        }).join('')}`:'';
      }).join('')}
      ${drBalLiab.length?`<div class="rst" style="color:#c2410c;">Debit Balance Accounts (receivables)</div>
        ${drBalLiab.map(a=>{const net=(a.closingDr||0)-(a.closingCr||0);return`<div class="rr"><span class="rrl">${a.name} <span style="font-size:9px;background:#fff7ed;color:#c2410c;border-radius:3px;padding:1px 4px;">Dr Bal</span></span><span class="rrv">${fmt(net)}</span></div>`;}).join('')}`:''}
      <div class="rg"><span>TOTAL ASSETS</span><span>${fmt(totAssets)}</span></div>
    </div>
  </div>
  </div>`;
}
function diagUnbalancedVouchers(){
  // Find all vouchers where Dr ‚â† Cr (should never happen but can occur with manual edits)
  const unbal = state.vouchers.filter(v=>{
    const dr = v.entries.reduce((s,e)=>s+(e.dr||0),0);
    const cr = v.entries.reduce((s,e)=>s+(e.cr||0),0);
    return Math.abs(dr-cr) > 0.01;
  }).map(v=>{
    const dr = v.entries.reduce((s,e)=>s+(e.dr||0),0);
    const cr = v.entries.reduce((s,e)=>s+(e.cr||0),0);
    return {...v, drTotal:dr, crTotal:cr, diff:dr-cr};
  });

  // Also find opening balance imbalance
  const opDr = state.accounts.filter(a=>a.nature==='Dr').reduce((s,a)=>s+(a.balance||0),0);
  const opCr = state.accounts.filter(a=>a.nature==='Cr').reduce((s,a)=>s+(a.balance||0),0);
  const opDiff = opDr - opCr;

  const rows = unbal.map((v,i)=>`
    <tr class="${i%2?'alt':''}">
      <td class="mono tb-">${v.id}</td>
      <td>${fmtD(v.date)}</td>
      <td><span class="badge ${bcol(v.type)}">${v.type}</span></td>
      <td class="tm-" style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${v.narration}</td>
      <td class="tr tg-">${fmt(v.drTotal)}</td>
      <td class="tr tr-">${fmt(v.crTotal)}</td>
      <td class="tr fw-bold ${v.diff>0?'tr-':'tg-'}">${fmt(Math.abs(v.diff))} ${v.diff>0?'Dr excess':'Cr excess'}</td>
      <td><button class="btn btn-g btn-sm" onclick="closeModal();editVoucher('${v.id}')">‚úè Fix</button></td>
    </tr>`).join('');

  openModal('üîç Balance Sheet Diagnostic', `
    ${Math.abs(opDiff)>0.01?`
    <div class="al al-d" style="margin-bottom:12px;">
      ‚ö† Opening Balances Unbalanced by ${fmt(Math.abs(opDiff))} ‚Äî go to Chart of Accounts to fix.
    </div>`:''}
    ${unbal.length===0&&Math.abs(opDiff)<0.01?`
    <div class="al al-s">‚úÖ All vouchers are balanced and opening balances are correct.<br>
    The difference may be due to Income/Expense accounts with reversed balances ‚Äî this is handled automatically in the display.</div>
    `:`
    <div class="al al-w" style="margin-bottom:12px;">Found <strong>${unbal.length}</strong> unbalanced voucher${unbal.length!==1?'s':''}.
    Each must have equal Dr and Cr totals.</div>
    <table class="tbl" style="width:100%;">
      <thead><tr><th>Voucher</th><th>Date</th><th>Type</th><th>Narration</th><th class="tr">Total Dr</th><th class="tr">Total Cr</th><th class="tr">Difference</th><th>Action</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`}
    <div style="margin-top:12px;font-size:11px;color:var(--tm);">
      üí° Tip: Edit each flagged voucher, correct the entries so Dr = Cr, then re-save. The balance sheet will auto-correct.
    </div>
    <div style="margin-top:12px;">
      <button class="btn btn-g" onclick="closeModal()">Close</button>
    </div>
  `);
}

function exportBalance(){
  const L=computeLedger();
  const aL=t=>state.accounts.filter(a=>a.type===t).map(a=>({...a,...L[a.id]}));
  const cap=aL('Capital'),liab=aL('Liability'),assets=aL('Asset'),incR=aL('Income'),expR=aL('Expense');
  const nP=incR.reduce((s,a)=>s+(a.closingCr||0)-(a.closingDr||0),0)-expR.reduce((s,a)=>s+(a.closingDr||0)-(a.closingCr||0),0);
  const totCap=cap.reduce((s,a)=>s+(a.closingCr||0)-(a.closingDr||0),0);
  exportXLS([[state.company,''],['BALANCE SHEET',''],['FY:',state.fy],[],
    ['SOURCES OF FUNDS',''],['Capital',''],[...cap.map(a=>['  '+a.name,a.closingCr||0])],['  Net Profit/(Loss)',nP],['Total Capital',totCap+nP],[],
    ['Liabilities',''],[...liab.map(a=>['  '+a.name,a.closingCr||0])],[],
    ['APPLICATION OF FUNDS',''],[...assets.map(a=>['  '+a.name,a.closingDr||0])]],'Balance Sheet',`Balance_Sheet_FY${state.fy}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: GST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADVANCE PAYMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgAdvances(){
  if(!state.advances)state.advances=[];
  const custAdv=state.advances.filter(a=>a.type==='customer');
  const vendAdv=state.advances.filter(a=>a.type==='vendor');
  const custTotal=custAdv.reduce((s,a)=>s+(a.amount||0),0);
  const vendTotal=vendAdv.reduce((s,a)=>s+(a.amount||0),0);
  const custAdjusted=custAdv.reduce((s,a)=>s+(a.adjusted||0),0);
  const vendAdjusted=vendAdv.reduce((s,a)=>s+(a.adjusted||0),0);
  const custPending=custTotal-custAdjusted;
  const vendPending=vendTotal-vendAdjusted;

  const custRows=custAdv.map((a,i)=>`<tr class="${i%2?'alt':''}">
    <td>${fmtD(a.date)}</td>
    <td style="font-weight:600;">${dbN(a.partyId)||a.partyName||'‚Äî'}</td>
    <td class="tr mono">${fmt(a.amount)}</td>
    <td class="tr mono tg-">${fmt(a.adjusted||0)}</td>
    <td class="tr mono ${(a.amount-(a.adjusted||0))>0?'tr-':'tg-'}">${fmt(a.amount-(a.adjusted||0))}</td>
    <td class="tm-" style="font-size:11px;">${a.narration||'‚Äî'}</td>
    <td><button class="btn btn-g btn-sm" onclick="openAdvForm('customer','${a.id}')">‚úè</button><button class="btn btn-d btn-sm" onclick="delAdv('${a.id}')">Del</button></td>
  </tr>`).join('');

  const vendRows=vendAdv.map((a,i)=>`<tr class="${i%2?'alt':''}">
    <td>${fmtD(a.date)}</td>
    <td style="font-weight:600;">${vN(a.partyId)||a.partyName||'‚Äî'}</td>
    <td class="tr mono">${fmt(a.amount)}</td>
    <td class="tr mono tg-">${fmt(a.adjusted||0)}</td>
    <td class="tr mono ${(a.amount-(a.adjusted||0))>0?'tr-':'tg-'}">${fmt(a.amount-(a.adjusted||0))}</td>
    <td class="tm-" style="font-size:11px;">${a.narration||'‚Äî'}</td>
    <td><button class="btn btn-g btn-sm" onclick="openAdvForm('vendor','${a.id}')">‚úè</button><button class="btn btn-d btn-sm" onclick="delAdv('${a.id}')">Del</button></td>
  </tr>`).join('');

  eid('content').innerHTML=`
  <div class="sg" style="grid-template-columns:repeat(4,1fr);margin-bottom:14px;">
    <div class="sc sc-b"><div class="sl">Customer Advances Received</div><div class="sv">${fmt(custTotal)}</div></div>
    <div class="sc sc-o"><div class="sl">Customer Advances Pending</div><div class="sv">${fmt(custPending)}</div></div>
    <div class="sc sc-g"><div class="sl">Vendor Advances Paid</div><div class="sv">${fmt(vendTotal)}</div></div>
    <div class="sc sc-r"><div class="sl">Vendor Advances Pending</div><div class="sv">${fmt(vendPending)}</div></div>
  </div>

  <div style="display:flex;gap:10px;margin-bottom:14px;">
    <button class="btn btn-p" onclick="openAdvForm('customer')">+ Customer Advance</button>
    <button class="btn btn-s" onclick="openAdvForm('vendor')">+ Vendor Advance</button>
  </div>

  <div class="g2" style="gap:14px;">
    <div>
      <div style="font-weight:700;color:var(--tm);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;">üì• Customer Advances Received</div>
      <div class="card"><table class="tbl">
        <thead><tr><th>Date</th><th>Customer</th><th class="tr">Amount</th><th class="tr">Adjusted</th><th class="tr">Pending</th><th>Narration</th><th class="no-print">Act</th></tr></thead>
        <tbody>${custRows||'<tr><td colspan="7" style="padding:16px;text-align:center;color:var(--tm);">No customer advances</td></tr>'}</tbody>
        ${custTotal>0?`<tfoot><tr class="tf"><td colspan="2">TOTAL</td><td class="tr">${fmt(custTotal)}</td><td class="tr">${fmt(custAdjusted)}</td><td class="tr">${fmt(custPending)}</td><td colspan="2"></td></tr></tfoot>`:''}
      </table></div>
    </div>
    <div>
      <div style="font-weight:700;color:var(--tm);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;">üì§ Vendor Advances Paid</div>
      <div class="card"><table class="tbl">
        <thead><tr><th>Date</th><th>Vendor</th><th class="tr">Amount</th><th class="tr">Adjusted</th><th class="tr">Pending</th><th>Narration</th><th class="no-print">Act</th></tr></thead>
        <tbody>${vendRows||'<tr><td colspan="7" style="padding:16px;text-align:center;color:var(--tm);">No vendor advances</td></tr>'}</tbody>
        ${vendTotal>0?`<tfoot><tr class="tf"><td colspan="2">TOTAL</td><td class="tr">${fmt(vendTotal)}</td><td class="tr">${fmt(vendAdjusted)}</td><td class="tr">${fmt(vendPending)}</td><td colspan="2"></td></tr></tfoot>`:''}
      </table></div>
    </div>
  </div>
  <div class="al al-i" style="margin-top:12px;font-size:12px;">
    ‚Ñπ Advance accounting: Customer advance ‚Üí Debit Cash/Bank, Credit 'Advance from Customers'. Vendor advance ‚Üí Debit 'Advance to Suppliers', Credit Cash/Bank.
    When adjusted against invoice ‚Üí Debit 'Advance from Customers', Credit Accounts Receivable (Customer) or Debit Accounts Payable, Credit 'Advance to Suppliers' (Vendor).
  </div>`;
}

function openAdvForm(type,editId){
  const list=state.advances||[];const a=editId?list.find(x=>x.id===editId):null;
  const partyList=type==='customer'?state.debtors:state.vendors;
  const partyOpts=partyList.map(p=>`<option value="${p.id}" ${a?.partyId===p.id?'selected':''}>${p.name}</option>`).join('');
  openModal(editId?`Edit Advance`:`New ${type==='customer'?'Customer':'Vendor'} Advance`,`
  <div class="fg" style="margin-bottom:14px;">
    <div class="fgr"><label class="fl">${type==='customer'?'Customer':'Vendor'} *</label><select class="fc" id="adv-party"><option value="">‚Äî Select ‚Äî</option>${partyOpts}</select></div>
    <div class="fgr"><label class="fl">Date *</label><input type="date" class="fc" id="adv-date" value="${a?.date||today()}"></div>
    <div class="fgr"><label class="fl">Amount (‚Çπ) *</label><input type="number" class="fc" id="adv-amt" value="${a?.amount||''}" min="0" placeholder="0"></div>
    <div class="fgr"><label class="fl">Adjusted Amount</label><input type="number" class="fc" id="adv-adj" value="${a?.adjusted||0}" min="0" placeholder="0"></div>
    <div class="fgr" style="grid-column:span 4;"><label class="fl">Narration</label><input class="fc" id="adv-nar" value="${a?.narration||''}" placeholder="${type==='customer'?'Advance received from customer':'Advance paid to vendor'}"></div>
  </div>
  <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;">
    <strong>üìí Journal Entry:</strong><br>
    ${type==='customer'
      ?'Dr: Cash/Bank &nbsp;&nbsp; Cr: Advance from Customers (Liability)'
      :'Dr: Advance to Suppliers (Asset) &nbsp;&nbsp; Cr: Cash/Bank'}
  </div>
  <div style="display:flex;gap:8px;"><button class="btn btn-p" onclick="saveAdv('${type}','${editId||''}')">üíæ Save Advance</button><button class="btn btn-g" onclick="closeModal()">Cancel</button></div>`);
}

function saveAdv(type,editId){
  if(!state.advances)state.advances=[];
  const partyId=eid('adv-party').value,dt=eid('adv-date').value;
  const amount=parseFloat(eid('adv-amt').value)||0;
  if(!partyId||!amount)return showAlert('Party and amount required');
  const obj={id:editId||('ADV'+Date.now()),type,partyId,date:dt,amount,adjusted:parseFloat(eid('adv-adj').value)||0,narration:eid('adv-nar').value.trim()};
  if(editId)state.advances=state.advances.map(x=>x.id===editId?obj:x);else state.advances.push(obj);
  scheduleSave();closeModal();pgAdvances();
}
function delAdv(id){if(!confirm('Delete advance?'))return;state.advances=(state.advances||[]).filter(x=>x.id!==id);scheduleSave();pgAdvances();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BANK RECONCILIATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgBankRecon(){
  if(!state.bankStatements)state.bankStatements=[];
  const bankAccs=state.accounts.filter(a=>a.group==='Cash & Bank');
  const selAcc=bankAccs[0]?.id||'';
  renderBankRecon(selAcc);
}

function renderBankRecon(selAccId){
  if(!state.bankStatements)state.bankStatements=[];
  const bankAccs=state.accounts.filter(a=>a.group==='Cash & Bank');
  const L=computeLedger();
  const bookBal=selAccId?(L[selAccId]?.closingDr||0):0;
  const stmts=state.bankStatements.filter(s=>s.bankAccId===selAccId);
  const bankBal=stmts.length?stmts[stmts.length-1]?.balance||0:0;
  const unmatched=stmts.filter(s=>!s.matched);
  const matched=stmts.filter(s=>s.matched);

  const stmtRows=stmts.map((s,i)=>`<tr class="${i%2?'alt':''}">
    <td>${fmtD(s.date)}</td>
    <td class="tm-" style="font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${s.description}</td>
    <td class="tr tg-">${s.debit>0?fmt(s.debit):'‚Äî'}</td>
    <td class="tr tr-">${s.credit>0?fmt(s.credit):'‚Äî'}</td>
    <td class="tr mono">${fmt(s.balance)}</td>
    <td>${s.matched?`<span class="badge bg-">‚úì Matched</span>`:`<span class="badge br">Unmatched</span>`}</td>
    <td style="white-space:nowrap;">
      ${!s.matched?`<button class="btn btn-s btn-sm" onclick="matchStmt('${s.id}')">‚úì Match</button>`:''}
      <button class="btn btn-d btn-sm" onclick="delStmt('${s.id}','${selAccId}')">Del</button>
    </td>
  </tr>`).join('');

  eid('content').innerHTML=`
  <div class="tb no-print">
    <select class="fc" style="min-width:220px;" onchange="renderBankRecon(this.value)">
      ${bankAccs.map(a=>`<option value="${a.id}" ${a.id===selAccId?'selected':''}>${a.name}</option>`).join('')}
    </select>
    <button class="btn btn-p" onclick="openAddStmtForm('${selAccId}')">+ Add Statement Entry</button>
    <button class="btn btn-g" onclick="importStmtCSV('${selAccId}')">üìÇ Import CSV</button>
    <button class="btn btn-s" onclick="autoMatch('${selAccId}')" style="margin-left:auto;">‚ö° Auto-Match</button>
  </div>

  <div class="sg" style="grid-template-columns:repeat(4,1fr);margin-bottom:14px;">
    <div class="sc sc-b"><div class="sl">Book Balance</div><div class="sv">${fmt(bookBal)}</div><div class="ss">As per ledger</div></div>
    <div class="sc sc-g"><div class="sl">Bank Balance</div><div class="sv">${fmt(bankBal)}</div><div class="ss">As per statement</div></div>
    <div class="sc ${unmatched.length>0?'sc-r':'sc-o'}"><div class="sl">Unmatched Entries</div><div class="sv">${unmatched.length}</div></div>
    <div class="sc sc-p"><div class="sl">Matched Entries</div><div class="sv">${matched.length}</div></div>
  </div>

  ${Math.abs(bookBal-bankBal)>1?`<div class="al al-w">‚ö† Difference of ${fmt(Math.abs(bookBal-bankBal))} between book and bank balance. Check unmatched entries.</div>`:`<div class="al al-s">‚úÖ Book Balance matches Bank Balance ‚Äî Reconciliation Complete!</div>`}

  <div class="card">
    <div class="ch">Bank Statement ‚Äî ${bankAccs.find(a=>a.id===selAccId)?.name||'‚Äî'}</div>
    <table class="tbl">
      <thead><tr><th>Date</th><th>Description</th><th class="tr">Debit (Dr)</th><th class="tr">Credit (Cr)</th><th class="tr">Balance</th><th>Status</th><th class="no-print">Actions</th></tr></thead>
      <tbody>${stmtRows||'<tr><td colspan="7" style="padding:20px;text-align:center;color:var(--tm);">No statement entries. Add entries or import CSV.</td></tr>'}</tbody>
    </table>
  </div>
  <div style="margin-top:10px;font-size:11px;color:var(--tm);">
    üí° Tip: Import your bank statement CSV (Date, Description, Debit, Credit, Balance) and click Auto-Match to automatically reconcile with book entries.
  </div>`;
}

function openAddStmtForm(bankAccId){
  openModal('Add Bank Statement Entry',`
  <div class="fg" style="margin-bottom:14px;">
    <div class="fgr"><label class="fl">Date *</label><input type="date" class="fc" id="bs-date" value="${today()}"></div>
    <div class="fgr" style="grid-column:span 3;"><label class="fl">Description *</label><input class="fc" id="bs-desc" placeholder="Transaction description from bank"></div>
    <div class="fgr"><label class="fl">Debit (Money In) ‚Çπ</label><input type="number" class="fc" id="bs-dr" value="0" min="0"></div>
    <div class="fgr"><label class="fl">Credit (Money Out) ‚Çπ</label><input type="number" class="fc" id="bs-cr" value="0" min="0"></div>
    <div class="fgr"><label class="fl">Running Balance ‚Çπ</label><input type="number" class="fc" id="bs-bal" value="0"></div>
  </div>
  <div style="display:flex;gap:8px;"><button class="btn btn-p" onclick="saveStmt('${bankAccId}')">üíæ Add Entry</button><button class="btn btn-g" onclick="closeModal()">Cancel</button></div>`);
}

function saveStmt(bankAccId){
  if(!state.bankStatements)state.bankStatements=[];
  const desc=eid('bs-desc').value.trim(),dt=eid('bs-date').value;
  if(!desc||!dt)return showAlert('Date and description required');
  const obj={id:'BS'+Date.now(),bankAccId,date:dt,description:desc,debit:parseFloat(eid('bs-dr').value)||0,credit:parseFloat(eid('bs-cr').value)||0,balance:parseFloat(eid('bs-bal').value)||0,matched:false};
  state.bankStatements.push(obj);scheduleSave();closeModal();renderBankRecon(bankAccId);
}

function delStmt(id,accId){if(!confirm('Delete?'))return;state.bankStatements=(state.bankStatements||[]).filter(x=>x.id!==id);scheduleSave();renderBankRecon(accId);}

function matchStmt(id){
  if(!state.bankStatements)return;
  const s=state.bankStatements.find(x=>x.id===id);if(s)s.matched=true;
  scheduleSave();const acc=eid('content').querySelector('select')?.value||'';renderBankRecon(acc);
}

function autoMatch(bankAccId){
  if(!state.bankStatements)return;
  const L=computeLedger();const acc=L[bankAccId];if(!acc)return;
  let matchCount=0;
  state.bankStatements.filter(s=>s.bankAccId===bankAccId&&!s.matched).forEach(stmt=>{
    const match=acc.txns.find(t=>{
      const amtMatch=(stmt.debit>0&&Math.abs(t.dr-stmt.debit)<1)||(stmt.credit>0&&Math.abs(t.cr-stmt.credit)<1);
      return amtMatch&&t.date===stmt.date;
    });
    if(match){stmt.matched=true;matchCount++;}
  });
  scheduleSave();
  showToast(`‚ö° Auto-matched ${matchCount} entries!`,'#059669');
  renderBankRecon(bankAccId);
}

function importStmtCSV(bankAccId){
  openModal('Import Bank Statement CSV',`
  <div class="al al-i" style="margin-bottom:12px;font-size:12px;">
    CSV format: <strong>Date, Description, Debit, Credit, Balance</strong><br>
    Date format: DD/MM/YYYY or YYYY-MM-DD. Debit = money received, Credit = money paid.
  </div>
  <input type="file" id="csv-file" accept=".csv" style="margin-bottom:12px;display:block;">
  <div style="display:flex;gap:8px;"><button class="btn btn-p" onclick="parseCSV('${bankAccId}')">üìÇ Import</button><button class="btn btn-g" onclick="closeModal()">Cancel</button></div>`);
}

function parseCSV(bankAccId){
  const file=eid('csv-file')?.files[0];if(!file)return showAlert('Select a CSV file');
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split('\n').filter(l=>l.trim()&&!l.startsWith('Date'));
    let count=0;
    lines.forEach(line=>{
      const cols=line.split(',').map(c=>c.trim().replace(/"/g,''));
      if(cols.length<4)return;
      let dt=cols[0];
      // Normalize date
      if(dt.includes('/'))dt=dt.split('/').reverse().join('-');
      const desc=cols[1]||'‚Äî';const dr=parseFloat(cols[2])||0;const cr=parseFloat(cols[3])||0;const bal=parseFloat(cols[4])||0;
      if(!state.bankStatements)state.bankStatements=[];
      state.bankStatements.push({id:'CSV'+Date.now()+count,bankAccId,date:dt,description:desc,debit:dr,credit:cr,balance:bal,matched:false});
      count++;
    });
    scheduleSave();closeModal();showToast(`üìÇ Imported ${count} statement entries`,'#059669');renderBankRecon(bankAccId);
  };
  reader.readAsText(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CASH FLOW STATEMENT ‚Äî AS-3 (Direct Method)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgCashFlow(){
  const L=computeLedger();
  // Operating Activities ‚Äî only count Cash/Bank account entries (avoid double-counting TDS/party entries)
  const netProfit=Object.values(L).filter(a=>a.type==='Income').reduce((s,a)=>s+a.closingCr,0)
    -Object.values(L).filter(a=>a.type==='Expense').reduce((s,a)=>s+a.closingDr,0);
  const cashBankIds=new Set(state.accounts.filter(a=>a.group==='Cash & Bank').map(a=>a.id));
  const receiptsFromCustomers=state.vouchers.filter(v=>v.date>=state.fyStart&&v.date<=state.fyEnd&&v.type==='Receipt')
    .reduce((s,v)=>s+v.entries.filter(e=>cashBankIds.has(e.accId)).reduce((x,e)=>x+(e.dr||0),0),0);
  const paymentsToSuppliers=state.vouchers.filter(v=>v.date>=state.fyStart&&v.date<=state.fyEnd&&v.type==='Payment')
    .reduce((s,v)=>s+v.entries.filter(e=>cashBankIds.has(e.accId)).reduce((x,e)=>x+(e.cr||0),0),0);
  const salaries=L['4002']?.closingDr||0;
  const rent=L['4003']?.closingDr||0;
  // Bug fix: include IGST output (2004) and CGST input (1006) in taxes
  const taxes=Math.max((L['2002']?.closingCr||0)+(L['2003']?.closingCr||0)+(L['2004']?.closingCr||0)
    -(L['1006']?.closingDr||0)-(L['1007']?.closingDr||0)-(L['1008']?.closingDr||0),0);
  const operatingCF=receiptsFromCustomers-paymentsToSuppliers-salaries-rent-taxes;

  // Investing Activities
  const fixedAssets=Object.values(L).filter(a=>a.group==='Fixed Assets').reduce((s,a)=>s-(a.closingDr-a.balance),0);
  const investingCF=fixedAssets;

  // Financing Activities
  const capitalReceipts=state.vouchers.filter(v=>v.type==='Receipt'&&v.narration.toLowerCase().includes('capital')).reduce((s,v)=>s+v.entries.reduce((x,e)=>x+(e.dr||0),0),0);
  const loanReceipts=(L['2006']?.closingCr||0)-(L['2006']?.balance||0);
  const financingCF=capitalReceipts+loanReceipts;

  const netCF=operatingCF+investingCF+financingCF;
  const openingCash=Object.values(L).filter(a=>a.group==='Cash & Bank').reduce((s,a)=>s+a.balance,0);
  const closingCash=openingCash+netCF;

  eid('content').innerHTML=`
  <div class="page-full">
  <div class="tb no-print">
    <div style="font-weight:700;font-size:14px;">Cash Flow Statement ‚Äî FY ${state.fy} (AS-3 Direct Method)</div>
    <button class="btn btn-s" onclick="exportCashFlow()" style="margin-left:auto;">‚¨á Excel</button>
  </div>
  <div class="sg" style="grid-template-columns:repeat(4,1fr);margin-bottom:14px;">
    <div class="sc sc-b"><div class="sl">Operating CF</div><div class="sv">${fmt(Math.abs(operatingCF))}</div><div class="ss">${operatingCF>=0?'Inflow':'Outflow'}</div></div>
    <div class="sc sc-p"><div class="sl">Investing CF</div><div class="sv">${fmt(Math.abs(investingCF))}</div><div class="ss">${investingCF>=0?'Inflow':'Outflow'}</div></div>
    <div class="sc sc-o"><div class="sl">Financing CF</div><div class="sv">${fmt(Math.abs(financingCF))}</div><div class="ss">${financingCF>=0?'Inflow':'Outflow'}</div></div>
    <div class="sc ${netCF>=0?'sc-g':'sc-r'}"><div class="sl">Net Cash Flow</div><div class="sv">${fmt(Math.abs(netCF))}</div><div class="ss">${netCF>=0?'Net Inflow':'Net Outflow'}</div></div>
  </div>
  <div class="g3 pf-grid" style="align-items:stretch;">
    <div class="rp">
      <div style="font-size:14px;font-weight:700;padding-bottom:10px;border-bottom:2px solid var(--bdr);margin-bottom:10px;">üîß A. Operating Activities</div>
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--tl);margin-bottom:6px;">Cash Inflows</div>
      <div class="rr"><span class="rrl">Receipts from Customers</span><span class="rrv tg-">${fmt(receiptsFromCustomers)}</span></div>
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--tl);margin:8px 0 6px;">Cash Outflows</div>
      <div class="rr"><span class="rrl">Payments to Suppliers</span><span class="rrv tr-">(${fmt(paymentsToSuppliers)})</span></div>
      <div class="rr"><span class="rrl">Salaries & Wages</span><span class="rrv tr-">(${fmt(salaries)})</span></div>
      <div class="rr"><span class="rrl">Rent Expenses</span><span class="rrv tr-">(${fmt(rent)})</span></div>
      <div class="rr"><span class="rrl">GST & Taxes</span><span class="rrv tr-">(${fmt(Math.max(taxes,0))})</span></div>
      <div class="rtot ${operatingCF>=0?'rt-g':'rt-r'}" style="margin-top:10px;"><span>Net Operating CF</span><span>${operatingCF>=0?'+':'-'}${fmt(Math.abs(operatingCF))}</span></div>
    </div>
    <div class="rp">
      <div style="font-size:14px;font-weight:700;padding-bottom:10px;border-bottom:2px solid var(--bdr);margin-bottom:10px;">üèó B. Investing Activities</div>
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--tl);margin-bottom:6px;">Capital Expenditure</div>
      <div class="rr"><span class="rrl">Purchase of Fixed Assets</span><span class="rrv tr-">(${fmt(Math.abs(fixedAssets))})</span></div>
      <div class="rr"><span class="rrl">Sale of Fixed Assets</span><span class="rrv tg-">${fmt(0)}</span></div>
      <div class="rr"><span class="rrl">Interest / Dividend Received</span><span class="rrv tg-">${fmt(L['3003']?.closingCr||0)}</span></div>
      <div class="rtot ${investingCF>=0?'rt-g':'rt-r'}" style="margin-top:10px;"><span>Net Investing CF</span><span>${investingCF>=0?'+':'-'}${fmt(Math.abs(investingCF))}</span></div>
    </div>
    <div class="rp">
      <div style="font-size:14px;font-weight:700;padding-bottom:10px;border-bottom:2px solid var(--bdr);margin-bottom:10px;">üí∞ C. Financing Activities</div>
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--tl);margin-bottom:6px;">Capital & Loans</div>
      <div class="rr"><span class="rrl">Capital Contributions</span><span class="rrv tg-">${fmt(capitalReceipts)}</span></div>
      <div class="rr"><span class="rrl">Loan Proceeds</span><span class="rrv tg-">${fmt(Math.max(loanReceipts,0))}</span></div>
      <div class="rr"><span class="rrl">Loan Repayments</span><span class="rrv tr-">(${fmt(0)})</span></div>
      <div class="rtot ${financingCF>=0?'rt-g':'rt-r'}" style="margin-top:10px;"><span>Net Financing CF</span><span>${financingCF>=0?'+':'-'}${fmt(Math.abs(financingCF))}</span></div>
    </div>
  </div>
  <div class="rp" style="margin-top:14px;background:linear-gradient(135deg,#0f172a,#1e3a6e);color:#fff;">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;">
      <div><div style="font-size:10px;opacity:.7;text-transform:uppercase;letter-spacing:1px;">Opening Cash & Bank Balance</div><div style="font-size:18px;font-weight:700;margin-top:4px;font-family:monospace;">${fmt(openingCash)}</div></div>
      <div style="text-align:center;"><div style="font-size:10px;opacity:.7;text-transform:uppercase;letter-spacing:1px;">Net Change in Cash</div><div style="font-size:18px;font-weight:700;margin-top:4px;font-family:monospace;color:${netCF>=0?'#34d399':'#f87171'};">${netCF>=0?'+':''}${fmt(netCF)}</div></div>
      <div style="text-align:right;"><div style="font-size:10px;opacity:.7;text-transform:uppercase;letter-spacing:1px;">Closing Cash & Bank Balance</div><div style="font-size:18px;font-weight:700;margin-top:4px;font-family:monospace;color:#93c5fd;">${fmt(closingCash)}</div></div>
    </div>
  </div>
  <div class="al al-i" style="margin-top:10px;font-size:11px;">‚Ñπ AS-3 Cash Flow Statement prepared using Direct Method. Figures derived from voucher entries and ledger balances.</div>
  </div>`;
}

function exportCashFlow(){
  const L=computeLedger();
  const cbIds=new Set(state.accounts.filter(a=>a.group==='Cash & Bank').map(a=>a.id));
  const receiptsFromCustomers=state.vouchers.filter(v=>v.type==='Receipt').reduce((s,v)=>s+v.entries.filter(e=>cbIds.has(e.accId)).reduce((x,e)=>x+(e.dr||0),0),0);
  const paymentsToSuppliers=state.vouchers.filter(v=>v.type==='Payment').reduce((s,v)=>s+v.entries.filter(e=>cbIds.has(e.accId)).reduce((x,e)=>x+(e.cr||0),0),0);
  exportXLS([[state.company,''],['CASH FLOW STATEMENT (AS-3)',''],['Financial Year:',state.fy],[],
    ['A. OPERATING ACTIVITIES',''],['Receipts from Customers',receiptsFromCustomers],['Payments to Suppliers',-paymentsToSuppliers],[],
    ['B. INVESTING ACTIVITIES',''],['Purchase of Fixed Assets',0],[],
    ['C. FINANCING ACTIVITIES',''],['Capital Contributions',0]],'Cash Flow',`Cash_Flow_FY${state.fy}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TDS REPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: TDS REPORTS (Comprehensive ‚Äî Payable + Receivable + 26AS)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _tdsMainTab='payable';
let _tdsSubTab='section';

function pgTDS(){ renderTDSPage(); }

function renderTDSPage(){
  const fyV=state.vouchers.filter(v=>v.date>=state.fyStart&&v.date<=state.fyEnd);

  // ‚îÄ‚îÄ TDS PAYABLE: we deduct from vendor payments ‚îÄ‚îÄ
  const payV=fyV.filter(v=>v.tdsSection&&v.tdsSection!=='');
  const bySecPay={};
  payV.forEach(v=>{
    const sec=v.tdsSection;
    if(!bySecPay[sec])bySecPay[sec]={code:sec,bills:[],totalBase:0,totalTDS:0};
    const base=v.totals?.taxable||v.entries.reduce((s,e)=>s+(e.dr||0),0);
    const secInfo=TDS_SECTIONS.find(x=>x.code===sec);
    const tds=v.totals?.tds||(secInfo?Math.round(base*secInfo.rate)/100:0);
    const party=vN(v.partyId)||'‚Äî';
    bySecPay[sec].bills.push({v,base,tds,party});
    bySecPay[sec].totalBase+=base;
    bySecPay[sec].totalTDS+=tds;
  });
  const totalPayTDS=Object.values(bySecPay).reduce((s,x)=>s+x.totalTDS,0);

  // ‚îÄ‚îÄ TDS RECEIVABLE: customers deduct from our invoices ‚îÄ‚îÄ
  const recV=fyV.filter(v=>(v.tdsRecAmt&&v.tdsRecAmt>0));
  const bySecRec={};
  recV.forEach(v=>{
    const sec=v.tdsRecSection||'194J';
    if(!bySecRec[sec])bySecRec[sec]={code:sec,bills:[],totalBase:0,totalTDS:0};
    const base=v.tdsRecBase||0;
    const tds=v.tdsRecAmt||0;
    const party=dbN(v.partyId)||'‚Äî';
    bySecRec[sec].bills.push({v,base,tds,party,deductorPAN:v.tdsRecDeductorPAN||'‚Äî',quarter:v.tdsRecQuarter||'‚Äî'});
    bySecRec[sec].totalBase+=base;
    bySecRec[sec].totalTDS+=tds;
  });
  const totalRecTDS=recV.reduce((s,v)=>s+(v.tdsRecAmt||0),0);

  // ‚îÄ‚îÄ 26AS Reconciliation ‚îÄ‚îÄ
  const form26AS=state.form26AS||[];
  const recon26=form26AS.map(entry=>{
    const matched=recV.find(v=>{
      const dbr=state.debtors.find(d=>d.id===v.partyId);
      const panMatch=(dbr?.pan===entry.deductorPAN)||(v.tdsRecDeductorPAN===entry.deductorPAN);
      const amtMatch=Math.abs((v.tdsRecAmt||0)-entry.tdsAmt)<2;
      const secMatch=(v.tdsRecSection||'194J')===entry.section;
      return panMatch&&amtMatch&&secMatch;
    });
    return{...entry,matched:!!matched,matchedVoucher:matched?.id||''};
  });
  const matched26=recon26.filter(x=>x.matched).length;
  const unmatched26=recon26.filter(x=>!x.matched).length;
  const total26TDS=form26AS.reduce((s,x)=>s+x.tdsAmt,0);
  const gap26=total26TDS-totalRecTDS;

  // ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ
  const mt=_tdsMainTab,st=_tdsSubTab;
  const tabStyle=(t,main)=>`padding:6px 14px;border-radius:6px;border:none;cursor:pointer;font-size:12px;font-weight:600;font-family:var(--font);transition:all .15s;background:${(main?mt:st)===t?'var(--primary)':'var(--bdr)'};color:${(main?mt:st)===t?'#fff':'var(--tm)'}`;

  // ‚îÄ‚îÄ Render Section-wise Payable ‚îÄ‚îÄ
  const paySecRows=Object.values(bySecPay).map((s,i)=>{
    const info=TDS_SECTIONS.find(x=>x.code===s.code);
    return`<tr class="${i%2?'alt':''}"><td class="mono tb-" style="font-weight:700;">${s.code}</td><td>${info?.desc||'‚Äî'}</td><td class="tc"><span class="badge by">${info?.rate||'‚Äî'}%</span></td><td class="tc">${s.bills.length}</td><td class="tr mono">${fmt(s.totalBase)}</td><td class="tr mono tr-" style="font-weight:700;">${fmt(s.totalTDS)}</td></tr>`;
  }).join('');

  const payBillRows=payV.map((v,i)=>{
    const sec=TDS_SECTIONS.find(x=>x.code===v.tdsSection);
    const base=v.totals?.taxable||v.entries.reduce((s,e)=>s+(e.dr||0),0);
    const tds=v.totals?.tds||(sec?Math.round(base*sec.rate)/100:0);
    const party=vN(v.partyId)||dbN(v.partyId)||'‚Äî';
    return`<tr class="${i%2?'alt':''}"><td>${fmtD(v.date)}</td><td class="mono tb-">${v.id}</td><td>${party}</td><td class="tm-" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${v.narration}</td><td><span class="badge by">${v.tdsSection}</span></td><td class="tr mono">${fmt(base)}</td><td class="tc"><span class="badge bgr">${sec?.rate||'‚Äî'}%</span></td><td class="tr mono tr-" style="font-weight:700;">${fmt(tds)}</td></tr>`;
  }).join('');

  // ‚îÄ‚îÄ Render Section-wise Receivable ‚îÄ‚îÄ
  const recSecRows=Object.values(bySecRec).map((s,i)=>{
    const info=TDS_SECTIONS.find(x=>x.code===s.code);
    return`<tr class="${i%2?'alt':''}"><td class="mono tb-" style="font-weight:700;">${s.code}</td><td>${info?.desc||'‚Äî'}</td><td class="tc"><span class="badge by">${info?.rate||'‚Äî'}%</span></td><td class="tc">${s.bills.length}</td><td class="tr mono">${fmt(s.totalBase)}</td><td class="tr mono tg-" style="font-weight:700;">${fmt(s.totalTDS)}</td></tr>`;
  }).join('');

  const recBillRows=recV.map((v,i)=>{
    const sec=TDS_SECTIONS.find(x=>x.code===(v.tdsRecSection||'194J'));
    const dbr=state.debtors.find(d=>d.id===v.partyId);
    const party=dbN(v.partyId)||'‚Äî';
    return`<tr class="${i%2?'alt':''}"><td>${fmtD(v.date)}</td><td class="mono tb-">${v.id}</td><td>${party}</td><td class="tm-" style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${v.narration}</td><td><span class="badge by">${v.tdsRecSection||'194J'}</span></td><td class="tr mono">${fmt(v.tdsRecBase||0)}</td><td class="tr mono tg-" style="font-weight:700;">${fmt(v.tdsRecAmt||0)}</td><td class="mono" style="font-size:11px;">${v.tdsRecDeductorPAN||dbr?.pan||'‚Äî'}</td><td class="tc"><span class="badge bb">${v.tdsRecQuarter||'‚Äî'}</span></td></tr>`;
  }).join('');

  // ‚îÄ‚îÄ 26AS Reconciliation Rows ‚îÄ‚îÄ
  const reconRows=recon26.map((x,i)=>{
    const booksAmt=recV.filter(v=>{
      const dbr=state.debtors.find(d=>d.id===v.partyId);
      return ((dbr?.pan===x.deductorPAN)||(v.tdsRecDeductorPAN===x.deductorPAN))&&(v.tdsRecSection||'194J')===x.section;
    }).reduce((s,v)=>s+(v.tdsRecAmt||0),0);
    const diff=x.tdsAmt-booksAmt;
    const status=x.matched?'Matched':'Unmatched';
    const statusBadge=x.matched?'<span class="badge bg-">‚úì Matched</span>':'<span class="badge br">‚ö† Unmatched</span>';
    return`<tr class="${i%2?'alt':''}"><td class="mono" style="font-size:11px;">${x.srNo}</td><td style="font-weight:600;">${x.deductorName}</td><td class="mono" style="font-size:11px;">${x.deductorTAN||'‚Äî'}</td><td class="mono" style="font-size:11px;">${x.deductorPAN}</td><td><span class="badge by">${x.section}</span></td><td class="tc">${x.quarter}</td><td class="tr mono">${fmt(x.amtCredit)}</td><td class="tr mono tg-">${fmt(x.tdsAmt)}</td><td class="tr mono">${fmt(booksAmt)}</td><td class="tr mono ${Math.abs(diff)>0?'tr-':''}">${Math.abs(diff)<0.5?'‚Äî':fmt(diff)}</td><td class="tc">${statusBadge}</td></tr>`;
  }).join('');

  // ‚îÄ‚îÄ CONTENT RENDER ‚îÄ‚îÄ
  eid('content').innerHTML=`
  <div class="page-full">
  <div class="tb no-print" style="justify-content:space-between;">
    <div style="font-weight:700;font-size:14px;">üìë TDS Reports ‚Äî FY ${state.fy} | TAN: ${state.tan||state.company.substring(0,4).toUpperCase()+'HXXXXX'}</div>
    <div style="display:flex;gap:7px;">
      ${mt==='payable'?`<button class="btn btn-s" onclick="exportTDSPayableSection()">‚¨á Section-wise XLS</button><button class="btn btn-p" onclick="exportTDSPayableBill()">‚¨á Bill-wise XLS</button>`:''}
      ${mt==='receivable'?`<button class="btn btn-s" onclick="exportTDSReceivableSection()">‚¨á Section-wise XLS</button><button class="btn btn-p" onclick="exportTDSReceivableBill()">‚¨á Bill-wise XLS</button>`:''}
      ${mt==='26as'?`<button class="btn btn-w" onclick="export26ASRecon()">‚¨á 26AS Recon XLS</button>`:''}
    </div>
  </div>

  <div class="sg" style="grid-template-columns:repeat(4,1fr);margin-bottom:14px;">
    <div class="sc sc-r"><div class="sl">TDS Payable (Deducted)</div><div class="sv">${fmt(totalPayTDS)}</div><div class="ss">${payV.length} transactions ¬∑ ${Object.keys(bySecPay).length} sections</div></div>
    <div class="sc sc-g"><div class="sl">TDS Receivable (Books)</div><div class="sv">${fmt(totalRecTDS)}</div><div class="ss">${recV.length} certificates ¬∑ ${Object.keys(bySecRec).length} sections</div></div>
    <div class="sc sc-b"><div class="sl">26AS ‚Äî TDS as per Traces</div><div class="sv">${fmt(total26TDS)}</div><div class="ss">${matched26} matched ¬∑ ${unmatched26} unmatched</div></div>
    <div class="sc ${Math.abs(gap26)>0?'sc-o':'sc-p'}"><div class="sl">26AS Variance (Books vs TRACES)</div><div class="sv">${fmt(Math.abs(gap26))}</div><div class="ss">${gap26>0?'Missing in Books':'Excess in Books'}</div></div>
  </div>

  <!-- Main Tabs -->
  <div style="display:flex;gap:6px;margin-bottom:16px;border-bottom:2px solid var(--bdr);padding-bottom:0;">
    <button style="${tabStyle('payable',true)};border-radius:8px 8px 0 0;padding:9px 18px;" onclick="_tdsMainTab='payable';_tdsSubTab='section';renderTDSPage()">üì§ TDS Payable</button>
    <button style="${tabStyle('receivable',true)};border-radius:8px 8px 0 0;padding:9px 18px;" onclick="_tdsMainTab='receivable';_tdsSubTab='section';renderTDSPage()">üì• TDS Receivable</button>
    <button style="${tabStyle('26as',true)};border-radius:8px 8px 0 0;padding:9px 18px;" onclick="_tdsMainTab='26as';renderTDSPage()">üîç 26AS Reconciliation</button>
  </div>

  ${mt==='payable'?`
  <!-- TDS PAYABLE -->
  <div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:10px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:#991b1b;">
    <strong>TDS Payable</strong> = TDS deducted by you on vendor/contractor payments. Must be deposited to Govt by 7th of following month. Used for Form 26Q filing.
  </div>
  <div style="display:flex;gap:6px;margin-bottom:12px;">
    <button style="${tabStyle('section',false)};border-radius:6px;padding:6px 14px;" onclick="_tdsSubTab='section';renderTDSPage()">Section-wise Summary</button>
    <button style="${tabStyle('bill',false)};border-radius:6px;padding:6px 14px;" onclick="_tdsSubTab='bill';renderTDSPage()">Bill-wise Details</button>
  </div>
  ${st==='section'?`
  <div class="card pf-grid"><table class="tbl">
    <thead><tr><th>TDS Section</th><th>Nature of Payment</th><th class="tc">Rate</th><th class="tc">No. of Bills</th><th class="tr">Total Taxable Amt</th><th class="tr">TDS Deducted</th></tr></thead>
    <tbody>${paySecRows||'<tr><td colspan="6" style="padding:18px;text-align:center;color:var(--tm);">No TDS payable entries. Add TDS Section in Payment/Purchase vouchers.</td></tr>'}</tbody>
    ${totalPayTDS>0?`<tfoot><tr class="tf"><td colspan="4">TOTAL TDS PAYABLE (Govt Deposit)</td><td class="tr">‚Äî</td><td class="tr">${fmt(totalPayTDS)}</td></tr></tfoot>`:''}
  </table></div>`:`
  <div class="card pf-grid"><table class="tbl">
    <thead><tr><th>Date</th><th>Voucher</th><th>Party / Deductee</th><th>Narration</th><th>Section</th><th class="tr">Base Amount</th><th class="tc">Rate</th><th class="tr">TDS Amount</th></tr></thead>
    <tbody>${payBillRows||'<tr><td colspan="8" style="padding:18px;text-align:center;color:var(--tm);">No bill-wise TDS payable entries found.</td></tr>'}</tbody>
    ${totalPayTDS>0?`<tfoot><tr class="tf"><td colspan="5">TOTAL TDS PAYABLE</td><td class="tr">‚Äî</td><td>‚Äî</td><td class="tr">${fmt(totalPayTDS)}</td></tr></tfoot>`:''}
  </table></div>`}
  `:''}

  ${mt==='receivable'?`
  <!-- TDS RECEIVABLE -->
  <div style="background:#ecfdf5;border:1px solid #a7f3d0;border-radius:10px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:#065f46;">
    <strong>TDS Receivable</strong> = TDS deducted by your customers/clients on payments to you. These appear in your <strong>Form 26AS</strong> / AIS on TRACES. Claim as advance tax / refund during ITR.
  </div>
  <div style="display:flex;gap:6px;margin-bottom:12px;">
    <button style="${tabStyle('section',false)};border-radius:6px;padding:6px 14px;" onclick="_tdsSubTab='section';renderTDSPage()">Section-wise Summary</button>
    <button style="${tabStyle('bill',false)};border-radius:6px;padding:6px 14px;" onclick="_tdsSubTab='bill';renderTDSPage()">Bill-wise Details</button>
  </div>
  ${st==='section'?`
  <div class="card pf-grid"><table class="tbl">
    <thead><tr><th>TDS Section</th><th>Nature of Income</th><th class="tc">Rate</th><th class="tc">TDS Certs</th><th class="tr">Total Base (Invoice)</th><th class="tr">TDS Receivable</th></tr></thead>
    <tbody>${recSecRows||'<tr><td colspan="6" style="padding:18px;text-align:center;color:var(--tm);">No TDS receivable entries. Record TDS in Receipt vouchers.</td></tr>'}</tbody>
    ${totalRecTDS>0?`<tfoot><tr class="tf"><td colspan="4">TOTAL TDS RECEIVABLE (Advance Tax Credit)</td><td class="tr">‚Äî</td><td class="tr">${fmt(totalRecTDS)}</td></tr></tfoot>`:''}
  </table></div>`:`
  <div class="card pf-grid" style="overflow-x:auto;"><table class="tbl">
    <thead><tr><th>Date</th><th>Voucher</th><th>Customer / Deductor</th><th>Narration</th><th>Section</th><th class="tr">Invoice Base</th><th class="tr">TDS Deducted</th><th>Deductor PAN</th><th class="tc">Quarter</th></tr></thead>
    <tbody>${recBillRows||'<tr><td colspan="9" style="padding:18px;text-align:center;color:var(--tm);">No TDS receivable bill entries found.</td></tr>'}</tbody>
    ${totalRecTDS>0?`<tfoot><tr class="tf"><td colspan="5">TOTAL TDS RECEIVABLE</td><td class="tr">‚Äî</td><td class="tr">${fmt(totalRecTDS)}</td><td colspan="2">‚Äî</td></tr></tfoot>`:''}
  </table></div>`}
  `:''}

  ${mt==='26as'?`
  <!-- 26AS RECONCILIATION -->
  <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px 16px;margin-bottom:14px;font-size:12px;color:#1e40af;">
    <strong>Form 26AS / AIS Reconciliation</strong> ‚Äî Match TDS as per TRACES portal with your books of accounts.
    Differences may arise due to timing (deductor filed late), PAN mismatch, or booking errors. Resolve before ITR filing.
  </div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px;">
    <div style="background:#ecfdf5;border:1px solid #a7f3d0;border-radius:10px;padding:12px 14px;">
      <div style="font-size:10px;font-weight:700;color:#065f46;text-transform:uppercase;">26AS Total TDS</div>
      <div style="font-size:18px;font-weight:700;color:#059669;font-family:var(--mono);">${fmt(total26TDS)}</div>
    </div>
    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px 14px;">
      <div style="font-size:10px;font-weight:700;color:#1e40af;text-transform:uppercase;">Books TDS Receivable</div>
      <div style="font-size:18px;font-weight:700;color:#2563eb;font-family:var(--mono);">${fmt(totalRecTDS)}</div>
    </div>
    <div style="background:${Math.abs(gap26)<1?'#ecfdf5':'#fef2f2'};border:1px solid ${Math.abs(gap26)<1?'#a7f3d0':'#fca5a5'};border-radius:10px;padding:12px 14px;">
      <div style="font-size:10px;font-weight:700;color:${Math.abs(gap26)<1?'#065f46':'#991b1b'};text-transform:uppercase;">Variance</div>
      <div style="font-size:18px;font-weight:700;color:${Math.abs(gap26)<1?'#059669':'#dc2626'};font-family:var(--mono);">${fmt(Math.abs(gap26))}</div>
    </div>
    <div style="background:#f0fdfa;border:1px solid #99f6e4;border-radius:10px;padding:12px 14px;">
      <div style="font-size:10px;font-weight:700;color:#0f766e;text-transform:uppercase;">Match Rate</div>
      <div style="font-size:18px;font-weight:700;color:#0d9488;font-family:var(--mono);">${form26AS.length>0?Math.round(matched26/form26AS.length*100):0}%</div>
    </div>
  </div>
  <div class="card pf-grid" style="overflow-x:auto;"><table class="tbl">
    <thead><tr><th>#</th><th>Deductor Name</th><th>TAN</th><th>PAN</th><th>Section</th><th class="tc">Quarter</th><th class="tr">Gross Credit (26AS)</th><th class="tr">TDS (26AS)</th><th class="tr">TDS (Books)</th><th class="tr">Variance</th><th class="tc">Status</th></tr></thead>
    <tbody>${reconRows||'<tr><td colspan="11" style="padding:18px;text-align:center;color:var(--tm);">No 26AS data loaded. Update sample data or import 26AS statement.</td></tr>'}</tbody>
    ${form26AS.length>0?`<tfoot><tr class="tf"><td colspan="6">TOTAL</td><td class="tr">${fmt(form26AS.reduce((s,x)=>s+x.amtCredit,0))}</td><td class="tr">${fmt(total26TDS)}</td><td class="tr">${fmt(totalRecTDS)}</td><td class="tr">${fmt(Math.abs(gap26))}</td><td class="tc">${matched26}/${form26AS.length} matched</td></tr></tfoot>`:''}
  </table></div>
  `:''}

  </div>`;
}

// ‚îÄ‚îÄ TDS Export Functions ‚îÄ‚îÄ
function exportTDSPayableSection(){
  const fyV=state.vouchers.filter(v=>v.tdsSection&&v.tdsSection!==''&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  const byS={};
  fyV.forEach(v=>{
    if(!byS[v.tdsSection])byS[v.tdsSection]={code:v.tdsSection,count:0,base:0,tds:0};
    const base=v.totals?.taxable||v.entries.reduce((s,e)=>s+(e.dr||0),0);
    const sec=TDS_SECTIONS.find(x=>x.code===v.tdsSection);
    const tds=v.totals?.tds||(sec?Math.round(base*sec.rate)/100:0);
    byS[v.tdsSection].count++;byS[v.tdsSection].base+=base;byS[v.tdsSection].tds+=tds;
  });
  exportXLS([
    [state.company,'','','',''],['TDS PAYABLE ‚Äî SECTION-WISE REPORT','','','',''],['Financial Year:',state.fy,'','TAN:',state.tan||'‚Äî'],['Generated on:',new Date().toLocaleDateString('en-IN'),'','',''],[''],
    ['TDS Section','Nature of Payment','No. of Bills','Total Taxable Amount','TDS Deducted (‚Çπ)'],
    ...Object.values(byS).map(s=>{const info=TDS_SECTIONS.find(x=>x.code===s.code);return[s.code,info?.desc||'‚Äî',s.count,s.base,s.tds];}),
    ['','','TOTAL TDS PAYABLE ‚Üí',Object.values(byS).reduce((s,x)=>s+x.base,0),Object.values(byS).reduce((s,x)=>s+x.tds,0)]
  ],'TDS Payable Section',`TDS_Payable_Section_FY${state.fy}.xlsx`);
  showToast('‚úÖ TDS Payable ‚Äî Section-wise report exported!');
}

function exportTDSPayableBill(){
  const fyV=state.vouchers.filter(v=>v.tdsSection&&v.tdsSection!==''&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  exportXLS([
    [state.company,'','','','','',''],['TDS PAYABLE ‚Äî BILL-WISE REPORT (FORM 26Q DATA)','','','','','',''],['Financial Year:',state.fy,'','TAN:',state.tan||'‚Äî','',''],[''],
    ['Date','Voucher No.','Party / Deductee','Narration','TDS Section','Nature','Taxable Amount','Rate %','TDS Amount'],
    ...fyV.map(v=>{
      const sec=TDS_SECTIONS.find(x=>x.code===v.tdsSection);
      const base=v.totals?.taxable||v.entries.reduce((s,e)=>s+(e.dr||0),0);
      const tds=v.totals?.tds||(sec?Math.round(base*sec.rate)/100:0);
      const party=vN(v.partyId)||dbN(v.partyId)||'‚Äî';
      return[v.date,v.id,party,v.narration,v.tdsSection,sec?.desc||'‚Äî',base,(sec?.rate||0)+'%',tds];
    }),
    ['','','','','','TOTAL TDS PAYABLE ‚Üí',fyV.reduce((s,v)=>{const base=v.totals?.taxable||v.entries.reduce((s2,e)=>s2+(e.dr||0),0);return s+base;},0),'',fyV.reduce((s,v)=>{const base=v.totals?.taxable||v.entries.reduce((s2,e)=>s2+(e.dr||0),0);const sec=TDS_SECTIONS.find(x=>x.code===v.tdsSection);return s+(v.totals?.tds||(sec?Math.round(base*sec.rate)/100:0));},0)]
  ],'TDS Payable Bill-wise',`TDS_Payable_Billwise_FY${state.fy}.xlsx`);
  showToast('‚úÖ TDS Payable ‚Äî Bill-wise report exported!');
}

function exportTDSReceivableSection(){
  const fyV=state.vouchers.filter(v=>v.tdsRecAmt&&v.tdsRecAmt>0&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  const byS={};
  fyV.forEach(v=>{
    const sec=v.tdsRecSection||'194J';
    if(!byS[sec])byS[sec]={code:sec,count:0,base:0,tds:0};
    byS[sec].count++;byS[sec].base+=v.tdsRecBase||0;byS[sec].tds+=v.tdsRecAmt||0;
  });
  exportXLS([
    [state.company,'','','',''],['TDS RECEIVABLE ‚Äî SECTION-WISE REPORT','','','',''],['Financial Year:',state.fy,'','',''],[''],
    ['TDS Section','Nature of Income','No. of Certificates','Total Base Amount','TDS Receivable (‚Çπ)'],
    ...Object.values(byS).map(s=>{const info=TDS_SECTIONS.find(x=>x.code===s.code);return[s.code,info?.desc||'‚Äî',s.count,s.base,s.tds];}),
    ['','','TOTAL TDS RECEIVABLE ‚Üí',Object.values(byS).reduce((s,x)=>s+x.base,0),Object.values(byS).reduce((s,x)=>s+x.tds,0)]
  ],'TDS Receivable Section',`TDS_Receivable_Section_FY${state.fy}.xlsx`);
  showToast('‚úÖ TDS Receivable ‚Äî Section-wise report exported!');
}

function exportTDSReceivableBill(){
  const fyV=state.vouchers.filter(v=>v.tdsRecAmt&&v.tdsRecAmt>0&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  exportXLS([
    [state.company,'','','','','','',''],['TDS RECEIVABLE ‚Äî BILL-WISE REPORT','','','','','','',''],['Financial Year:',state.fy,'','','','','',''],[''],
    ['Date','Voucher No.','Customer / Deductor','Narration','Section','Invoice Base','TDS Deducted','Deductor PAN','Quarter'],
    ...fyV.map(v=>{
      const dbr=state.debtors.find(d=>d.id===v.partyId);
      return[v.date,v.id,dbN(v.partyId)||'‚Äî',v.narration,v.tdsRecSection||'194J',v.tdsRecBase||0,v.tdsRecAmt||0,v.tdsRecDeductorPAN||dbr?.pan||'‚Äî',v.tdsRecQuarter||'‚Äî'];
    }),
    ['','','','','TOTAL TDS RECEIVABLE ‚Üí',fyV.reduce((s,v)=>s+(v.tdsRecBase||0),0),fyV.reduce((s,v)=>s+(v.tdsRecAmt||0),0),'','']
  ],'TDS Receivable Bill-wise',`TDS_Receivable_Billwise_FY${state.fy}.xlsx`);
  showToast('‚úÖ TDS Receivable ‚Äî Bill-wise report exported!');
}

function export26ASRecon(){
  const form26AS=state.form26AS||[];
  const fyRecV=state.vouchers.filter(v=>v.tdsRecAmt&&v.tdsRecAmt>0&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  const rows=form26AS.map(x=>{
    const booksAmt=fyRecV.filter(v=>{const dbr=state.debtors.find(d=>d.id===v.partyId);return((dbr?.pan===x.deductorPAN)||(v.tdsRecDeductorPAN===x.deductorPAN))&&(v.tdsRecSection||'194J')===x.section;}).reduce((s,v)=>s+(v.tdsRecAmt||0),0);
    const diff=x.tdsAmt-booksAmt;
    return[x.srNo,x.deductorName,x.deductorTAN||'‚Äî',x.deductorPAN,x.section,x.quarter,x.amtCredit,x.tdsAmt,booksAmt,diff,diff===0?'Matched':'Unmatched'];
  });
  const total26=form26AS.reduce((s,x)=>s+x.tdsAmt,0);
  const totalBooks=fyRecV.reduce((s,v)=>s+(v.tdsRecAmt||0),0);
  exportXLS([
    [state.company,'','','','','','','','','',''],['FORM 26AS RECONCILIATION STATEMENT','','','','','','','','','',''],['Financial Year:',state.fy,'','','','','','','','',''],[''],
    ['Sr.','Deductor Name','TAN','PAN','Section','Quarter','Gross Credit (26AS)','TDS as per 26AS','TDS as per Books','Variance','Status'],
    ...rows,
    ['','','','','','TOTAL ‚Üí',form26AS.reduce((s,x)=>s+x.amtCredit,0),total26,totalBooks,total26-totalBooks,'']
  ],'26AS Reconciliation',`26AS_Recon_FY${state.fy}.xlsx`);
  showToast('‚úÖ 26AS Reconciliation exported!');
}

function pgGST(){renderGST('all');}
function renderGST(filter){
  // Bug fix: include Debit Notes in output (sales-side) and Credit Notes in input (purchase-side)
  // Bug fix: filter by current FY
  const sV=state.vouchers.filter(v=>['Sales','Debit Note'].includes(v.type)&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  const pV=state.vouchers.filter(v=>['Purchase','Credit Note'].includes(v.type)&&v.date>=state.fyStart&&v.date<=state.fyEnd);

  // Bug fix: use correct GST accounts per voucher side
  // Sales/Debit Note: Output GST in 2002(CGST Cr), 2003(SGST Cr), 2004(IGST Cr)
  // Purchase/Credit Note: Input GST in 1006(CGST Dr), 1007(SGST Dr), 1008(IGST Dr)
  const calcVoucherGST=(vouchers, side='output')=>{
    let taxable=0,cgst=0,sgst=0,igst=0;
    vouchers.forEach(v=>{
      if(v.items&&v.items.length>0){
        v.items.forEach(it=>{taxable+=it.taxable||0;cgst+=it.cgst||0;sgst+=it.sgst||0;igst+=it.igst||0;});
      } else {
        if(side==='output'){
          // Read Output GST from liability accounts (Cr side)
          const cgstAmt=v.entries.filter(e=>e.accId==='2002').reduce((s,e)=>s+(e.cr||0),0);
          const sgstAmt=v.entries.filter(e=>e.accId==='2003').reduce((s,e)=>s+(e.cr||0),0);
          const igstAmt=v.entries.filter(e=>e.accId==='2004').reduce((s,e)=>s+(e.cr||0),0);
          const gross=v.entries.reduce((s,e)=>s+(e.dr||0),0);
          taxable+=gross-cgstAmt-sgstAmt-igstAmt;cgst+=cgstAmt;sgst+=sgstAmt;igst+=igstAmt;
        } else {
          // Read Input GST from asset accounts (Dr side)
          const cgstAmt=v.entries.filter(e=>e.accId==='1006').reduce((s,e)=>s+(e.dr||0),0);
          const sgstAmt=v.entries.filter(e=>e.accId==='1007').reduce((s,e)=>s+(e.dr||0),0);
          const igstAmt=v.entries.filter(e=>e.accId==='1008').reduce((s,e)=>s+(e.dr||0),0);
          const gross=v.entries.reduce((s,e)=>s+(e.dr||0),0);
          taxable+=gross-cgstAmt-sgstAmt-igstAmt;cgst+=cgstAmt;sgst+=sgstAmt;igst+=igstAmt;
        }
      }
    });
    return{taxable:Math.round(taxable*100)/100,cgst:Math.round(cgst*100)/100,sgst:Math.round(sgst*100)/100,igst:Math.round(igst*100)/100};
  };

  const salesGST=calcVoucherGST(sV,'output');
  const purchGST=calcVoucherGST(pV,'input');
  const inputCredit=purchGST.cgst+purchGST.sgst+purchGST.igst;
  const outputTax=salesGST.cgst+salesGST.sgst+salesGST.igst;
  const netGST=outputTax-inputCredit;

  const sRows=sV.map((v,i)=>{
    const g=calcVoucherGST([v],'output');
    return`<tr class="${i%2?'alt':''}"><td>${fmtD(v.date)}</td><td class="mono tb-">${v.id}</td><td class="tm-" style="font-size:11px;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${v.narration}</td><td class="tr">${fmt(g.taxable)}</td><td class="tr tg-">${fmt(g.cgst)}</td><td class="tr tg-">${fmt(g.sgst)}</td><td class="tr bp">${fmt(g.igst)}</td><td class="tr" style="font-weight:700;">${fmt(g.taxable+g.cgst+g.sgst+g.igst)}</td></tr>`;
  }).join('');

  const pRows=pV.map((v,i)=>{
    const g=calcVoucherGST([v],'input');
    return`<tr class="${i%2?'alt':''}"><td>${fmtD(v.date)}</td><td class="mono tb-">${v.id}</td><td class="tm-" style="font-size:11px;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${v.narration}</td><td class="tr">${fmt(g.taxable)}</td><td class="tr tg-">${fmt(g.cgst)}</td><td class="tr tg-">${fmt(g.sgst)}</td><td class="tr bp">${fmt(g.igst)}</td><td class="tr" style="font-weight:700;">${fmt(g.taxable+g.cgst+g.sgst+g.igst)}</td></tr>`;
  }).join('');

  eid('content').innerHTML=`
  <div class="page-full">
  <div class="tb no-print">
    <div style="font-weight:700;font-size:14px;">GST Reports ‚Äî FY ${state.fy}${state.gstin?' | GSTIN: '+state.gstin:''}</div>
    <button class="btn btn-s" onclick="exportGSTReport()" style="margin-left:auto;">‚¨á Export GSTR Excel</button>
  </div>
  <div class="sg" style="grid-template-columns:repeat(5,1fr);margin-bottom:14px;">
    <div class="sc sc-b"><div class="sl">Taxable Sales</div><div class="sv">${fmt(salesGST.taxable)}</div></div>
    <div class="sc sc-g"><div class="sl">Output GST (CGST+SGST+IGST)</div><div class="sv">${fmt(outputTax)}</div></div>
    <div class="sc sc-p"><div class="sl">Input Tax Credit</div><div class="sv">${fmt(inputCredit)}</div></div>
    <div class="sc ${netGST>=0?'sc-r':'sc-g'}"><div class="sl">Net GST ${netGST>=0?'Payable':'Refund'}</div><div class="sv">${fmt(Math.abs(netGST))}</div></div>
    <div class="sc sc-o"><div class="sl">Taxable Purchases</div><div class="sv">${fmt(purchGST.taxable)}</div></div>
  </div>

  <div style="background:#f0fdf4;border:1px solid #a7f3d0;border-radius:12px;padding:14px;margin-bottom:14px;">
    <div style="font-size:12px;font-weight:700;color:#065f46;margin-bottom:10px;">GSTR-3B Summary</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;font-size:12px;">
      <div><div style="color:var(--tm);font-size:10px;margin-bottom:4px;">Output Tax (Sales)</div>
        <div>CGST: <strong>${fmt(salesGST.cgst)}</strong></div>
        <div>SGST: <strong>${fmt(salesGST.sgst)}</strong></div>
        <div>IGST: <strong>${fmt(salesGST.igst)}</strong></div>
      </div>
      <div><div style="color:var(--tm);font-size:10px;margin-bottom:4px;">Input Tax Credit (Purchases)</div>
        <div>CGST: <strong>${fmt(purchGST.cgst)}</strong></div>
        <div>SGST: <strong>${fmt(purchGST.sgst)}</strong></div>
        <div>IGST: <strong>${fmt(purchGST.igst)}</strong></div>
      </div>
      <div><div style="color:var(--tm);font-size:10px;margin-bottom:4px;">Net GST Liability</div>
        <div>CGST Net: <strong style="color:${(salesGST.cgst-purchGST.cgst)>0?'#dc2626':'#059669'}">${fmt(Math.abs(salesGST.cgst-purchGST.cgst))}</strong></div>
        <div>SGST Net: <strong style="color:${(salesGST.sgst-purchGST.sgst)>0?'#dc2626':'#059669'}">${fmt(Math.abs(salesGST.sgst-purchGST.sgst))}</strong></div>
        <div>IGST Net: <strong style="color:${(salesGST.igst-purchGST.igst)>0?'#dc2626':'#059669'}">${fmt(Math.abs(salesGST.igst-purchGST.igst))}</strong></div>
      </div>
    </div>
  </div>

  <div class="g2 pf-grid" style="gap:14px;align-items:stretch;">
    <div>
      <div style="font-weight:700;color:#1d4ed8;font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;">GSTR-1: Sales Register (Output Tax)</div>
      <div class="card"><table class="tbl">
        <thead><tr><th>Date</th><th>Voucher</th><th>Narration</th><th class="tr">Taxable</th><th class="tr">CGST</th><th class="tr">SGST</th><th class="tr">IGST</th><th class="tr">Total</th></tr></thead>
        <tbody>${sRows||'<tr><td colspan="8" style="padding:14px;text-align:center;color:var(--tm)">No sales</td></tr>'}</tbody>
      </table></div>
    </div>
    <div>
      <div style="font-weight:700;color:#c2410c;font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;">GSTR-2: Purchase Register (Input Tax Credit)</div>
      <div class="card"><table class="tbl">
        <thead><tr><th>Date</th><th>Voucher</th><th>Narration</th><th class="tr">Taxable</th><th class="tr">CGST</th><th class="tr">SGST</th><th class="tr">IGST</th><th class="tr">Total</th></tr></thead>
        <tbody>${pRows||'<tr><td colspan="8" style="padding:14px;text-align:center;color:var(--tm)">No purchases</td></tr>'}</tbody>
      </table></div>
    </div>
  </div>
  </div>`;
}
function exportGSTReport(){
  const sV=state.vouchers.filter(v=>v.type==='Sales'),pV=state.vouchers.filter(v=>v.type==='Purchase');
  exportXLS([[state.company,'','','','','',''],['GST REPORT ‚Äî GSTR-3B','','','','','',''],['GSTIN:',state.gstin||'‚Äî','FY:',state.fy,'','',''],
    ['GSTR-1: SALES REGISTER','','','','','',''],['Date','Voucher','Narration','Taxable','CGST','SGST','IGST'],
    ...sV.flatMap(v=>{const g=v.items?.length?{taxable:v.items.reduce((s,i)=>s+(i.taxable||0),0),cgst:v.items.reduce((s,i)=>s+(i.cgst||0),0),sgst:v.items.reduce((s,i)=>s+(i.sgst||0),0),igst:v.items.reduce((s,i)=>s+(i.igst||0),0)}:{taxable:0,cgst:0,sgst:0,igst:0};return[[v.date,v.id,v.narration,g.taxable,g.cgst,g.sgst,g.igst]];}),
    [],['GSTR-2: PURCHASE REGISTER','','','','','',''],['Date','Voucher','Narration','Taxable','CGST','SGST','IGST'],
    ...pV.flatMap(v=>{const g=v.items?.length?{taxable:v.items.reduce((s,i)=>s+(i.taxable||0),0),cgst:v.items.reduce((s,i)=>s+(i.cgst||0),0),sgst:v.items.reduce((s,i)=>s+(i.sgst||0),0),igst:v.items.reduce((s,i)=>s+(i.igst||0),0)}:{taxable:0,cgst:0,sgst:0,igst:0};return[[v.date,v.id,v.narration,g.taxable,g.cgst,g.sgst,g.igst]];})],'GST Report',`GST_Report_FY${state.fy}.xlsx`);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: EXCEL IMPORT / EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgImport(){
  eid('content').innerHTML=`
  <div class="g2" style="gap:16px;">
    <div>
      <div style="font-weight:700;font-size:14px;margin-bottom:14px;">üì• Import Data</div>
      <div class="card" style="padding:20px;margin-bottom:14px;">
        <div style="font-weight:700;margin-bottom:8px;">Step 1: Download Excel Template</div>
        <div style="font-size:12px;color:var(--tm);margin-bottom:12px;">Download the template, fill in your data across all sheets (Accounts, Vouchers, Vendors, Debtors), then upload it back.</div>
        <button class="btn btn-p" onclick="downloadTemplate()">‚¨á Download Excel Template</button>
      </div>
      <div class="card" style="padding:20px;margin-bottom:14px;">
        <div style="font-weight:700;margin-bottom:8px;">Step 2: Upload Filled Excel ‚Üí Convert to JSON</div>
        <div style="font-size:12px;color:var(--tm);margin-bottom:12px;">Upload your filled Excel file. The app will read and convert it to JSON format for preview.</div>
        <input type="file" id="xl-upload" accept=".xlsx,.xls" style="display:none;" onchange="parseExcelImport(this)">
        <button class="btn btn-p" onclick="eid('xl-upload').click()">üìÇ Upload Excel File</button>
      </div>
      <div class="card" style="padding:20px;">
        <div style="font-weight:700;margin-bottom:8px;">Import from JSON Backup</div>
        <div style="font-size:12px;color:var(--tm);margin-bottom:12px;">Restore from a previously exported JSON backup file.</div>
        <input type="file" id="json-upload" accept=".json" style="display:none;" onchange="importJSON(this)">
        <button class="btn btn-g" onclick="eid('json-upload').click()">üìÇ Import JSON Backup</button>
      </div>
    </div>
    <div>
      <div style="font-weight:700;font-size:14px;margin-bottom:14px;">üì§ Export Data</div>
      <div class="card" style="padding:20px;">
        <div style="background:#ecfdf5;border:1.5px solid #a7f3d0;border-radius:10px;padding:14px;margin-bottom:14px;">
          <div style="font-weight:700;margin-bottom:4px;font-size:13px;">üóÇ Full Excel Backup (Recommended)</div>
          <div style="font-size:11px;color:#065f46;margin-bottom:10px;">Exports everything ‚Äî Accounts, Vouchers, Vendors, Debtors, Invoices, Employees, Payroll, Bank Statements & Trial Balance into a single multi-sheet Excel file.</div>
          <button class="btn btn-s" style="width:100%;justify-content:center;" onclick="exportFullBackupExcel()">‚¨á Download Full Excel Backup</button>
        </div>
        <div class="fgr" style="margin-bottom:14px;">
          <div style="font-weight:700;margin-bottom:4px;">üìä Standard Export (Accounts + Vouchers)</div>
          <div style="font-size:11px;color:var(--tm);margin-bottom:8px;">Core accounting data only ‚Äî Accounts, Vouchers, Vendors, Debtors, Trial Balance.</div>
          <button class="btn btn-p" onclick="exportAllExcel()">‚¨á Export Accounting Data (Excel)</button>
        </div>
        <div class="fgr" style="margin-bottom:14px;">
          <div style="font-weight:700;margin-bottom:4px;">üíæ JSON Backup</div>
          <div style="font-size:11px;color:var(--tm);margin-bottom:8px;">Complete raw backup. Use this to restore all data later.</div>
          <button class="btn btn-g" onclick="exportJSON()">üíæ Download JSON Backup</button>
        </div>
        <hr style="border:none;border-top:1px solid var(--bdr);margin:12px 0;">
        <div>
          <div style="font-weight:700;margin-bottom:4px;font-size:12px;">üìä Current Data Summary</div>
          <div style="font-size:11px;color:var(--tm);line-height:1.9;">
            üìã Accounts: <strong>${state.accounts.length}</strong> &nbsp;|&nbsp;
            üìù Vouchers: <strong>${state.vouchers.length}</strong><br>
            üè≠ Vendors: <strong>${state.vendors.length}</strong> &nbsp;|&nbsp;
            ü§ù Debtors: <strong>${state.debtors.length}</strong><br>
            üßæ Invoices: <strong>${(state.invoices||[]).length}</strong> &nbsp;|&nbsp;
            üë• Employees: <strong>${(state.employees||[]).length}</strong><br>
            üè¶ Bank Entries: <strong>${(state.bankStatements||[]).length}</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="import-preview" style="margin-top:16px;"></div>`;
}

function downloadTemplate(){
  const sheets=[
    {name:'Accounts',data:[
      ['AccounTally Pro ‚Äî Import Template','','','','',''],
      ['Instructions: Fill in data from row 4 onwards. Do not modify headers.','','','','',''],
      [],
      ['Account ID','Account Name','Group','Type (Asset/Liability/Income/Expense/Capital)','Opening Balance','Nature (Dr/Cr)'],
      ['1001','Cash in Hand','Cash & Bank','Asset',0,'Dr'],
      ['1002','Bank Account','Cash & Bank','Asset',0,'Dr'],
      ['3001','Sales Revenue','Sales Accounts','Income',0,'Cr'],
      ['4001','Purchases','Purchase Accounts','Expense',0,'Dr'],
      ['5001',"Owner's Capital",'Capital Account','Capital',0,'Cr'],
    ]},
    {name:'Vouchers',data:[
      ['AccounTally Pro ‚Äî Vouchers Import','','','','','','',''],
      ['Instructions: One row per entry line. Voucher ID groups entries together.','','','','','','',''],
      [],
      ['Voucher ID','Date (YYYY-MM-DD)','Type','Account ID','Debit Amount','Credit Amount','Narration','Reference No','Due Date (YYYY-MM-DD)'],
      ['[Voucher-ID]','[YYYY-MM-DD]','Receipt','[Account-ID]','[Debit]','[Credit]','[Narration]','[Ref]','[DueDate]'],
    ]},
    {name:'Vendors',data:[
      ['AccounTally Pro ‚Äî Vendor Master','','','','','','','','','','','',''],
      ['Instructions: One vendor per row','','','','','','','','','','','',''],
      [],
      ['Name','Address','City','State','Pincode','Contact','Email','GST Registered (Yes/No)','GSTN','Bank Name','Account No','IFSC','Branch','Credit Days'],
    ]},
    {name:'Debtors',data:[
      ['AccounTally Pro ‚Äî Debtor Master','','','','','','','','','','','',''],
      ['Instructions: One customer per row','','','','','','','','','','','',''],
      [],
      ['Name','Address','City','State','Pincode','Contact','Email','GST Registered (Yes/No)','GSTN','Bank Name','Account No','IFSC','Branch','Credit Days'],
    ]},
    {name:'README',data:[
      ['AccounTally Pro ‚Äî Import Instructions'],
      [],
      ['HOW TO IMPORT:'],
      ['1. Fill the Accounts sheet with your chart of accounts'],
      ['2. Fill Vouchers sheet with your transactions (one line per entry, group by Voucher ID)'],
      ['3. Fill Vendors sheet with your supplier details'],
      ['4. Fill Debtors sheet with your customer details'],
      ['5. Save this file'],
      ['6. In AccounTally Pro, go to Excel Import/Export ‚Üí Upload Excel File'],
      ['7. Preview the data and click Import'],
      [],
      ['IMPORTANT NOTES:'],
      ['- Do not change the column headers (row 4 in each sheet)'],
      ['- Dates must be in YYYY-MM-DD format'],
      ['- Account Type must be: Asset, Liability, Income, Expense, or Capital'],
      ['- Voucher Type must be: Receipt, Payment, Sales, Purchase, Journal, Contra, Debit Note, or Credit Note'],
      ['- GST Registered field: Enter Yes or No'],
    ]}
  ];
  exportMultiXLS(sheets,`AccounTally_Import_Template.xlsx`);
}

let importedData=null;

function parseExcelImport(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'binary'});
      importedData={accounts:[],vouchers:[],vendors:[],debtors:[]};
      // Parse Accounts
      if(wb.SheetNames.includes('Accounts')){
        const ws=wb.Sheets['Accounts'];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''}).slice(3).filter(r=>r[0]);
        importedData.accounts=rows.map(r=>({id:String(r[0]).trim(),name:String(r[1]).trim(),group:String(r[2]).trim(),type:String(r[3]).trim(),balance:parseFloat(r[4])||0,nature:String(r[5]).trim()||'Dr'})).filter(a=>a.id&&a.name);
      }
      // Parse Vouchers
      if(wb.SheetNames.includes('Vouchers')){
        const ws=wb.Sheets['Vouchers'];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''}).slice(3).filter(r=>r[0]);
        const vmap={};
        rows.forEach(r=>{
          const vid=String(r[0]).trim();
          if(!vmap[vid])vmap[vid]={id:vid,date:String(r[1]).trim(),type:String(r[2]).trim(),narration:String(r[6]).trim(),ref:String(r[7]).trim()||'',dueDate:String(r[8]).trim()||'',partyId:'',entries:[]};
          vmap[vid].entries.push({accId:String(r[3]).trim(),dr:parseFloat(r[4])||0,cr:parseFloat(r[5])||0});
        });
        importedData.vouchers=Object.values(vmap).filter(v=>v.entries.length>=2);
      }
      // Parse Vendors
      if(wb.SheetNames.includes('Vendors')){
        const ws=wb.Sheets['Vendors'];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''}).slice(3).filter(r=>r[0]);
        importedData.vendors=rows.map((r,i)=>({id:'v'+i,name:String(r[0]).trim(),address:String(r[1]).trim(),city:String(r[2]).trim(),state:String(r[3]).trim(),pincode:String(r[4]).trim(),contact:String(r[5]).trim(),email:String(r[6]).trim(),gstRegistered:String(r[7]).toLowerCase()==='yes',gstn:String(r[8]).trim(),bankName:String(r[9]).trim(),bankAccount:String(r[10]).trim(),bankIFSC:String(r[11]).trim(),bankBranch:String(r[12]).trim(),creditDays:parseInt(r[13])||30})).filter(v=>v.name);
      }
      // Parse Debtors
      if(wb.SheetNames.includes('Debtors')){
        const ws=wb.Sheets['Debtors'];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''}).slice(3).filter(r=>r[0]);
        importedData.debtors=rows.map((r,i)=>({id:'d'+i,name:String(r[0]).trim(),address:String(r[1]).trim(),city:String(r[2]).trim(),state:String(r[3]).trim(),pincode:String(r[4]).trim(),contact:String(r[5]).trim(),email:String(r[6]).trim(),gstRegistered:String(r[7]).toLowerCase()==='yes',gstn:String(r[8]).trim(),bankName:String(r[9]).trim(),bankAccount:String(r[10]).trim(),bankIFSC:String(r[11]).trim(),bankBranch:String(r[12]).trim(),creditDays:parseInt(r[13])||30})).filter(d=>d.name);
      }
      // Show preview
      const jsonStr=JSON.stringify(importedData,null,2);
      eid('import-preview').innerHTML=`
      <div class="card" style="padding:20px;">
        <div style="font-weight:700;font-size:14px;margin-bottom:12px;">üìã Import Preview (JSON)</div>
        <div class="g2" style="margin-bottom:14px;">
          <div class="al al-i" style="margin:0;">üìã Accounts: <strong>${importedData.accounts.length}</strong></div>
          <div class="al al-i" style="margin:0;">üìù Vouchers: <strong>${importedData.vouchers.length}</strong></div>
          <div class="al al-i" style="margin:0;">üè≠ Vendors: <strong>${importedData.vendors.length}</strong></div>
          <div class="al al-i" style="margin:0;">ü§ù Debtors: <strong>${importedData.debtors.length}</strong></div>
        </div>
        <div style="background:#f8fafc;border:1px solid var(--bdr);border-radius:8px;padding:12px;max-height:250px;overflow-y:auto;font-family:var(--mono);font-size:11px;white-space:pre-wrap;margin-bottom:14px;">${jsonStr.slice(0,3000)}${jsonStr.length>3000?'\n... [truncated for preview]':''}</div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-s" onclick="doImportExcel('merge')">‚úÖ Import (Merge with existing)</button>
          <button class="btn btn-d" onclick="doImportExcel('replace')">‚ö† Import (Replace all data)</button>
          <button class="btn btn-p" onclick="downloadImportedJSON()">‚¨á Download as JSON</button>
        </div>
      </div>`;
    }catch(err){eid('import-preview').innerHTML=`<div class="al al-d">Error parsing Excel: ${err.message}</div>`;}
  };
  reader.readAsBinaryString(file);
  input.value='';
}

function doImportExcel(mode){
  if(!importedData)return showAlert('No data to import');
  if(!confirm(`This will ${mode==='replace'?'REPLACE ALL your data':'merge imported data with existing'}. Continue?`))return;
  if(mode==='replace'){
    state.accounts=importedData.accounts;
    state.vouchers=importedData.vouchers;
    state.vendors=importedData.vendors;
    state.debtors=importedData.debtors;
  }else{
    // Merge: add new IDs, skip duplicates
    importedData.accounts.forEach(a=>{if(!state.accounts.find(x=>x.id===a.id))state.accounts.push(a);});
    importedData.vouchers.forEach(v=>{if(!state.vouchers.find(x=>x.id===v.id))state.vouchers.push(v);});
    importedData.vendors.forEach(v=>{if(!state.vendors.find(x=>x.name===v.name))state.vendors.push(v);});
    importedData.debtors.forEach(d=>{if(!state.debtors.find(x=>x.name===d.name))state.debtors.push(d);});
  }
  scheduleSave();
  showAlert(`Import successful! ${importedData.accounts.length} accounts, ${importedData.vouchers.length} vouchers imported.`);
  importedData=null;
  pgImport();
}

function downloadImportedJSON(){
  if(!importedData)return;
  const blob=new Blob([JSON.stringify(importedData,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`AccounTally_Import_Data_${today()}.json`;a.click();
}

function exportAllExcel(){
  const L=computeLedger();
  const rows=state.accounts.map(a=>({...a,...L[a.id]}));
  exportMultiXLS([
    {name:'Accounts',data:[['Account ID','Account Name','Group','Type','Opening Bal','Nature'],...state.accounts.map(a=>[a.id,a.name,a.group,a.type,a.balance,a.nature])]},
    {name:'Vouchers',data:[['Voucher ID','Date','Type','Account ID','Debit','Credit','Narration','Ref','Due Date'],...state.vouchers.flatMap(v=>v.entries.map(e=>[v.id,v.date,v.type,e.accId,e.dr||0,e.cr||0,v.narration,v.ref||'',v.dueDate||'']))]},
    {name:'Vendors',data:[['Name','Address','City','State','Pincode','Contact','Email','GST Registered','GSTN','Bank Name','Account No','IFSC','Branch','Credit Days'],...state.vendors.map(v=>[v.name,v.address,v.city,v.state,v.pincode,v.contact,v.email,v.gstRegistered?'Yes':'No',v.gstn,v.bankName,v.bankAccount,v.bankIFSC,v.bankBranch,v.creditDays])]},
    {name:'Debtors',data:[['Name','Address','City','State','Pincode','Contact','Email','GST Registered','GSTN','Bank Name','Account No','IFSC','Branch','Credit Days'],...state.debtors.map(d=>[d.name,d.address,d.city,d.state,d.pincode,d.contact,d.email,d.gstRegistered?'Yes':'No',d.gstn,d.bankName,d.bankAccount,d.bankIFSC,d.bankBranch,d.creditDays])]},
    {name:'Trial Balance',data:[['Account ID','Account Name','Debit','Credit'],...rows.map(r=>[r.id,r.name,r.closingDr||0,r.closingCr||0])]},
  ],`${state.company.replace(/\s+/g,'_')}_Complete_Export_${today()}.xlsx`);
}
function exportFullBackupExcel(){
  const L=computeLedger();
  const sheets=[
    {name:'Accounts',data:[['Account ID','Account Name','Group','Type','Opening Balance','Nature'],...state.accounts.map(a=>[a.id,a.name,a.group,a.type,a.balance,a.nature])]},
    {name:'Vouchers',data:[['Voucher ID','Date','Type','Account ID','Debit','Credit','Narration'],...state.vouchers.flatMap(v=>v.entries.map(e=>[v.id,v.date,v.type,e.accId,e.dr||0,e.cr||0,v.narration]))]},
    {name:'Vendors',data:[['Name','City','State','GSTN','Contact','Email'],...(state.vendors||[]).map(v=>[v.name,v.city,v.state,v.gstn,v.contact,v.email])]},
    {name:'Debtors',data:[['Name','City','State','GSTN','Contact','Email'],...(state.debtors||[]).map(d=>[d.name,d.city,d.state,d.gstn,d.contact,d.email])]},
    {name:'Invoices',data:[['Invoice No','Date','Customer','GSTN','Total'],...(state.invoices||[]).map(inv=>{const tot=(inv.items||[]).reduce((s,it)=>s+(it.qty*it.rate*(1+(it.gst||0)/100)),0);return [inv.id,inv.date,inv.customer,inv.customerGstin||'',tot.toFixed(2)];})]},
    {name:'Employees',data:[['ID','Name','Designation','Department','Basic','PAN'],...(state.employees||[]).map(e=>[e.id,e.name,e.designation,e.department,e.basic,e.pan])]},
    {name:'Payroll',data:[['Month','Emp ID','Name','Gross','PF','ESI','TDS','Net'],...(state.payroll||[]).flatMap(p=>(p.entries||[]).map(e=>[p.month,e.empId,e.name,e.gross||0,e.pf||0,e.esi||0,e.tds||0,e.net||0]))]},
    {name:'Bank Statements',data:[['Account ID','Date','Description','Debit','Credit','Balance','Matched'],...(state.bankStatements||[]).map(s=>[s.bankAccId,s.date,s.description,s.debit||0,s.credit||0,s.balance||0,s.matched?'Yes':'No'])]},
    {name:'Trial Balance',data:[['Account ID','Account Name','Debit','Credit'],...state.accounts.map(a=>[a.id,a.name,L[a.id]?.closingDr||0,L[a.id]?.closingCr||0])]},
  ];
  exportMultiXLS(sheets,`${(state.company||'AccounTally').replace(/\s+/g,'_')}_FullBackup_${today()}.xlsx`);
  showToast('‚úÖ Full Excel backup downloaded!','#059669');
}

function exportJSON(){
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`AccounTally_Backup_${today()}.json`;a.click();
}
function importJSON(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(!data.accounts||!data.vouchers)throw new Error('Invalid backup file');
      if(!confirm('Replace ALL current data with backup? This cannot be undone.'))return;
      state={...DEFAULT_STATE,...data};
      scheduleSave();
      showAlert('Backup restored successfully!');
      navigate('dashboard');
    }catch(err){showAlert('Import failed: '+err.message);}
  };
  reader.readAsText(file);
  input.value='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MY PROFILE ‚Äî update mobile + password for logged-in user
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function updateMyProfile(){
  const mobile = (eid('my-mobile')?.value||'').trim();
  const pass   = eid('my-pass')?.value||'';
  const pass2  = eid('my-pass2')?.value||'';
  const msgEl  = eid('my-profile-msg');
  const btn    = document.querySelector('#my-profile-msg ~ button');

  if(pass && pass !== pass2){
    if(msgEl){msgEl.textContent='‚ùå Passwords do not match.';msgEl.style.color='#dc2626';msgEl.style.display='block';}
    return;
  }
  if(pass && pass.length < 6){
    if(msgEl){msgEl.textContent='‚ùå Password must be at least 6 characters.';msgEl.style.color='#dc2626';msgEl.style.display='block';}
    return;
  }
  if(btn){btn.disabled=true;btn.textContent='Saving‚Ä¶';}
  try{
    const updates = {};
    if(pass) updates.password = pass;
    const mobileE164 = mobile && !mobile.startsWith('+') ? '+91'+mobile.replace(/^0/,'') : mobile;
    if(mobile) updates.data = { mobile: mobileE164 };

    if(Object.keys(updates).length === 0){
      if(msgEl){msgEl.textContent='‚ÑπÔ∏è Nothing to update.';msgEl.style.color='#6b7280';msgEl.style.display='block';}
      return;
    }

    // Update Supabase Auth (password + metadata)
    const {error: authErr} = await getSupa().auth.updateUser(updates);
    if(authErr) throw new Error('Auth update failed: ' + authErr.message);

    // Update app_users mobile column
    if(mobile){
      await getSupa().from('app_users')
        .update({mobile: mobileE164})
        .eq('username', currentUser.username);
      if(currentUser) currentUser.mobile = mobileE164;
    }

    if(msgEl){msgEl.textContent='‚úÖ Profile updated successfully!';msgEl.style.color='#059669';msgEl.style.display='block';}
    if(pass){
      // Clear password fields after change
      if(eid('my-pass')) eid('my-pass').value='';
      if(eid('my-pass2')) eid('my-pass2').value='';
    }
    logAudit('Profile Updated', 'User '+currentUser?.username+' updated their profile');
    setTimeout(()=>{if(msgEl)msgEl.style.display='none';},4000);
  }catch(e){
    if(msgEl){msgEl.textContent='‚ùå '+e.message;msgEl.style.color='#dc2626';msgEl.style.display='block';}
  }finally{
    if(btn){btn.disabled=false;btn.textContent='üíæ Save My Profile';}
  }
}

function pgSettings(){
  const fyList=generateFYList();const stateOpts=INDIAN_STATES.map(s=>`<option value="${s}" ${s===(state.companyState||'Maharashtra')?'selected':''}>${s}</option>`).join('');
  eid('content').innerHTML=`
  <div style="max-width:700px;">
    <div class="card" style="padding:22px;margin-bottom:14px;border:1.5px solid #bfdbfe;">
      <div style="font-size:15px;font-weight:700;margin-bottom:4px;">üë§ My Profile</div>
      <div style="font-size:12px;color:var(--tm);margin-bottom:14px;">Logged in as <strong>${currentUser?.username||'?'}</strong> ¬∑ Role: <strong>${currentUser?.role||'?'}</strong></div>
      <div class="fg">
        <div class="fgr">
          <label class="fl">üì± Mobile Number <small style="color:var(--tm);">(used for OTP password reset)</small></label>
          <input class="fc" id="my-mobile" type="tel" placeholder="+91 9876543210" maxlength="13"
            value="${currentUser?.mobile||''}">
        </div>
        <div class="fgr">
          <label class="fl">üîë New Password <small style="color:var(--tm);">(leave blank to keep current)</small></label>
          <input class="fc" type="password" id="my-pass" placeholder="Enter new password (min 6 chars)">
        </div>
        <div class="fgr">
          <label class="fl">üîë Confirm New Password</label>
          <input class="fc" type="password" id="my-pass2" placeholder="Re-enter new password">
        </div>
      </div>
      <div id="my-profile-msg" style="font-size:12px;margin-top:8px;display:none;"></div>
      <button class="btn btn-p" style="margin-top:12px;" onclick="updateMyProfile()">üíæ Save My Profile</button>
    </div>

    <div class="card" style="padding:22px;margin-bottom:14px;">
      <div style="font-size:15px;font-weight:700;margin-bottom:14px;">üè¢ Company Settings</div>
      <div class="fg">
        <div class="fgr" style="grid-column:span 2;"><label class="fl">Company Name *</label><input class="fc" id="s-co" value="${state.company}" placeholder="Your company name"></div>
        <div class="fgr" style="grid-column:span 2;"><label class="fl">Company Address</label><input class="fc" id="s-addr" value="${state.address||''}" placeholder="Registered address"></div>
        <div class="fgr"><label class="fl">GSTIN</label><input class="fc" id="s-gstin" value="${state.gstin||''}" placeholder="27AABCU9603R1ZX" maxlength="15" style="text-transform:uppercase;"></div>
        <div class="fgr"><label class="fl">State</label><select class="fc" id="s-cstate">${stateOpts}</select></div>
        <div class="fgr"><label class="fl">Financial Year</label>
          <select class="fc" id="s-fy">${fyList.map(f=>`<option value="${f}" ${f===state.fy?'selected':''}>${f}</option>`).join('')}</select>
        </div>
        <div class="fgr"><label class="fl">PAN</label><input class="fc" id="s-pan" value="${state.pan||''}" placeholder="AABCU9603R" maxlength="10" style="text-transform:uppercase;"></div>
        <div class="fgr"><label class="fl">FY Start Date</label><input type="date" class="fc" id="s-fys" value="${state.fyStart}"></div>
        <div class="fgr"><label class="fl">FY End Date</label><input type="date" class="fc" id="s-fye" value="${state.fyEnd}"></div>
        <div class="fgr"><label class="fl">Email</label><input type="email" class="fc" id="s-email" value="${state.email||''}" placeholder="company@email.com"></div>
        <div class="fgr"><label class="fl">Phone</label><input class="fc" id="s-phone" value="${state.phone||''}" placeholder="Contact number"></div>
      </div>
      <button class="btn btn-p" style="margin-top:14px;" onclick="saveSettings()">üíæ Save Company Settings</button>
    </div>

    <div class="card" style="padding:22px;margin-bottom:14px;">
      <div style="font-size:15px;font-weight:700;margin-bottom:14px;">üë• User Management</div>
      <div id="user-list-wrap">Loading...</div>
      ${currentUser?.role==='admin'?'<button class="btn btn-p" style="margin-top:12px;" onclick="openAddUserForm()">+ Add New User</button>':''}
    </div>

    <div class="card" style="padding:22px;margin-bottom:14px;">
      <div style="font-size:15px;font-weight:700;margin-bottom:4px;">üíæ Storage Info</div>
      <div style="font-size:12px;color:var(--tm);margin-bottom:12px;">All data is permanently stored in Supabase Cloud. It is safe, accessible from any device, and never deleted unless you manually clear it.</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-s" onclick="exportAllExcel()">‚¨á Export Full Data (Excel)</button>
        <button class="btn btn-p" onclick="exportJSON()">üíæ JSON Backup</button>
        <button class="btn btn-g" onclick="eid('json-upload2').click()">üìÇ Restore JSON</button>
        <input type="file" id="json-upload2" accept=".json" style="display:none;" onchange="importJSON(this)">
      </div>
    </div>

    <div class="card" style="padding:22px;border:2px solid #bfdbfe;margin-bottom:14px;">
      <div style="font-size:15px;font-weight:700;margin-bottom:4px;color:#1d4ed8;">üß™ Demo & Testing</div>
      <div style="font-size:12px;color:var(--tm);margin-bottom:12px;">Load sample data to explore all features ‚Äî includes vendors, customers, items, 21 vouchers (Sales, Purchase, Receipt, Payment, Debit Note, Credit Note, Journal), 5 employees, and April 2025 payroll.</div>
      <button class="btn btn-p" onclick="loadSampleData()">üì¶ Load Sample Data</button>
    </div>

    <div class="card" style="padding:22px;border:2px solid #fca5a5;">
      <div style="font-size:15px;font-weight:700;margin-bottom:4px;color:var(--bad);">‚ö† Danger Zone</div>
      <div style="font-size:12px;color:var(--tm);margin-bottom:16px;">Irreversible actions ‚Äî proceed with caution.</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;">
          <div>
            <div style="font-size:12px;font-weight:700;color:#991b1b;">üóë Reset All Data</div>
            <div style="font-size:11px;color:#7f1d1d;margin-top:2px;">Delete all vouchers, accounts, vendors, customers. Cannot be undone.</div>
          </div>
          <button class="btn btn-d btn-sm" onclick="resetAllData()">Reset</button>
        </div>
        ${currentUser?.role==='admin'?`
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;">
          <div>
            <div style="font-size:12px;font-weight:700;color:#991b1b;">üèö Delete This Company</div>
            <div style="font-size:11px;color:#7f1d1d;margin-top:2px;">Permanently delete <strong>${state.company}</strong>, all its data and all its users.</div>
          </div>
          <button class="btn btn-d btn-sm" onclick="confirmDeleteCompany('${state.companyId}','${(state.company||'').replace(/'/g,"\\'")}')">Delete</button>
        </div>`:''}
      </div>
    </div>
  </div>`;
  loadUserList();
}

async function loadUserList(){
  const wrap=eid('user-list-wrap');if(!wrap)return;
  try{
    const users=await DB.getAll('users');
    wrap.innerHTML=users.length?`<div class="card"><table class="tbl">
      <thead><tr><th>Username</th><th>Role</th><th class="no-print">Action</th></tr></thead>
      <tbody>${users.map(u=>`<tr><td class="fw-bold">${u.username}</td><td><span class="badge bb">${u.role||'user'}</span></td>
        <td>${u.username!==currentUser?.username ? (currentUser?.role==='admin' ? `<button class="btn btn-d btn-sm" onclick="delUser('${u.username}')">Del</button>` : '<span style="font-size:11px;color:var(--tm);">‚Äî</span>') : '<span class="badge bg-">You</span>'}</td>
      </tr>`).join('')}</tbody></table></div>`:'<div class="al al-i">No users found.</div>';
  }catch(e){if(wrap)wrap.innerHTML='<div class="al al-d">Error loading users</div>';}
}

function openAddUserForm(){
  openModal('Add New User',`
  <div class="fg">
    <div class="fgr"><label class="fl">Full Name *</label><input class="fc" id="nu-fname" placeholder="Display name"></div>
    <div class="fgr"><label class="fl">Username *</label><input class="fc" id="nu-user" placeholder="Login username"></div>
    <div class="fgr"><label class="fl">Role</label>
      <select class="fc" id="nu-role">
        <option value="admin">Admin ‚Äî Full access</option>
        <option value="accountant">Accountant ‚Äî Enter vouchers</option>
        <option value="viewer">Viewer ‚Äî Read only</option>
      </select>
    </div>
    <div class="fgr"><label class="fl">Mobile Number * <small style="color:var(--tm);">(OTP reset)</small></label><input class="fc" id="nu-mobile" type="tel" placeholder="+91 9876543210" maxlength="13"></div>
    <div class="fgr"><label class="fl">Password *</label><input type="password" class="fc" id="nu-pass" placeholder="Min 6 chars"></div>
    <div class="fgr"><label class="fl">Confirm Password *</label><input type="password" class="fc" id="nu-pass2" placeholder="Re-enter password"></div>
  </div>
  <div style="margin-top:14px;display:flex;gap:8px;">
    <button class="btn btn-p" onclick="addNewUser()">üíæ Create User</button>
    <button class="btn btn-g" onclick="closeModal()">Cancel</button>
  </div>`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHARED HELPER: get or create Supabase Auth user, return client
//  with their session so self-insert RLS passes
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function getOrCreateAuthUser(email, password, mobile) {
  const ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmc2x0eGVoZmRtbnd4a3dlY3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTg0MDgsImV4cCI6MjA4NzQzNDQwOH0.Xe8JTV2Gw1WfCx-0U4im64dZ8aw_wYWhrFqciDrX990';
  const URL  = 'https://dfsltxehfdmnwxkwecww.supabase.co';
  // Always use a fresh isolated client ‚Äî never touches admin session
  const tc = supabase.createClient(URL, ANON, {auth:{persistSession:false,autoRefreshToken:false}});

  let userId = null;
  let insertClient = null;  // client that holds new user's session

  // Step 1: Try signup
  const {data:sd, error:se} = await tc.auth.signUp({
    email, password,
    options:{ data:{ mobile: mobile||'' } }
  });

  if (!se) {
    // Fresh signup succeeded
    if (!sd.user) throw new Error('Signup returned no user. Go to Supabase ‚Üí Auth ‚Üí Settings ‚Üí Email and turn OFF "Enable email confirmations".');
    userId = sd.user.id;
    if (sd.session) await tc.auth.setSession(sd.session);
    insertClient = sd.session ? tc : getSupa();
  } else if (se.message.includes('already registered') || se.message.includes('already been registered')) {
    // Ghost user from a previous failed attempt ‚Äî sign in to reclaim
    const {data:ld, error:le} = await tc.auth.signInWithPassword({email, password});
    if (le) {
      // Wrong password ‚Äî this username is taken with a different password
      throw new Error('Username already exists with a different password. Use a different username.');
    }
    userId = ld.user.id;
    // Check if this auth user already has a working app_users row
    const {data:existing} = await getSupa().from('app_users').select('username,company_id').eq('user_id', userId).maybeSingle();
    if (existing) {
      throw new Error('Username "' + email.split('_')[0] + '" already exists in this or another company. Use a different username.');
    }
    if (ld.session) await tc.auth.setSession(ld.session);
    insertClient = ld.session ? tc : getSupa();
  } else {
    throw new Error('Auth error: ' + se.message);
  }

  return { userId, insertClient };
}

async function addNewUser(){
  const u=sanitizeInput(eid('nu-user').value.trim()),r=eid('nu-role').value;
  const p=eid('nu-pass').value,p2=eid('nu-pass2').value;
  if(!u||!p)return showAlert('Username and password required');
  if(p!==p2)return showAlert('Passwords do not match');
  if(p.length<6)return showAlert('Password must be at least 6 characters');
  const btn=document.querySelector('#modal .btn-p');
  if(btn){btn.disabled=true;btn.textContent='Creating‚Ä¶';}
  try{
    const username=u.toLowerCase();
    const companyId=state.companyId||_selectedCompanyId;
    const email=username+'_'+companyId.toLowerCase()+'@accountally.app';
    const rawMob=(eid('nu-mobile')?.value||'').trim();
    const mobile=rawMob&&!rawMob.startsWith('+')?'+91'+rawMob.replace(/^0/,''):rawMob;
    const fullName=eid('nu-fname')?.value.trim()||username;

    // Step 1: Create auth user via isolated tempClient (never touches admin session)
    const ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmc2x0eGVoZmRtbnd4a3dlY3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTg0MDgsImV4cCI6MjA4NzQzNDQwOH0.Xe8JTV2Gw1WfCx-0U4im64dZ8aw_wYWhrFqciDrX990';
    const tc=supabase.createClient('https://dfsltxehfdmnwxkwecww.supabase.co',ANON,{auth:{persistSession:false,autoRefreshToken:false}});
    const {data:sd,error:se}=await tc.auth.signUp({email,password:p,options:{data:{mobile}}});
    if(se) throw new Error('Auth signup failed: '+se.message);
    if(!sd.user) throw new Error('Signup returned no user ‚Äî turn OFF email confirmations in Supabase Auth Settings.');
    const userId=sd.user.id;

    // Step 2: Insert app_users using ADMIN session (RLS: "same company insert" policy allows this)
    const {error:userErr}=await getSupa().from('app_users').insert({
      username, user_id:userId, company_id:companyId, role:r, mobile
    });
    if(userErr) throw new Error('Could not save user profile: '+userErr.message);

    if(!state.appUsers)state.appUsers=[];
    if(!state.appUsers.find(x=>x.username===username)){
      state.appUsers.push({username,role:r,fullName,createdAt:new Date().toISOString()});
    }
    scheduleSave();
    closeModal();
    showToast('‚úÖ User "'+username+'" created successfully!','#059669');
    loadUserList();
  }catch(e){
    showAlert('Error creating user: '+(e.message||'Check your connection and try again.'));
  }finally{
    if(btn){btn.disabled=false;btn.textContent='üíæ Create User';}
  }
}
async function delUser(username){
  if(currentUser?.role!=='admin'){showToast('Only admins can delete users.','#dc2626');return;}
  if(!confirm(`Delete user "${username}"?`))return;
  await DB.del('users',username);
  loadUserList();
}

function loadSampleData(){
  if(!confirm('This will ADD sample data (vendors, customers, items, vouchers, employees, payroll) to your current data.\n\nExisting data will NOT be deleted.\n\nProceed?')) return;
  const s = state;
  injectSampleData(s);
  scheduleSave();
  showToast('‚úÖ Sample data loaded! 5 customers, 3 vendors, 5 items, 21 vouchers, 5 employees, 1 payroll added.','#059669');
  navigate('dashboard');
}

function saveSettings(){
  const co=eid('s-co').value.trim()||state.company;
  if(!co)return showAlert('Company name is required');
  const fy=eid('s-fy').value;
  const range=fyRange(fy);
  state.company=co;
  state.fy=fy;
  state.fyStart=eid('s-fys').value||range.start;
  state.fyEnd=eid('s-fye').value||range.end;
  state.gstin=(eid('s-gstin')?.value.toUpperCase().trim())||state.gstin||'';
  state.companyState=eid('s-cstate')?.value||state.companyState||'Maharashtra';
  state.pan=(eid('s-pan')?.value.toUpperCase().trim())||state.pan||'';
  state.address=eid('s-addr')?.value.trim()||state.address||'';
  state.email=eid('s-email')?.value.trim()||state.email||'';
  state.phone=eid('s-phone')?.value.trim()||state.phone||'';
  scheduleSave();
  eid('sb-company').textContent=co;
  eid('sb-fy').textContent='FY '+fy;
  eid('top-fy').textContent='FY '+fy;
  if(eid('topbar-gstin'))eid('topbar-gstin').textContent=state.gstin?'GSTIN: '+state.gstin:'';
  showToast('‚úÖ Company settings saved!','#059669');
}

// Auto-update FY dates when FY dropdown changes
document.addEventListener('change',function(e){
  if(e.target&&e.target.id==='s-fy'){
    const r=fyRange(e.target.value);
    if(eid('s-fys'))eid('s-fys').value=r.start;
    if(eid('s-fye'))eid('s-fye').value=r.end;
  }
});

function resetAllData(){
  if(!confirm('Delete ALL data and reset to defaults?\nThis will clear all vouchers, parties, items, and balances.'))return;
  if(!confirm('FINAL CONFIRMATION: This cannot be undone. All your accounting data will be deleted.'))return;
  const co=state.company,fy=state.fy,gs=state.gstin,cs=state.companyState,pa=state.pan,ad=state.address,em=state.email,ph=state.phone;
  const cid=state.companyId; // Preserve companyId ‚Äî critical for isolation
  const au=state.appUsers;   // Preserve users
  state=JSON.parse(JSON.stringify(DEFAULT_STATE));
  state.company=co;state.fy=fy;state.gstin=gs||'';state.companyState=cs||'Maharashtra';
  state.pan=pa||'';state.address=ad||'';state.email=em||'';state.phone=ph||'';
  state.companyId=cid;  // Restore companyId
  state.appUsers=au||[]; // Restore users
  scheduleSave();
  showToast('üóë All transaction data cleared. Company settings retained.','#dc2626');
  navigate('dashboard');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: GST INVOICE GENERATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let invFilter='all';
function pgInvoice(){
  if(!state.invoices)state.invoices=[];
  const list=state.invoices.filter(inv=>invFilter==='all'||inv.status===invFilter);
  const rows=list.sort((a,b)=>b.date.localeCompare(a.date)).map((inv,i)=>{
    const total=inv.items.reduce((s,it)=>s+(it.qty*it.rate*(1+(it.gst||0)/100)),0);

    return `<tr class="${i%2?'alt':''}">
      <td class="mono tb-">${inv.id}</td>
      <td>${fmtD(inv.date)}</td>
      <td>${inv.customer||'‚Äî'}</td>
      <td class="tr mono">${fmt(total)}</td>
      <td><span class="badge ${inv.status==='paid'?'bg-':inv.status==='cancelled'?'br':'by'}">${inv.status||'draft'}</span></td>
      <td>
        <button class="btn btn-g btn-sm" onclick="viewInvoice('${inv.id}')">üëÅ View</button>
        <button class="btn btn-p btn-sm" onclick="printInvoice('${inv.id}')">üñ® Print</button>
        ${inv.status!=='paid'?`<button class="btn btn-s btn-sm" onclick="markInvPaid('${inv.id}')">‚úÖ Paid</button>`:''}
        <button class="btn btn-d btn-sm" onclick="deleteInvoice('${inv.id}')">üóë</button>
      </td>
    </tr>`;
  }).join('');

  const totalInv=state.invoices.reduce((s,inv)=>s+inv.items.reduce((ss,it)=>ss+(it.qty*it.rate*(1+(it.gst||0)/100)),0),0);
  const paidInv=state.invoices.filter(i=>i.status==='paid').reduce((s,inv)=>s+inv.items.reduce((ss,it)=>ss+(it.qty*it.rate*(1+(it.gst||0)/100)),0),0);
  const pendingInv=totalInv-paidInv;

  eid('content').innerHTML=`
  <div class="sg" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px;">
    <div class="sc sc-b"><div class="sl">Total Invoices</div><div class="sv">${state.invoices.length}</div><div class="ss">All time</div></div>
    <div class="sc sc-g"><div class="sl">Total Billed</div><div class="sv">${fmt(totalInv)}</div><div class="ss">Incl. GST</div></div>
    <div class="sc sc-p"><div class="sl">Paid</div><div class="sv">${fmt(paidInv)}</div><div class="ss">${state.invoices.filter(i=>i.status==='paid').length} invoices</div></div>
    <div class="sc sc-o"><div class="sl">Pending</div><div class="sv">${fmt(pendingInv)}</div><div class="ss">${state.invoices.filter(i=>i.status!=='paid'&&i.status!=='cancelled').length} invoices</div></div>
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
    <div class="tg">
      <button class="t ${invFilter==='all'?'act':''}" onclick="invFilter='all';pgInvoice()">All</button>
      <button class="t ${invFilter==='draft'?'act':''}" onclick="invFilter='draft';pgInvoice()">Draft</button>
      <button class="t ${invFilter==='paid'?'act':''}" onclick="invFilter='paid';pgInvoice()">Paid</button>
    </div>
    <button class="btn btn-p" onclick="openNewInvoice()">‚ûï New GST Invoice</button>
  </div>
  <div class="card">
    <table class="tbl">
      <thead><tr><th>Invoice No</th><th>Date</th><th>Customer</th><th class="tr">Amount</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody>${rows||'<tr><td colspan="6" class="tc tm-" style="padding:20px;">No invoices yet. Click "New GST Invoice" to create one.</td></tr>'}</tbody>
    </table>
  </div>`;
}

function openNewInvoice(){
  const invNo='INV-'+String(Date.now()).slice(-6);
  const custOpts=state.debtors.map(d=>`<option value="${d.name}">${d.name}</option>`).join('');
  const itemOpts=state.items.map(it=>`<option value="${it.name}" data-rate="${it.sellingPrice||0}" data-hsn="${it.hsn||''}" data-gst="${it.gst||18}">${it.name}</option>`).join('');
  openModal('üßæ New GST Invoice',`
    <div class="fg" style="margin-bottom:14px;">
      <div class="fgr"><label class="fl">Invoice No</label><input class="fc" id="inv-no" value="${invNo}" readonly></div>
      <div class="fgr"><label class="fl">Date</label><input class="fc" id="inv-date" type="date" value="${today()}"></div>
      <div class="fgr"><label class="fl">Customer Name</label>
        <input class="fc" id="inv-cust" list="inv-cust-list" placeholder="Customer name">
        <datalist id="inv-cust-list">${custOpts}</datalist>
      </div>
      <div class="fgr"><label class="fl">Customer GSTIN</label><input class="fc" id="inv-cgstin" placeholder="Customer GSTIN (optional)"></div>
    </div>
    <div class="fgr" style="margin-bottom:10px;"><label class="fl">Customer Address</label><textarea class="fc" id="inv-caddr" rows="2" placeholder="Billing address"></textarea></div>
    <div style="font-weight:700;font-size:11px;color:var(--tm);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Invoice Items</div>
    <table class="et" id="inv-items-tbl" style="margin-bottom:10px;">
      <thead><tr><th>#</th><th>Item / Description</th><th>HSN/SAC</th><th>Qty</th><th>Rate (‚Çπ)</th><th>GST%</th><th>Amount</th><th></th></tr></thead>
      <tbody id="inv-items-body">
        <tr id="inv-row-1">
          <td>1</td>
          <td><input class="fc" style="min-width:140px;" id="inv-item-1" list="inv-item-list-1" oninput="autoFillItem(1)" placeholder="Item name">
          <datalist id="inv-item-list-1">${itemOpts}</datalist></td>
          <td><input class="fc" style="width:80px;" id="inv-hsn-1" placeholder="HSN"></td>
          <td><input class="fc" style="width:60px;" id="inv-qty-1" type="number" value="1" oninput="calcInvRow(1)"></td>
          <td><input class="fc" style="width:90px;" id="inv-rate-1" type="number" value="0" oninput="calcInvRow(1)"></td>
          <td><select class="fc" style="width:70px;" id="inv-gst-1" onchange="calcInvRow(1)"><option>0</option><option>5</option><option selected>18</option><option>12</option><option>28</option></select></td>
          <td id="inv-amt-1" class="mono" style="text-align:right;">0.00</td>
          <td></td>
        </tr>
      </tbody>
      <tfoot><tr><td colspan="6" style="text-align:right;font-weight:700;padding:8px;">Total</td><td id="inv-total" class="mono" style="text-align:right;font-weight:700;padding:8px;">0.00</td><td></td></tr></tfoot>
    </table>
    <button class="btn btn-g btn-sm" onclick="addInvRow()">‚ûï Add Row</button>
    <div class="fg" style="margin-top:14px;">
      <div class="fgr"><label class="fl">Payment Terms</label>
        <select class="fc" id="inv-terms"><option>Due on Receipt</option><option>Net 7</option><option>Net 15</option><option>Net 30</option><option>Net 45</option><option>Net 60</option></select>
      </div>
      <div class="fgr"><label class="fl">Notes</label><input class="fc" id="inv-notes" placeholder="Thank you for your business!"></div>
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;">
      <button class="btn btn-p" onclick="saveInvoice('draft')">üíæ Save Draft</button>
      <button class="btn btn-s" onclick="saveInvoice('sent')">üì§ Save & Print</button>
      <button class="btn btn-g" onclick="closeModal()">Cancel</button>
    </div>
  `);
  window._invRowCount=1;
}

let _invRowCount=1;
function addInvRow(){
  _invRowCount++;
  const n=_invRowCount;
  const itemOpts=state.items.map(it=>`<option value="${it.name}" data-rate="${it.sellingPrice||0}" data-hsn="${it.hsn||''}" data-gst="${it.gst||18}">${it.name}</option>`).join('');
  const tbody=document.getElementById('inv-items-body');
  const tr=document.createElement('tr');
  tr.id='inv-row-'+n;
  tr.innerHTML=`<td>${n}</td>
    <td><input class="fc" style="min-width:140px;" id="inv-item-${n}" list="inv-item-list-${n}" oninput="autoFillItem(${n})" placeholder="Item name">
    <datalist id="inv-item-list-${n}">${itemOpts}</datalist></td>
    <td><input class="fc" style="width:80px;" id="inv-hsn-${n}" placeholder="HSN"></td>
    <td><input class="fc" style="width:60px;" id="inv-qty-${n}" type="number" value="1" oninput="calcInvRow(${n})"></td>
    <td><input class="fc" style="width:90px;" id="inv-rate-${n}" type="number" value="0" oninput="calcInvRow(${n})"></td>
    <td><select class="fc" style="width:70px;" id="inv-gst-${n}" onchange="calcInvRow(${n})"><option>0</option><option>5</option><option>12</option><option selected>18</option><option>28</option></select></td>
    <td id="inv-amt-${n}" class="mono" style="text-align:right;">0.00</td>
    <td><button class="btn btn-d btn-sm" onclick="document.getElementById('inv-row-${n}').remove();calcInvTotal()">‚úï</button></td>`;
  tbody.appendChild(tr);
}

function autoFillItem(n){
  const name=document.getElementById('inv-item-'+n)?.value;
  const it=state.items.find(i=>i.name===name);
  if(!it)return;
  if(document.getElementById('inv-hsn-'+n)) document.getElementById('inv-hsn-'+n).value=it.hsn||'';
  if(document.getElementById('inv-rate-'+n)) document.getElementById('inv-rate-'+n).value=it.sellingPrice||0;
  const gstSel=document.getElementById('inv-gst-'+n);
  if(gstSel){[...gstSel.options].forEach(o=>{if(Number(o.value)===Number(it.gst||18))o.selected=true;});}
  calcInvRow(n);
}

function calcInvRow(n){
  const qty=parseFloat(document.getElementById('inv-qty-'+n)?.value||0);
  const rate=parseFloat(document.getElementById('inv-rate-'+n)?.value||0);
  const gst=parseFloat(document.getElementById('inv-gst-'+n)?.value||0);
  const amt=qty*rate*(1+gst/100);
  const el=document.getElementById('inv-amt-'+n);
  if(el)el.textContent=amt.toFixed(2);
  calcInvTotal();
}

function calcInvTotal(){
  let total=0;
  const tbody=document.getElementById('inv-items-body');
  if(!tbody)return;
  [...tbody.rows].forEach(tr=>{
    const id=tr.id?.replace('inv-row-','');
    if(!id)return;
    const el=document.getElementById('inv-amt-'+id);
    total+=parseFloat(el?.textContent||0);
  });
  const tel=document.getElementById('inv-total');
  if(tel)tel.textContent=total.toFixed(2);
}

function saveInvoice(status){
  const no=document.getElementById('inv-no')?.value;
  const date=document.getElementById('inv-date')?.value;
  const cust=document.getElementById('inv-cust')?.value;
  if(!cust){showAlert('Please enter customer name.');return;}
  const items=[];
  const tbody=document.getElementById('inv-items-body');
  [...tbody.rows].forEach(tr=>{
    const id=tr.id?.replace('inv-row-','');
    if(!id)return;
    const name=document.getElementById('inv-item-'+id)?.value||'';
    if(!name)return;
    items.push({
      name,
      hsn:document.getElementById('inv-hsn-'+id)?.value||'',
      qty:parseFloat(document.getElementById('inv-qty-'+id)?.value||1),
      rate:parseFloat(document.getElementById('inv-rate-'+id)?.value||0),
      gst:parseFloat(document.getElementById('inv-gst-'+id)?.value||0),
    });
  });
  if(!items.length){showAlert('Add at least one item.');return;}
  const inv={
    id:no, date, customer:cust,
    customerGstin:document.getElementById('inv-cgstin')?.value||'',
    customerAddr:document.getElementById('inv-caddr')?.value||'',
    terms:document.getElementById('inv-terms')?.value||'Due on Receipt',
    notes:document.getElementById('inv-notes')?.value||'',
    items, status,
    createdBy:currentUser?.username||'admin',
    createdAt:new Date().toISOString(),
  };
  if(!state.invoices)state.invoices=[];
  state.invoices.push(inv);
  logAudit('Invoice Created', `Invoice ${inv.id} for ${inv.customer}`);
  scheduleSave();
  closeModal();
  showToast('‚úÖ Invoice saved!','#059669');
  if(status==='sent')printInvoice(no);
  pgInvoice();
}

function markInvPaid(id){
  const inv=state.invoices.find(i=>i.id===id);
  if(!inv)return;
  inv.status='paid';
  scheduleSave();
  showToast('‚úÖ Invoice marked as paid!','#059669');
  pgInvoice();
}

function deleteInvoice(id){
  if(!confirm('Delete this invoice?'))return;
  const _delInv=state.invoices.find(i=>i.id===id);
  state.invoices=state.invoices.filter(i=>i.id!==id);
  logAudit('Invoice Deleted', `Invoice ${id} customer: ${_delInv?.customer||'?'}`);
  scheduleSave();
  pgInvoice();
}

function viewInvoice(id){
  const inv=state.invoices.find(i=>i.id===id);
  if(!inv)return;
  const html=buildInvoiceHTML(inv);
  openModal('Invoice Preview - '+id,`<div>${html}</div><div style="margin-top:14px;display:flex;gap:8px;"><button class="btn btn-p" onclick="printInvoice('${id}')">üñ® Print</button><button class="btn btn-g" onclick="closeModal()">Close</button></div>`);
}

function printInvoice(id){
  const inv=state.invoices.find(i=>i.id===id);
  if(!inv){showToast('Invoice not found','#dc2626');return;}
  const html=buildInvoiceHTML(inv);
  const w=window.open('','_blank','width=900,height=700');
  w.document.write(`<!DOCTYPE html><html><head><title>Invoice ${inv.id}</title>
  <style>
    body{font-family:Arial,sans-serif;font-size:13px;color:#111;margin:0;padding:0;}
    .inv-wrap{max-width:800px;margin:0 auto;padding:30px;}
    .inv-header{display:flex;justify-content:space-between;border-bottom:3px solid #1d4ed8;padding-bottom:14px;margin-bottom:14px;}
    .company-name{font-size:22px;font-weight:800;color:#1d4ed8;}
    .inv-title{font-size:28px;font-weight:800;color:#1d4ed8;text-align:right;}
    .inv-meta{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:16px;}
    .inv-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;}
    .inv-box-title{font-size:10px;font-weight:700;text-transform:uppercase;color:#64748b;margin-bottom:6px;}
    table{width:100%;border-collapse:collapse;margin-bottom:16px;}
    th{background:#1d4ed8;color:#fff;padding:8px 10px;text-align:left;font-size:11px;}
    td{padding:7px 10px;border-bottom:1px solid #e2e8f0;}
    .tr{text-align:right;}.tc{text-align:center;}
    .totals-box{margin-left:auto;width:300px;}
    .tot-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px dashed #e2e8f0;}
    .tot-final{display:flex;justify-content:space-between;padding:8px;background:#1d4ed8;color:#fff;font-weight:800;border-radius:6px;margin-top:6px;}
    .footer{margin-top:30px;border-top:1px solid #e2e8f0;padding-top:12px;font-size:11px;color:#64748b;}
    @media print{body{margin:0;}.no-print{display:none;}}
  </style></head><body>${html}</body></html>`);
  w.document.close();
  setTimeout(()=>w.print(),600);
}

function buildInvoiceHTML(inv){
  const subtotal=inv.items.reduce((s,it)=>s+(it.qty*it.rate),0);
  let cgst=0,sgst=0,igst=0;
  const isIntra=(inv.customerState===state.companyState||!inv.customerState);
  inv.items.forEach(it=>{
    const taxAmt=it.qty*it.rate*(it.gst/100);
    if(isIntra){cgst+=taxAmt/2;sgst+=taxAmt/2;}else{igst+=taxAmt;}
  });
  const total=subtotal+cgst+sgst+igst;
  const itemRows=inv.items.map((it,i)=>{
    const taxable=it.qty*it.rate;
    const taxAmt=taxable*(it.gst/100);
    return `<tr>
      <td class="tc">${i+1}</td>
      <td>${it.name}</td>
      <td class="tc">${it.hsn||'‚Äî'}</td>
      <td class="tc">${it.qty}</td>
      <td class="tr">‚Çπ${fmtN(it.rate)}</td>
      <td class="tr">‚Çπ${fmtN(taxable)}</td>
      <td class="tc">${it.gst}%</td>
      <td class="tr">‚Çπ${fmtN(taxAmt)}</td>
      <td class="tr">‚Çπ${fmtN(taxable+taxAmt)}</td>
    </tr>`;
  }).join('');

  return `<div class="inv-wrap">
    <div class="inv-header">
      <div>
        <div class="company-name">${state.company}</div>
        ${state.gstin?`<div style="font-size:12px;color:#475569;margin-top:4px;">GSTIN: ${state.gstin}</div>`:''}
        ${state.address?`<div style="font-size:12px;color:#475569;">${state.address}</div>`:''}
        ${state.phone?`<div style="font-size:12px;color:#475569;">üìû ${state.phone}</div>`:''}
      </div>
      <div style="text-align:right;">
        <div class="inv-title">TAX INVOICE</div>
        <div style="font-size:13px;margin-top:4px;"><strong>#${inv.id}</strong></div>
        <div style="font-size:12px;color:#475569;">Date: ${fmtD(inv.date)}</div>
        <div style="font-size:12px;color:#475569;">Terms: ${inv.terms||'Due on Receipt'}</div>
      </div>
    </div>
    <div class="inv-meta">
      <div class="inv-box">
        <div class="inv-box-title">Bill To</div>
        <div style="font-weight:700;font-size:14px;">${inv.customer}</div>
        ${inv.customerGstin?`<div style="font-size:12px;color:#475569;">GSTIN: ${inv.customerGstin}</div>`:''}
        ${inv.customerAddr?`<div style="font-size:12px;color:#475569;">${inv.customerAddr}</div>`:''}
      </div>
      <div class="inv-box">
        <div class="inv-box-title">Invoice Details</div>
        <div><strong>Invoice No:</strong> ${inv.id}</div>
        <div><strong>Date:</strong> ${fmtD(inv.date)}</div>
        <div><strong>Financial Year:</strong> ${state.fy}</div>
        <div><strong>Status:</strong> <span style="color:${inv.status==='paid'?'#059669':'#d97706'};font-weight:700;">${(inv.status||'draft').toUpperCase()}</span></div>
      </div>
    </div>
    <table>
      <thead><tr><th class="tc">#</th><th>Item / Description</th><th class="tc">HSN/SAC</th><th class="tc">Qty</th><th class="tr">Rate</th><th class="tr">Taxable</th><th class="tc">GST%</th><th class="tr">Tax Amt</th><th class="tr">Total</th></tr></thead>
      <tbody>${itemRows}</tbody>
    </table>
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:20px;">
      <div style="flex:1;">
        ${inv.notes?`<div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:10px;font-size:12px;"><strong>Notes:</strong> ${inv.notes}</div>`:''}
        ${state.gstin?`<div style="margin-top:10px;font-size:11px;color:#64748b;">Subject to ${state.companyState||'Maharashtra'} Jurisdiction</div>`:''}
      </div>
      <div class="totals-box">
        <div class="tot-row"><span>Subtotal (Taxable)</span><span>‚Çπ${fmtN(subtotal)}</span></div>
        ${cgst>0?`<div class="tot-row"><span>CGST</span><span>‚Çπ${fmtN(cgst)}</span></div><div class="tot-row"><span>SGST</span><span>‚Çπ${fmtN(sgst)}</span></div>`:''}
        ${igst>0?`<div class="tot-row"><span>IGST</span><span>‚Çπ${fmtN(igst)}</span></div>`:''}
        <div class="tot-final"><span>Grand Total</span><span>‚Çπ${fmtN(total)}</span></div>
      </div>
    </div>
    <div class="footer">
      <div style="display:flex;justify-content:space-between;">
        <div>This is a computer-generated invoice.</div>
        <div style="text-align:right;margin-top:40px;border-top:1px solid #e2e8f0;padding-top:6px;">Authorised Signatory<br><strong>${state.company}</strong></div>
      </div>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: EMPLOYEE MASTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgEmployees(){
  if(!state.employees)state.employees=[];
  const rows=state.employees.map((e,i)=>`<tr class="${i%2?'alt':''}">
    <td class="mono tb-">${e.id}</td>
    <td><strong>${e.name}</strong></td>
    <td>${e.designation||'‚Äî'}</td>
    <td>${e.department||'‚Äî'}</td>
    <td class="tr mono">${fmt(e.basicSalary||0)}</td>
    <td class="tr mono">${fmt(e.grossSalary||0)}</td>
    <td><span class="badge ${e.status==='active'?'bg-':'br'}">${e.status||'active'}</span></td>
    <td>
      <button class="btn btn-g btn-sm" onclick="editEmployee('${e.id}')">‚úèÔ∏è Edit</button>
      <button class="btn btn-d btn-sm" onclick="deleteEmployee('${e.id}')">üóë</button>
    </td>
  </tr>`).join('');

  eid('content').innerHTML=`
  <div class="sg" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px;">
    <div class="sc sc-b"><div class="sl">Total Employees</div><div class="sv">${state.employees.length}</div></div>
    <div class="sc sc-g"><div class="sl">Active</div><div class="sv">${state.employees.filter(e=>e.status==='active').length}</div></div>
    <div class="sc sc-o"><div class="sl">Monthly Payroll</div><div class="sv">${fmt(state.employees.filter(e=>e.status==='active').reduce((s,e)=>s+(e.grossSalary||0),0))}</div></div>
    <div class="sc sc-p"><div class="sl">Departments</div><div class="sv">${[...new Set(state.employees.map(e=>e.department).filter(Boolean))].length}</div></div>
  </div>
  <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
    <button class="btn btn-p" onclick="openAddEmployee()">‚ûï Add Employee</button>
  </div>
  <div class="card">
    <table class="tbl">
      <thead><tr><th>Emp ID</th><th>Name</th><th>Designation</th><th>Department</th><th class="tr">Basic Salary</th><th class="tr">Gross Salary</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody>${rows||'<tr><td colspan="8" class="tc tm-" style="padding:20px;">No employees. Add your first employee.</td></tr>'}</tbody>
    </table>
  </div>`;
}

function openAddEmployee(id){
  const emp=id?state.employees.find(e=>e.id===id):{};
  const isEdit=!!id;
  // Bug fix: use max existing ID number + 1 to avoid duplicates after deletion
  const existingNums=(state.employees||[]).map(e=>parseInt((e.id||'').replace(/\D/g,''))||0);
  const nextEmpNum=(existingNums.length?Math.max(...existingNums):0)+1;
  const newId='EMP-'+String(nextEmpNum).padStart(3,'0');
  openModal((isEdit?'‚úèÔ∏è Edit':'‚ûï Add')+' Employee',`
    <div class="fg">
      <div class="fgr"><label class="fl">Employee ID</label><input class="fc" id="emp-id" value="${isEdit?emp.id:newId}" ${isEdit?'readonly':''}></div>
      <div class="fgr"><label class="fl">Full Name *</label><input class="fc" id="emp-name" value="${emp.name||''}" placeholder="Employee full name"></div>
      <div class="fgr"><label class="fl">Designation</label><input class="fc" id="emp-desg" value="${emp.designation||''}" placeholder="e.g. Accountant"></div>
      <div class="fgr"><label class="fl">Department</label><input class="fc" id="emp-dept" value="${emp.department||''}" placeholder="e.g. Accounts"></div>
      <div class="fgr"><label class="fl">Date of Joining</label><input class="fc" id="emp-doj" type="date" value="${emp.doj||today()}"></div>
      <div class="fgr"><label class="fl">Date of Birth</label><input class="fc" id="emp-dob" type="date" value="${emp.dob||''}"></div>
      <div class="fgr"><label class="fl">PAN Number</label><input class="fc" id="emp-pan" value="${emp.pan||''}" placeholder="ABCDE1234F"></div>
      <div class="fgr"><label class="fl">Aadhaar No</label><input class="fc" id="emp-aadh" value="${emp.aadhaar||''}" placeholder="XXXX-XXXX-XXXX"></div>
      <div class="fgr"><label class="fl">Mobile</label><input class="fc" id="emp-mob" value="${emp.mobile||''}" placeholder="10-digit mobile"></div>
      <div class="fgr"><label class="fl">Email</label><input class="fc" id="emp-email" value="${emp.email||''}" placeholder="employee@email.com"></div>
      <div class="fgr"><label class="fl">Bank Account No</label><input class="fc" id="emp-bank" value="${emp.bankAccNo||''}" placeholder="Account number"></div>
      <div class="fgr"><label class="fl">IFSC Code</label><input class="fc" id="emp-ifsc" value="${emp.ifsc||''}" placeholder="IFSC code"></div>
    </div>
    <div style="background:#f8fafc;border-radius:8px;padding:14px;margin-top:12px;">
      <div style="font-weight:700;font-size:11px;color:var(--tm);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">üí∞ Salary Structure</div>
      <div class="fg">
        <div class="fgr"><label class="fl">Basic Salary (‚Çπ)</label><input class="fc" id="emp-basic" type="number" value="${emp.basicSalary||0}" oninput="calcEmpSalary()"></div>
        <div class="fgr"><label class="fl">HRA (‚Çπ)</label><input class="fc" id="emp-hra" type="number" value="${emp.hra||0}" oninput="calcEmpSalary()"></div>
        <div class="fgr"><label class="fl">DA (‚Çπ)</label><input class="fc" id="emp-da" type="number" value="${emp.da||0}" oninput="calcEmpSalary()"></div>
        <div class="fgr"><label class="fl">Other Allowances (‚Çπ)</label><input class="fc" id="emp-other" type="number" value="${emp.otherAllow||0}" oninput="calcEmpSalary()"></div>
        <div class="fgr"><label class="fl">PF Deduction (‚Çπ)</label><input class="fc" id="emp-pf" type="number" value="${emp.pf||0}" oninput="calcEmpSalary()"></div>
        <div class="fgr"><label class="fl">PT / Prof Tax (‚Çπ)</label><input class="fc" id="emp-pt" type="number" value="${emp.pt||0}" oninput="calcEmpSalary()"></div>
        <div class="fgr"><label class="fl">TDS (‚Çπ/month)</label><input class="fc" id="emp-tds" type="number" value="${emp.tds||0}" oninput="calcEmpSalary()"></div>
        <div class="fgr"><label class="fl">Gross Salary (Auto)</label><input class="fc" id="emp-gross" readonly style="background:#e8f5e9;font-weight:700;color:#059669;" value="${emp.grossSalary||0}"></div>
        <div class="fgr"><label class="fl">Net Salary (Auto)</label><input class="fc" id="emp-net" readonly style="background:#e3f2fd;font-weight:700;color:#1d4ed8;" value="${emp.netSalary||0}"></div>
        <div class="fgr"><label class="fl">Status</label>
          <select class="fc" id="emp-status">
            <option value="active" ${(emp.status||'active')==='active'?'selected':''}>Active</option>
            <option value="inactive" ${emp.status==='inactive'?'selected':''}>Inactive</option>
            <option value="resigned" ${emp.status==='resigned'?'selected':''}>Resigned</option>
          </select>
        </div>
      </div>
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;">
      <button class="btn btn-p" onclick="saveEmployee('${isEdit?id:''}')">üíæ Save Employee</button>
      <button class="btn btn-g" onclick="closeModal()">Cancel</button>
    </div>
  `);
}

function calcEmpSalary(){
  const basic=parseFloat(document.getElementById('emp-basic')?.value||0);
  const hra=parseFloat(document.getElementById('emp-hra')?.value||0);
  const da=parseFloat(document.getElementById('emp-da')?.value||0);
  const other=parseFloat(document.getElementById('emp-other')?.value||0);
  const pf=parseFloat(document.getElementById('emp-pf')?.value||0);
  const pt=parseFloat(document.getElementById('emp-pt')?.value||0);
  const tds=parseFloat(document.getElementById('emp-tds')?.value||0);
  const gross=basic+hra+da+other;
  const net=gross-pf-pt-tds;
  const gEl=document.getElementById('emp-gross');const nEl=document.getElementById('emp-net');
  if(gEl)gEl.value=gross.toFixed(2);
  if(nEl)nEl.value=net.toFixed(2);
}

function saveEmployee(editId){
  const name=document.getElementById('emp-name')?.value.trim();
  if(!name){showAlert('Employee name required.');return;}
  const emp={
    id:document.getElementById('emp-id')?.value.trim(),
    name,
    designation:document.getElementById('emp-desg')?.value.trim(),
    department:document.getElementById('emp-dept')?.value.trim(),
    doj:document.getElementById('emp-doj')?.value,
    dob:document.getElementById('emp-dob')?.value,
    pan:document.getElementById('emp-pan')?.value.trim().toUpperCase(),
    aadhaar:document.getElementById('emp-aadh')?.value.trim(),
    mobile:document.getElementById('emp-mob')?.value.trim(),
    email:document.getElementById('emp-email')?.value.trim(),
    bankAccNo:document.getElementById('emp-bank')?.value.trim(),
    ifsc:document.getElementById('emp-ifsc')?.value.trim().toUpperCase(),
    basicSalary:parseFloat(document.getElementById('emp-basic')?.value||0),
    hra:parseFloat(document.getElementById('emp-hra')?.value||0),
    da:parseFloat(document.getElementById('emp-da')?.value||0),
    otherAllow:parseFloat(document.getElementById('emp-other')?.value||0),
    pf:parseFloat(document.getElementById('emp-pf')?.value||0),
    pt:parseFloat(document.getElementById('emp-pt')?.value||0),
    tds:parseFloat(document.getElementById('emp-tds')?.value||0),
    grossSalary:parseFloat(document.getElementById('emp-gross')?.value||0),
    netSalary:parseFloat(document.getElementById('emp-net')?.value||0),
    status:document.getElementById('emp-status')?.value||'active',
  };
  if(!state.employees)state.employees=[];
  if(editId){const idx=state.employees.findIndex(e=>e.id===editId);if(idx>=0)state.employees[idx]=emp;else state.employees.push(emp);}
  else state.employees.push(emp);
  scheduleSave();
  closeModal();
  showToast('‚úÖ Employee saved!','#059669');
  pgEmployees();
}

function editEmployee(id){openAddEmployee(id);}
function deleteEmployee(id){
  if(!confirm('Delete this employee record?'))return;
  state.employees=state.employees.filter(e=>e.id!==id);
  scheduleSave();pgEmployees();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: PAYROLL PROCESSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgPayroll(){
  if(!state.payroll)state.payroll=[];
  if(!state.employees)state.employees=[];
  const months=[];
  const now=new Date();
  for(let i=0;i<6;i++){const d=new Date(now.getFullYear(),now.getMonth()-i,1);months.push({val:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`,lbl:d.toLocaleString('en-IN',{month:'long',year:'numeric'})});}

  const recentPayrolls=[...state.payroll].sort((a,b)=>b.month.localeCompare(a.month)).slice(0,6);
  const prRows=recentPayrolls.map((pr,i)=>`<tr class="${i%2?'alt':''}">
    <td>${pr.monthLabel||pr.month}</td>
    <td class="tc">${pr.entries?.length||0} employees</td>
    <td class="tr mono">${fmt(pr.entries?.reduce((s,e)=>s+(e.grossSalary||0),0)||0)}</td>
    <td class="tr mono">${fmt(pr.entries?.reduce((s,e)=>s+(e.totalDeductions||0),0)||0)}</td>
    <td class="tr mono">${fmt(pr.entries?.reduce((s,e)=>s+(e.netSalary||0),0)||0)}</td>
    <td>
      <button class="btn btn-g btn-sm" onclick="viewPayroll('${pr.month}')">üëÅ View</button>
      <button class="btn btn-p btn-sm" onclick="printPayroll('${pr.month}')">üñ® Print</button>
      <button class="btn btn-d btn-sm" onclick="deletePayroll('${pr.month}')" title="Delete payroll for ${pr.monthLabel||pr.month}">üóë</button>
    </td>
  </tr>`).join('');

  const monthOpts=months.map(m=>`<option value="${m.val}">${m.lbl}</option>`).join('');

  eid('content').innerHTML=`
  <div class="sg" style="grid-template-columns:repeat(3,1fr);margin-bottom:18px;">
    <div class="sc sc-b"><div class="sl">Active Employees</div><div class="sv">${state.employees.filter(e=>e.status==='active').length}</div></div>
    <div class="sc sc-g"><div class="sl">Monthly Payroll</div><div class="sv">${fmt(state.employees.filter(e=>e.status==='active').reduce((s,e)=>s+(e.netSalary||0),0))}</div><div class="ss">Estimated net</div></div>
    <div class="sc sc-p"><div class="sl">Payrolls Processed</div><div class="sv">${state.payroll.length}</div></div>
  </div>

  <div class="card" style="margin-bottom:16px;">
    <div class="ch">‚ö° Process New Payroll</div>
    <div style="padding:16px;display:flex;align-items:flex-end;gap:12px;flex-wrap:wrap;">
      <div class="fgr"><label class="fl">Select Month</label>
        <select class="fc si" id="pr-month">${monthOpts}</select>
      </div>
      <button class="btn btn-p" onclick="processPayroll()">‚öôÔ∏è Generate Payroll</button>
    </div>
  </div>

  <div class="card">
    <div class="ch">üìã Payroll History</div>
    <table class="tbl">
      <thead><tr><th>Month</th><th class="tc">Employees</th><th class="tr">Gross Payroll</th><th class="tr">Deductions</th><th class="tr">Net Payroll</th><th>Actions</th></tr></thead>
      <tbody>${prRows||'<tr><td colspan="6" class="tc tm-" style="padding:20px;">No payroll processed yet.</td></tr>'}</tbody>
    </table>
  </div>`;
}

function processPayroll(){
  const month=document.getElementById('pr-month')?.value;
  if(!month){showAlert('Select a month.');return;}
  if(!state.employees||!state.employees.length){showAlert('No employees found. Add employees first from Employee Master.');return;}
  const exists=state.payroll.find(p=>p.month===month);
  if(exists){if(!confirm('Payroll for this month already exists. Overwrite?'))return;state.payroll=state.payroll.filter(p=>p.month!==month);}
  const active=state.employees.filter(e=>e.status==='active');
  const d=new Date(month+'-01');
  const daysInMonth=new Date(d.getFullYear(),d.getMonth()+1,0).getDate();
  const entries=active.map(emp=>({
    empId:emp.id,
    empName:emp.name,
    designation:emp.designation||'',
    department:emp.department||'',
    basicSalary:emp.basicSalary||0,
    hra:emp.hra||0,
    da:emp.da||0,
    otherAllow:emp.otherAllow||0,
    grossSalary:emp.grossSalary||0,
    pf:emp.pf||0,
    pt:emp.pt||0,
    tds:emp.tds||0,
    totalDeductions:(emp.pf||0)+(emp.pt||0)+(emp.tds||0),
    netSalary:emp.netSalary||0,
    daysWorked:daysInMonth,
    daysInMonth,
    lopDays:0,
    bankAccNo:emp.bankAccNo||'',
    ifsc:emp.ifsc||'',
  }));
  const d2=new Date(month+'-01');
  const monthLabel=d2.toLocaleString('en-IN',{month:'long',year:'numeric'});
  state.payroll.push({month,monthLabel,entries,processedBy:currentUser?.username||'admin',processedAt:new Date().toISOString()});

  // ‚îÄ‚îÄ Auto-post journal voucher for salary expense ‚îÄ‚îÄ
  const totalGross=entries.reduce((s,e)=>s+(e.grossSalary||0),0);
  const totalPF=entries.reduce((s,e)=>s+(e.pf||0),0);
  const totalPT=entries.reduce((s,e)=>s+(e.pt||0),0);
  const totalTDS=entries.reduce((s,e)=>s+(e.tds||0),0);
  const totalNet=entries.reduce((s,e)=>s+(e.netSalary||0),0);
  const payDate=month+'-28'; // End of month pay date
  // Find or create a payroll voucher ID
  const usedNums=new Set(state.vouchers.map(v=>parseInt(v.id.replace(/\D/g,''))||0));
  let nextN=1;while(usedNums.has(nextN))nextN++;
  const prVoucherId='V'+String(nextN).padStart(3,'0');
  const salAccId=state.accounts.find(a=>a.name.includes('Salaries')||a.group==='Salary Accounts')?.id||'4002';
  const bankAccId=state.accounts.find(a=>a.group==='Cash & Bank'&&a.name.toLowerCase().includes('bank'))?.id
    ||state.accounts.find(a=>a.group==='Cash & Bank')?.id||'1002';
  const pfPayableId=state.accounts.find(a=>a.name.includes('PF'))?.id||'2001';
  const tdsPayableId='2005';
  const jEntries=[
    {accId:salAccId, dr:totalGross, cr:0, tag:'Salary Expense'},
  ];
  if(totalNet>0) jEntries.push({accId:bankAccId, dr:0, cr:totalNet, tag:'Net Salary Paid'});
  if(totalPF>0) jEntries.push({accId:'2001', dr:0, cr:totalPF, tag:'PF Payable'});
  if(totalTDS>0) jEntries.push({accId:tdsPayableId, dr:0, cr:totalTDS, tag:'TDS Payable'});
  if(totalPT>0) jEntries.push({accId:'2001', dr:0, cr:totalPT, tag:'Prof Tax Payable'});
  // Only post if entries are balanced
  const jDr=jEntries.reduce((s,e)=>s+(e.dr||0),0), jCr=jEntries.reduce((s,e)=>s+(e.cr||0),0);
  if(Math.abs(jDr-jCr)<0.01){
    state.vouchers.push({
      id:prVoucherId, date:payDate, type:'Journal',
      narration:'Salary for '+monthLabel+' (Auto-posted by Payroll)',
      ref:'PAYROLL-'+month, partyId:'', dueDate:'', entries:jEntries,
      gstType:'', tdsSection:'', items:[],
      totals:{taxable:totalGross,cgst:0,sgst:0,igst:0,tds:totalTDS,grand:totalGross}
    });
  }

  scheduleSave();
  showToast('‚úÖ Payroll for '+monthLabel+' processed! Journal voucher '+prVoucherId+' auto-posted.','#059669');
  pgPayroll();
}

function deletePayroll(month){
  if(!canEdit()){showToast('Only Admin/Accountant can delete payroll.','#dc2626');return;}
  const pr=state.payroll.find(p=>p.month===month);
  if(!pr){showToast('Payroll not found.','#dc2626');return;}
  const label=pr.monthLabel||month;
  const refKey='PAYROLL-'+month;
  // Check if auto-posted voucher exists
  const linkedVoucher=state.vouchers.find(v=>v.ref===refKey);
  const msg=linkedVoucher
    ?`Delete payroll for "${label}"?\n\nThis will also DELETE the auto-posted journal voucher (${linkedVoucher.id}).\n\nThis cannot be undone.`
    :`Delete payroll for "${label}"?\n\nThis cannot be undone.`;
  if(!confirm(msg))return;
  // Remove payroll record
  state.payroll=state.payroll.filter(p=>p.month!==month);
  // Remove linked journal voucher
  if(linkedVoucher){
    state.vouchers=state.vouchers.filter(v=>v.ref!==refKey);
    showToast(`üóë Payroll "${label}" and voucher ${linkedVoucher.id} deleted.`,'#dc2626');
  } else {
    showToast(`üóë Payroll "${label}" deleted.`,'#dc2626');
  }
  scheduleSave();
  pgPayroll();
}

function viewPayroll(month){
  const pr=state.payroll.find(p=>p.month===month);
  if(!pr)return;
  const rows=pr.entries.map((e,i)=>`<tr class="${i%2?'alt':''}">
    <td class="mono">${e.empId}</td><td>${e.empName}</td><td>${e.designation}</td>
    <td class="tr mono">${fmt(e.basicSalary)}</td>
    <td class="tr mono">${fmt(e.grossSalary)}</td>
    <td class="tr mono" style="color:#dc2626;">${fmt(e.totalDeductions)}</td>
    <td class="tr mono" style="color:#059669;font-weight:700;">${fmt(e.netSalary)}</td>
    <td><button class="btn btn-g btn-sm" onclick="closeModal();printPayslip('${month}','${e.empId}')">üñ® Payslip</button></td>
  </tr>`).join('');
  const totalGross=pr.entries.reduce((s,e)=>s+(e.grossSalary||0),0);
  const totalDed=pr.entries.reduce((s,e)=>s+(e.totalDeductions||0),0);
  const totalNet=pr.entries.reduce((s,e)=>s+(e.netSalary||0),0);
  openModal('üìã Payroll ‚Äî '+pr.monthLabel,`
    <div style="overflow-x:auto;">
    <table class="tbl">
      <thead><tr><th>Emp ID</th><th>Name</th><th>Designation</th><th class="tr">Basic</th><th class="tr">Gross</th><th class="tr">Deductions</th><th class="tr">Net Salary</th><th>Payslip</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot class="tf"><tr><td colspan="4" class="tr">Totals</td><td class="tr">${fmt(totalGross)}</td><td class="tr">${fmt(totalDed)}</td><td class="tr">${fmt(totalNet)}</td><td></td></tr></tfoot>
    </table>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button class="btn btn-p" onclick="closeModal();printPayroll('${month}')">üñ® Print All Payslips</button>
      <button class="btn btn-g" onclick="closeModal()">Close</button>
    </div>`);
}

function printPayslip(month,empId){
  const pr=state.payroll.find(p=>p.month===month);
  if(!pr)return;
  const e=pr.entries.find(x=>x.empId===empId);
  if(!e)return;
  const w=window.open('','_blank','width=800,height=600');
  w.document.write(`<!DOCTYPE html><html><head><title>Payslip</title><style>
    body{font-family:Arial,sans-serif;font-size:13px;margin:0;padding:20px;}
    .hdr{background:#1d4ed8;color:#fff;padding:16px 20px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;}
    .box{border:1px solid #e2e8f0;border-radius:0 0 8px 8px;padding:16px;}
    .row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px dashed #f1f5f9;}
    .sec{font-weight:700;font-size:11px;text-transform:uppercase;color:#64748b;margin:12px 0 6px;}
    .earn-ded{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:10px;}
    .totrow{background:#f8fafc;font-weight:700;padding:8px;border-radius:4px;display:flex;justify-content:space-between;margin-top:6px;}
    .netbox{background:#1d4ed8;color:#fff;padding:12px 16px;border-radius:8px;display:flex;justify-content:space-between;font-size:16px;font-weight:800;margin-top:12px;}
    @media print{body{padding:10px;}}
  </style></head><body>
  <div class="hdr">
    <div><div style="font-size:18px;font-weight:800;">${state.company}</div><div style="opacity:.8;font-size:12px;">PAYSLIP</div></div>
    <div style="text-align:right;"><div>${pr.monthLabel}</div><div style="opacity:.8;font-size:12px;">Pay Period</div></div>
  </div>
  <div class="box">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #e2e8f0;">
      <div><div class="sec">Employee Details</div>
        <div class="row"><span>Name</span><strong>${e.empName}</strong></div>
        <div class="row"><span>Employee ID</span><span>${e.empId}</span></div>
        <div class="row"><span>Designation</span><span>${e.designation||'‚Äî'}</span></div>
        <div class="row"><span>Department</span><span>${e.department||'‚Äî'}</span></div>
      </div>
      <div><div class="sec">Payment Details</div>
        <div class="row"><span>Days Worked</span><span>${e.daysWorked}/${e.daysInMonth}</span></div>
        <div class="row"><span>Bank Account</span><span>${e.bankAccNo||'‚Äî'}</span></div>
        <div class="row"><span>IFSC</span><span>${e.ifsc||'‚Äî'}</span></div>
        <div class="row"><span>Payment Mode</span><span>Bank Transfer</span></div>
      </div>
    </div>
    <div class="earn-ded">
      <div><div class="sec">üíö Earnings</div>
        <div class="row"><span>Basic Salary</span><span>‚Çπ${fmtN(e.basicSalary)}</span></div>
        ${e.hra?`<div class="row"><span>HRA</span><span>‚Çπ${fmtN(e.hra)}</span></div>`:''}
        ${e.da?`<div class="row"><span>DA</span><span>‚Çπ${fmtN(e.da)}</span></div>`:''}
        ${e.otherAllow?`<div class="row"><span>Other Allowances</span><span>‚Çπ${fmtN(e.otherAllow)}</span></div>`:''}
        <div class="totrow"><span>Gross Earnings</span><span>‚Çπ${fmtN(e.grossSalary)}</span></div>
      </div>
      <div><div class="sec">‚ùå Deductions</div>
        ${e.pf?`<div class="row"><span>Provident Fund (PF)</span><span>‚Çπ${fmtN(e.pf)}</span></div>`:''}
        ${e.pt?`<div class="row"><span>Professional Tax</span><span>‚Çπ${fmtN(e.pt)}</span></div>`:''}
        ${e.tds?`<div class="row"><span>TDS (Income Tax)</span><span>‚Çπ${fmtN(e.tds)}</span></div>`:''}
        <div class="totrow"><span>Total Deductions</span><span>‚Çπ${fmtN(e.totalDeductions)}</span></div>
      </div>
    </div>
    <div class="netbox"><span>NET TAKE HOME SALARY</span><span>‚Çπ${fmtN(e.netSalary)}</span></div>
    <div style="margin-top:16px;font-size:11px;color:#64748b;text-align:center;">This is a computer-generated payslip. No signature required.</div>
  </div>
  </body></html>`);
  w.document.close();
  setTimeout(()=>w.print(),600);
}

function printPayroll(month){
  const pr=state.payroll.find(p=>p.month===month);
  if(!pr)return;
  pr.entries.forEach(e=>printPayslip(month,e.empId));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE: USER MANAGEMENT (Multi-User)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROLES={
  admin:{label:'Admin',desc:'Full access to everything',color:'#7c3aed'},
  accountant:{label:'Accountant',desc:'Can enter vouchers and view reports',color:'#1d4ed8'},
  viewer:{label:'Viewer',desc:'Read-only access to reports',color:'#059669'},
};

function pgUserMgmt(){
  if(currentUser?.role!=='admin'){
    eid('content').innerHTML=`<div class="al al-d">‚õî Access Denied. Only Admin can manage users.</div>`;
    return;
  }
  if(!state.appUsers)state.appUsers=[];
  const rows=state.appUsers.map((u,i)=>{
    const roleInfo=ROLES[u.role]||{label:u.role,color:'#64748b'};
    const isYou=u.username===currentUser?.username;
    return `<tr class="${i%2?'alt':''}">
      <td><strong>${u.username}</strong>${isYou?'<span class="badge bb" style="margin-left:6px;">You</span>':''}</td>
      <td><span class="badge" style="background:${roleInfo.color}20;color:${roleInfo.color};">${roleInfo.label}</span></td>
      <td class="tm-" style="font-size:11px;">${roleInfo.desc}</td>
      <td class="tm-" style="font-size:11px;">${u.createdAt?fmtD(u.createdAt.slice(0,10)):'‚Äî'}</td>
      <td>
        ${isYou ? '<span class="tm-" style="font-size:11px;">Current user</span>' :
          currentUser?.role==='admin' ?
            `<button class="btn btn-g btn-sm" onclick="editAppUser('${u.username}')">‚úèÔ∏è Edit</button>
             <button class="btn btn-d btn-sm" onclick="deleteAppUser('${u.username}')">üóë Delete</button>` :
          '<span style="font-size:11px;color:var(--tm);">‚Äî</span>'}
      </td>
    </tr>`;
  }).join('');

  eid('content').innerHTML=`
  <div class="al al-i" style="margin-bottom:16px;">‚ÑπÔ∏è User Management allows you to add multiple users with different roles. Each user logs in with their own username and password and sees the same company data.</div>
  <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
    <button class="btn btn-p" onclick="openAddUser()">‚ûï Add New User</button>
  </div>
  <div class="card">
    <div class="ch">üë• System Users</div>
    <table class="tbl">
      <thead><tr><th>Username</th><th>Role</th><th>Permissions</th><th>Added On</th><th>Actions</th></tr></thead>
      <tbody>${rows||'<tr><td colspan="5" class="tc tm-" style="padding:20px;">No users found.</td></tr>'}</tbody>
    </table>
  </div>
  <div style="margin-top:16px;" class="card">
    <div class="ch">üîê Role Permissions Reference</div>
    <div style="padding:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
      ${Object.entries(ROLES).map(([k,v])=>`
        <div style="border:1.5px solid ${v.color}30;border-radius:10px;padding:14px;">
          <div style="font-weight:700;color:${v.color};font-size:13px;">üë§ ${v.label}</div>
          <div style="font-size:11px;color:#475569;margin-top:4px;">${v.desc}</div>
          <div style="margin-top:8px;font-size:11px;">
            ${k==='admin'?'‚úÖ All modules<br>‚úÖ User Management<br>‚úÖ Settings<br>‚úÖ Delete data':
              k==='accountant'?'‚úÖ Voucher entry<br>‚úÖ All reports<br>‚úÖ Invoice & Payroll<br>‚ùå User Management':
              '‚úÖ View reports<br>‚úÖ View invoices<br>‚ùå Add/Edit data<br>‚ùå User Management'}
          </div>
        </div>`).join('')}
    </div>
  </div>`;
}

function openAddUser(editUsername){
  const u=editUsername?state.appUsers.find(x=>x.username===editUsername):{};
  const isEdit=!!editUsername;
  openModal((isEdit?'‚úèÔ∏è Edit':'‚ûï Add New')+' User',`
    <div class="al al-w" style="margin-bottom:14px;">‚ö†Ô∏è Share login credentials securely. Each user will log in with their username and password.</div>
    <div class="fg">
      <div class="fgr"><label class="fl">Username *</label>
        <input class="fc" id="nu-user" value="${u.username||''}" placeholder="e.g. accountant1" ${isEdit?'readonly':''}></div>
      <div class="fgr"><label class="fl">Full Name</label>
        <input class="fc" id="nu-name" value="${u.fullName||''}" placeholder="User's full name"></div>
      <div class="fgr"><label class="fl">Role *</label>
        <select class="fc" id="nu-role">
          <option value="admin" ${(u.role||'')==='admin'?'selected':''}>üëë Admin ‚Äî Full access</option>
          <option value="accountant" ${(u.role||'')==='accountant'?'selected':''}>üìä Accountant ‚Äî Enter & View</option>
          <option value="viewer" ${(u.role||'')==='viewer'?'selected':''}>üëÅ Viewer ‚Äî Read only</option>
        </select>
      </div>
      ${!isEdit?`
      <div class="fgr" style="grid-column:span 2;"><label class="fl">Mobile Number <small style="color:var(--tm);">(for OTP password reset)</small></label>
        <input class="fc" id="nu-mobile" type="tel" placeholder="+91 9876543210" maxlength="13"></div>
      <div class="fgr"><label class="fl">Password *</label>
        <input class="fc" id="nu-pass" type="password" placeholder="Minimum 6 characters"></div>
      <div class="fgr"><label class="fl">Confirm Password *</label>
        <input class="fc" id="nu-pass2" type="password" placeholder="Re-enter password"></div>`:''}
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;">
      <button class="btn btn-p" onclick="saveAppUser('${isEdit?editUsername:''}')">üíæ ${isEdit?'Update User':'Create User'}</button>
      <button class="btn btn-g" onclick="closeModal()">Cancel</button>
    </div>
  `);
}

async function saveAppUser(editUsername){
  const username=document.getElementById('nu-user')?.value.trim();
  const pass=document.getElementById('nu-pass')?.value||'';
  const pass2=document.getElementById('nu-pass2')?.value||'';
  const role=document.getElementById('nu-role')?.value;
  const fullName=document.getElementById('nu-name')?.value.trim()||username;
  if(!username){showAlert('Username required.');return;}
  if(!editUsername&&!pass){showAlert('Password required for new user.');return;}
  if(!editUsername&&pass!==pass2){showAlert('Passwords do not match.');return;}
  if(pass&&pass.length<6){showAlert('Password must be at least 6 characters.');return;}
  if(!role){showAlert('Select a role.');return;}
  if(!state.appUsers)state.appUsers=[];
  try{
    if(editUsername){
      // Edit: update role and fullName only
      const idx=state.appUsers.findIndex(u=>u.username===editUsername);
      const updatedUser={username:editUsername,role,fullName,
        createdAt:state.appUsers[idx]?.createdAt||new Date().toISOString()};
      const {error:updErr}=await getSupa().from('app_users')
        .update({role}).eq('username',editUsername);
      if(updErr) throw new Error('DB error: '+updErr.message);
      if(idx>=0) state.appUsers[idx]=updatedUser;
      else state.appUsers.push(updatedUser);
    } else {
      // New user ‚Äî check duplicate first
      if(state.appUsers.find(u=>u.username.toLowerCase()===username.toLowerCase())){
        showAlert('Username "'+username+'" already exists. Choose a different username.');return;
      }
      const companyId2=state.companyId||_selectedCompanyId;
      const cid=(companyId2||'').toLowerCase();
      const email=username.toLowerCase()+'_'+cid+'@accountally.app';
      const rawMobile=(document.getElementById('nu-mobile')?.value||'').trim();
      const phoneE164=rawMobile&&!rawMobile.startsWith('+')?'+91'+rawMobile.replace(/^0/,''):rawMobile;

      // Create auth user via isolated tempClient
      const ANON2='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmc2x0eGVoZmRtbnd4a3dlY3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTg0MDgsImV4cCI6MjA4NzQzNDQwOH0.Xe8JTV2Gw1WfCx-0U4im64dZ8aw_wYWhrFqciDrX990';
      const tc2=supabase.createClient('https://dfsltxehfdmnwxkwecww.supabase.co',ANON2,{auth:{persistSession:false,autoRefreshToken:false}});
      const {data:sd2,error:se2}=await tc2.auth.signUp({email,password:pass,options:{data:{mobile:phoneE164}}});
      if(se2) throw new Error('Auth signup failed: '+se2.message);
      if(!sd2.user) throw new Error('Signup failed ‚Äî ensure email confirmations are OFF in Supabase.');
      // Insert using ADMIN session (RLS: "same company insert" policy allows this)
      const {error:insErr}=await getSupa().from('app_users').insert({
        username:username.toLowerCase(),
        user_id:sd2.user.id,
        company_id:companyId2,
        role,
        mobile:phoneE164
      });
      if(insErr) throw new Error('DB error: '+insErr.message);
      const newUser={username:username.toLowerCase(),role,fullName,
        createdAt:new Date().toISOString(),createdBy:currentUser?.username};
      if(!state.appUsers.find(u=>u.username===username.toLowerCase())){
        state.appUsers.push(newUser);
      }
    }
    scheduleSave();
    closeModal();
    showToast('‚úÖ User "'+(editUsername||username)+'" '+(editUsername?'updated':'created')+' successfully!','#059669');
    pgUserMgmt();
  } catch(e){
    console.error('saveAppUser error:',e);
    showAlert('Error saving user: '+(e.message||'Check your internet connection and try again.'));
  }
}

function editAppUser(username){openAddUser(username);}
async function deleteAppUser(username){
  if(currentUser?.role!=='admin'){showToast('Only admins can delete users.','#dc2626');return;}
  if(!confirm('Delete user "'+username+'"? They will no longer be able to log in.'))return;
  state.appUsers=state.appUsers.filter(u=>u.username!==username);
  await DB.del('users',username);
  scheduleSave();
  showToast('üóë User deleted.','#dc2626');
  pgUserMgmt();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAMPLE DATA ‚Äî 360¬∞ IND AS ¬∑ Accounting ¬∑ GST ¬∑ TDS ¬∑ Payroll
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function injectSampleData(s){
  s.company='TechServe India Pvt. Ltd.';
  s.gstin='27AABCT4582R1ZX';
  s.companyState='Maharashtra';
  s.tan='MUMT12345G';

  // ‚îÄ‚îÄ Accounts ‚Äî Extended Chart per IND AS ‚îÄ‚îÄ
  s.accounts=[
    // Current Assets
    {id:'1001',name:'Cash in Hand',group:'Cash & Bank',type:'Asset',nature:'Dr',balance:125000},
    {id:'1002',name:'HDFC Bank ‚Äî Current A/c',group:'Cash & Bank',type:'Asset',nature:'Dr',balance:4850000},
    {id:'1003',name:'Accounts Receivable (Debtors)',group:'Sundry Debtors',type:'Asset',nature:'Dr',balance:0},
    {id:'1004',name:'Inventory / Stock-in-Trade',group:'Stock-in-Hand',type:'Asset',nature:'Dr',balance:650000},
    {id:'1006',name:'Input CGST (ITC)',group:'Current Assets',type:'Asset',nature:'Dr',balance:0},
    {id:'1007',name:'Input SGST (ITC)',group:'Current Assets',type:'Asset',nature:'Dr',balance:0},
    {id:'1008',name:'Input IGST (ITC)',group:'Current Assets',type:'Asset',nature:'Dr',balance:0},
    {id:'1009',name:'Advance to Suppliers',group:'Advance to Suppliers',type:'Asset',nature:'Dr',balance:0},
    {id:'1010',name:'TDS Receivable (Advance Tax)',group:'Current Assets',type:'Asset',nature:'Dr',balance:0},
    {id:'1011',name:'Prepaid Expenses',group:'Current Assets',type:'Asset',nature:'Dr',balance:48000},
    {id:'1012',name:'Security Deposits (Asset)',group:'Loans & Advances',type:'Asset',nature:'Dr',balance:240000},
    {id:'1013',name:'Advance Income Tax Paid',group:'Current Assets',type:'Asset',nature:'Dr',balance:180000},
    {id:'1014',name:'Other Receivables',group:'Current Assets',type:'Asset',nature:'Dr',balance:0},
    // Non-Current Assets (IND AS 16 ‚Äî PPE)
    {id:'1005',name:'Gross Block ‚Äî Computers & IT',group:'Fixed Assets',type:'Asset',nature:'Dr',balance:920000},
    {id:'1015',name:'Gross Block ‚Äî Furniture & Fixtures',group:'Fixed Assets',type:'Asset',nature:'Dr',balance:380000},
    {id:'1016',name:'Acc. Depreciation ‚Äî Computers',group:'Fixed Assets',type:'Asset',nature:'Cr',balance:184000},
    {id:'1017',name:'Acc. Depreciation ‚Äî Furniture',group:'Fixed Assets',type:'Asset',nature:'Cr',balance:57000},
    {id:'1018',name:'Right-of-Use Asset (IND AS 116)',group:'Fixed Assets',type:'Asset',nature:'Dr',balance:1800000},
    {id:'1019',name:'Acc. Dep ‚Äî ROU Asset',group:'Fixed Assets',type:'Asset',nature:'Cr',balance:300000},
    {id:'1020',name:'Capital WIP',group:'Fixed Assets',type:'Asset',nature:'Dr',balance:0},
    {id:'1021',name:'Intangibles ‚Äî Software Licenses',group:'Fixed Assets',type:'Asset',nature:'Dr',balance:450000},
    {id:'1022',name:'Acc. Amortisation ‚Äî Software',group:'Fixed Assets',type:'Asset',nature:'Cr',balance:90000},
    // Liabilities
    {id:'2001',name:'Accounts Payable (Creditors)',group:'Sundry Creditors',type:'Liability',nature:'Cr',balance:0},
    {id:'2002',name:'Output CGST Payable',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    {id:'2003',name:'Output SGST Payable',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    {id:'2004',name:'Output IGST Payable',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    {id:'2005',name:'TDS Payable (Govt Deposit)',group:'TDS Payable',type:'Liability',nature:'Cr',balance:0},
    {id:'2006',name:'Advance from Customers',group:'Advance from Customers',type:'Liability',nature:'Cr',balance:0},
    {id:'2007',name:'Term Loan ‚Äî HDFC Bank',group:'Loans (Liability)',type:'Liability',nature:'Cr',balance:5000000},
    {id:'2008',name:'GST Payable (Net)',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    {id:'2009',name:'Salary Payable',group:'Current Liabilities',type:'Liability',nature:'Cr',balance:0},
    {id:'2010',name:'PF Payable (EPFO)',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    {id:'2011',name:'PT Payable (State)',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    {id:'2012',name:'Lease Liability ‚Äî Current (IND AS 116)',group:'Current Liabilities',type:'Liability',nature:'Cr',balance:360000},
    {id:'2013',name:'Lease Liability ‚Äî Non Current',group:'Loans (Liability)',type:'Liability',nature:'Cr',balance:1440000},
    {id:'2014',name:'Provision for Gratuity (IND AS 19)',group:'Current Liabilities',type:'Liability',nature:'Cr',balance:0},
    {id:'2015',name:'Deferred Tax Liability (IND AS 12)',group:'Current Liabilities',type:'Liability',nature:'Cr',balance:85000},
    {id:'2016',name:'Interest Payable',group:'Current Liabilities',type:'Liability',nature:'Cr',balance:0},
    {id:'2017',name:'Income Tax Payable (TDS+Adv)',group:'Duties & Taxes',type:'Liability',nature:'Cr',balance:0},
    // Income
    {id:'3001',name:'Revenue ‚Äî Product Sales',group:'Sales Accounts',type:'Income',nature:'Cr',balance:0},
    {id:'3002',name:'Revenue ‚Äî IT Services (SAC 998314)',group:'Service Income',type:'Income',nature:'Cr',balance:0},
    {id:'3003',name:'Revenue ‚Äî AMC/Support (SAC 998715)',group:'Service Income',type:'Income',nature:'Cr',balance:0},
    {id:'3004',name:'Other Operating Income',group:'Direct Income',type:'Income',nature:'Cr',balance:0},
    {id:'3005',name:'Interest Income (FD/Bank)',group:'Indirect Income',type:'Income',nature:'Cr',balance:0},
    {id:'3006',name:'Rental / Sublease Income',group:'Indirect Income',type:'Income',nature:'Cr',balance:0},
    // Expenses
    {id:'4001',name:'Cost of Goods Sold / Purchases',group:'Purchase Accounts',type:'Expense',nature:'Dr',balance:0},
    {id:'4002',name:'Salaries & Wages (Gross)',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4003',name:'Rent & Lease Expense',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4004',name:'Electricity & Utilities',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4005',name:'Office & Administrative Expenses',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4006',name:'Marketing & Business Development',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4007',name:'Bank Charges & Finance Costs',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4008',name:'Depreciation & Amortisation',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4009',name:'Professional & Legal Fees',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4010',name:'Travelling & Conveyance',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4011',name:'Software Subscriptions (SaaS)',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4012',name:'Insurance Premium',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4013',name:'Interest on Term Loan',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4014',name:'Interest on Lease Liability (IND AS 116)',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4015',name:'Gratuity Expense (IND AS 19)',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4016',name:'Recruitment & Training',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    {id:'4017',name:'Deferred Tax Expense (IND AS 12)',group:'Indirect Expenses',type:'Expense',nature:'Dr',balance:0},
    // Capital
    {id:'5001',name:"Paid-up Share Capital",group:'Capital Account',type:'Capital',nature:'Cr',balance:5000000},
    {id:'5002',name:'Securities Premium Reserve',group:'Reserves & Surplus',type:'Capital',nature:'Cr',balance:2000000},
    {id:'5003',name:'General Reserve',group:'Reserves & Surplus',type:'Capital',nature:'Cr',balance:1500000},
    {id:'5004',name:'Retained Earnings (P&L A/c)',group:'Retained Earnings',type:'Capital',nature:'Cr',balance:1200000},
    {id:'5005',name:'OCI Reserve ‚Äî Actuarial Gain/Loss',group:'Reserves & Surplus',type:'Capital',nature:'Cr',balance:0},
  ];

  // ‚îÄ‚îÄ Vendors (with PAN for TDS) ‚îÄ‚îÄ
  s.vendors=[
    {id:'V001',name:'Sigma Cloud Solutions LLP',contact:'9988001122',email:'accounts@sigmacloud.in',gstin:'27AASCS4421R1ZP',pan:'AASCS4421R',state:'Maharashtra',address:'Bandra Kurla Complex, Mumbai 400051',type:'Contractor'},
    {id:'V002',name:'Nexus Consulting Services',contact:'9911223344',email:'billing@nexusconsult.com',gstin:'07AANCX7812R1ZQ',pan:'AANCX7812R',state:'Delhi',address:'Sector 18, Noida 201301',type:'Professional'},
    {id:'V003',name:'Prime Realty Properties',contact:'9922334455',email:'lease@primerealty.com',gstin:'27AABCP3344R1ZR',pan:'AABCP3344R',state:'Maharashtra',address:'Nariman Point, Mumbai 400021',type:'Landlord'},
    {id:'V004',name:'TechEquip Distributors Pvt Ltd',contact:'9844556677',email:'sales@techequip.in',gstin:'29AABCT9087R1ZS',pan:'AABCT9087R',state:'Karnataka',address:'Electronic City Phase 1, Bangalore 560100',type:'Supplier'},
    {id:'V005',name:'DataCenter India Pvt Ltd',contact:'9955667788',email:'colocation@dci.in',gstin:'27AABCD2211R1ZT',pan:'AABCD2211R',state:'Maharashtra',address:'Ghansoli, Navi Mumbai 400701',type:'Contractor'},
    {id:'V006',name:'Swaminathan & Associates (CA Firm)',contact:'9866778899',email:'ca@swamifirm.com',gstin:'33AACFS8877R1ZU',pan:'AACFS8877R',state:'Tamil Nadu',address:'T Nagar, Chennai 600017',type:'Professional'},
    {id:'V007',name:'Print Media Solutions',contact:'9833445566',email:'info@printmedia.co.in',gstin:'27AABCPM345R1ZV',pan:'AABCPM345R',state:'Maharashtra',address:'Andheri East, Mumbai 400069',type:'Contractor'},
    {id:'V008',name:'National Insurance Co. Ltd.',contact:'18001237000',email:'commercial@nicl.co.in',gstin:'27AABCN1122R1ZW',pan:'AABCN1122R',state:'Maharashtra',address:'Mumbai Division Office',type:'Insurance'},
  ];

  // ‚îÄ‚îÄ Customers / Debtors (with PAN for TDS deducted by them) ‚îÄ‚îÄ
  s.debtors=[
    {id:'C001',name:'Infosys Limited',contact:'9000011111',email:'vendor.payments@infosys.com',gstin:'29AABCI1234R1Z5',pan:'AABCI1234R',tan:'BNGI12345D',state:'Karnataka',address:'Electronics City, Bangalore 560100',creditLimit:2000000,creditDays:45,category:'Enterprise'},
    {id:'C002',name:'Tata Consultancy Services Ltd',contact:'9000022222',email:'accounts.payable@tcs.com',gstin:'27AABCT5678R1Z6',pan:'AABCT5678R',tan:'MUMT87654G',state:'Maharashtra',address:'TCS House, Nariman Point, Mumbai 400021',creditLimit:5000000,creditDays:60,category:'Enterprise'},
    {id:'C003',name:'Wipro Technologies Ltd',contact:'9000033333',email:'apteam@wipro.com',gstin:'29AABCW9012R1Z7',pan:'AABCW9012R',tan:'BNGI88776G',state:'Karnataka',address:'Sarjapur Road, Bangalore 560035',creditLimit:3000000,creditDays:45,category:'Enterprise'},
    {id:'C004',name:'HCL Technologies Ltd',contact:'9000044444',email:'finance.vendor@hcl.com',gstin:'09AABCH3456R1Z8',pan:'AABCH3456R',tan:'DLHT23456G',state:'Uttar Pradesh',address:'Sector 126, Noida 201304',creditLimit:2500000,creditDays:30,category:'Enterprise'},
    {id:'C005',name:'Reliance Jio Infocomm Ltd',contact:'9000055555',email:'payments@jio.com',gstin:'27AAACR5055K1ZF',pan:'AAACR5055K',tan:'MUMT67890G',state:'Maharashtra',address:'Navi Mumbai 400703',creditLimit:3000000,creditDays:30,category:'Enterprise'},
    {id:'C006',name:'HDFC Bank Ltd',contact:'9000066666',email:'vendor.mgmt@hdfcbank.com',gstin:'27AAHCH0942H1Z6',pan:'AAHCH0942H',tan:'MUMT11223G',state:'Maharashtra',address:'HDFC Bank House, Lower Parel, Mumbai',creditLimit:1000000,creditDays:30,category:'BFSI'},
    {id:'C007',name:'Apollo Hospitals Enterprise Ltd',contact:'9000077777',email:'procurement@apollohospitals.com',gstin:'36AAACA4033E1ZR',pan:'AAACA4033E',tan:'HYDT34567G',state:'Telangana',address:'Jubilee Hills, Hyderabad 500033',creditLimit:1500000,creditDays:45,category:'Healthcare'},
    {id:'C008',name:'Mahindra & Mahindra Ltd',contact:'9000088888',email:'vendor.fin@mahindra.com',gstin:'27AAACM3025F1Z8',pan:'AAACM3025F',tan:'PUMT45678G',state:'Maharashtra',address:'Mahindra Towers, Worli, Mumbai',creditLimit:2000000,creditDays:60,category:'Manufacturing'},
  ];

  // ‚îÄ‚îÄ Items (HSN/SAC ‚Äî Goods + Services) ‚îÄ‚îÄ
  s.items=[
    {id:'ITM001',name:'IT Consulting ‚Äî Senior (Per Hour)',hsn:'',sac:'998314',type:'service',unit:'Hour',saleRate:3500,purchaseRate:2000,gstRate:18,incomeAccId:'3002',expenseAccId:'4001',description:'Senior IT Consulting per hour (IND AS 15 ‚Äî IFRS 15 Variable Consideration)'},
    {id:'ITM002',name:'IT Consulting ‚Äî Junior (Per Hour)',hsn:'',sac:'998314',type:'service',unit:'Hour',saleRate:2000,purchaseRate:1200,gstRate:18,incomeAccId:'3002',expenseAccId:'4001',description:'Junior/Mid-level IT Consulting per hour'},
    {id:'ITM003',name:'Annual Maintenance Contract (AMC)',hsn:'',sac:'998715',type:'service',unit:'Year',saleRate:250000,purchaseRate:160000,gstRate:18,incomeAccId:'3003',expenseAccId:'4001',description:'Comprehensive AMC ‚Äî Software & Hardware Support'},
    {id:'ITM004',name:'Cloud Infrastructure Setup',hsn:'',sac:'998319',type:'service',unit:'Project',saleRate:850000,purchaseRate:550000,gstRate:18,incomeAccId:'3002',expenseAccId:'4001',description:'Cloud Migration & Setup (AWS/Azure)'},
    {id:'ITM005',name:'Cybersecurity Audit',hsn:'',sac:'998399',type:'service',unit:'Audit',saleRate:180000,purchaseRate:110000,gstRate:18,incomeAccId:'3002',expenseAccId:'4001',description:'VAPT + Security Assessment'},
    {id:'ITM006',name:'Business Laptop ‚Äî Dell Latitude',hsn:'847130',sac:'',type:'goods',unit:'Nos',saleRate:82000,purchaseRate:65000,gstRate:18,incomeAccId:'3001',expenseAccId:'4001',description:'Dell Latitude 5540 i7 16GB RAM 512GB SSD'},
    {id:'ITM007',name:'Network Switch ‚Äî Cisco Catalyst',hsn:'851762',sac:'',type:'goods',unit:'Nos',saleRate:95000,purchaseRate:72000,gstRate:18,incomeAccId:'3001',expenseAccId:'4001',description:'Cisco Catalyst 9200L 24-port Managed Switch'},
    {id:'ITM008',name:'Server ‚Äî Dell PowerEdge R750',hsn:'847149',sac:'',type:'goods',unit:'Nos',saleRate:480000,purchaseRate:385000,gstRate:18,incomeAccId:'3001',expenseAccId:'4001',description:'Dell PowerEdge R750 2U Rack Server'},
    {id:'ITM009',name:'Office Stationery & Supplies',hsn:'482000',sac:'',type:'goods',unit:'Box',saleRate:600,purchaseRate:400,gstRate:12,incomeAccId:'3001',expenseAccId:'4001',description:'Premium office stationery pack'},
    {id:'ITM010',name:'UPS ‚Äî APC Smart-UPS',hsn:'850440',sac:'',type:'goods',unit:'Nos',saleRate:35000,purchaseRate:27000,gstRate:18,incomeAccId:'3001',expenseAccId:'4001',description:'APC Smart-UPS 2000VA LCD'},
  ];

  // ‚îÄ‚îÄ VOUCHERS ‚Äî Full Year Transactions ‚îÄ‚îÄ
  s.vouchers=[

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OPENING JOURNAL ‚Äî IND AS Balance Sheet Opening ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {id:'V001',date:'2025-04-01',type:'Journal',narration:'Opening entries FY 2025-26 ‚Äî per audited Balance Sheet',ref:'OB-2025',partyId:'',dueDate:'',
     entries:[
       {accId:'1002',dr:4850000,cr:0,tag:'Bank Bal'},
       {accId:'1001',dr:125000,cr:0,tag:'Cash Bal'},
       {accId:'1004',dr:650000,cr:0,tag:'Inventory'},
       {accId:'1011',dr:48000,cr:0,tag:'Prepaid'},
       {accId:'1012',dr:240000,cr:0,tag:'Security Dep'},
       {accId:'1013',dr:180000,cr:0,tag:'Adv Tax'},
       {accId:'1005',dr:920000,cr:0,tag:'Computers GBlock'},
       {accId:'1015',dr:380000,cr:0,tag:'Furniture GBlock'},
       {accId:'1018',dr:1800000,cr:0,tag:'ROU Asset'},
       {accId:'1021',dr:450000,cr:0,tag:'Intangibles'},
       {accId:'1016',dr:0,cr:184000,tag:'AccDep Comp'},
       {accId:'1017',dr:0,cr:57000,tag:'AccDep Furn'},
       {accId:'1019',dr:0,cr:300000,tag:'AccDep ROU'},
       {accId:'1022',dr:0,cr:90000,tag:'AccAmort Sw'},
       {accId:'2007',dr:0,cr:5000000,tag:'Term Loan'},
       {accId:'2012',dr:0,cr:360000,tag:'Lease Liab Cur'},
       {accId:'2013',dr:0,cr:1440000,tag:'Lease Liab NCur'},
       {accId:'2015',dr:0,cr:85000,tag:'DTL'},
       {accId:'5001',dr:0,cr:5000000,tag:'Share Capital'},
       {accId:'5002',dr:0,cr:2000000,tag:'Sec Premium'},
       {accId:'5003',dr:0,cr:1500000,tag:'Gen Reserve'},
       {accId:'5004',dr:0,cr:1627000,tag:'Retained Earnings'},
     ],
     gstType:'',tdsSection:'',items:[],totals:{taxable:0,cgst:0,sgst:0,igst:0,tds:0,grand:0}},

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SALES ‚Äî Q1 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {id:'V002',date:'2025-04-08',type:'Sales',narration:'Cloud Infrastructure Setup ‚Äî Infosys (Phase 1)',ref:'INV-2526-001',partyId:'C001',dueDate:'2025-05-23',
     entries:[{accId:'1003',dr:1003000,cr:0,tag:'Debtor Dr'},{accId:'3002',dr:0,cr:850000,tag:'Sales Cr'},{accId:'2002',dr:0,cr:76500,tag:'Output CGST'},{accId:'2003',dr:0,cr:76500,tag:'Output SGST'}],
     gstType:'CGST+SGST (Intra-state)',tdsSection:'',items:[{name:'Cloud Infrastructure Setup',sac:'998319',qty:1,rate:850000,gstRate:18,taxableAmt:850000,cgst:76500,sgst:76500,igst:0,total:1003000}],
     totals:{taxable:850000,cgst:76500,sgst:76500,igst:0,tds:0,grand:1003000}},

    {id:'V003',date:'2025-04-15',type:'Sales',narration:'IT Consulting Services ‚Äî TCS Mumbai (200 hrs Senior)',ref:'INV-2526-002',partyId:'C002',dueDate:'2025-06-14',
     entries:[{accId:'1003',dr:826000,cr:0,tag:'Debtor Dr'},{accId:'3002',dr:0,cr:700000,tag:'Sales Cr'},{accId:'2002',dr:0,cr:63000,tag:'Output CGST'},{accId:'2003',dr:0,cr:63000,tag:'Output SGST'}],
     gstType:'CGST+SGST (Intra-state)',tdsSection:'',items:[{name:'IT Consulting ‚Äî Senior (Per Hour)',sac:'998314',qty:200,rate:3500,gstRate:18,taxableAmt:700000,cgst:63000,sgst:63000,igst:0,total:826000}],
     totals:{taxable:700000,cgst:63000,sgst:63000,igst:0,tds:0,grand:826000}},

    {id:'V004',date:'2025-04-22',type:'Sales',narration:'Server + Network Equipment Supply ‚Äî Wipro Bangalore (IGST)',ref:'INV-2526-003',partyId:'C003',dueDate:'2025-06-06',
     entries:[{accId:'1003',dr:1415400,cr:0,tag:'Debtor Dr'},{accId:'3001',dr:0,cr:1199500,tag:'Sales Cr'},{accId:'2004',dr:0,cr:215910,tag:'Output IGST'}],
     gstType:'IGST (Inter-state)',tdsSection:'',
     items:[{name:'Server ‚Äî Dell PowerEdge R750',hsn:'847149',qty:2,rate:480000,gstRate:18,taxableAmt:960000,cgst:0,sgst:0,igst:172800,total:1132800},{name:'Network Switch ‚Äî Cisco Catalyst',hsn:'851762',qty:2,rate:95000,gstRate:18,taxableAmt:190000,cgst:0,sgst:0,igst:34200,total:224200},{name:'UPS ‚Äî APC Smart-UPS',hsn:'850440',qty:1,rate:35000,gstRate:18,taxableAmt:35000,cgst:0,sgst:0,igst:6300,total:41300},{name:'Business Laptop ‚Äî Dell Latitude',hsn:'847130',qty:1,rate:14500,gstRate:18,taxableAmt:14500,cgst:0,sgst:0,igst:2610,total:17110}],
     totals:{taxable:1199500,cgst:0,sgst:0,igst:215910,tds:0,grand:1415410}},

    {id:'V005',date:'2025-05-05',type:'Sales',narration:'AMC Renewal ‚Äî HCL Technologies Noida (IGST)',ref:'INV-2526-004',partyId:'C004',dueDate:'2025-07-04',
     entries:[{accId:'1003',dr:295000,cr:0,tag:'Debtor Dr'},{accId:'3003',dr:0,cr:250000,tag:'AMC Sales Cr'},{accId:'2004',dr:0,cr:45000,tag:'Output IGST'}],
     gstType:'IGST (Inter-state)',tdsSection:'',items:[{name:'Annual Maintenance Contract (AMC)',sac:'998715',qty:1,rate:250000,gstRate:18,taxableAmt:250000,cgst:0,sgst:0,igst:45000,total:295000}],
     totals:{taxable:250000,cgst:0,sgst:0,igst:45000,tds:0,grand:295000}},

    {id:'V006',date:'2025-05-15',type:'Sales',narration:'Cybersecurity Audit + Consulting ‚Äî Reliance Jio',ref:'INV-2526-005',partyId:'C005',dueDate:'2025-07-14',
     entries:[{accId:'1003',dr:566800,cr:0,tag:'Debtor Dr'},{accId:'3002',dr:0,cr:480000,tag:'Sales Cr'},{accId:'2002',dr:0,cr:43200,tag:'Output CGST'},{accId:'2003',dr:0,cr:43200,tag:'Output SGST'}],
     gstType:'CGST+SGST (Intra-state)',tdsSection:'',items:[{name:'Cybersecurity Audit',sac:'998399',qty:1,rate:180000,gstRate:18,taxableAmt:180000,cgst:16200,sgst:16200,igst:0,total:212400},{name:'IT Consulting ‚Äî Senior (Per Hour)',sac:'998314',qty:85,rate:3500,gstRate:18,taxableAmt:297500,cgst:26775,sgst:26775,igst:0,total:351050}],
     totals:{taxable:477500,cgst:42975,sgst:42975,igst:0,tds:0,grand:563450}},

    {id:'V007',date:'2025-06-01',type:'Sales',narration:'Laptop Supply ‚Äî HDFC Bank (Intra-state)',ref:'INV-2526-006',partyId:'C006',dueDate:'2025-08-30',
     entries:[{accId:'1003',dr:484920,cr:0,tag:'Debtor Dr'},{accId:'3001',dr:0,cr:410950,tag:'Sales Cr'},{accId:'2002',dr:0,cr:36985,tag:'Output CGST'},{accId:'2003',dr:0,cr:36985,tag:'Output SGST'}],
     gstType:'CGST+SGST (Intra-state)',tdsSection:'',items:[{name:'Business Laptop ‚Äî Dell Latitude',hsn:'847130',qty:5,rate:82000,gstRate:18,taxableAmt:410000,cgst:36900,sgst:36900,igst:0,total:483800}],
     totals:{taxable:410000,cgst:36900,sgst:36900,igst:0,tds:0,grand:483800}},

    {id:'V008',date:'2025-06-20',type:'Sales',narration:'IT Consulting ‚Äî Apollo Hospitals (IGST) Q1 Billing',ref:'INV-2526-007',partyId:'C007',dueDate:'2025-08-19',
     entries:[{accId:'1003',dr:472000,cr:0,tag:'Debtor Dr'},{accId:'3002',dr:0,cr:400000,tag:'Sales Cr'},{accId:'2004',dr:0,cr:72000,tag:'Output IGST'}],
     gstType:'IGST (Inter-state)',tdsSection:'',items:[{name:'IT Consulting ‚Äî Senior (Per Hour)',sac:'998314',qty:80,rate:3500,gstRate:18,taxableAmt:280000,cgst:0,sgst:0,igst:50400,total:330400},{name:'IT Consulting ‚Äî Junior (Per Hour)',sac:'998314',qty:60,rate:2000,gstRate:18,taxableAmt:120000,cgst:0,sgst:0,igst:21600,total:141600}],
     totals:{taxable:400000,cgst:0,sgst:0,igst:72000,tds:0,grand:472000}},

    // Q2 Sales
    {id:'V009',date:'2025-07-10',type:'Sales',narration:'Cloud Mgmt & Support ‚Äî Mahindra (IGST)',ref:'INV-2526-008',partyId:'C008',dueDate:'2025-09-08',
     entries:[{accId:'1003',dr:590000,cr:0,tag:'Debtor Dr'},{accId:'3002',dr:0,cr:500000,tag:'Sales Cr'},{accId:'2004',dr:0,cr:90000,tag:'Output IGST'}],
     gstType:'IGST (Inter-state)',tdsSection:'',items:[{name:'IT Consulting ‚Äî Senior (Per Hour)',sac:'998314',qty:100,rate:3500,gstRate:18,taxableAmt:350000,cgst:0,sgst:0,igst:63000,total:413000},{name:'IT Consulting ‚Äî Junior (Per Hour)',sac:'998314',qty:75,rate:2000,gstRate:18,taxableAmt:150000,cgst:0,sgst:0,igst:27000,total:177000}],
     totals:{taxable:500000,cgst:0,sgst:0,igst:90000,tds:0,grand:590000}},

    {id:'V010',date:'2025-08-05',type:'Sales',narration:'AMC + Consulting ‚Äî Infosys (Intra-state)',ref:'INV-2526-009',partyId:'C001',dueDate:'2025-09-19',
     entries:[{accId:'1003',dr:649000,cr:0,tag:'Debtor Dr'},{accId:'3003',dr:0,cr:250000,tag:'AMC Cr'},{accId:'3002',dr:0,cr:300000,tag:'Consulting Cr'},{accId:'2002',dr:0,cr:49500,tag:'Output CGST'},{accId:'2003',dr:0,cr:49500,tag:'Output SGST'}],
     gstType:'CGST+SGST (Intra-state)',tdsSection:'',items:[{name:'Annual Maintenance Contract (AMC)',sac:'998715',qty:1,rate:250000,gstRate:18,taxableAmt:250000,cgst:22500,sgst:22500,igst:0,total:295000},{name:'IT Consulting ‚Äî Senior (Per Hour)',sac:'998314',qty:150,rate:2000,gstRate:18,taxableAmt:300000,cgst:27000,sgst:27000,igst:0,total:354000}],
     totals:{taxable:550000,cgst:49500,sgst:49500,igst:0,tds:0,grand:649000}},

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PURCHASES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {id:'V011',date:'2025-04-10',type:'Purchase',narration:'Laptop procurement ‚Äî TechEquip Distributors Bangalore',ref:'PO-2526-001',partyId:'V004',dueDate:'2025-05-10',
     entries:[{accId:'4001',dr:325000,cr:0,tag:'Purchase Dr'},{accId:'1008',dr:58500,cr:0,tag:'Input IGST'},{accId:'2001',dr:0,cr:383500,tag:'Creditor Cr'}],
     gstType:'IGST (Inter-state)',tdsSection:'',
     items:[{name:'Business Laptop ‚Äî Dell Latitude',hsn:'847130',qty:5,rate:65000,gstRate:18,taxableAmt:325000,cgst:0,sgst:0,igst:58500,total:383500}],
     totals:{taxable:325000,cgst:0,sgst:0,igst:58500,tds:0,grand:383500}},

    {id:'V012',date:'2025-04-20',type:'Purchase',narration:'Server & Network Equipment ‚Äî TechEquip (IGST)',ref:'PO-2526-002',partyId:'V004',dueDate:'2025-05-20',
     entries:[{accId:'4001',dr:914000,cr:0,tag:'Purchase Dr'},{accId:'1008',dr:164520,cr:0,tag:'Input IGST'},{accId:'2001',dr:0,cr:1078520,tag:'Creditor Cr'}],
     gstType:'IGST (Inter-state)',tdsSection:'',
     items:[{name:'Server ‚Äî Dell PowerEdge R750',hsn:'847149',qty:2,rate:385000,gstRate:18,taxableAmt:770000,cgst:0,sgst:0,igst:138600,total:908600},{name:'Network Switch ‚Äî Cisco Catalyst',hsn:'851762',qty:2,rate:72000,gstRate:18,taxableAmt:144000,cgst:0,sgst:0,igst:25920,total:169920}],
     totals:{taxable:914000,cgst:0,sgst:0,igst:164520,tds:0,grand:1078520}},

    {id:'V013',date:'2025-05-01',type:'Purchase',narration:'Sigma Cloud ‚Äî Subcontractor Cloud Services (TDS 194C)',ref:'PO-2526-003',partyId:'V001',dueDate:'2025-06-01',
     entries:[{accId:'4001',dr:600000,cr:0,tag:'Cloud Sub Expense'},{accId:'1006',dr:54000,cr:0,tag:'Input CGST'},{accId:'1007',dr:54000,cr:0,tag:'Input SGST'},{accId:'2005',dr:0,cr:6000,tag:'TDS 194C Payable'},{accId:'2001',dr:0,cr:702000,tag:'Creditor Cr'}],
     gstType:'CGST+SGST (Intra-state)',tdsSection:'194C',
     items:[{name:'Cloud Infrastructure Setup',sac:'998319',qty:1,rate:600000,gstRate:18,taxableAmt:600000,cgst:54000,sgst:54000,igst:0,total:708000}],
     totals:{taxable:600000,cgst:54000,sgst:54000,igst:0,tds:6000,grand:702000}},

    {id:'V014',date:'2025-05-10',type:'Purchase',narration:'Office Stationery ‚Äî Intra-state supplier (Exempt from TDS)',ref:'PO-2526-004',partyId:'V003',dueDate:'2025-05-25',
     entries:[{accId:'4005',dr:42000,cr:0,tag:'Office Exp'},{accId:'1006',dr:2520,cr:0,tag:'Input CGST'},{accId:'1007',dr:2520,cr:0,tag:'Input SGST'},{accId:'2001',dr:0,cr:47040,tag:'Creditor Cr'}],
     gstType:'CGST+SGST (Intra-state)',tdsSection:'',
     items:[{name:'Office Stationery & Supplies',hsn:'482000',qty:70,rate:600,gstRate:12,taxableAmt:42000,cgst:2520,sgst:2520,igst:0,total:47040}],
     totals:{taxable:42000,cgst:2520,sgst:2520,igst:0,tds:0,grand:47040}},

    // Q2 Purchase
    {id:'V015',date:'2025-07-12',type:'Purchase',narration:'DataCenter Colocation ‚Äî Sigma Cloud (TDS 194C)',ref:'PO-2526-005',partyId:'V001',dueDate:'2025-08-12',
     entries:[{accId:'4005',dr:350000,cr:0,tag:'Datacenter Exp'},{accId:'1006',dr:31500,cr:0,tag:'Input CGST'},{accId:'1007',dr:31500,cr:0,tag:'Input SGST'},{accId:'2005',dr:0,cr:3500,tag:'TDS 194C Payable'},{accId:'2001',dr:0,cr:409500,tag:'Creditor Cr'}],
     gstType:'CGST+SGST (Intra-state)',tdsSection:'194C',
     items:[{name:'Cloud Infrastructure Setup',sac:'998319',qty:1,rate:350000,gstRate:18,taxableAmt:350000,cgst:31500,sgst:31500,igst:0,total:413000}],
     totals:{taxable:350000,cgst:31500,sgst:31500,igst:0,tds:3500,grand:409500}},

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAYMENTS ‚Äî Vendors ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {id:'V016',date:'2025-04-28',type:'Payment',narration:'Rent payment April 2025 ‚Äî Prime Realty (TDS 194I)',ref:'',partyId:'V003',dueDate:'',
     entries:[{accId:'4003',dr:180000,cr:0,tag:'Rent Exp'},{accId:'2005',dr:0,cr:18000,tag:'TDS 194I Payable'},{accId:'1002',dr:0,cr:162000,tag:'Bank Cr'}],
     gstType:'',tdsSection:'194I',
     items:[],totals:{taxable:180000,cgst:0,sgst:0,igst:0,tds:18000,grand:162000}},

    {id:'V017',date:'2025-05-07',type:'Payment',narration:'TDS deposit ‚Äî April 2025 (Form 26Q/27Q)',ref:'TDS-CHALLAN-APR25',partyId:'',dueDate:'',
     entries:[{accId:'2005',dr:24000,cr:0,tag:'TDS Payable Cleared'},{accId:'1002',dr:0,cr:24000,tag:'Bank Cr'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:24000,cgst:0,sgst:0,igst:0,tds:0,grand:24000}},

    {id:'V018',date:'2025-05-12',type:'Payment',narration:'Payment to TechEquip ‚Äî PO-2526-001',ref:'RTGS-20250512',partyId:'V004',dueDate:'',
     entries:[{accId:'2001',dr:383500,cr:0,tag:'Creditor Dr'},{accId:'1002',dr:0,cr:383500,tag:'Bank Cr'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:383500,cgst:0,sgst:0,igst:0,tds:0,grand:383500}},

    {id:'V019',date:'2025-05-28',type:'Payment',narration:'Rent payment May 2025 ‚Äî Prime Realty (TDS 194I)',ref:'',partyId:'V003',dueDate:'',
     entries:[{accId:'4003',dr:180000,cr:0,tag:'Rent Exp'},{accId:'2005',dr:0,cr:18000,tag:'TDS 194I Payable'},{accId:'1002',dr:0,cr:162000,tag:'Bank Cr'}],
     gstType:'',tdsSection:'194I',
     items:[],totals:{taxable:180000,cgst:0,sgst:0,igst:0,tds:18000,grand:162000}},

    {id:'V020',date:'2025-06-02',type:'Payment',narration:'CA Firm fees ‚Äî Swaminathan & Associates (TDS 194J)',ref:'',partyId:'V006',dueDate:'',
     entries:[{accId:'4009',dr:85000,cr:0,tag:'Prof Fees'},{accId:'2005',dr:0,cr:8500,tag:'TDS 194J Payable'},{accId:'1002',dr:0,cr:76500,tag:'Bank Cr'}],
     gstType:'',tdsSection:'194J',
     items:[],totals:{taxable:85000,cgst:0,sgst:0,igst:0,tds:8500,grand:76500}},

    {id:'V021',date:'2025-06-07',type:'Payment',narration:'TDS deposit ‚Äî May 2025 (Form 26Q)',ref:'TDS-CHALLAN-MAY25',partyId:'',dueDate:'',
     entries:[{accId:'2005',dr:36500,cr:0,tag:'TDS Payable Cleared'},{accId:'1002',dr:0,cr:36500,tag:'Bank Cr'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:36500,cgst:0,sgst:0,igst:0,tds:0,grand:36500}},

    {id:'V022',date:'2025-06-28',type:'Payment',narration:'Rent payment June 2025 ‚Äî Prime Realty (TDS 194I)',ref:'',partyId:'V003',dueDate:'',
     entries:[{accId:'4003',dr:180000,cr:0,tag:'Rent Exp'},{accId:'2005',dr:0,cr:18000,tag:'TDS 194I Payable'},{accId:'1002',dr:0,cr:162000,tag:'Bank Cr'}],
     gstType:'',tdsSection:'194I',
     items:[],totals:{taxable:180000,cgst:0,sgst:0,igst:0,tds:18000,grand:162000}},

    {id:'V023',date:'2025-07-05',type:'Payment',narration:'TDS deposit ‚Äî June 2025 (Q1 TDS)',ref:'TDS-CHALLAN-JUN25',partyId:'',dueDate:'',
     entries:[{accId:'2005',dr:26500,cr:0,tag:'TDS Payable Cleared'},{accId:'1002',dr:0,cr:26500,tag:'Bank Cr'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:26500,cgst:0,sgst:0,igst:0,tds:0,grand:26500}},

    {id:'V024',date:'2025-07-15',type:'Payment',narration:'Digital Marketing Agency ‚Äî Print Media (TDS 194C)',ref:'',partyId:'V007',dueDate:'',
     entries:[{accId:'4006',dr:75000,cr:0,tag:'Marketing Exp'},{accId:'2005',dr:0,cr:750,tag:'TDS 194C Payable'},{accId:'1002',dr:0,cr:74250,tag:'Bank Cr'}],
     gstType:'',tdsSection:'194C',
     items:[],totals:{taxable:75000,cgst:0,sgst:0,igst:0,tds:750,grand:74250}},

    {id:'V025',date:'2025-07-28',type:'Payment',narration:'Rent payment July 2025 ‚Äî Prime Realty (TDS 194I)',ref:'',partyId:'V003',dueDate:'',
     entries:[{accId:'4003',dr:180000,cr:0,tag:'Rent Exp'},{accId:'2005',dr:0,cr:18000,tag:'TDS 194I Payable'},{accId:'1002',dr:0,cr:162000,tag:'Bank Cr'}],
     gstType:'',tdsSection:'194I',
     items:[],totals:{taxable:180000,cgst:0,sgst:0,igst:0,tds:18000,grand:162000}},

    {id:'V026',date:'2025-08-05',type:'Payment',narration:'Insurance Premium ‚Äî National Insurance (Annual)',ref:'NICL-POL-2526',partyId:'V008',dueDate:'',
     entries:[{accId:'4012',dr:96000,cr:0,tag:'Insurance'},{accId:'1011',dr:0,cr:48000,tag:'Prepaid Adj'},{accId:'1002',dr:0,cr:48000,tag:'Bank Cr'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:96000,cgst:0,sgst:0,igst:0,tds:0,grand:96000}},

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECEIPTS (with TDS RECEIVABLE) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {id:'V027',date:'2025-05-23',type:'Receipt',narration:'Infosys payment INV-2526-001 (TDS deducted u/s 194J)',ref:'NEFT-INF-20250523',partyId:'C001',dueDate:'',
     entries:[{accId:'1002',dr:935500,cr:0,tag:'Bank Dr'},{accId:'1010',dr:85000,cr:0,tag:'TDS Receivable Dr'},{accId:'1003',dr:0,cr:1003000,tag:'Debtor Cr (net of TDS + amt received)'}],
     gstType:'',tdsSection:'',tdsRecSection:'194J',tdsRecAmt:85000,tdsRecBase:850000,tdsRecDeductorPAN:'AABCI1234R',tdsRecQuarter:'Q1 (Apr-Jun)',
     items:[],totals:{taxable:850000,cgst:0,sgst:0,igst:0,tds:85000,grand:935500}},

    {id:'V028',date:'2025-06-14',type:'Receipt',narration:'TCS payment INV-2526-002 (TDS deducted u/s 194J @10%)',ref:'RTGS-TCS-20250614',partyId:'C002',dueDate:'',
     entries:[{accId:'1002',dr:756000,cr:0,tag:'Bank Dr'},{accId:'1010',dr:70000,cr:0,tag:'TDS Receivable Dr'},{accId:'1003',dr:0,cr:826000,tag:'Debtor Cr'}],
     gstType:'',tdsSection:'',tdsRecSection:'194J',tdsRecAmt:70000,tdsRecBase:700000,tdsRecDeductorPAN:'AABCT5678R',tdsRecQuarter:'Q1 (Apr-Jun)',
     items:[],totals:{taxable:700000,cgst:0,sgst:0,igst:0,tds:70000,grand:756000}},

    {id:'V029',date:'2025-06-30',type:'Receipt',narration:'Wipro partial payment INV-2526-003',ref:'RTGS-WIP-20250630',partyId:'C003',dueDate:'',
     entries:[{accId:'1002',dr:800000,cr:0,tag:'Bank Dr'},{accId:'1003',dr:0,cr:800000,tag:'Debtor Cr'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:800000,cgst:0,sgst:0,igst:0,tds:0,grand:800000}},

    {id:'V030',date:'2025-07-04',type:'Receipt',narration:'HCL payment INV-2526-004 (TDS u/s 194J ‚Äî AMC)',ref:'NEFT-HCL-20250704',partyId:'C004',dueDate:'',
     entries:[{accId:'1002',dr:270000,cr:0,tag:'Bank Dr'},{accId:'1010',dr:25000,cr:0,tag:'TDS Receivable Dr'},{accId:'1003',dr:0,cr:295000,tag:'Debtor Cr'}],
     gstType:'',tdsSection:'',tdsRecSection:'194J',tdsRecAmt:25000,tdsRecBase:250000,tdsRecDeductorPAN:'AABCH3456R',tdsRecQuarter:'Q1 (Apr-Jun)',
     items:[],totals:{taxable:250000,cgst:0,sgst:0,igst:0,tds:25000,grand:270000}},

    {id:'V031',date:'2025-07-14',type:'Receipt',narration:'Reliance Jio payment INV-2526-005 (TDS u/s 194J)',ref:'RTGS-JIO-20250714',partyId:'C005',dueDate:'',
     entries:[{accId:'1002',dr:515750,cr:0,tag:'Bank Dr'},{accId:'1010',dr:47750,cr:0,tag:'TDS Receivable Dr'},{accId:'1003',dr:0,cr:563500,tag:'Debtor Cr'}],
     gstType:'',tdsSection:'',tdsRecSection:'194J',tdsRecAmt:47750,tdsRecBase:477500,tdsRecDeductorPAN:'AAACR5055K',tdsRecQuarter:'Q1 (Apr-Jun)',
     items:[],totals:{taxable:477500,cgst:0,sgst:0,igst:0,tds:47750,grand:515750}},

    {id:'V032',date:'2025-08-19',type:'Receipt',narration:'Apollo Hospitals payment INV-2526-007 (TDS u/s 194J)',ref:'RTGS-APO-20250819',partyId:'C007',dueDate:'',
     entries:[{accId:'1002',dr:432000,cr:0,tag:'Bank Dr'},{accId:'1010',dr:40000,cr:0,tag:'TDS Receivable Dr'},{accId:'1003',dr:0,cr:472000,tag:'Debtor Cr'}],
     gstType:'',tdsSection:'',tdsRecSection:'194J',tdsRecAmt:40000,tdsRecBase:400000,tdsRecDeductorPAN:'AAACA4033E',tdsRecQuarter:'Q2 (Jul-Sep)',
     items:[],totals:{taxable:400000,cgst:0,sgst:0,igst:0,tds:40000,grand:432000}},

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEBIT NOTE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {id:'V033',date:'2025-06-15',type:'Debit Note',narration:'Additional consulting hours ‚Äî Infosys June (20 hrs)',ref:'DN-2526-001',partyId:'C001',dueDate:'2025-07-30',
     entries:[{accId:'1003',dr:82600,cr:0,tag:'Debtor Dr'},{accId:'3002',dr:0,cr:70000,tag:'Service Cr'},{accId:'2002',dr:0,cr:6300,tag:'Output CGST'},{accId:'2003',dr:0,cr:6300,tag:'Output SGST'}],
     gstType:'CGST+SGST (Intra-state)',tdsSection:'',items:[{name:'IT Consulting ‚Äî Senior (Per Hour)',sac:'998314',qty:20,rate:3500,gstRate:18,taxableAmt:70000,cgst:6300,sgst:6300,igst:0,total:82600}],
     totals:{taxable:70000,cgst:6300,sgst:6300,igst:0,tds:0,grand:82600}},

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CREDIT NOTE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {id:'V034',date:'2025-07-20',type:'Credit Note',narration:'Defective UPS return ‚Äî TechEquip (against PO-002)',ref:'CN-2526-001',partyId:'V004',dueDate:'',
     entries:[{accId:'2001',dr:41300,cr:0,tag:'Creditor Dr'},{accId:'4001',dr:0,cr:35000,tag:'Purchase Cr'},{accId:'1008',dr:0,cr:6300,tag:'Input IGST Rev'}],
     gstType:'IGST (Inter-state)',tdsSection:'',items:[{name:'UPS ‚Äî APC Smart-UPS',hsn:'850440',qty:1,rate:35000,gstRate:18,taxableAmt:35000,cgst:0,sgst:0,igst:6300,total:41300}],
     totals:{taxable:35000,cgst:0,sgst:0,igst:6300,tds:0,grand:41300}},

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JOURNAL ‚Äî IND AS Compliance Entries ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {id:'V035',date:'2025-06-30',type:'Journal',narration:'Q1 Depreciation ‚Äî Computers @33.33% p.a. SLM (IND AS 16)',ref:'DEP-Q1-COMP',partyId:'',dueDate:'',
     entries:[{accId:'4008',dr:76665,cr:0,tag:'Depreciation'},{accId:'1016',dr:0,cr:76665,tag:'AccDep Computers'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:76665,cgst:0,sgst:0,igst:0,tds:0,grand:76665}},

    {id:'V036',date:'2025-06-30',type:'Journal',narration:'Q1 Depreciation ‚Äî Furniture @10% p.a. SLM (IND AS 16)',ref:'DEP-Q1-FURN',partyId:'',dueDate:'',
     entries:[{accId:'4008',dr:9500,cr:0,tag:'Depreciation'},{accId:'1017',dr:0,cr:9500,tag:'AccDep Furniture'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:9500,cgst:0,sgst:0,igst:0,tds:0,grand:9500}},

    {id:'V037',date:'2025-06-30',type:'Journal',narration:'Q1 ROU Asset Depreciation ‚Äî Lease (IND AS 116)',ref:'DEP-Q1-ROU',partyId:'',dueDate:'',
     entries:[{accId:'4008',dr:75000,cr:0,tag:'ROU Dep'},{accId:'1019',dr:0,cr:75000,tag:'AccDep ROU'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:75000,cgst:0,sgst:0,igst:0,tds:0,grand:75000}},

    {id:'V038',date:'2025-06-30',type:'Journal',narration:'Q1 Amortisation ‚Äî Software Licenses @20% p.a. SLM (IND AS 38)',ref:'AMORT-Q1-SW',partyId:'',dueDate:'',
     entries:[{accId:'4008',dr:22500,cr:0,tag:'Amortisation'},{accId:'1022',dr:0,cr:22500,tag:'AccAmort Software'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:22500,cgst:0,sgst:0,igst:0,tds:0,grand:22500}},

    {id:'V039',date:'2025-06-30',type:'Journal',narration:'Interest on Lease Liability ‚Äî Q1 IND AS 116 (5% p.a.)',ref:'INT-LEASE-Q1',partyId:'',dueDate:'',
     entries:[{accId:'4014',dr:22500,cr:0,tag:'Interest Lease'},{accId:'2016',dr:0,cr:22500,tag:'Interest Payable'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:22500,cgst:0,sgst:0,igst:0,tds:0,grand:22500}},

    {id:'V040',date:'2025-06-30',type:'Journal',narration:'Interest on Term Loan ‚Äî Q1 (8.5% p.a. HDFC)',ref:'INT-LOAN-Q1',partyId:'',dueDate:'',
     entries:[{accId:'4013',dr:106250,cr:0,tag:'Loan Interest'},{accId:'2007',dr:106250,cr:0,tag:'Loan Reduced'},{accId:'1002',dr:0,cr:212500,tag:'Bank Cr EMI'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:106250,cgst:0,sgst:0,igst:0,tds:0,grand:106250}},

    {id:'V041',date:'2025-06-30',type:'Journal',narration:'Provision for Gratuity ‚Äî Q1 Actuarial (IND AS 19)',ref:'GRAT-Q1-PROV',partyId:'',dueDate:'',
     entries:[{accId:'4015',dr:85000,cr:0,tag:'Gratuity Exp'},{accId:'2014',dr:0,cr:85000,tag:'Gratuity Provision'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:85000,cgst:0,sgst:0,igst:0,tds:0,grand:85000}},

    {id:'V042',date:'2025-06-30',type:'Journal',narration:'Deferred Tax Adjustment Q1 ‚Äî Timing Differences (IND AS 12)',ref:'DTA-Q1-ADJ',partyId:'',dueDate:'',
     entries:[{accId:'4017',dr:12000,cr:0,tag:'DT Expense'},{accId:'2015',dr:0,cr:12000,tag:'DTL Increased'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:12000,cgst:0,sgst:0,igst:0,tds:0,grand:12000}},

    {id:'V043',date:'2025-06-30',type:'Journal',narration:'Prepaid Insurance reversal Q1 ‚Äî 3 months of annual policy',ref:'PREPAID-Q1',partyId:'',dueDate:'',
     entries:[{accId:'4012',dr:24000,cr:0,tag:'Insurance Exp'},{accId:'1011',dr:0,cr:24000,tag:'Prepaid Adj'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:24000,cgst:0,sgst:0,igst:0,tds:0,grand:24000}},

    {id:'V044',date:'2025-07-31',type:'Journal',narration:'Q2 Depreciation ‚Äî All Assets (Computers+Furniture+ROU+SW)',ref:'DEP-Q2-ALL',partyId:'',dueDate:'',
     entries:[{accId:'4008',dr:183665,cr:0,tag:'Total Dep'},{accId:'1016',dr:0,cr:76665,tag:'AccDep Comp'},{accId:'1017',dr:0,cr:9500,tag:'AccDep Furn'},{accId:'1019',dr:0,cr:75000,tag:'AccDep ROU'},{accId:'1022',dr:0,cr:22500,tag:'AccAmort SW'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:183665,cgst:0,sgst:0,igst:0,tds:0,grand:183665}},

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTRA ‚Äî Bank/Cash ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {id:'V045',date:'2025-04-05',type:'Contra',narration:'Cash withdrawal from HDFC Bank for petty cash',ref:'',partyId:'',dueDate:'',
     entries:[{accId:'1001',dr:50000,cr:0,tag:'Cash Dr'},{accId:'1002',dr:0,cr:50000,tag:'Bank Cr'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:50000,cgst:0,sgst:0,igst:0,tds:0,grand:50000}},

    {id:'V046',date:'2025-07-01',type:'Contra',narration:'Bank deposit ‚Äî excess petty cash to HDFC',ref:'',partyId:'',dueDate:'',
     entries:[{accId:'1002',dr:25000,cr:0,tag:'Bank Dr'},{accId:'1001',dr:0,cr:25000,tag:'Cash Cr'}],
     gstType:'',tdsSection:'',items:[],totals:{taxable:25000,cgst:0,sgst:0,igst:0,tds:0,grand:25000}},
  ];

  // ‚îÄ‚îÄ Employees (IND AS 19 Compliant ‚Äî Full Salary Structure) ‚îÄ‚îÄ
  s.employees=[
    {id:'EMP-001',name:'Arjun Kapoor',designation:'CTO / Head Technology',department:'Engineering',doj:'2020-04-01',dob:'1985-03-15',
     pan:'ACEPK7834R',aadhaar:'1234-5678-9012',mobile:'9876540001',email:'arjun.kapoor@techserve.in',
     bankAccNo:'50100987654321',ifsc:'HDFC0001234',
     basicSalary:120000,hra:48000,da:12000,otherAllow:25000,lta:10000,medAllow:1250,
     specialAllow:18750,grossSalary:235000,
     pf:14400,esi:0,pt:200,tds:28500,totalDeductions:43100,netSalary:191900,status:'active'},

    {id:'EMP-002',name:'Priya Nair',designation:'Finance Manager (CA)',department:'Finance',doj:'2021-06-15',dob:'1990-07-22',
     pan:'BFRPN4521K',aadhaar:'2345-6789-0123',mobile:'9876540002',email:'priya.nair@techserve.in',
     bankAccNo:'0002109876543',ifsc:'ICIC0002345',
     basicSalary:80000,hra:32000,da:8000,otherAllow:12000,lta:6667,medAllow:1250,
     specialAllow:10083,grossSalary:150000,
     pf:9600,esi:0,pt:200,tds:14200,totalDeductions:24000,netSalary:126000,status:'active'},

    {id:'EMP-003',name:'Rahul Mishra',designation:'Senior Developer',department:'Engineering',doj:'2022-08-01',dob:'1993-11-05',
     pan:'CGMPR9031Z',aadhaar:'3456-7890-1234',mobile:'9876540003',email:'rahul.mishra@techserve.in',
     bankAccNo:'3001234567890',ifsc:'SBIN0003456',
     basicSalary:70000,hra:28000,da:7000,otherAllow:8000,lta:5833,medAllow:1250,
     specialAllow:7917,grossSalary:128000,
     pf:8400,esi:0,pt:200,tds:10800,totalDeductions:19400,netSalary:108600,status:'active'},

    {id:'EMP-004',name:'Sneha Gupta',designation:'DevOps Engineer',department:'Engineering',doj:'2023-02-01',dob:'1996-04-18',
     pan:'DHCPG6712B',aadhaar:'4567-8901-2345',mobile:'9876540004',email:'sneha.gupta@techserve.in',
     bankAccNo:'4001234567891',ifsc:'AXIS0004567',
     basicSalary:60000,hra:24000,da:6000,otherAllow:6000,lta:5000,medAllow:1250,
     specialAllow:6750,grossSalary:109000,
     pf:7200,esi:0,pt:200,tds:7500,totalDeductions:14900,netSalary:94100,status:'active'},

    {id:'EMP-005',name:'Vikram Sinha',designation:'Sales Head',department:'Sales & BD',doj:'2021-11-20',dob:'1987-09-30',
     pan:'EIJVS2298M',aadhaar:'5678-9012-3456',mobile:'9876540005',email:'vikram.sinha@techserve.in',
     bankAccNo:'5001234567892',ifsc:'HDFC0005678',
     basicSalary:90000,hra:36000,da:9000,otherAllow:20000,lta:7500,medAllow:1250,
     specialAllow:11250,grossSalary:175000,
     pf:10800,esi:0,pt:200,tds:19500,totalDeductions:30500,netSalary:144500,status:'active'},

    {id:'EMP-006',name:'Anjali Bose',designation:'HR Manager',department:'Human Resources',doj:'2020-09-15',dob:'1991-06-12',
     pan:'FJKAB1089P',aadhaar:'6789-0123-4567',mobile:'9876540006',email:'anjali.bose@techserve.in',
     bankAccNo:'6001234567893',ifsc:'KKBK0006789',
     basicSalary:55000,hra:22000,da:5500,otherAllow:5500,lta:4583,medAllow:1250,
     specialAllow:7167,grossSalary:101000,
     pf:6600,esi:0,pt:200,tds:6000,totalDeductions:12800,netSalary:88200,status:'active'},

    {id:'EMP-007',name:'Dev Anand Joshi',designation:'Business Analyst',department:'Sales & BD',doj:'2023-07-10',dob:'1994-02-28',
     pan:'GLMDJ4520N',aadhaar:'7890-1234-5678',mobile:'9876540007',email:'dev.joshi@techserve.in',
     bankAccNo:'7001234567894',ifsc:'YESB0007890',
     basicSalary:50000,hra:20000,da:5000,otherAllow:4000,lta:4167,medAllow:1250,
     specialAllow:5583,grossSalary:90000,
     pf:6000,esi:0,pt:200,tds:4800,totalDeductions:11000,netSalary:79000,status:'active'},

    {id:'EMP-008',name:'Kavitha Sundar',designation:'UI/UX Designer',department:'Engineering',doj:'2024-01-15',dob:'1998-08-10',
     pan:'HNPKS9834Q',aadhaar:'8901-2345-6789',mobile:'9876540008',email:'kavitha.s@techserve.in',
     bankAccNo:'8001234567895',ifsc:'PUNB0008901',
     basicSalary:45000,hra:18000,da:4500,otherAllow:3000,lta:3750,medAllow:1250,
     specialAllow:4500,grossSalary:80000,
     pf:5400,esi:0,pt:200,tds:3200,totalDeductions:8800,netSalary:71200,status:'active'},
  ];

  // ‚îÄ‚îÄ Payroll ‚Äî April 2025 ‚îÄ‚îÄ
  const aprilEntries=s.employees.filter(e=>e.status==='active').map(emp=>({
    empId:emp.id,empName:emp.name,designation:emp.designation,department:emp.department,
    basicSalary:emp.basicSalary,hra:emp.hra,da:emp.da,otherAllow:emp.otherAllow||0,
    lta:emp.lta||0,medAllow:emp.medAllow||0,specialAllow:emp.specialAllow||0,
    grossSalary:emp.grossSalary,pf:emp.pf,esi:emp.esi||0,pt:emp.pt,tds:emp.tds,
    totalDeductions:emp.totalDeductions,netSalary:emp.netSalary,
    daysWorked:30,daysInMonth:30,lopDays:0,bankAccNo:emp.bankAccNo,ifsc:emp.ifsc,
  }));
  const mkPayTotal=arr=>arr.reduce((a,e)=>({gr:a.gr+e.grossSalary,net:a.net+e.netSalary,pf:a.pf+e.pf,tds:a.tds+e.tds,pt:a.pt+e.pt}),{gr:0,net:0,pf:0,tds:0,pt:0});
  const aprT=mkPayTotal(aprilEntries);

  // ‚îÄ‚îÄ Payroll ‚Äî May 2025 ‚îÄ‚îÄ
  const mayEntries=aprilEntries.map(e=>({...e,daysWorked:e.empId==='EMP-004'?28:31,daysInMonth:31}));
  const mayT=mkPayTotal(mayEntries);

  // ‚îÄ‚îÄ Payroll ‚Äî June 2025 ‚îÄ‚îÄ
  const junEntries=aprilEntries.map(e=>({...e,daysWorked:30,daysInMonth:30}));
  const junT=mkPayTotal(junEntries);

  s.payroll=[
    {month:'2025-04',monthLabel:'April 2025',entries:aprilEntries,processedBy:'admin',processedAt:'2025-04-30T18:00:00.000Z'},
    {month:'2025-05',monthLabel:'May 2025',entries:mayEntries,processedBy:'admin',processedAt:'2025-05-31T18:00:00.000Z'},
    {month:'2025-06',monthLabel:'June 2025',entries:junEntries,processedBy:'admin',processedAt:'2025-06-30T18:00:00.000Z'},
  ];

  // Payroll Journal Vouchers ‚Äî Auto-posted
  const mkPayJV=(id,date,ref,monthLabel,t)=>({
    id,date,type:'Journal',narration:`Salary for ${monthLabel} ‚Äî Auto-posted`,ref,partyId:'',dueDate:'',
    entries:[
      {accId:'4002',dr:t.gr,cr:0,tag:'Gross Salary Expense'},
      {accId:'1002',dr:0,cr:t.net,tag:'Net Salary Disbursed'},
      {accId:'2010',dr:0,cr:t.pf,tag:'PF Payable'},
      {accId:'2011',dr:0,cr:t.pt,tag:'PT Payable'},
      {accId:'2005',dr:0,cr:t.tds,tag:'TDS Payable (192B)'},
    ],
    gstType:'',tdsSection:'',items:[],
    totals:{taxable:t.gr,cgst:0,sgst:0,igst:0,tds:t.tds,grand:t.gr}
  });
  s.vouchers.push(mkPayJV('V047','2025-04-30','PAYROLL-APR25','April 2025',aprT));
  s.vouchers.push(mkPayJV('V048','2025-05-31','PAYROLL-MAY25','May 2025',mayT));
  s.vouchers.push(mkPayJV('V049','2025-06-30','PAYROLL-JUN25','June 2025',junT));

  // PF + PT payment entries each month
  const ptPFPmt=(id,date,t)=>({
    id,date,type:'Payment',narration:`PF+PT deposit ${date.slice(0,7)}`,ref:'',partyId:'',dueDate:'',
    entries:[{accId:'2010',dr:t.pf,cr:0},{accId:'2011',dr:t.pt,cr:0},{accId:'1002',dr:0,cr:t.pf+t.pt}],
    gstType:'',tdsSection:'',items:[],totals:{taxable:t.pf+t.pt,cgst:0,sgst:0,igst:0,tds:0,grand:t.pf+t.pt}
  });
  s.vouchers.push(ptPFPmt('V050','2025-05-15',aprT));
  s.vouchers.push(ptPFPmt('V051','2025-06-15',mayT));
  s.vouchers.push(ptPFPmt('V052','2025-07-15',junT));

  // ‚îÄ‚îÄ Form 26AS Data (TDS received from customers ‚Äî matches TDS Receivable) ‚îÄ‚îÄ
  s.form26AS=[
    {srNo:'1',deductorName:'Infosys Limited',deductorTAN:'BNGI12345D',deductorPAN:'AABCI1234R',section:'194J',quarter:'Q1 (Apr-Jun)',amtCredit:850000,tdsAmt:85000,depositDate:'2025-07-07',remarks:''},
    {srNo:'2',deductorName:'Tata Consultancy Services Ltd',deductorTAN:'MUMT87654G',deductorPAN:'AABCT5678R',section:'194J',quarter:'Q1 (Apr-Jun)',amtCredit:700000,tdsAmt:70000,depositDate:'2025-07-07',remarks:''},
    {srNo:'3',deductorName:'HCL Technologies Ltd',deductorTAN:'DLHT23456G',deductorPAN:'AABCH3456R',section:'194J',quarter:'Q1 (Apr-Jun)',amtCredit:250000,tdsAmt:25000,depositDate:'2025-07-07',remarks:''},
    {srNo:'4',deductorName:'Reliance Jio Infocomm Ltd',deductorTAN:'MUMT67890G',deductorPAN:'AAACR5055K',section:'194J',quarter:'Q1 (Apr-Jun)',amtCredit:477500,tdsAmt:47750,depositDate:'2025-07-07',remarks:''},
    {srNo:'5',deductorName:'Apollo Hospitals Enterprise Ltd',deductorTAN:'HYDT34567G',deductorPAN:'AAACA4033E',section:'194J',quarter:'Q2 (Jul-Sep)',amtCredit:400000,tdsAmt:40000,depositDate:'2025-10-07',remarks:''},
    {srNo:'6',deductorName:'Wipro Technologies Ltd',deductorTAN:'BNGI88776G',deductorPAN:'AABCW9012R',section:'194J',quarter:'Q1 (Apr-Jun)',amtCredit:1199500,tdsAmt:119950,depositDate:'2025-07-07',remarks:'Note: Wipro deducted ‚Äî not yet in books'},
  ];

  return s;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FEATURE 1: GSTR-1 RETURN
//  Monthly/Quarterly statement of outward supplies to be filed by
//  all GST registered taxpayers. Generates B2B, B2CS, CDNR tables.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgGSTR1(){
  const months=['Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan','Feb','Mar'];
  const fyParts=(state.fy||'2025-26').split('-');
  const fyYear=parseInt(fyParts[0]);
  const fyMonths=months.map((m,i)=>{
    const yr=i<9?fyYear:fyYear+1;
    const mo=String(i<9?i+4:i-8).padStart(2,'0');
    return {label:`${m} ${yr}`, value:`${yr}-${mo}`};
  });

  // Get sales vouchers for FY
  const salesV=state.vouchers.filter(v=>
    ['Sales','Debit Note'].includes(v.type)&&
    v.date>=state.fyStart&&v.date<=state.fyEnd
  );

  // Split B2B (customer has GSTIN) vs B2CS (consumer/unregistered)
  const b2b=salesV.filter(v=>{
    const party=state.debtors.find(d=>d.id===v.partyId||d.name===v.partyId);
    return party?.gstin;
  });
  const b2cs=salesV.filter(v=>{
    const party=state.debtors.find(d=>d.id===v.partyId||d.name===v.partyId);
    return !party?.gstin;
  });

  function calcGST(v){
    if(v.items&&v.items.length){
      return{
        taxable:v.items.reduce((s,i)=>s+(i.taxable||0),0),
        cgst:v.items.reduce((s,i)=>s+(i.cgst||0),0),
        sgst:v.items.reduce((s,i)=>s+(i.sgst||0),0),
        igst:v.items.reduce((s,i)=>s+(i.igst||0),0)
      };
    }
    const cgst=v.entries.filter(e=>e.accId==='2002').reduce((s,e)=>s+(e.cr||0),0);
    const sgst=v.entries.filter(e=>e.accId==='2003').reduce((s,e)=>s+(e.cr||0),0);
    const igst=v.entries.filter(e=>e.accId==='2004').reduce((s,e)=>s+(e.cr||0),0);
    const gross=v.entries.reduce((s,e)=>s+(e.dr||0),0);
    return{taxable:gross-cgst-sgst-igst,cgst,sgst,igst};
  }

  // HSN Summary
  const hsnMap={};
  salesV.forEach(v=>{
    (v.items||[]).forEach(it=>{
      const hsn=it.hsn||it.itemCode||'‚Äî';
      if(!hsnMap[hsn])hsnMap[hsn]={hsn,desc:it.desc||it.name||'',qty:0,unit:'NOS',taxable:0,cgst:0,sgst:0,igst:0};
      hsnMap[hsn].qty+=it.qty||1;
      hsnMap[hsn].taxable+=it.taxable||0;
      hsnMap[hsn].cgst+=it.cgst||0;
      hsnMap[hsn].sgst+=it.sgst||0;
      hsnMap[hsn].igst+=it.igst||0;
    });
  });
  const hsnRows=Object.values(hsnMap);

  const b2bRows=b2b.map((v,i)=>{
    const g=calcGST(v);
    const party=state.debtors.find(d=>d.id===v.partyId||d.name===v.partyId);
    return`<tr class="${i%2?'alt':''}">
      <td class="mono" style="font-size:11px;">${party?.gstin||'‚Äî'}</td>
      <td>${party?.name||v.partyId||v.narration}</td>
      <td class="mono tb-">${v.id}</td>
      <td>${fmtD(v.date)}</td>
      <td class="tr">${fmt(g.taxable)}</td>
      <td class="tr tg-">${fmt(g.igst>0?g.igst:g.cgst+g.sgst)}</td>
      <td class="tr" style="font-weight:700;">${fmt(g.taxable+g.cgst+g.sgst+g.igst)}</td>
    </tr>`;
  }).join('');

  const b2csRows=b2cs.map((v,i)=>{
    const g=calcGST(v);
    return`<tr class="${i%2?'alt':''}">
      <td>${v.narration}</td>
      <td class="mono tb-">${v.id}</td>
      <td>${fmtD(v.date)}</td>
      <td class="tr">${fmt(g.taxable)}</td>
      <td class="tr tg-">${fmt(g.cgst)}</td>
      <td class="tr tg-">${fmt(g.sgst)}</td>
      <td class="tr bp">${fmt(g.igst)}</td>
      <td class="tr" style="font-weight:700;">${fmt(g.taxable+g.cgst+g.sgst+g.igst)}</td>
    </tr>`;
  }).join('');

  const hsnTableRows=hsnRows.map((h,i)=>`<tr class="${i%2?'alt':''}">
    <td class="mono">${h.hsn}</td>
    <td style="font-size:11px;">${h.desc}</td>
    <td class="tr">${fmtN(h.qty)}</td>
    <td>${h.unit}</td>
    <td class="tr">${fmt(h.taxable)}</td>
    <td class="tr tg-">${fmt(h.cgst)}</td>
    <td class="tr tg-">${fmt(h.sgst)}</td>
    <td class="tr bp">${fmt(h.igst)}</td>
    <td class="tr" style="font-weight:700;">${fmt(h.taxable+h.cgst+h.sgst+h.igst)}</td>
  </tr>`).join('');

  const totSales=salesV.reduce((s,v)=>{const g=calcGST(v);return s+g.taxable+g.cgst+g.sgst+g.igst;},0);
  const totTax=salesV.reduce((s,v)=>{const g=calcGST(v);return s+g.cgst+g.sgst+g.igst;},0);

  eid('content').innerHTML=`
  <div style="max-width:1100px;">
    <div class="tb no-print" style="margin-bottom:16px;flex-wrap:wrap;gap:8px;">
      <div>
        <div style="font-size:15px;font-weight:700;">GSTR-1 ‚Äî Statement of Outward Supplies</div>
        <div style="font-size:11px;color:var(--tm);">GSTIN: <strong>${state.gstin||'Not Set'}</strong> &nbsp;|&nbsp; FY: <strong>${state.fy}</strong> &nbsp;|&nbsp; Legal Name: <strong>${state.company}</strong></div>
      </div>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <button class="btn btn-s" onclick="exportGSTR1()">‚¨á Download JSON (NIC Format)</button>
        <button class="btn btn-p" onclick="exportGSTR1Excel()">üìä Export Excel</button>
      </div>
    </div>

    <div class="sg" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px;">
      <div class="sc sc-b"><div class="sl">Total Invoices</div><div class="sv">${salesV.length}</div><div class="ss">B2B: ${b2b.length} | B2CS: ${b2cs.length}</div></div>
      <div class="sc sc-g"><div class="sl">Taxable Value</div><div class="sv">${fmt(salesV.reduce((s,v)=>{const g=calcGST(v);return s+g.taxable;},0))}</div></div>
      <div class="sc sc-o"><div class="sl">Tax Collected</div><div class="sv">${fmt(totTax)}</div></div>
      <div class="sc sc-p"><div class="sl">Invoice Value</div><div class="sv">${fmt(totSales)}</div></div>
    </div>

    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:12px;">
      <strong>‚ö†Ô∏è Filing Reminder:</strong> GSTR-1 is due by <strong>11th of next month</strong> (monthly filers) or <strong>13th of month after quarter end</strong> (QRMP). 
      Export the JSON below and upload to <a href="https://www.gst.gov.in" target="_blank" style="color:#2563eb;">gst.gov.in</a> ‚Üí Returns ‚Üí File Returns.
    </div>

    <!-- TABLE 4A: B2B Supplies -->
    <div style="font-weight:700;font-size:11px;color:#1d4ed8;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">
      Table 4A ‚Äî B2B Supplies (Registered Customers with GSTIN)
    </div>
    <div class="card" style="margin-bottom:16px;">
      <table class="tbl">
        <thead><tr><th>Customer GSTIN</th><th>Customer Name</th><th>Invoice No</th><th>Date</th><th class="tr">Taxable</th><th class="tr">Tax</th><th class="tr">Invoice Value</th></tr></thead>
        <tbody>${b2bRows||'<tr><td colspan="7" style="padding:14px;text-align:center;color:var(--tm);">No B2B invoices found for this FY</td></tr>'}</tbody>
      </table>
    </div>

    <!-- TABLE 7: B2CS Supplies -->
    <div style="font-weight:700;font-size:11px;color:#c2410c;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">
      Table 7 ‚Äî B2CS Supplies (Unregistered Customers / Consumers)
    </div>
    <div class="card" style="margin-bottom:16px;">
      <table class="tbl">
        <thead><tr><th>Description</th><th>Invoice No</th><th>Date</th><th class="tr">Taxable</th><th class="tr">CGST</th><th class="tr">SGST</th><th class="tr">IGST</th><th class="tr">Total</th></tr></thead>
        <tbody>${b2csRows||'<tr><td colspan="8" style="padding:14px;text-align:center;color:var(--tm);">No B2CS invoices found</td></tr>'}</tbody>
      </table>
    </div>

    <!-- TABLE 12: HSN Summary -->
    <div style="font-weight:700;font-size:11px;color:#059669;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">
      Table 12 ‚Äî HSN-wise Summary of Outward Supplies
    </div>
    <div class="card" style="margin-bottom:16px;">
      <table class="tbl">
        <thead><tr><th>HSN/SAC</th><th>Description</th><th class="tr">Qty</th><th>Unit</th><th class="tr">Taxable</th><th class="tr">CGST</th><th class="tr">SGST</th><th class="tr">IGST</th><th class="tr">Total</th></tr></thead>
        <tbody>${hsnTableRows||'<tr><td colspan="9" style="padding:14px;text-align:center;color:var(--tm);">Add HSN codes to items to see HSN summary</td></tr>'}</tbody>
      </table>
    </div>
  </div>`;
}

function exportGSTR1(){
  // NIC-compliant GSTR-1 JSON structure
  const salesV=state.vouchers.filter(v=>v.type==='Sales'&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  function calcGST(v){
    if(v.items&&v.items.length)return{txval:v.items.reduce((s,i)=>s+(i.taxable||0),0),iamt:v.items.reduce((s,i)=>s+(i.igst||0),0),camt:v.items.reduce((s,i)=>s+(i.cgst||0),0),samt:v.items.reduce((s,i)=>s+(i.sgst||0),0)};
    const cgst=v.entries.filter(e=>e.accId==='2002').reduce((s,e)=>s+(e.cr||0),0);
    const sgst=v.entries.filter(e=>e.accId==='2003').reduce((s,e)=>s+(e.cr||0),0);
    const igst=v.entries.filter(e=>e.accId==='2004').reduce((s,e)=>s+(e.cr||0),0);
    const gross=v.entries.reduce((s,e)=>s+(e.dr||0),0);
    return{txval:Math.round((gross-cgst-sgst-igst)*100)/100,iamt:igst,camt:cgst,samt:sgst};
  }
  const b2b=salesV.filter(v=>{const p=state.debtors.find(d=>d.id===v.partyId||d.name===v.partyId);return p?.gstin;});
  const b2cs=salesV.filter(v=>{const p=state.debtors.find(d=>d.id===v.partyId||d.name===v.partyId);return !p?.gstin;});
  const gstr1={version:'GST3.0.4',hash:'hash',gstin:state.gstin||'',fp:state.fyEnd?.slice(0,7)?.replace('-',''),b2b:b2b.map(v=>{
    const p=state.debtors.find(d=>d.id===v.partyId||d.name===v.partyId);
    const g=calcGST(v);
    return{ctin:p?.gstin,inv:[{inum:v.id,idt:v.date.split('-').reverse().join('/'),val:Math.round((g.txval+g.camt+g.samt+g.iamt)*100)/100,pos:state.companyState?.slice(0,2)||'27',rchrg:'N',itms:[{num:1,itm_det:{rt:18,...g}}]}]};
  }),b2cs:b2cs.map(v=>{const g=calcGST(v);return{sply_ty:'INTRA',rt:18,...g};})};
  const blob=new Blob([JSON.stringify(gstr1,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`GSTR1_${state.gstin||'NA'}_FY${state.fy}.json`;a.click();
  logAudit('GSTR-1 Exported','JSON format');
  showToast('‚úÖ GSTR-1 JSON downloaded!','#059669');
}

function exportGSTR1Excel(){
  const salesV=state.vouchers.filter(v=>v.type==='Sales'&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  function calcGST(v){
    if(v.items&&v.items.length)return{taxable:v.items.reduce((s,i)=>s+(i.taxable||0),0),cgst:v.items.reduce((s,i)=>s+(i.cgst||0),0),sgst:v.items.reduce((s,i)=>s+(i.sgst||0),0),igst:v.items.reduce((s,i)=>s+(i.igst||0),0)};
    const cgst=v.entries.filter(e=>e.accId==='2002').reduce((s,e)=>s+(e.cr||0),0);
    const sgst=v.entries.filter(e=>e.accId==='2003').reduce((s,e)=>s+(e.cr||0),0);
    const igst=v.entries.filter(e=>e.accId==='2004').reduce((s,e)=>s+(e.cr||0),0);
    const gross=v.entries.reduce((s,e)=>s+(e.dr||0),0);
    return{taxable:gross-cgst-sgst-igst,cgst,sgst,igst};
  }
  const header=[[`GSTR-1 RETURN ‚Äî FY ${state.fy}`],['GSTIN:',state.gstin,'Company:',state.company],[]];
  const b2bRows=salesV.map(v=>{const g=calcGST(v);const p=state.debtors.find(d=>d.id===v.partyId||d.name===v.partyId);return[v.id,v.date,p?.gstin||'B2CS',p?.name||v.narration,g.taxable,g.cgst,g.sgst,g.igst,g.taxable+g.cgst+g.sgst+g.igst];});
  exportMultiXLS([
    {data:[...header,['Invoice No','Date','Customer GSTIN','Customer Name','Taxable Value','CGST','SGST','IGST','Invoice Value'],...b2bRows],name:'GSTR-1 B2B+B2CS'},
  ],`GSTR1_${state.fy}.xlsx`);
  logAudit('GSTR-1 Exported','Excel format');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FEATURE 2: GSTR-3B RETURN
//  Monthly self-declared summary return. Shows outward/inward
//  supplies, ITC, and net tax payable. Ready for filing.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgGSTR3B(){
  const fyStart=state.fyStart, fyEnd=state.fyEnd;
  const sV=state.vouchers.filter(v=>['Sales','Debit Note'].includes(v.type)&&v.date>=fyStart&&v.date<=fyEnd);
  const pV=state.vouchers.filter(v=>['Purchase','Credit Note'].includes(v.type)&&v.date>=fyStart&&v.date<=fyEnd);

  function sumGST(vouchers,side){
    let taxable=0,cgst=0,sgst=0,igst=0;
    vouchers.forEach(v=>{
      if(v.items&&v.items.length){taxable+=v.items.reduce((s,i)=>s+(i.taxable||0),0);cgst+=v.items.reduce((s,i)=>s+(i.cgst||0),0);sgst+=v.items.reduce((s,i)=>s+(i.sgst||0),0);igst+=v.items.reduce((s,i)=>s+(i.igst||0),0);}
      else if(side==='output'){const c=v.entries.filter(e=>e.accId==='2002').reduce((s,e)=>s+(e.cr||0),0);const g=v.entries.filter(e=>e.accId==='2003').reduce((s,e)=>s+(e.cr||0),0);const i2=v.entries.filter(e=>e.accId==='2004').reduce((s,e)=>s+(e.cr||0),0);const gr=v.entries.reduce((s,e)=>s+(e.dr||0),0);taxable+=gr-c-g-i2;cgst+=c;sgst+=g;igst+=i2;}
      else{const c=v.entries.filter(e=>e.accId==='1006').reduce((s,e)=>s+(e.dr||0),0);const g=v.entries.filter(e=>e.accId==='1007').reduce((s,e)=>s+(e.dr||0),0);const i2=v.entries.filter(e=>e.accId==='1008').reduce((s,e)=>s+(e.dr||0),0);const gr=v.entries.reduce((s,e)=>s+(e.cr||0),0);taxable+=gr-c-g-i2;cgst+=c;sgst+=g;igst+=i2;}
    });
    return{taxable:Math.round(taxable*100)/100,cgst:Math.round(cgst*100)/100,sgst:Math.round(sgst*100)/100,igst:Math.round(igst*100)/100};
  }

  const out=sumGST(sV,'output');
  const itc=sumGST(pV,'input');
  const netCGST=Math.max(0,out.cgst-itc.cgst);
  const netSGST=Math.max(0,out.sgst-itc.sgst);
  const netIGST=Math.max(0,out.igst-itc.igst);
  const netTax=netCGST+netSGST+netIGST;

  // Monthly breakdown for Table 3.1
  const months=[];
  const fyYear=parseInt((state.fy||'2025-26').split('-')[0]);
  for(let i=0;i<12;i++){
    const m=(i<9?fyYear:fyYear+1);
    const mo=String(i<9?i+4:i-8).padStart(2,'0');
    const key=`${m}-${mo}`;
    const mv=sV.filter(v=>v.date.startsWith(key));
    const mout=sumGST(mv,'output');
    if(mv.length>0)months.push({label:`${['Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan','Feb','Mar'][i]} ${m}`,key,...mout,total:mout.taxable+mout.cgst+mout.sgst+mout.igst,count:mv.length});
  }
  const monthRows=months.map((m,i)=>`<tr class="${i%2?'alt':''}">
    <td style="font-weight:600;">${m.label}</td>
    <td class="tr">${m.count}</td>
    <td class="tr">${fmt(m.taxable)}</td>
    <td class="tr tg-">${fmt(m.cgst)}</td>
    <td class="tr tg-">${fmt(m.sgst)}</td>
    <td class="tr bp">${fmt(m.igst)}</td>
    <td class="tr" style="font-weight:700;">${fmt(m.total)}</td>
  </tr>`).join('');

  eid('content').innerHTML=`
  <div style="max-width:900px;">
    <div class="tb no-print" style="margin-bottom:16px;">
      <div>
        <div style="font-size:15px;font-weight:700;">GSTR-3B ‚Äî Monthly Self-Declaration Return</div>
        <div style="font-size:11px;color:var(--tm);">GSTIN: <strong>${state.gstin||'Not Set'}</strong> &nbsp;|&nbsp; FY: <strong>${state.fy}</strong></div>
      </div>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <button class="btn btn-s" onclick="exportGSTR3BJSON()">‚¨á Download JSON</button>
        <button class="btn btn-p" onclick="exportGSTR3BExcel()">üìä Export Excel</button>
      </div>
    </div>

    <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:12px;">
      <strong>üìÖ Due Date:</strong> GSTR-3B is due by <strong>20th of the following month</strong>. 
      Download the JSON or Excel and cross-verify before filing at <a href="https://www.gst.gov.in" target="_blank" style="color:#2563eb;">gst.gov.in</a>.
    </div>

    <!-- 3.1 Outward Supplies -->
    <div class="card" style="margin-bottom:14px;">
      <div class="ch">3.1 ‚Äî Details of Outward Supplies and Inward Supplies liable to Reverse Charge</div>
      <div style="padding:16px;">
        <table class="tbl">
          <thead><tr><th>Nature of Supplies</th><th class="tr">Total Taxable Value</th><th class="tr">CGST</th><th class="tr">SGST</th><th class="tr">IGST</th><th class="tr">Total Tax</th></tr></thead>
          <tbody>
            <tr><td>a) Outward taxable supplies (other than zero rated, nil rated and exempted)</td><td class="tr">${fmt(out.taxable)}</td><td class="tr tg-">${fmt(out.cgst)}</td><td class="tr tg-">${fmt(out.sgst)}</td><td class="tr bp">${fmt(out.igst)}</td><td class="tr" style="font-weight:700;">${fmt(out.cgst+out.sgst+out.igst)}</td></tr>
            <tr class="alt"><td>b) Zero rated supply (Export)</td><td class="tr">0.00</td><td class="tr">0.00</td><td class="tr">0.00</td><td class="tr">0.00</td><td class="tr">0.00</td></tr>
            <tr><td>c) Nil rated, Exempt</td><td class="tr">0.00</td><td class="tr">‚Äî</td><td class="tr">‚Äî</td><td class="tr">‚Äî</td><td class="tr">‚Äî</td></tr>
            <tr class="alt"><td><strong>TOTAL (a+b+c)</strong></td><td class="tr"><strong>${fmt(out.taxable)}</strong></td><td class="tr"><strong>${fmt(out.cgst)}</strong></td><td class="tr"><strong>${fmt(out.sgst)}</strong></td><td class="tr"><strong>${fmt(out.igst)}</strong></td><td class="tr"><strong>${fmt(out.cgst+out.sgst+out.igst)}</strong></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 4 ITC -->
    <div class="card" style="margin-bottom:14px;">
      <div class="ch">4 ‚Äî Eligible Input Tax Credit (ITC)</div>
      <div style="padding:16px;">
        <table class="tbl">
          <thead><tr><th>Details</th><th class="tr">CGST</th><th class="tr">SGST</th><th class="tr">IGST</th><th class="tr">Total ITC</th></tr></thead>
          <tbody>
            <tr><td>A) ITC Available ‚Äî All other ITC (Purchases)</td><td class="tr tg-">${fmt(itc.cgst)}</td><td class="tr tg-">${fmt(itc.sgst)}</td><td class="tr bp">${fmt(itc.igst)}</td><td class="tr" style="font-weight:700;">${fmt(itc.cgst+itc.sgst+itc.igst)}</td></tr>
            <tr class="alt"><td>D) Ineligible ITC</td><td class="tr">0.00</td><td class="tr">0.00</td><td class="tr">0.00</td><td class="tr">0.00</td></tr>
            <tr><td><strong>NET ITC AVAILABLE</strong></td><td class="tr"><strong style="color:#059669;">${fmt(itc.cgst)}</strong></td><td class="tr"><strong style="color:#059669;">${fmt(itc.sgst)}</strong></td><td class="tr"><strong style="color:#059669;">${fmt(itc.igst)}</strong></td><td class="tr"><strong style="color:#059669;">${fmt(itc.cgst+itc.sgst+itc.igst)}</strong></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 5.1 Net Tax Payable -->
    <div class="card" style="margin-bottom:14px;">
      <div class="ch" style="background:${netTax>0?'#dc2626':'#059669'};">5.1 ‚Äî Tax Payable after ITC Adjustment</div>
      <div style="padding:16px;">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px;">
          <div style="background:#f0fdf4;border:1px solid #a7f3d0;border-radius:10px;padding:14px;text-align:center;">
            <div style="font-size:10px;font-weight:700;color:#065f46;text-transform:uppercase;margin-bottom:6px;">CGST Payable</div>
            <div style="font-size:20px;font-weight:700;color:${netCGST>0?'#dc2626':'#059669'};">${fmt(netCGST)}</div>
            <div style="font-size:10px;color:var(--tm);margin-top:4px;">Output ${fmt(out.cgst)} ‚àí ITC ${fmt(itc.cgst)}</div>
          </div>
          <div style="background:#f0fdf4;border:1px solid #a7f3d0;border-radius:10px;padding:14px;text-align:center;">
            <div style="font-size:10px;font-weight:700;color:#065f46;text-transform:uppercase;margin-bottom:6px;">SGST Payable</div>
            <div style="font-size:20px;font-weight:700;color:${netSGST>0?'#dc2626':'#059669'};">${fmt(netSGST)}</div>
            <div style="font-size:10px;color:var(--tm);margin-top:4px;">Output ${fmt(out.sgst)} ‚àí ITC ${fmt(itc.sgst)}</div>
          </div>
          <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:14px;text-align:center;">
            <div style="font-size:10px;font-weight:700;color:#1e40af;text-transform:uppercase;margin-bottom:6px;">IGST Payable</div>
            <div style="font-size:20px;font-weight:700;color:${netIGST>0?'#dc2626':'#059669'};">${fmt(netIGST)}</div>
            <div style="font-size:10px;color:var(--tm);margin-top:4px;">Output ${fmt(out.igst)} ‚àí ITC ${fmt(itc.igst)}</div>
          </div>
        </div>
        <div style="background:${netTax>0?'#fef2f2':'#f0fdf4'};border:1px solid ${netTax>0?'#fecaca':'#a7f3d0'};border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:12px;font-weight:700;color:var(--tm);margin-bottom:6px;">TOTAL NET GST ${netTax>0?'PAYABLE':'REFUNDABLE'}</div>
          <div style="font-size:28px;font-weight:700;color:${netTax>0?'#dc2626':'#059669'};">${fmt(netTax)}</div>
        </div>
      </div>
    </div>

    <!-- Monthly Breakdown -->
    <div class="card" style="margin-bottom:14px;">
      <div class="ch">Month-wise Sales Breakdown</div>
      <table class="tbl">
        <thead><tr><th>Month</th><th class="tr">Invoices</th><th class="tr">Taxable</th><th class="tr">CGST</th><th class="tr">SGST</th><th class="tr">IGST</th><th class="tr">Total</th></tr></thead>
        <tbody>${monthRows||'<tr><td colspan="7" class="tc tm-" style="padding:14px;">No sales data found for this FY</td></tr>'}</tbody>
      </table>
    </div>
  </div>`;
}

function exportGSTR3BJSON(){
  const sV=state.vouchers.filter(v=>v.type==='Sales'&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  const pV=state.vouchers.filter(v=>v.type==='Purchase'&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  function sum(v,accIds,side){return v.flatMap(vv=>vv.entries.filter(e=>accIds.includes(e.accId))).reduce((s,e)=>s+(side==='cr'?e.cr||0:e.dr||0),0);}
  const outCGST=sum(sV,['2002'],'cr'),outSGST=sum(sV,['2003'],'cr'),outIGST=sum(sV,['2004'],'cr');
  const inCGST=sum(pV,['1006'],'dr'),inSGST=sum(pV,['1007'],'dr'),inIGST=sum(pV,['1008'],'dr');
  const grossSales=sV.reduce((s,v)=>s+v.entries.reduce((ss,e)=>ss+(e.dr||0),0),0);
  const taxableSales=grossSales-outCGST-outSGST-outIGST;
  const gstr3b={version:'GST3.0.2',gstin:state.gstin||'',ret_period:state.fyEnd?.slice(0,7)?.replace('-',''),
    sup_details:{osup_det:{txval:taxableSales,iamt:outIGST,camt:outCGST,samt:outSGST,csamt:0},osup_zero:{txval:0,iamt:0,camt:0,samt:0,csamt:0},osup_nil_exmp:{txval:0},isup_rev:{txval:0,iamt:0,camt:0,samt:0,csamt:0}},
    itc_elg:{itc_avl:[{ty:'IMPG',iamt:0,camt:0,samt:0,csamt:0},{ty:'IMPS',iamt:0,camt:0,samt:0,csamt:0},{ty:'ISRC',iamt:0,camt:0,samt:0,csamt:0},{ty:'ISD',iamt:0,camt:0,samt:0,csamt:0},{ty:'OTH',iamt:outIGST>inIGST?inIGST:outIGST,camt:outCGST>inCGST?inCGST:outCGST,samt:outSGST>inSGST?inSGST:outSGST,csamt:0}]},
    inward_sup:{isup_details:[{ty:'GST',intra:0,inter:0},{ty:'NONGST',intra:0,inter:0}]},
    pdng_ltfee:{intr_lt_fee:{camt:0,samt:0}}};
  const blob=new Blob([JSON.stringify(gstr3b,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`GSTR3B_${state.gstin||'NA'}_FY${state.fy}.json`;a.click();
  logAudit('GSTR-3B Exported','JSON format');
  showToast('‚úÖ GSTR-3B JSON downloaded!','#059669');
}

function exportGSTR3BExcel(){
  const sV=state.vouchers.filter(v=>v.type==='Sales'&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  const pV=state.vouchers.filter(v=>v.type==='Purchase'&&v.date>=state.fyStart&&v.date<=state.fyEnd);
  function calcGST(v,side){if(v.items&&v.items.length)return{taxable:v.items.reduce((s,i)=>s+(i.taxable||0),0),cgst:v.items.reduce((s,i)=>s+(i.cgst||0),0),sgst:v.items.reduce((s,i)=>s+(i.sgst||0),0),igst:v.items.reduce((s,i)=>s+(i.igst||0),0)};const c=v.entries.filter(e=>e.accId===(side==='out'?'2002':'1006')).reduce((s,e)=>s+(side==='out'?e.cr||0:e.dr||0),0);const g=v.entries.filter(e=>e.accId===(side==='out'?'2003':'1007')).reduce((s,e)=>s+(side==='out'?e.cr||0:e.dr||0),0);const i2=v.entries.filter(e=>e.accId===(side==='out'?'2004':'1008')).reduce((s,e)=>s+(side==='out'?e.cr||0:e.dr||0),0);const gr=v.entries.reduce((s,e)=>s+(side==='out'?e.dr||0:e.cr||0),0);return{taxable:gr-c-g-i2,cgst:c,sgst:g,igst:i2};}
  const outTot=sV.reduce((a,v)=>{const g=calcGST(v,'out');return{taxable:a.taxable+g.taxable,cgst:a.cgst+g.cgst,sgst:a.sgst+g.sgst,igst:a.igst+g.igst};},{taxable:0,cgst:0,sgst:0,igst:0});
  const itcTot=pV.reduce((a,v)=>{const g=calcGST(v,'in');return{taxable:a.taxable+g.taxable,cgst:a.cgst+g.cgst,sgst:a.sgst+g.sgst,igst:a.igst+g.igst};},{taxable:0,cgst:0,sgst:0,igst:0});
  exportXLS([[`GSTR-3B ‚Äî FY ${state.fy}`],['GSTIN:',state.gstin||'Not Set','Company:',state.company],[],
    ['SECTION','TAXABLE VALUE','CGST','SGST','IGST','TOTAL TAX'],
    ['3.1 Outward Taxable Supplies',outTot.taxable,outTot.cgst,outTot.sgst,outTot.igst,outTot.cgst+outTot.sgst+outTot.igst],
    ['4A ITC Available (Purchases)',itcTot.taxable,itcTot.cgst,itcTot.sgst,itcTot.igst,itcTot.cgst+itcTot.sgst+itcTot.igst],
    [],['NET TAX PAYABLE','',Math.max(0,outTot.cgst-itcTot.cgst),Math.max(0,outTot.sgst-itcTot.sgst),Math.max(0,outTot.igst-itcTot.igst),Math.max(0,(outTot.cgst+outTot.sgst+outTot.igst)-(itcTot.cgst+itcTot.sgst+itcTot.igst))]
  ],'GSTR-3B',`GSTR3B_${state.fy}.xlsx`);
  logAudit('GSTR-3B Exported','Excel format');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FEATURE 3: E-INVOICE (IRN) GENERATOR
//  Generates IRN-compliant JSON payload per CBIC schema v1.1.
//  QR code generated client-side. JSON ready for upload to IRP.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgEInvoice(){
  const invs=(state.invoices||[]).filter(inv=>inv.status!=='cancelled');
  const rows=invs.sort((a,b)=>b.date.localeCompare(a.date)).map((inv,i)=>{
    const total=inv.items.reduce((s,it)=>s+(it.qty*it.rate*(1+(it.gst||0)/100)),0);
    const hasIRN=inv.irn;
    return`<tr class="${i%2?'alt':''}">
      <td class="mono tb-">${inv.id}</td>
      <td>${fmtD(inv.date)}</td>
      <td>${inv.customer}</td>
      <td class="tr mono">${fmt(total)}</td>
      <td>${hasIRN?`<span class="badge bg-">‚úÖ IRN Generated</span>`:`<span class="badge by">Pending</span>`}</td>
      <td style="white-space:nowrap;">
        ${!hasIRN?`<button class="btn btn-p btn-sm" onclick="generateIRN('${inv.id}')">üîê Generate IRN</button>`:''}
        ${hasIRN?`<button class="btn btn-g btn-sm" onclick="viewIRN('${inv.id}')">üëÅ View IRN</button>`:''}
        ${hasIRN?`<button class="btn btn-s btn-sm" onclick="downloadEInvoice('${inv.id}')">‚¨á Download JSON</button>`:''}
      </td>
    </tr>`;
  }).join('');

  eid('content').innerHTML=`
  <div style="max-width:1000px;">
    <div class="tb no-print" style="margin-bottom:16px;">
      <div>
        <div style="font-size:15px;font-weight:700;">E-Invoice (IRN) Generator</div>
        <div style="font-size:11px;color:var(--tm);">Seller GSTIN: <strong>${state.gstin||'‚ö†Ô∏è Not Set ‚Äî Add in Settings'}</strong></div>
      </div>
      <button class="btn btn-p" onclick="navigate('invoice')" style="margin-left:auto;">‚ûï Create New Invoice</button>
    </div>

    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:14px;margin-bottom:16px;font-size:12px;">
      <strong>üìå How it works:</strong><br>
      1. Create a GST Invoice in <strong>GST Invoice Generator</strong> ‚Üí 2. Come here and click <strong>Generate IRN</strong> ‚Üí 3. Download the JSON ‚Üí 4. Upload to <a href="https://einvoice1.gst.gov.in" target="_blank" style="color:#2563eb;">einvoice1.gst.gov.in</a> to get the official IRN + QR code from NIC.
      <br><br>‚ö†Ô∏è <strong>E-Invoice is mandatory</strong> for businesses with annual turnover above ‚Çπ5 crore. The IRN generated here is a <em>draft payload</em> in the correct NIC schema ‚Äî you must upload it to the government portal to get the official signed IRN.
    </div>

    <div class="sg" style="grid-template-columns:repeat(3,1fr);margin-bottom:16px;">
      <div class="sc sc-b"><div class="sl">Total Invoices</div><div class="sv">${invs.length}</div></div>
      <div class="sc sc-g"><div class="sl">IRN Generated</div><div class="sv">${invs.filter(i=>i.irn).length}</div></div>
      <div class="sc sc-o"><div class="sl">Pending IRN</div><div class="sv">${invs.filter(i=>!i.irn).length}</div></div>
    </div>

    <div class="card">
      <div class="ch">All Invoices ‚Äî E-Invoice Status</div>
      <table class="tbl">
        <thead><tr><th>Invoice No</th><th>Date</th><th>Customer</th><th class="tr">Amount</th><th>IRN Status</th><th>Actions</th></tr></thead>
        <tbody>${rows||'<tr><td colspan="6" class="tc tm-" style="padding:20px;">No invoices found. Create invoices in the GST Invoice Generator first.</td></tr>'}</tbody>
      </table>
    </div>
  </div>`;
}

function generateIRN(invId){
  const inv=state.invoices.find(i=>i.id===invId);
  if(!inv){showAlert('Invoice not found.');return;}
  if(!state.gstin){showAlert('Please set your GSTIN in Settings before generating e-invoice.');navigate('settings');return;}

  // Build NIC-compliant e-invoice JSON (Schema v1.1)
  const taxable=inv.items.reduce((s,it)=>s+(it.qty*it.rate),0);
  const totalGST=inv.items.reduce((s,it)=>s+(it.qty*it.rate*((it.gst||0)/100)),0);
  const isInterState=(inv.customerGstin&&inv.customerGstin.slice(0,2)!==state.gstin.slice(0,2));

  const itemList=inv.items.map((it,idx)=>{
    const amt=it.qty*it.rate;
    const gstAmt=amt*(it.gst||0)/100;
    const cgst=isInterState?0:gstAmt/2;
    const sgst=isInterState?0:gstAmt/2;
    const igst=isInterState?gstAmt:0;
    return{
      SlNo:String(idx+1),
      PrdDesc:it.name||it.desc||'',
      IsServc:it.hsn&&it.hsn.startsWith('99')?'Y':'N',
      HsnCd:it.hsn||'',
      Qty:it.qty,
      Unit:'NOS',
      UnitPrice:it.rate,
      TotAmt:amt,
      Discount:0,
      PreTaxVal:amt,
      AssAmt:amt,
      GstRt:it.gst||0,
      IgstAmt:Math.round(igst*100)/100,
      CgstAmt:Math.round(cgst*100)/100,
      SgstAmt:Math.round(sgst*100)/100,
      CesRt:0,
      CesAmt:0,
      CesNonAdvlAmt:0,
      StateCesRt:0,
      StateCesAmt:0,
      StateCesNonAdvlAmt:0,
      OthChrg:0,
      TotItemVal:Math.round((amt+gstAmt)*100)/100
    };
  });

  const sellerGSTIN=state.gstin;
  const buyerGSTIN=inv.customerGstin||'URP';

  const payload={
    Version:'1.1',
    TranDtls:{TaxSch:'GST',SupTyp:buyerGSTIN==='URP'?'B2C':'B2B',RegRev:'N',EcmGstin:null,IgstOnIntra:'N'},
    DocDtls:{Typ:'INV',No:inv.id,Dt:inv.date.split('-').reverse().join('/')},
    SellerDtls:{
      Gstin:sellerGSTIN,LglNm:state.company,TrdNm:state.company,
      Addr1:state.address||'',Addr2:'',Loc:state.companyState||'',
      Pin:state.pincode||0,Stcd:sellerGSTIN.slice(0,2),Ph:state.phone||'',Em:state.email||''
    },
    BuyerDtls:{
      Gstin:buyerGSTIN,LglNm:inv.customer,TrdNm:inv.customer,
      Pos:buyerGSTIN!=='URP'?buyerGSTIN.slice(0,2):sellerGSTIN.slice(0,2),
      Addr1:inv.customerAddr||'',Addr2:'',Loc:'',Pin:0,
      Stcd:buyerGSTIN!=='URP'?buyerGSTIN.slice(0,2):sellerGSTIN.slice(0,2),Ph:'',Em:''
    },
    ValDtls:{
      AssVal:Math.round(taxable*100)/100,
      CgstVal:isInterState?0:Math.round(totalGST/2*100)/100,
      SgstVal:isInterState?0:Math.round(totalGST/2*100)/100,
      IgstVal:isInterState?Math.round(totalGST*100)/100:0,
      CesVal:0,StCesVal:0,Discount:0,OthChrg:0,
      RndOffAmt:0,
      TotInvVal:Math.round((taxable+totalGST)*100)/100
    },
    ItemList:itemList,
    EwbDtls:null
  };

  // Generate a draft IRN hash (SHA-256 of key fields ‚Äî real IRN is signed by NIC)
  sha256legacy(`${sellerGSTIN}|${inv.id}|${inv.date}|${buyerGSTIN}`).then(hash=>{
    inv.irn=hash.toUpperCase();
    inv.irnPayload=payload;
    inv.irnGeneratedAt=new Date().toISOString();
    inv.irnGeneratedBy=currentUser?.username||'admin';
    scheduleSave();
    logAudit('E-Invoice IRN Generated',`Invoice ${inv.id} ‚Äî IRN: ${hash.slice(0,16).toUpperCase()}...`);
    showToast('üîê IRN payload generated! Download JSON and upload to NIC portal.','#059669');
    pgEInvoice();
    // Auto-show the IRN
    setTimeout(()=>viewIRN(invId),300);
  });
}

function viewIRN(invId){
  const inv=state.invoices.find(i=>i.id===invId);
  if(!inv?.irn){showAlert('IRN not generated yet.');return;}
  const total=inv.items.reduce((s,it)=>s+(it.qty*it.rate*(1+(it.gst||0)/100)),0);
  openModal(`üîê E-Invoice ‚Äî ${inv.id}`,`
    <div style="background:#f0fdf4;border:1px solid #a7f3d0;border-radius:10px;padding:14px;margin-bottom:14px;">
      <div style="font-size:10px;font-weight:700;color:#065f46;text-transform:uppercase;margin-bottom:6px;">Draft IRN Hash (SHA-256)</div>
      <div style="font-family:monospace;font-size:11px;word-break:break-all;color:#1e293b;">${inv.irn}</div>
      <div style="font-size:10px;color:var(--tm);margin-top:6px;">‚ö†Ô∏è This is a draft hash. Upload the JSON to einvoice1.gst.gov.in to get the official signed IRN.</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:12px;margin-bottom:14px;">
      <div><span style="color:var(--tm);">Invoice No:</span> <strong>${inv.id}</strong></div>
      <div><span style="color:var(--tm);">Date:</span> <strong>${fmtD(inv.date)}</strong></div>
      <div><span style="color:var(--tm);">Customer:</span> <strong>${inv.customer}</strong></div>
      <div><span style="color:var(--tm);">Customer GSTIN:</span> <strong>${inv.customerGstin||'URP (Unregistered)'}</strong></div>
      <div><span style="color:var(--tm);">Seller GSTIN:</span> <strong>${state.gstin}</strong></div>
      <div><span style="color:var(--tm);">Invoice Value:</span> <strong>${fmt(total)}</strong></div>
      <div><span style="color:var(--tm);">Generated By:</span> <strong>${inv.irnGeneratedBy||'admin'}</strong></div>
      <div><span style="color:var(--tm);">Generated At:</span> <strong>${new Date(inv.irnGeneratedAt).toLocaleString('en-IN')}</strong></div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-s" onclick="downloadEInvoice('${invId}')">‚¨á Download JSON</button>
      <button class="btn btn-g" onclick="closeModal()">Close</button>
    </div>
  `);
}

function downloadEInvoice(invId){
  const inv=state.invoices.find(i=>i.id===invId);
  if(!inv?.irnPayload){showAlert('Generate IRN first.');return;}
  const blob=new Blob([JSON.stringify(inv.irnPayload,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`EInvoice_${inv.id}_${state.gstin||'NA'}.json`;a.click();
  logAudit('E-Invoice Downloaded',`Invoice ${inv.id}`);
  showToast('‚úÖ E-Invoice JSON downloaded!','#059669');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FEATURE 4: AUDIT TRAIL
//  Complete log of who did what and when. Immutable, searchable.
//  Stored in state.auditLog ‚Äî capped at 500 entries.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pgAuditTrail(){
  if(!state.auditLog)state.auditLog=[];
  const log=state.auditLog;
  const searchQ=(eid('at-search')?.value||'').toLowerCase();
  const filterUser=eid('at-user')?.value||'all';
  const filterAction=eid('at-action')?.value||'all';

  const filtered=log.filter(e=>{
    const matchSearch=!searchQ||(e.action||'').toLowerCase().includes(searchQ)||(e.detail||'').toLowerCase().includes(searchQ)||(e.user||'').toLowerCase().includes(searchQ);
    const matchUser=filterUser==='all'||e.user===filterUser;
    const matchAction=filterAction==='all'||e.action===filterAction;
    return matchSearch&&matchUser&&matchAction;
  });

  const users=[...new Set(log.map(e=>e.user).filter(Boolean))];
  const actions=[...new Set(log.map(e=>e.action).filter(Boolean))];

  const actionColors={
    'Login':'#059669','Logout':'#64748b',
    'Invoice Created':'#2563eb','Invoice Deleted':'#dc2626',
    'Voucher Created':'#7c3aed','Voucher Edited':'#d97706',
    'Company Created':'#0891b2','E-Invoice IRN Generated':'#059669',
    'GSTR-1 Exported':'#16a34a','GSTR-3B Exported':'#16a34a',
    'E-Invoice Downloaded':'#2563eb',
  };

  const rows=filtered.slice(0,200).map((e,i)=>{
    const color=actionColors[e.action]||'#64748b';
    const ts=new Date(e.ts);
    const timeStr=ts.toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    return`<tr class="${i%2?'alt':''}">
      <td style="font-size:11px;white-space:nowrap;color:var(--tm);">${timeStr}</td>
      <td><span style="background:${color}22;color:${color};border:1px solid ${color}44;border-radius:12px;padding:2px 8px;font-size:11px;font-weight:700;">${e.action||'‚Äî'}</span></td>
      <td style="font-size:12px;font-weight:600;">${e.user||'‚Äî'}</td>
      <td><span class="badge ${e.role==='admin'?'bg-':e.role==='accountant'?'by':'bt'}">${e.role||'‚Äî'}</span></td>
      <td style="font-size:11px;color:var(--tm);">${e.detail||'‚Äî'}</td>
      <td style="font-size:11px;color:var(--tl);">${e.page||'‚Äî'}</td>
    </tr>`;
  }).join('');

  eid('content').innerHTML=`
  <div style="max-width:1200px;">
    <div class="tb no-print" style="margin-bottom:16px;flex-wrap:wrap;gap:8px;">
      <div>
        <div style="font-size:15px;font-weight:700;">Audit Trail ‚Äî Complete Activity Log</div>
        <div style="font-size:11px;color:var(--tm);">Showing ${filtered.length} of ${log.length} entries (max 500 stored)</div>
      </div>
      <div style="display:flex;gap:8px;margin-left:auto;flex-wrap:wrap;">
        <input class="fc" id="at-search" placeholder="üîç Search action/user/detail..." style="width:220px;" oninput="pgAuditTrail()" value="${searchQ}">
        <select class="fc" id="at-user" onchange="pgAuditTrail()" style="width:130px;">
          <option value="all">All Users</option>
          ${users.map(u=>`<option value="${u}" ${filterUser===u?'selected':''}>${u}</option>`).join('')}
        </select>
        <select class="fc" id="at-action" onchange="pgAuditTrail()" style="width:180px;">
          <option value="all">All Actions</option>
          ${actions.map(a=>`<option value="${a}" ${filterAction===a?'selected':''}>${a}</option>`).join('')}
        </select>
        <button class="btn btn-s" onclick="exportAuditLog()">‚¨á Export Excel</button>
        ${currentUser?.role==='admin'?`<button class="btn btn-d" onclick="if(confirm('Clear all audit logs? This cannot be undone.')){state.auditLog=[];logAudit('Audit Log Cleared','All entries deleted');scheduleSave();pgAuditTrail();}">üóë Clear Log</button>`:''}
      </div>
    </div>

    <div class="sg" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px;">
      <div class="sc sc-b"><div class="sl">Total Events</div><div class="sv">${log.length}</div></div>
      <div class="sc sc-g"><div class="sl">Login Events</div><div class="sv">${log.filter(e=>e.action==='Login').length}</div></div>
      <div class="sc sc-p"><div class="sl">Vouchers Posted</div><div class="sv">${log.filter(e=>e.action==='Voucher Created').length}</div></div>
      <div class="sc sc-o"><div class="sl">Unique Users</div><div class="sv">${users.length}</div></div>
    </div>

    ${filtered.length===0?`<div style="background:#f8fafc;border:1px dashed var(--bdr);border-radius:12px;padding:40px;text-align:center;color:var(--tm);">
      <div style="font-size:32px;margin-bottom:10px;">üîç</div>
      <div style="font-weight:700;">No entries match your filter</div>
      ${log.length===0?'<div style="font-size:12px;margin-top:6px;">Activity will appear here as users perform actions in the app.</div>':''}
    </div>`:
    `<div class="card">
      <table class="tbl">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Action</th>
            <th>User</th>
            <th>Role</th>
            <th>Details</th>
            <th>Page</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      ${filtered.length>200?`<div style="padding:10px 16px;font-size:11px;color:var(--tm);border-top:1px solid var(--bdr);">Showing first 200 of ${filtered.length} filtered entries. Export to Excel to see all.</div>`:''}
    </div>`}
  </div>`;
}

function exportAuditLog(){
  if(!state.auditLog||!state.auditLog.length){showAlert('No audit log entries to export.');return;}
  const rows=state.auditLog.map(e=>[
    new Date(e.ts).toLocaleString('en-IN'),
    e.action||'',
    e.user||'',
    e.role||'',
    e.detail||'',
    e.page||''
  ]);
  exportXLS([
    [state.company,'Audit Trail Export'],
    ['Exported On:',new Date().toLocaleString('en-IN'),'Exported By:',currentUser?.username||'admin'],
    [],
    ['Date & Time','Action','User','Role','Details','Page'],
    ...rows
  ],'Audit Trail',`AuditTrail_${state.company}_${today()}.xlsx`);
  logAudit('Audit Log Exported',`${state.auditLog.length} entries`);
}


//‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  const safetyTimer=setTimeout(()=>{
    console.warn('Init timeout ‚Äî showing company select');
    showCompanySelectScreen();
  },8000);
  try{
    // v11: restore Supabase Auth token first
    let session=null;
    try{
      const {data}=await getSupa().auth.getSession();
      session=data?.session||null;
    }catch(e){ console.warn('getSession error:',e); }

    const savedUsername=sessionStorage.getItem('loggedInUser');
    const savedCompanyId=sessionStorage.getItem('companyId');

    if(session && savedUsername && savedCompanyId){
      let userRow=null;
      try{
        const {data,error}=await getSupa().from('app_users')
          .select('*').eq('username',savedUsername).maybeSingle();
        if(!error) userRow=data;
      }catch(_){}

      if(userRow && userRow.company_id===savedCompanyId){
        const user=rowToUser(userRow);
        let savedState=null;
        try{savedState=await DB.get('data',savedCompanyId);}catch(_){}
        if(savedState){state={...DEFAULT_STATE,...savedState,companyId:savedCompanyId};}
        else{state={...DEFAULT_STATE,companyId:savedCompanyId};}
        if(state.appUsers)state.appUsers=state.appUsers.filter(x=>x&&x.username);
        currentUser=user;
        _selectedCompanyId=savedCompanyId;
        clearTimeout(safetyTimer);
        document.getElementById('co-select-wrap').classList.add('hidden');
        document.getElementById('login-wrap').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        const rl=user.role==='admin'?'üëë':user.role==='accountant'?'üìä':'üëÅ';
        document.getElementById('usr-btn').textContent=`${rl} ${user.username} ‚ñæ`;
        document.getElementById('sb-company').textContent=state.company||'My Company';
        document.getElementById('sb-fy').textContent='FY '+(state.fy||'2025-26');
        document.getElementById('top-fy').textContent='FY '+(state.fy||'2025-26');
        resetSessionTimer();
        applyRoleRestrictions(user.role);
        updateCompanySwitcherBtn();
        navigate('dashboard');
        return;
      } else {
        try{await getSupa().auth.signOut();}catch(_){}
        sessionStorage.clear();
      }
    } else {
      if(!session) sessionStorage.clear();
    }
    clearTimeout(safetyTimer);
    showCompanySelectScreen();
  }catch(e){
    clearTimeout(safetyTimer);
    console.error('Init error:',e);
    showCompanySelectScreen();
  }
}

// Close modal on overlay click
document.getElementById('modal').addEventListener('click',function(e){
  if(e.target===this)closeModal();
});

init();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OTP PASSWORD RESET ‚Äî v13
//  Flow: Enter mobile ‚Üí Supabase sends SMS OTP ‚Üí Verify ‚Üí New password
//  Requires: Twilio configured in Supabase ‚Üí Authentication ‚Üí Settings
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _otpState = { mobile:'', phoneE164:'', timer:null, resendCooldown:0 };

function openOtpScreen(){
  document.getElementById('login-wrap').classList.add('hidden');
  document.getElementById('otp-wrap').classList.remove('hidden');
  otpGoStep(1);
  setTimeout(()=>document.getElementById('otp-mobile-input')?.focus(), 100);
}

function closeOtpScreen(){
  document.getElementById('otp-wrap').classList.add('hidden');
  document.getElementById('login-wrap').classList.remove('hidden');
  clearInterval(_otpState.timer);
  _otpState = { mobile:'', phoneE164:'', timer:null, resendCooldown:0 };
}

function otpGoStep(n){
  [1,2,3].forEach(i=>{
    const el=document.getElementById('otp-s'+i);
    if(el) el.classList.toggle('active', i===n);
  });
  const err=document.getElementById('otp-error');
  if(err){ err.textContent=''; err.style.display='none'; }
}

function otpShowError(msg){
  const err=document.getElementById('otp-error');
  if(err){ err.textContent=msg; err.style.display='block'; }
}

// Step 1: User enters mobile number ‚Üí send OTP
async function otpSendStep1(){
  const raw=(document.getElementById('otp-mobile-input')?.value||'').trim();
  if(!raw){ otpShowError('Please enter your mobile number.'); return; }

  // Normalise to E.164 ‚Äî prefix +91 for 10-digit Indian numbers
  let phone = raw.replace(/\s|-/g,'');
  if(!phone.startsWith('+')){ phone = '+91'+phone.replace(/^0/,''); }
  if(!/^\+\d{10,15}$/.test(phone)){
    otpShowError('Enter a valid mobile number (10 digits, e.g. 9876543210).');
    return;
  }

  _otpState.mobile  = raw;
  _otpState.phoneE164 = phone;

  const btn=document.querySelector('#otp-s1 .login-btn');
  if(btn){ btn.disabled=true; btn.textContent='Sending OTP‚Ä¶'; }

  try{
    const {error} = await getSupa().auth.signInWithOtp({ phone });
    if(error) throw new Error(error.message);

    // Show masked number in step 2
    const masked = phone.slice(0,-4).replace(/\d/g,'*') + phone.slice(-4);
    document.getElementById('otp-sent-to').textContent = masked;

    otpGoStep(2);
    ['od1','od2','od3','od4','od5','od6'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.value='';
    });
    document.getElementById('od1')?.focus();
    otpStartTimer(600);

  }catch(e){
    let msg = e.message||'Failed to send OTP.';
    if(msg.includes('SMS') || msg.includes('provider') || msg.includes('Twilio')){
      msg = '‚ö†Ô∏è SMS service not configured yet. Ask your admin to set up Twilio in Supabase ‚Üí Authentication ‚Üí Settings ‚Üí SMS Provider.';
    } else if(msg.includes('rate') || msg.includes('limit')){
      msg = 'Too many attempts. Please wait a minute and try again.';
    }
    otpShowError(msg);
  }finally{
    if(btn){ btn.disabled=false; btn.textContent='Send OTP ‚Üí'; }
  }
}

// OTP digit input ‚Äî auto-advance, auto-submit when all 6 filled
function otpDigitInput(el, nextId){
  el.value = el.value.replace(/[^0-9]/g,'');
  if(el.value && nextId) document.getElementById(nextId)?.focus();
  const all = ['od1','od2','od3','od4','od5','od6'];
  if(all.every(id=>(document.getElementById(id)?.value||'').length===1)) otpVerify();
}
function otpDigitKey(e, el, prevId){
  if(e.key==='Backspace' && !el.value && prevId) document.getElementById(prevId)?.focus();
  if(e.key==='ArrowLeft' && prevId) document.getElementById(prevId)?.focus();
}

// Step 2: Verify OTP
async function otpVerify(){
  const otp=['od1','od2','od3','od4','od5','od6'].map(id=>document.getElementById(id)?.value||'').join('');
  if(otp.length!==6){ otpShowError('Enter all 6 digits.'); return; }

  const btn=document.querySelector('#otp-s2 .login-btn');
  if(btn){ btn.disabled=true; btn.textContent='Verifying‚Ä¶'; }

  try{
    const {data, error} = await getSupa().auth.verifyOtp({
      phone: _otpState.phoneE164,
      token: otp,
      type: 'sms'
    });
    if(error) throw new Error(error.message);

    clearInterval(_otpState.timer);
    otpGoStep(3);
    document.getElementById('otp-newpass')?.focus();

  }catch(e){
    let msg = e.message || 'Invalid OTP.';
    if(msg.includes('expired')) msg = 'OTP has expired. Please resend.';
    if(msg.includes('invalid') || msg.includes('Invalid')) msg = 'Incorrect OTP. Check the SMS and try again.';
    otpShowError(msg);
    ['od1','od2','od3','od4','od5','od6'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.value='';
    });
    document.getElementById('od1')?.focus();
  }finally{
    if(btn){ btn.disabled=false; btn.textContent='Verify OTP ‚Üí'; }
  }
}

// Step 3: Set new password (user is authenticated after OTP verify)
async function otpSetNewPassword(){
  const p  = document.getElementById('otp-newpass')?.value  || '';
  const p2 = document.getElementById('otp-newpass2')?.value || '';
  if(p.length < 6){ otpShowError('Password must be at least 6 characters.'); return; }
  if(p !== p2)    { otpShowError('Passwords do not match.'); return; }

  const btn=document.querySelector('#otp-s3 .login-btn');
  if(btn){ btn.disabled=true; btn.textContent='Saving‚Ä¶'; }

  try{
    const {error} = await getSupa().auth.updateUser({password: p});
    if(error) throw new Error(error.message);
    await getSupa().auth.signOut();
    closeOtpScreen();
    showToast('‚úÖ Password reset successfully! Please log in with your new password.','#059669');
  }catch(e){
    otpShowError('Failed to save password: '+(e.message||'Try again.'));
  }finally{
    if(btn){ btn.disabled=false; btn.textContent='üîê Save New Password ‚Üí'; }
  }
}

// Resend OTP ‚Äî 60s cooldown
async function otpResend(){
  if(_otpState.resendCooldown > 0){
    otpShowError('Please wait '+_otpState.resendCooldown+'s before resending.');
    return;
  }
  _otpState.resendCooldown = 60;
  const cd = setInterval(()=>{ _otpState.resendCooldown--; if(_otpState.resendCooldown<=0) clearInterval(cd); }, 1000);
  await otpSendStep1();
}

// Countdown timer
function otpStartTimer(seconds){
  clearInterval(_otpState.timer);
  let remaining = seconds;
  const el = document.getElementById('otp-timer-val');
  function tick(){
    if(!el) return;
    const m=Math.floor(remaining/60), s=remaining%60;
    el.textContent = m+':'+(s<10?'0':'')+s;
    if(remaining<=0){
      clearInterval(_otpState.timer);
      el.textContent='Expired';
      el.style.color='#ef4444';
    }
    remaining--;
  }
  tick();
  _otpState.timer = setInterval(tick, 1000);
}

</script>
</body>
</html>
